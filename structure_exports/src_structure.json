{
  "project_info": {
    "name": "src",
    "path": "E:\\Spring Boot\\cocinadelicia-backend\\src",
    "generated_at": "2026-02-01T22:28:37.4362609",
    "total_files": 162,
    "total_size": 413001
  },
  "structure": {
    "main": {
      "java": {
        "com": {
          "cocinadelicia": {
            "backend": {
              "auth": {
                "cognito": {
                  "CognitoUserInfoClient.java": {
                    "type": "file",
                    "info": {
                      "size": 1462,
                      "last_modified": "2026-02-01T22:28:36.4023115",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "catalog": {
                "admin": {
                  "controller": {
                    "AdminCatalogController.java": {
                      "type": "file",
                      "info": {
                        "size": 5938,
                        "last_modified": "2026-02-01T22:28:36.4378041",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "AdminProductImageController.java": {
                      "type": "file",
                      "info": {
                        "size": 1137,
                        "last_modified": "2026-02-01T22:28:36.4438071",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "AdminProductImageManagementController.java": {
                      "type": "file",
                      "info": {
                        "size": 1706,
                        "last_modified": "2026-02-01T22:28:36.4488073",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "dto": {
                    "PresignImageUploadRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 312,
                        "last_modified": "2026-02-01T22:28:36.4578071",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "PresignImageUploadResponse.java": {
                      "type": "file",
                      "info": {
                        "size": 265,
                        "last_modified": "2026-02-01T22:28:36.4628071",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "ProductImageAdminPatchRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 139,
                        "last_modified": "2026-02-01T22:28:36.468807",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "ProductImageAdminRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 219,
                        "last_modified": "2026-02-01T22:28:36.472807",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "ProductImageAdminResponse.java": {
                      "type": "file",
                      "info": {
                        "size": 176,
                        "last_modified": "2026-02-01T22:28:36.4778072",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "service": {
                    "AdminCategoryService.java": {
                      "type": "file",
                      "info": {
                        "size": 521,
                        "last_modified": "2026-02-01T22:28:36.4858071",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "AdminProductImageService.java": {
                      "type": "file",
                      "info": {
                        "size": 652,
                        "last_modified": "2026-02-01T22:28:36.4898072",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "AdminProductService.java": {
                      "type": "file",
                      "info": {
                        "size": 670,
                        "last_modified": "2026-02-01T22:28:36.4948069",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "AdminProductVariantService.java": {
                      "type": "file",
                      "info": {
                        "size": 613,
                        "last_modified": "2026-02-01T22:28:36.4988072",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "impl": {
                      "AdminCategoryServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 3132,
                          "last_modified": "2026-02-01T22:28:36.5038068",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      },
                      "AdminProductImageServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 5818,
                          "last_modified": "2026-02-01T22:28:36.507807",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      },
                      "AdminProductServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 4104,
                          "last_modified": "2026-02-01T22:28:36.5128069",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      },
                      "AdminProductVariantServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 3986,
                          "last_modified": "2026-02-01T22:28:36.516807",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      }
                    }
                  }
                },
                "controller": {
                  "CatalogController.java": {
                    "type": "file",
                    "info": {
                      "size": 6496,
                      "last_modified": "2026-02-01T22:28:36.531809",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "dto": {
                  "CatalogFilter.java": {
                    "type": "file",
                    "info": {
                      "size": 1787,
                      "last_modified": "2026-02-01T22:28:36.5398739",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CatalogImageResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 740,
                      "last_modified": "2026-02-01T22:28:36.5448738",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CatalogVariantResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 929,
                      "last_modified": "2026-02-01T22:28:36.5498731",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CategorySummaryResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 846,
                      "last_modified": "2026-02-01T22:28:36.5548733",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "MoneyResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 482,
                      "last_modified": "2026-02-01T22:28:36.5598733",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductDetailResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 2080,
                      "last_modified": "2026-02-01T22:28:36.5648732",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductSummaryResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 3465,
                      "last_modified": "2026-02-01T22:28:36.5698746",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "mapper": {
                  "ProductCatalogMapper.java": {
                    "type": "file",
                    "info": {
                      "size": 9358,
                      "last_modified": "2026-02-01T22:28:36.5788726",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "service": {
                  "CatalogService.java": {
                    "type": "file",
                    "info": {
                      "size": 951,
                      "last_modified": "2026-02-01T22:28:36.5868725",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "impl": {
                    "CatalogServiceImpl.java": {
                      "type": "file",
                      "info": {
                        "size": 4995,
                        "last_modified": "2026-02-01T22:28:36.5928725",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                }
              },
              "CocinaDeLiciaApplication.java": {
                "type": "file",
                "info": {
                  "size": 347,
                  "last_modified": "2026-02-01T22:28:36.6078726",
                  "mime_type": "text/x-java-source",
                  "extension": ".java"
                }
              },
              "common": {
                "config": {
                  "HttpClientConfig.java": {
                    "type": "file",
                    "info": {
                      "size": 571,
                      "last_modified": "2026-02-01T22:28:36.6128732",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "SecurityConfig.java": {
                    "type": "file",
                    "info": {
                      "size": 5222,
                      "last_modified": "2026-02-01T22:28:36.6168724",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "SecurityConfigLocal.java": {
                    "type": "file",
                    "info": {
                      "size": 1261,
                      "last_modified": "2026-02-01T22:28:36.6338757",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "WebSocketConfig.java": {
                    "type": "file",
                    "info": {
                      "size": 1518,
                      "last_modified": "2026-02-01T22:28:36.638381",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "WebSocketJwtAuthChannelInterceptor.java": {
                    "type": "file",
                    "info": {
                      "size": 2978,
                      "last_modified": "2026-02-01T22:28:36.643385",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "exception": {
                  "BadRequestException.java": {
                    "type": "file",
                    "info": {
                      "size": 537,
                      "last_modified": "2026-02-01T22:28:36.6503844",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "DomainException.java": {
                    "type": "file",
                    "info": {
                      "size": 241,
                      "last_modified": "2026-02-01T22:28:36.6553848",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ForbiddenException.java": {
                    "type": "file",
                    "info": {
                      "size": 588,
                      "last_modified": "2026-02-01T22:28:36.6593846",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "NotFoundException.java": {
                    "type": "file",
                    "info": {
                      "size": 529,
                      "last_modified": "2026-02-01T22:28:36.6633837",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "model": {
                  "BaseAudit.java": {
                    "type": "file",
                    "info": {
                      "size": 717,
                      "last_modified": "2026-02-01T22:28:36.6715736",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "enums": {
                    "CurrencyCode.java": {
                      "type": "file",
                      "info": {
                        "size": 103,
                        "last_modified": "2026-02-01T22:28:36.6765737",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "FulfillmentType.java": {
                      "type": "file",
                      "info": {
                        "size": 114,
                        "last_modified": "2026-02-01T22:28:36.6805729",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "OrderStatus.java": {
                      "type": "file",
                      "info": {
                        "size": 185,
                        "last_modified": "2026-02-01T22:28:36.684573",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "PaymentMethod.java": {
                      "type": "file",
                      "info": {
                        "size": 162,
                        "last_modified": "2026-02-01T22:28:36.688573",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "PaymentStatus.java": {
                      "type": "file",
                      "info": {
                        "size": 162,
                        "last_modified": "2026-02-01T22:28:36.6925731",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "RoleName.java": {
                      "type": "file",
                      "info": {
                        "size": 127,
                        "last_modified": "2026-02-01T22:28:36.6975743",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                },
                "s3": {
                  "CdnUrlBuilder.java": {
                    "type": "file",
                    "info": {
                      "size": 865,
                      "last_modified": "2026-02-01T22:28:36.7095741",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ImagePresignService.java": {
                    "type": "file",
                    "info": {
                      "size": 2715,
                      "last_modified": "2026-02-01T22:28:36.7150419",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "S3PresignerConfig.java": {
                    "type": "file",
                    "info": {
                      "size": 665,
                      "last_modified": "2026-02-01T22:28:36.7200661",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "web": {
                  "ApiError.java": {
                    "type": "file",
                    "info": {
                      "size": 782,
                      "last_modified": "2026-02-01T22:28:36.7290691",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "GlobalExceptionHandler.java": {
                    "type": "file",
                    "info": {
                      "size": 6529,
                      "last_modified": "2026-02-01T22:28:36.733069",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "PageResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 940,
                      "last_modified": "2026-02-01T22:28:36.7380687",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "WebSocketInfoController.java": {
                    "type": "file",
                    "info": {
                      "size": 1656,
                      "last_modified": "2026-02-01T22:28:36.7425766",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "config": {
                "OpenApiConfig.java": {
                  "type": "file",
                  "info": {
                    "size": 3247,
                    "last_modified": "2026-02-01T22:28:36.7545927",
                    "mime_type": "text/x-java-source",
                    "extension": ".java"
                  }
                }
              },
              "order": {
                "adapter": {
                  "JpaPriceHistoryAdapter.java": {
                    "type": "file",
                    "info": {
                      "size": 727,
                      "last_modified": "2026-02-01T22:28:36.7625926",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "admin": {
                  "controller": {
                    "OrderAdminController.java": {
                      "type": "file",
                      "info": {
                        "size": 6333,
                        "last_modified": "2026-02-01T22:28:36.7695933",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "dto": {
                    "CreateOrderAdminRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 1996,
                        "last_modified": "2026-02-01T22:28:36.7775927",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "OrderAdminResponse.java": {
                      "type": "file",
                      "info": {
                        "size": 3281,
                        "last_modified": "2026-02-01T22:28:36.7815923",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "OrderFilterRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 1394,
                        "last_modified": "2026-02-01T22:28:36.7855925",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "OrderStatsResponse.java": {
                      "type": "file",
                      "info": {
                        "size": 1219,
                        "last_modified": "2026-02-01T22:28:36.7895927",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "UpdateOrderCustomerRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 604,
                        "last_modified": "2026-02-01T22:28:36.7935924",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "UpdateOrderDetailsRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 910,
                        "last_modified": "2026-02-01T22:28:36.7970828",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "UpdateOrderItemsRequest.java": {
                      "type": "file",
                      "info": {
                        "size": 580,
                        "last_modified": "2026-02-01T22:28:36.8020827",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "mapper": {
                    "OrderAdminMapper.java": {
                      "type": "file",
                      "info": {
                        "size": 2473,
                        "last_modified": "2026-02-01T22:28:36.8090828",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "service": {
                    "impl": {
                      "OrderAdminServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 25873,
                          "last_modified": "2026-02-01T22:28:36.8170837",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      }
                    },
                    "OrderAdminService.java": {
                      "type": "file",
                      "info": {
                        "size": 2126,
                        "last_modified": "2026-02-01T22:28:36.8240852",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                },
                "chef": {
                  "controller": {
                    "OrderChefController.java": {
                      "type": "file",
                      "info": {
                        "size": 2694,
                        "last_modified": "2026-02-01T22:28:36.8350867",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "dto": {
                    "OrderChefResponse.java": {
                      "type": "file",
                      "info": {
                        "size": 960,
                        "last_modified": "2026-02-01T22:28:36.8425929",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "mapper": {
                    "OrderChefMapper.java": {
                      "type": "file",
                      "info": {
                        "size": 1206,
                        "last_modified": "2026-02-01T22:28:36.8495926",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "service": {
                    "impl": {
                      "OrderChefServiceImpl.java": {
                        "type": "file",
                        "info": {
                          "size": 4503,
                          "last_modified": "2026-02-01T22:28:36.8575929",
                          "mime_type": "text/x-java-source",
                          "extension": ".java"
                        }
                      }
                    },
                    "OrderChefService.java": {
                      "type": "file",
                      "info": {
                        "size": 751,
                        "last_modified": "2026-02-01T22:28:36.8645929",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                },
                "controller": {
                  "OrderController.java": {
                    "type": "file",
                    "info": {
                      "size": 16106,
                      "last_modified": "2026-02-01T22:28:36.8755927",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "domain": {
                  "OrderOwnershipValidator.java": {
                    "type": "file",
                    "info": {
                      "size": 3867,
                      "last_modified": "2026-02-01T22:28:36.8835924",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderStatusTransition.java": {
                    "type": "file",
                    "info": {
                      "size": 4255,
                      "last_modified": "2026-02-01T22:28:36.8875925",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderStatusTransitionValidator.java": {
                    "type": "file",
                    "info": {
                      "size": 1796,
                      "last_modified": "2026-02-01T22:28:36.8915929",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "dto": {
                  "CreateOrderRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 1928,
                      "last_modified": "2026-02-01T22:28:36.8985926",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderCancelRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 448,
                      "last_modified": "2026-02-01T22:28:36.9025926",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderFilter.java": {
                    "type": "file",
                    "info": {
                      "size": 946,
                      "last_modified": "2026-02-01T22:28:36.9065925",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderItemRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 962,
                      "last_modified": "2026-02-01T22:28:36.9115971",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderItemResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 999,
                      "last_modified": "2026-02-01T22:28:36.9155935",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderPageResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 878,
                      "last_modified": "2026-02-01T22:28:36.9195931",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 3374,
                      "last_modified": "2026-02-01T22:28:36.9235964",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ShippingAddressRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 1424,
                      "last_modified": "2026-02-01T22:28:36.9275964",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UpdateOrderStatusRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 853,
                      "last_modified": "2026-02-01T22:28:36.9305966",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "events": {
                  "OrderEventPayload.java": {
                    "type": "file",
                    "info": {
                      "size": 363,
                      "last_modified": "2026-02-01T22:28:36.9380993",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderWebSocketPublisher.java": {
                    "type": "file",
                    "info": {
                      "size": 1202,
                      "last_modified": "2026-02-01T22:28:36.9421027",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "mapper": {
                  "OrderMapper.java": {
                    "type": "file",
                    "info": {
                      "size": 1656,
                      "last_modified": "2026-02-01T22:28:36.9491024",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "model": {
                  "CustomerOrder.java": {
                    "type": "file",
                    "info": {
                      "size": 4048,
                      "last_modified": "2026-02-01T22:28:36.9561461",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderItem.java": {
                    "type": "file",
                    "info": {
                      "size": 1697,
                      "last_modified": "2026-02-01T22:28:36.9601026",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderStatusHistory.java": {
                    "type": "file",
                    "info": {
                      "size": 1311,
                      "last_modified": "2026-02-01T22:28:36.9641028",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "Payment.java": {
                    "type": "file",
                    "info": {
                      "size": 1763,
                      "last_modified": "2026-02-01T22:28:36.968103",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "port": {
                  "PriceQueryPort.java": {
                    "type": "file",
                    "info": {
                      "size": 379,
                      "last_modified": "2026-02-01T22:28:36.9751493",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "repository": {
                  "CustomerOrderRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 1060,
                      "last_modified": "2026-02-01T22:28:36.983102",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderItemRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 321,
                      "last_modified": "2026-02-01T22:28:36.9871022",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "OrderStatusHistoryRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 531,
                      "last_modified": "2026-02-01T22:28:36.9911029",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "PaymentRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 315,
                      "last_modified": "2026-02-01T22:28:36.9951026",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "spec": {
                    "OrderSpecifications.java": {
                      "type": "file",
                      "info": {
                        "size": 1272,
                        "last_modified": "2026-02-01T22:28:36.9991026",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                },
                "service": {
                  "impl": {
                    "OrderServiceImpl.java": {
                      "type": "file",
                      "info": {
                        "size": 15380,
                        "last_modified": "2026-02-01T22:28:37.0091025",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "OrderService.java": {
                    "type": "file",
                    "info": {
                      "size": 1126,
                      "last_modified": "2026-02-01T22:28:37.0161026",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "product": {
                "dto": {
                  "CategoryAdminRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 758,
                      "last_modified": "2026-02-01T22:28:37.0261052",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CategoryAdminResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 257,
                      "last_modified": "2026-02-01T22:28:37.0301055",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductAdminRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 1218,
                      "last_modified": "2026-02-01T22:28:37.0341058",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductAdminResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 499,
                      "last_modified": "2026-02-01T22:28:37.0476334",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductVariantAdminRequest.java": {
                    "type": "file",
                    "info": {
                      "size": 912,
                      "last_modified": "2026-02-01T22:28:37.0516332",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductVariantAdminResponse.java": {
                    "type": "file",
                    "info": {
                      "size": 406,
                      "last_modified": "2026-02-01T22:28:37.0566334",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "mapper": {
                  "CategoryAdminMapper.java": {
                    "type": "file",
                    "info": {
                      "size": 1115,
                      "last_modified": "2026-02-01T22:28:37.0636332",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductAdminMapper.java": {
                    "type": "file",
                    "info": {
                      "size": 2386,
                      "last_modified": "2026-02-01T22:28:37.066633",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductVariantMapper.java": {
                    "type": "file",
                    "info": {
                      "size": 1671,
                      "last_modified": "2026-02-01T22:28:37.0706331",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "model": {
                  "Category.java": {
                    "type": "file",
                    "info": {
                      "size": 1005,
                      "last_modified": "2026-02-01T22:28:37.0776331",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "PriceHistory.java": {
                    "type": "file",
                    "info": {
                      "size": 1462,
                      "last_modified": "2026-02-01T22:28:37.0816331",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "Product.java": {
                    "type": "file",
                    "info": {
                      "size": 2428,
                      "last_modified": "2026-02-01T22:28:37.0856334",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductImage.java": {
                    "type": "file",
                    "info": {
                      "size": 1478,
                      "last_modified": "2026-02-01T22:28:37.088633",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductVariant.java": {
                    "type": "file",
                    "info": {
                      "size": 2283,
                      "last_modified": "2026-02-01T22:28:37.0926375",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "Tag.java": {
                    "type": "file",
                    "info": {
                      "size": 895,
                      "last_modified": "2026-02-01T22:28:37.0966364",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "repository": {
                  "CategoryRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 670,
                      "last_modified": "2026-02-01T22:28:37.1036334",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "PriceHistoryRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 1998,
                      "last_modified": "2026-02-01T22:28:37.1066338",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductImageRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 739,
                      "last_modified": "2026-02-01T22:28:37.1106331",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 2461,
                      "last_modified": "2026-02-01T22:28:37.1146332",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "ProductVariantRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 340,
                      "last_modified": "2026-02-01T22:28:37.1186331",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "spec": {
                    "ProductSpecifications.java": {
                      "type": "file",
                      "info": {
                        "size": 5863,
                        "last_modified": "2026-02-01T22:28:37.1226331",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "TagRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 236,
                      "last_modified": "2026-02-01T22:28:37.1296367",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "service": {
                  "dto": {
                    "PriceInfo.java": {
                      "type": "file",
                      "info": {
                        "size": 497,
                        "last_modified": "2026-02-01T22:28:37.1366367",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "impl": {
                    "PriceServiceImpl.java": {
                      "type": "file",
                      "info": {
                        "size": 1149,
                        "last_modified": "2026-02-01T22:28:37.1441164",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "PriceService.java": {
                    "type": "file",
                    "info": {
                      "size": 495,
                      "last_modified": "2026-02-01T22:28:37.1513308",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "user": {
                "AdminPingController.java": {
                  "type": "file",
                  "info": {
                    "size": 367,
                    "last_modified": "2026-02-01T22:28:37.1617918",
                    "mime_type": "text/x-java-source",
                    "extension": ".java"
                  }
                },
                "controller": {
                  "UserController.java": {
                    "type": "file",
                    "info": {
                      "size": 1185,
                      "last_modified": "2026-02-01T22:28:37.1657919",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "dto": {
                  "UserRegistrationDTO.java": {
                    "type": "file",
                    "info": {
                      "size": 253,
                      "last_modified": "2026-02-01T22:28:37.1719771",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UserResponseDTO.java": {
                    "type": "file",
                    "info": {
                      "size": 344,
                      "last_modified": "2026-02-01T22:28:37.1759772",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "model": {
                  "AppUser.java": {
                    "type": "file",
                    "info": {
                      "size": 1494,
                      "last_modified": "2026-02-01T22:28:37.182977",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CustomerAddress.java": {
                    "type": "file",
                    "info": {
                      "size": 1192,
                      "last_modified": "2026-02-01T22:28:37.1869771",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "Role.java": {
                    "type": "file",
                    "info": {
                      "size": 897,
                      "last_modified": "2026-02-01T22:28:37.1909771",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UserRole.java": {
                    "type": "file",
                    "info": {
                      "size": 1384,
                      "last_modified": "2026-02-01T22:28:37.1949823",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UserRoleId.java": {
                    "type": "file",
                    "info": {
                      "size": 663,
                      "last_modified": "2026-02-01T22:28:37.198977",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "repository": {
                  "CustomerAddressRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 266,
                      "last_modified": "2026-02-01T22:28:37.2059771",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "RoleRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 552,
                      "last_modified": "2026-02-01T22:28:37.2099769",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UserRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 454,
                      "last_modified": "2026-02-01T22:28:37.213983",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "UserRoleRepository.java": {
                    "type": "file",
                    "info": {
                      "size": 379,
                      "last_modified": "2026-02-01T22:28:37.2179768",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "service": {
                  "CurrentUserService.java": {
                    "type": "file",
                    "info": {
                      "size": 296,
                      "last_modified": "2026-02-01T22:28:37.2249793",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "impl": {
                    "CurrentUserServiceImpl.java": {
                      "type": "file",
                      "info": {
                        "size": 1769,
                        "last_modified": "2026-02-01T22:28:37.2289799",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    },
                    "UserServiceImpl.java": {
                      "type": "file",
                      "info": {
                        "size": 6637,
                        "last_modified": "2026-02-01T22:28:37.2329813",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  },
                  "UserService.java": {
                    "type": "file",
                    "info": {
                      "size": 839,
                      "last_modified": "2026-02-01T22:28:37.2396956",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "resources": {
        "application-dev.yml": {
          "type": "file",
          "info": {
            "size": 2431,
            "last_modified": "2026-02-01T22:28:37.2626952",
            "mime_type": "text/x-yaml",
            "extension": ".yml"
          }
        },
        "application-local.yml": {
          "type": "file",
          "info": {
            "size": 1435,
            "last_modified": "2026-02-01T22:28:37.2667847",
            "mime_type": "text/x-yaml",
            "extension": ".yml"
          }
        },
        "application-prod.yml": {
          "type": "file",
          "info": {
            "size": 2662,
            "last_modified": "2026-02-01T22:28:37.2699986",
            "mime_type": "text/x-yaml",
            "extension": ".yml"
          }
        },
        "application-test.yml": {
          "type": "file",
          "info": {
            "size": 719,
            "last_modified": "2026-02-01T22:28:37.2739984",
            "mime_type": "text/x-yaml",
            "extension": ".yml"
          }
        },
        "application.yml": {
          "type": "file",
          "info": {
            "size": 903,
            "last_modified": "2026-02-01T22:28:37.278",
            "mime_type": "text/x-yaml",
            "extension": ".yml"
          }
        },
        "db": {
          "migration": {
            "V1__init_schema.sql": {
              "type": "file",
              "info": {
                "size": 11810,
                "last_modified": "2026-02-01T22:28:37.281999",
                "mime_type": "text/x-sql",
                "extension": ".sql"
              }
            },
            "V2__seed_demo.sql": {
              "type": "file",
              "info": {
                "size": 82591,
                "last_modified": "2026-02-01T22:28:37.2859989",
                "mime_type": "text/x-sql",
                "extension": ".sql"
              }
            },
            "V3__add_order_status_history.sql": {
              "type": "file",
              "info": {
                "size": 1594,
                "last_modified": "2026-02-01T22:28:37.2899991",
                "mime_type": "text/x-sql",
                "extension": ".sql"
              }
            },
            "V4__seed_real_customers.sql": {
              "type": "file",
              "info": {
                "size": 9589,
                "last_modified": "2026-02-01T22:28:37.2939989",
                "mime_type": "text/x-sql",
                "extension": ".sql"
              }
            }
          }
        },
        "log4j2-spring-prod.xml": {
          "type": "file",
          "info": {
            "size": 1573,
            "last_modified": "2026-02-01T22:28:37.3039994",
            "mime_type": "application/xml",
            "extension": ".xml"
          }
        },
        "log4j2-spring.xml": {
          "type": "file",
          "info": {
            "size": 2270,
            "last_modified": "2026-02-01T22:28:37.3199994",
            "mime_type": "application/xml",
            "extension": ".xml"
          }
        },
        "S3PresignerConfig.java": {
          "type": "file",
          "info": {
            "size": 0,
            "last_modified": "2026-02-01T22:28:37.3240024",
            "mime_type": "text/x-java-source",
            "extension": ".java"
          }
        },
        "ssl": {
          "cdd-local.p12": {
            "type": "file",
            "info": {
              "size": 2766,
              "last_modified": "2026-02-01T22:28:37.3270479",
              "mime_type": "application/x-x509-key; format=der",
              "extension": ".p12"
            }
          }
        },
        "static": {
        },
        "templates": {
        }
      }
    },
    "test": {
      "java": {
        "com": {
          "cocinadelicia": {
            "backend": {
              "catalog": {
                "CatalogControllerTest.java": {
                  "type": "file",
                  "info": {
                    "size": 2,
                    "last_modified": "2026-02-01T22:28:37.3545241",
                    "mime_type": "text/x-java-source",
                    "extension": ".java"
                  }
                },
                "controller": {
                  "CatalogControllerTest.java": {
                    "type": "file",
                    "info": {
                      "size": 2,
                      "last_modified": "2026-02-01T22:28:37.3585372",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  },
                  "CatalogDetailEndpointsTest.java": {
                    "type": "file",
                    "info": {
                      "size": 4472,
                      "last_modified": "2026-02-01T22:28:37.3626671",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "CocinaDeLiciaApplicationTests.java": {
                "type": "file",
                "info": {
                  "size": 316,
                  "last_modified": "2026-02-01T22:28:37.3726671",
                  "mime_type": "text/x-java-source",
                  "extension": ".java"
                }
              },
              "migration": {
                "FlywayMigrationTest.java": {
                  "type": "file",
                  "info": {
                    "size": 2,
                    "last_modified": "2026-02-01T22:28:37.376667",
                    "mime_type": "text/x-java-source",
                    "extension": ".java"
                  }
                }
              },
              "OpenApiSmokeTest.java": {
                "type": "file",
                "info": {
                  "size": 1404,
                  "last_modified": "2026-02-01T22:28:37.3838031",
                  "mime_type": "text/x-java-source",
                  "extension": ".java"
                }
              },
              "order": {
                "controller": {
                  "OrderControllerTest.java": {
                    "type": "file",
                    "info": {
                      "size": 9015,
                      "last_modified": "2026-02-01T22:28:37.387093",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                },
                "domain": {
                  "OrderStatusTransitionValidatorTest.java": {
                    "type": "file",
                    "info": {
                      "size": 1621,
                      "last_modified": "2026-02-01T22:28:37.394093",
                      "mime_type": "text/x-java-source",
                      "extension": ".java"
                    }
                  }
                }
              },
              "product": {
                "repository": {
                  "spec": {
                    "ProductSpecificationsTest.java": {
                      "type": "file",
                      "info": {
                        "size": 2,
                        "last_modified": "2026-02-01T22:28:37.4050928",
                        "mime_type": "text/x-java-source",
                        "extension": ".java"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "files": [
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\auth\\cognito\\CognitoUserInfoClient.java",
      "content": "package com.cocinadelicia.backend.auth.cognito;\r\n\r\nimport java.util.Map;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.http.*;\r\nimport org.springframework.stereotype.Component;\r\nimport org.springframework.web.client.RestTemplate;\r\n\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class CognitoUserInfoClient {\r\n\r\n  @Value(\"${cognito.domain}\")\r\n  private String domain; // ej. cdd-auth.auth.us-east-1.amazoncognito.com\r\n\r\n  private final RestTemplate restTemplate;\r\n\r\n  /**\r\n   * Llama a https://{domain}/oauth2/userInfo con el Access Token de Cognito. Devuelve atributos\r\n   * como email, given_name, family_name, phone_number (si estn disponibles).\r\n   */\r\n  public Map<String, Object> fetchUserInfo(String accessToken) {\r\n    String url = \"https://\" + domain + \"/oauth2/userInfo\";\r\n\r\n    HttpHeaders headers = new HttpHeaders();\r\n    headers.setBearerAuth(accessToken);\r\n    headers.setAccept(java.util.List.of(MediaType.APPLICATION_JSON));\r\n    HttpEntity<Void> entity = new HttpEntity<>(headers);\r\n\r\n    ResponseEntity<Map> resp = restTemplate.exchange(url, HttpMethod.GET, entity, Map.class);\r\n\r\n    if (!resp.getStatusCode().is2xxSuccessful() || resp.getBody() == null) {\r\n      throw new IllegalStateException(\r\n          \"Cannot fetch userInfo from Cognito (status=\" + resp.getStatusCode() + \")\");\r\n    }\r\n    //noinspection unchecked\r\n    return resp.getBody();\r\n  }\r\n}\r\n",
      "info": {
        "size": 1462,
        "last_modified": "2026-02-01T22:28:36.4023115",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\controller\\AdminCatalogController.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.controller;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminCategoryService;\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductService;\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductVariantService;\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport com.cocinadelicia.backend.product.dto.*;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport jakarta.validation.Valid;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springdoc.core.annotations.ParameterObject;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.web.PageableDefault;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/admin/catalog\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"admin-catalog\", description = \"Administracin de catlogo (solo ADMIN)\")\r\npublic class AdminCatalogController {\r\n\r\n  private final AdminCategoryService categoryService;\r\n  private final AdminProductService productService;\r\n  private final AdminProductVariantService variantService;\r\n\r\n  // ---------- Categoras ----------\r\n\r\n  @Operation(summary = \"Listar categoras (admin)\")\r\n  @GetMapping(\"/categories\")\r\n  public ResponseEntity<List<CategoryAdminResponse>> getCategories() {\r\n    return ResponseEntity.ok(categoryService.getAll());\r\n  }\r\n\r\n  @Operation(summary = \"Obtener categora por ID (admin)\")\r\n  @GetMapping(\"/categories/{id}\")\r\n  public ResponseEntity<CategoryAdminResponse> getCategory(@PathVariable Long id) {\r\n    return ResponseEntity.ok(categoryService.getById(id));\r\n  }\r\n\r\n  @Operation(summary = \"Crear nueva categora (admin)\")\r\n  @PostMapping(\"/categories\")\r\n  public ResponseEntity<CategoryAdminResponse> createCategory(\r\n      @Valid @RequestBody CategoryAdminRequest request) {\r\n    return ResponseEntity.ok(categoryService.create(request));\r\n  }\r\n\r\n  @Operation(summary = \"Actualizar categora (admin)\")\r\n  @PutMapping(\"/categories/{id}\")\r\n  public ResponseEntity<CategoryAdminResponse> updateCategory(\r\n      @PathVariable Long id, @Valid @RequestBody CategoryAdminRequest request) {\r\n    return ResponseEntity.ok(categoryService.update(id, request));\r\n  }\r\n\r\n  @Operation(summary = \"Eliminar categora (admin)\")\r\n  @DeleteMapping(\"/categories/{id}\")\r\n  public ResponseEntity<Void> deleteCategory(@PathVariable Long id) {\r\n    categoryService.delete(id);\r\n    return ResponseEntity.noContent().build();\r\n  }\r\n\r\n  // ---------- Productos ----------\r\n\r\n  @Operation(summary = \"Listar productos (admin)\")\r\n  @GetMapping(\"/products\")\r\n  public ResponseEntity<PageResponse<ProductAdminResponse>> getProducts(\r\n      @RequestParam(name = \"categoryId\", required = false) Long categoryId,\r\n      @RequestParam(name = \"active\", required = false) Boolean isActive,\r\n      @ParameterObject @PageableDefault(size = 20) Pageable pageable) {\r\n\r\n    PageResponse<ProductAdminResponse> page =\r\n        productService.getProducts(categoryId, isActive, pageable);\r\n    return ResponseEntity.ok(page);\r\n  }\r\n\r\n  @Operation(summary = \"Obtener producto por ID (admin)\")\r\n  @GetMapping(\"/products/{id}\")\r\n  public ResponseEntity<ProductAdminResponse> getProduct(@PathVariable Long id) {\r\n    return ResponseEntity.ok(productService.getById(id));\r\n  }\r\n\r\n  @Operation(summary = \"Crear nuevo producto (admin)\")\r\n  @PostMapping(\"/products\")\r\n  public ResponseEntity<ProductAdminResponse> createProduct(\r\n      @Valid @RequestBody ProductAdminRequest request) {\r\n    return ResponseEntity.ok(productService.create(request));\r\n  }\r\n\r\n  @Operation(summary = \"Actualizar producto (admin)\")\r\n  @PutMapping(\"/products/{id}\")\r\n  public ResponseEntity<ProductAdminResponse> updateProduct(\r\n      @PathVariable Long id, @Valid @RequestBody ProductAdminRequest request) {\r\n    return ResponseEntity.ok(productService.update(id, request));\r\n  }\r\n\r\n  @Operation(summary = \"Eliminar producto (admin)\")\r\n  @DeleteMapping(\"/products/{id}\")\r\n  public ResponseEntity<Void> deleteProduct(@PathVariable Long id) {\r\n    productService.delete(id);\r\n    return ResponseEntity.noContent().build();\r\n  }\r\n\r\n  // ---------- Variantes ----------\r\n\r\n  @Operation(summary = \"Listar variantes de un producto (admin)\")\r\n  @GetMapping(\"/products/{productId}/variants\")\r\n  public ResponseEntity<List<ProductVariantAdminResponse>> getVariantsByProduct(\r\n      @PathVariable Long productId) {\r\n    return ResponseEntity.ok(variantService.getByProductId(productId));\r\n  }\r\n\r\n  @Operation(summary = \"Obtener variante por ID (admin)\")\r\n  @GetMapping(\"/variants/{id}\")\r\n  public ResponseEntity<ProductVariantAdminResponse> getVariant(@PathVariable Long id) {\r\n    return ResponseEntity.ok(variantService.getById(id));\r\n  }\r\n\r\n  @Operation(summary = \"Crear nueva variante para un producto (admin)\")\r\n  @PostMapping(\"/products/{productId}/variants\")\r\n  public ResponseEntity<ProductVariantAdminResponse> createVariant(\r\n      @PathVariable Long productId, @Valid @RequestBody ProductVariantAdminRequest request) {\r\n    return ResponseEntity.ok(variantService.create(productId, request));\r\n  }\r\n\r\n  @Operation(summary = \"Actualizar variante (admin, parcial)\")\r\n  @PatchMapping(\"/variants/{id}\")\r\n  public ResponseEntity<ProductVariantAdminResponse> updateVariant(\r\n      @PathVariable Long id, @RequestBody ProductVariantAdminRequest request) {\r\n    // Al ser parcial, no usamos @Valid a nivel global del DTO,\r\n    // las validaciones las manejamos dentro del servicio (ej: stock >= 0)\r\n    return ResponseEntity.ok(variantService.update(id, request));\r\n  }\r\n\r\n  @Operation(summary = \"Eliminar variante (admin)\")\r\n  @DeleteMapping(\"/variants/{id}\")\r\n  public ResponseEntity<Void> deleteVariant(@PathVariable Long id) {\r\n    variantService.delete(id);\r\n    return ResponseEntity.noContent().build();\r\n  }\r\n}\r\n",
      "info": {
        "size": 5938,
        "last_modified": "2026-02-01T22:28:36.4378041",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\controller\\AdminProductImageController.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.controller;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.dto.PresignImageUploadRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.PresignImageUploadResponse;\r\nimport com.cocinadelicia.backend.common.s3.ImagePresignService;\r\nimport jakarta.validation.Valid;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/admin/catalog/products\")\r\n@RequiredArgsConstructor\r\npublic class AdminProductImageController {\r\n\r\n  private final ImagePresignService imagePresignService;\r\n\r\n  @PostMapping(\"/{productId}/images/presign\")\r\n  public ResponseEntity<PresignImageUploadResponse> presignUpload(\r\n      @PathVariable long productId, @Valid @RequestBody PresignImageUploadRequest body) {\r\n\r\n    var res = imagePresignService.presignProductImageUpload(productId, body.contentType());\r\n\r\n    return ResponseEntity.ok(\r\n        new PresignImageUploadResponse(\r\n            res.uploadUrl(), res.objectKey(), res.publicUrl(), 600, res.requiredHeaders()));\r\n  }\r\n}\r\n",
      "info": {
        "size": 1137,
        "last_modified": "2026-02-01T22:28:36.4438071",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\controller\\AdminProductImageManagementController.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.controller;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminPatchRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminResponse;\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductImageService;\r\nimport jakarta.validation.Valid;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequiredArgsConstructor\r\n@RequestMapping(\"/api/admin/catalog\")\r\npublic class AdminProductImageManagementController {\r\n\r\n  private final AdminProductImageService service;\r\n\r\n  @GetMapping(\"/products/{productId}/images\")\r\n  public ResponseEntity<List<ProductImageAdminResponse>> list(@PathVariable long productId) {\r\n    return ResponseEntity.ok(service.listByProduct(productId));\r\n  }\r\n\r\n  @PostMapping(\"/products/{productId}/images\")\r\n  public ResponseEntity<ProductImageAdminResponse> add(\r\n      @PathVariable long productId, @Valid @RequestBody ProductImageAdminRequest body) {\r\n    return ResponseEntity.ok(service.addToProduct(productId, body));\r\n  }\r\n\r\n  @PatchMapping(\"/images/{imageId}\")\r\n  public ResponseEntity<ProductImageAdminResponse> patch(\r\n      @PathVariable long imageId, @RequestBody ProductImageAdminPatchRequest body) {\r\n    return ResponseEntity.ok(service.patch(imageId, body));\r\n  }\r\n\r\n  @DeleteMapping(\"/images/{imageId}\")\r\n  public ResponseEntity<Void> delete(@PathVariable long imageId) {\r\n    service.delete(imageId);\r\n    return ResponseEntity.noContent().build();\r\n  }\r\n}\r\n",
      "info": {
        "size": 1706,
        "last_modified": "2026-02-01T22:28:36.4488073",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\dto\\PresignImageUploadRequest.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.dto;\r\n\r\nimport jakarta.validation.constraints.Max;\r\nimport jakarta.validation.constraints.Min;\r\nimport jakarta.validation.constraints.NotBlank;\r\n\r\npublic record PresignImageUploadRequest(\r\n    @NotBlank String contentType, @Min(1) @Max(819200) long sizeBytes) {}\r\n",
      "info": {
        "size": 312,
        "last_modified": "2026-02-01T22:28:36.4578071",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\dto\\PresignImageUploadResponse.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.dto;\r\n\r\nimport java.util.Map;\r\n\r\npublic record PresignImageUploadResponse(\r\n    String uploadUrl,\r\n    String objectKey,\r\n    String publicUrl,\r\n    int expiresInSeconds,\r\n    Map<String, String> requiredHeaders) {}\r\n",
      "info": {
        "size": 265,
        "last_modified": "2026-02-01T22:28:36.4628071",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\dto\\ProductImageAdminPatchRequest.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.dto;\r\n\r\npublic record ProductImageAdminPatchRequest(Boolean isMain, Integer sortOrder) {}\r\n",
      "info": {
        "size": 139,
        "last_modified": "2026-02-01T22:28:36.468807",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\dto\\ProductImageAdminRequest.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.dto;\r\n\r\nimport jakarta.validation.constraints.NotBlank;\r\n\r\npublic record ProductImageAdminRequest(\r\n    @NotBlank String objectKey, Boolean isMain, Integer sortOrder) {}\r\n",
      "info": {
        "size": 219,
        "last_modified": "2026-02-01T22:28:36.472807",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\dto\\ProductImageAdminResponse.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.dto;\r\n\r\npublic record ProductImageAdminResponse(\r\n    Long id, String objectKey, String url, boolean isMain, int sortOrder) {}\r\n",
      "info": {
        "size": 176,
        "last_modified": "2026-02-01T22:28:36.4778072",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\AdminCategoryService.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service;\r\n\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminResponse;\r\nimport java.util.List;\r\n\r\npublic interface AdminCategoryService {\r\n\r\n  List<CategoryAdminResponse> getAll();\r\n\r\n  CategoryAdminResponse getById(Long id);\r\n\r\n  CategoryAdminResponse create(CategoryAdminRequest request);\r\n\r\n  CategoryAdminResponse update(Long id, CategoryAdminRequest request);\r\n\r\n  void delete(Long id);\r\n}\r\n",
      "info": {
        "size": 521,
        "last_modified": "2026-02-01T22:28:36.4858071",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\AdminProductImageService.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminPatchRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminResponse;\r\nimport java.util.List;\r\n\r\npublic interface AdminProductImageService {\r\n\r\n  List<ProductImageAdminResponse> listByProduct(long productId);\r\n\r\n  ProductImageAdminResponse addToProduct(long productId, ProductImageAdminRequest req);\r\n\r\n  ProductImageAdminResponse patch(long imageId, ProductImageAdminPatchRequest req);\r\n\r\n  void delete(long imageId);\r\n}\r\n",
      "info": {
        "size": 652,
        "last_modified": "2026-02-01T22:28:36.4898072",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\AdminProductService.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service;\r\n\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminResponse;\r\nimport org.springframework.data.domain.Pageable;\r\n\r\npublic interface AdminProductService {\r\n\r\n  PageResponse<ProductAdminResponse> getProducts(\r\n      Long categoryId, Boolean isActive, Pageable pageable);\r\n\r\n  ProductAdminResponse getById(Long id);\r\n\r\n  ProductAdminResponse create(ProductAdminRequest request);\r\n\r\n  ProductAdminResponse update(Long id, ProductAdminRequest request);\r\n\r\n  void delete(Long id);\r\n}\r\n",
      "info": {
        "size": 670,
        "last_modified": "2026-02-01T22:28:36.4948069",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\AdminProductVariantService.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service;\r\n\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminResponse;\r\nimport java.util.List;\r\n\r\npublic interface AdminProductVariantService {\r\n\r\n  List<ProductVariantAdminResponse> getByProductId(Long productId);\r\n\r\n  ProductVariantAdminResponse getById(Long id);\r\n\r\n  ProductVariantAdminResponse create(Long productId, ProductVariantAdminRequest request);\r\n\r\n  ProductVariantAdminResponse update(Long id, ProductVariantAdminRequest request);\r\n\r\n  void delete(Long id);\r\n}\r\n",
      "info": {
        "size": 613,
        "last_modified": "2026-02-01T22:28:36.4988072",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\impl\\AdminCategoryServiceImpl.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service.impl;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminCategoryService;\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminResponse;\r\nimport com.cocinadelicia.backend.product.mapper.CategoryAdminMapper;\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport com.cocinadelicia.backend.product.repository.CategoryRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional\r\npublic class AdminCategoryServiceImpl implements AdminCategoryService {\r\n\r\n  private final CategoryRepository categoryRepository;\r\n  private final ProductRepository productRepository;\r\n  private final CategoryAdminMapper mapper;\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public List<CategoryAdminResponse> getAll() {\r\n    List<Category> list = categoryRepository.findAllByOrderByNameAsc();\r\n    return list.stream().map(mapper::toResponse).toList();\r\n  }\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public CategoryAdminResponse getById(Long id) {\r\n    Category category =\r\n        categoryRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\"CATEGORY_NOT_FOUND\", \"Categora no encontrada: \" + id));\r\n    return mapper.toResponse(category);\r\n  }\r\n\r\n  @Override\r\n  public CategoryAdminResponse create(CategoryAdminRequest request) {\r\n    Category category = mapper.toNewEntity(request);\r\n    Category saved = categoryRepository.save(category);\r\n    log.info(\"AdminCategory.create id={} name={}\", saved.getId(), saved.getName());\r\n    return mapper.toResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public CategoryAdminResponse update(Long id, CategoryAdminRequest request) {\r\n    Category category =\r\n        categoryRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\"CATEGORY_NOT_FOUND\", \"Categora no encontrada: \" + id));\r\n\r\n    mapper.updateEntityFromRequest(request, category);\r\n    Category saved = categoryRepository.save(category);\r\n    log.info(\"AdminCategory.update id={}\", saved.getId());\r\n    return mapper.toResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public void delete(Long id) {\r\n    // Opcional: validar que no haya productos asociados\r\n    boolean hasProducts = productRepository.existsByCategory_Id(id);\r\n    if (hasProducts) {\r\n      throw new BadRequestException(\r\n          \"CATEGORY_IN_USE\", \"No se puede eliminar la categora porque tiene productos asociados\");\r\n    }\r\n    categoryRepository.deleteById(id);\r\n    log.info(\"AdminCategory.delete id={}\", id);\r\n  }\r\n}\r\n",
      "info": {
        "size": 3132,
        "last_modified": "2026-02-01T22:28:36.5038068",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\impl\\AdminProductImageServiceImpl.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service.impl;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminPatchRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminRequest;\r\nimport com.cocinadelicia.backend.catalog.admin.dto.ProductImageAdminResponse;\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductImageService;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.s3.CdnUrlBuilder;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductImage;\r\nimport com.cocinadelicia.backend.product.repository.ProductImageRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional\r\npublic class AdminProductImageServiceImpl implements AdminProductImageService {\r\n\r\n  private final ProductRepository productRepository;\r\n  private final ProductImageRepository productImageRepository;\r\n  private final CdnUrlBuilder cdnUrlBuilder;\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public List<ProductImageAdminResponse> listByProduct(long productId) {\r\n    // valida producto\r\n    productRepository\r\n        .findById(productId)\r\n        .orElseThrow(\r\n            () ->\r\n                new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + productId));\r\n\r\n    return productImageRepository\r\n        .findByProduct_IdOrderBySortOrderAscCreatedAtAsc(productId)\r\n        .stream()\r\n        .map(this::toDto)\r\n        .toList();\r\n  }\r\n\r\n  @Override\r\n  public ProductImageAdminResponse addToProduct(long productId, ProductImageAdminRequest req) {\r\n    Product product =\r\n        productRepository\r\n            .findById(productId)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + productId));\r\n\r\n    // (opcional pero recomendado) asegurar que la key pertenezca al producto\r\n    String expectedPrefix = \"products/\" + productId + \"/\";\r\n    if (req.objectKey() == null || !req.objectKey().startsWith(expectedPrefix)) {\r\n      throw new IllegalArgumentException(\"objectKey invlida. Debe empezar con: \" + expectedPrefix);\r\n    }\r\n\r\n    boolean hasMain = productImageRepository.existsByProduct_IdAndIsMainTrue(productId);\r\n\r\n    boolean requestMain = Boolean.TRUE.equals(req.isMain());\r\n    boolean shouldBeMain =\r\n        requestMain || !hasMain; //  Regla: si no hay principal, la nueva pasa a main\r\n\r\n    int sortOrder =\r\n        req.sortOrder() != null ? Math.max(0, req.sortOrder()) : 0; //  Regla: default 0\r\n\r\n    if (shouldBeMain) {\r\n      //  swap: si viene isMain=true (o auto), apagamos otras\r\n      var current =\r\n          productImageRepository.findByProduct_IdOrderBySortOrderAscCreatedAtAsc(productId);\r\n      for (var img : current) {\r\n        if (img.isMain()) img.setMain(false);\r\n      }\r\n    }\r\n\r\n    ProductImage entity =\r\n        ProductImage.builder()\r\n            .product(product)\r\n            .objectKey(req.objectKey())\r\n            .isMain(shouldBeMain)\r\n            .sortOrder(sortOrder)\r\n            .build();\r\n\r\n    ProductImage saved = productImageRepository.save(entity);\r\n    log.info(\r\n        \"AdminProductImage.add productId={} imageId={} main={}\",\r\n        productId,\r\n        saved.getId(),\r\n        saved.isMain());\r\n\r\n    return toDto(saved);\r\n  }\r\n\r\n  @Override\r\n  public ProductImageAdminResponse patch(long imageId, ProductImageAdminPatchRequest req) {\r\n    ProductImage img =\r\n        productImageRepository\r\n            .findById(imageId)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"IMAGE_NOT_FOUND\", \"Imagen no encontrada: \" + imageId));\r\n\r\n    long productId = img.getProduct().getId();\r\n\r\n    if (req.sortOrder() != null) {\r\n      img.setSortOrder(Math.max(0, req.sortOrder()));\r\n    }\r\n\r\n    if (Boolean.TRUE.equals(req.isMain())) {\r\n      //  swap principal\r\n      var all = productImageRepository.findByProduct_IdOrderBySortOrderAscCreatedAtAsc(productId);\r\n      for (var it : all) {\r\n        it.setMain(it.getId().equals(img.getId()));\r\n      }\r\n    }\r\n\r\n    ProductImage saved = productImageRepository.save(img);\r\n    return toDto(saved);\r\n  }\r\n\r\n  @Override\r\n  public void delete(long imageId) {\r\n    ProductImage img =\r\n        productImageRepository\r\n            .findById(imageId)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"IMAGE_NOT_FOUND\", \"Imagen no encontrada: \" + imageId));\r\n\r\n    long productId = img.getProduct().getId();\r\n    boolean wasMain = img.isMain();\r\n\r\n    productImageRepository.delete(img); // SQLDelete -> soft delete\r\n    log.info(\r\n        \"AdminProductImage.delete imageId={} productId={} wasMain={}\", imageId, productId, wasMain);\r\n\r\n    if (wasMain) {\r\n      //  si borramos la main, elegimos otra como main (si existe)\r\n      var remaining =\r\n          productImageRepository.findByProduct_IdOrderBySortOrderAscCreatedAtAsc(productId);\r\n      if (!remaining.isEmpty()) {\r\n        remaining.get(0).setMain(true);\r\n        for (int i = 1; i < remaining.size(); i++) remaining.get(i).setMain(false);\r\n        productImageRepository.saveAll(remaining);\r\n      }\r\n    }\r\n  }\r\n\r\n  private ProductImageAdminResponse toDto(ProductImage img) {\r\n    return new ProductImageAdminResponse(\r\n        img.getId(),\r\n        img.getObjectKey(),\r\n        cdnUrlBuilder.toPublicUrl(img.getObjectKey()),\r\n        img.isMain(),\r\n        img.getSortOrder());\r\n  }\r\n}\r\n",
      "info": {
        "size": 5818,
        "last_modified": "2026-02-01T22:28:36.507807",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\impl\\AdminProductServiceImpl.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service.impl;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductService;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminResponse;\r\nimport com.cocinadelicia.backend.product.mapper.ProductAdminMapper;\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.repository.CategoryRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional\r\npublic class AdminProductServiceImpl implements AdminProductService {\r\n\r\n  private final ProductRepository productRepository;\r\n  private final CategoryRepository categoryRepository;\r\n  private final ProductAdminMapper mapper;\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public PageResponse<ProductAdminResponse> getProducts(\r\n      Long categoryId, Boolean isActive, Pageable pageable) {\r\n\r\n    Page<Product> page;\r\n\r\n    if (categoryId != null && isActive != null) {\r\n      page = productRepository.findByCategory_IdAndIsActive(categoryId, isActive, pageable);\r\n    } else if (categoryId != null) {\r\n      page = productRepository.findByCategory_Id(categoryId, pageable);\r\n    } else if (isActive != null) {\r\n      page = productRepository.findByIsActive(isActive, pageable);\r\n    } else {\r\n      page = productRepository.findAll(pageable);\r\n    }\r\n\r\n    Page<ProductAdminResponse> mapped = page.map(mapper::toResponse);\r\n    return PageResponse.from(mapped);\r\n  }\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public ProductAdminResponse getById(Long id) {\r\n    Product product =\r\n        productRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + id));\r\n    return mapper.toResponse(product);\r\n  }\r\n\r\n  @Override\r\n  public ProductAdminResponse create(ProductAdminRequest request) {\r\n    Category category =\r\n        categoryRepository\r\n            .findById(request.categoryId())\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"CATEGORY_NOT_FOUND\", \"Categora no encontrada: \" + request.categoryId()));\r\n\r\n    Product product = mapper.toNewEntity(request, category);\r\n    Product saved = productRepository.save(product);\r\n    log.info(\"AdminProduct.create id={} name={}\", saved.getId(), saved.getName());\r\n    return mapper.toResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public ProductAdminResponse update(Long id, ProductAdminRequest request) {\r\n    Product product =\r\n        productRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + id));\r\n\r\n    Category category = null;\r\n    if (request.categoryId() != null) {\r\n      category =\r\n          categoryRepository\r\n              .findById(request.categoryId())\r\n              .orElseThrow(\r\n                  () ->\r\n                      new NotFoundException(\r\n                          \"CATEGORY_NOT_FOUND\",\r\n                          \"Categora no encontrada: \" + request.categoryId()));\r\n    }\r\n\r\n    mapper.updateEntityFromRequest(request, product, category);\r\n    Product saved = productRepository.save(product);\r\n    log.info(\"AdminProduct.update id={}\", saved.getId());\r\n    return mapper.toResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public void delete(Long id) {\r\n    productRepository.deleteById(id);\r\n    log.info(\"AdminProduct.delete id={}\", id);\r\n  }\r\n}\r\n",
      "info": {
        "size": 4104,
        "last_modified": "2026-02-01T22:28:36.5128069",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\admin\\service\\impl\\AdminProductVariantServiceImpl.java",
      "content": "package com.cocinadelicia.backend.catalog.admin.service.impl;\r\n\r\nimport com.cocinadelicia.backend.catalog.admin.service.AdminProductVariantService;\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminResponse;\r\nimport com.cocinadelicia.backend.product.mapper.ProductVariantMapper;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductVariantRepository;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional\r\npublic class AdminProductVariantServiceImpl implements AdminProductVariantService {\r\n\r\n  private final ProductVariantRepository variantRepository;\r\n  private final ProductRepository productRepository;\r\n  private final ProductVariantMapper mapper;\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public List<ProductVariantAdminResponse> getByProductId(Long productId) {\r\n    Product product =\r\n        productRepository\r\n            .findById(productId)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + productId));\r\n\r\n    List<ProductVariant> list = product.getVariants();\r\n    return list.stream().map(mapper::toAdminResponse).toList();\r\n  }\r\n\r\n  @Override\r\n  @Transactional(readOnly = true)\r\n  public ProductVariantAdminResponse getById(Long id) {\r\n    ProductVariant variant =\r\n        variantRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"VARIANT_NOT_FOUND\", \"Variante no encontrada: \" + id));\r\n    return mapper.toAdminResponse(variant);\r\n  }\r\n\r\n  @Override\r\n  public ProductVariantAdminResponse create(Long productId, ProductVariantAdminRequest request) {\r\n    Product product =\r\n        productRepository\r\n            .findById(productId)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"PRODUCT_NOT_FOUND\", \"Producto no encontrado: \" + productId));\r\n\r\n    //  Validacin de stock\r\n    if (request.stockQuantity() != null && request.stockQuantity() < 0) {\r\n      throw new BadRequestException(\"INVALID_STOCK_QUANTITY\", \"El stock no puede ser negativo.\");\r\n    }\r\n\r\n    ProductVariant variant = mapper.toNewEntity(request);\r\n    variant.setProduct(product);\r\n\r\n    ProductVariant saved = variantRepository.save(variant);\r\n    log.info(\"AdminVariant.create id={} productId={}\", saved.getId(), productId);\r\n    return mapper.toAdminResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public ProductVariantAdminResponse update(Long id, ProductVariantAdminRequest request) {\r\n    ProductVariant variant =\r\n        variantRepository\r\n            .findById(id)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"VARIANT_NOT_FOUND\", \"Variante no encontrada: \" + id));\r\n\r\n    //  Validacin de stock\r\n    if (request.stockQuantity() != null && request.stockQuantity() < 0) {\r\n      throw new BadRequestException(\"INVALID_STOCK_QUANTITY\", \"El stock no puede ser negativo.\");\r\n    }\r\n\r\n    mapper.updateEntityFromRequest(request, variant);\r\n    ProductVariant saved = variantRepository.save(variant);\r\n    log.info(\"AdminVariant.update id={}\", saved.getId());\r\n    return mapper.toAdminResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public void delete(Long id) {\r\n    variantRepository.deleteById(id);\r\n    log.info(\"AdminVariant.delete id={}\", id);\r\n  }\r\n}\r\n",
      "info": {
        "size": 3986,
        "last_modified": "2026-02-01T22:28:36.516807",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\controller\\CatalogController.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/controller/CatalogController.java\r\npackage com.cocinadelicia.backend.catalog.controller;\r\n\r\nimport com.cocinadelicia.backend.catalog.dto.CatalogFilter;\r\nimport com.cocinadelicia.backend.catalog.dto.CategorySummaryResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.ProductDetailResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.ProductSummaryResponse;\r\nimport com.cocinadelicia.backend.catalog.service.CatalogService;\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.Parameter;\r\nimport io.swagger.v3.oas.annotations.media.Content;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport io.swagger.v3.oas.annotations.responses.ApiResponse;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springdoc.core.annotations.ParameterObject;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.web.PageableDefault;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/catalog\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"catalog\", description = \"Catlogo pblico de productos\")\r\npublic class CatalogController {\r\n\r\n  private final CatalogService catalogService;\r\n\r\n  @Operation(\r\n      summary = \"Listar categoras activas del catlogo\",\r\n      description =\r\n          \"\"\"\r\n                  Devuelve la lista de categoras activas del catlogo, ordenadas por nombre.\r\n                  Endpoint pblico: no requiere autenticacin.\r\n                  \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Lista de categoras activas\",\r\n            content =\r\n                @Content(\r\n                    mediaType = \"application/json\",\r\n                    schema = @Schema(implementation = CategorySummaryResponse.class)))\r\n      })\r\n  @GetMapping(\"/categories\")\r\n  public ResponseEntity<List<CategorySummaryResponse>> getCategories() {\r\n    return ResponseEntity.ok(catalogService.getCategories());\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Listar productos del catlogo\",\r\n      description =\r\n          \"\"\"\r\n      Lista paginada de productos activos del catlogo.\r\n\r\n      Filtros soportados:\r\n      - q (opcional): bsqueda de texto en nombre, descripcin y tags.\r\n      - categorySlug (opcional): filtra por categora.\r\n      - tags (opcional): lista de slugs de tags (AND). Ej: vegetariano,sin-azucar\r\n      - availableOnly (opcional): si es true, solo productos con variantes disponibles.\r\n      - featured (opcional): si es true, solo productos con variantes destacadas.\r\n      - dailyMenu (opcional): si es true, solo productos marcados como men del da.\r\n      - new (opcional): si es true, solo productos nuevos.\r\n      - page / size: paginacin estndar (0-based).\r\n      \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pgina de productos del catlogo\",\r\n            content =\r\n                @Content(\r\n                    mediaType = \"application/json\",\r\n                    schema = @Schema(implementation = PageResponse.class)))\r\n      })\r\n  @GetMapping(\"/products\")\r\n  public ResponseEntity<PageResponse<ProductSummaryResponse>> getProducts(\r\n      @Parameter(\r\n              description = \"Texto de bsqueda (busca en nombre, descripcin y tags)\",\r\n              example = \"milanesa\")\r\n          @RequestParam(name = \"q\", required = false)\r\n          String searchQuery,\r\n      @Parameter(description = \"Slug de la categora a filtrar (opcional)\", example = \"empanadas\")\r\n          @RequestParam(name = \"categorySlug\", required = false)\r\n          String categorySlug,\r\n      @Parameter(\r\n              description = \"Lista de slugs de tags para filtrar (AND). Separados por coma\",\r\n              example = \"vegetariano,sin-gluten\")\r\n          @RequestParam(name = \"tags\", required = false)\r\n          java.util.List<String> tagSlugs,\r\n      @Parameter(\r\n              description = \"Si es true, solo productos con variantes disponibles\",\r\n              example = \"true\")\r\n          @RequestParam(name = \"availableOnly\", required = false)\r\n          Boolean availableOnly,\r\n      @Parameter(\r\n              description = \"Si es true, solo productos con variantes destacadas\",\r\n              example = \"true\")\r\n          @RequestParam(name = \"featured\", required = false)\r\n          Boolean featured,\r\n      @Parameter(\r\n              description = \"Si es true, solo productos marcados como men del da\",\r\n              example = \"true\")\r\n          @RequestParam(name = \"dailyMenu\", required = false)\r\n          Boolean dailyMenu,\r\n      @Parameter(name = \"new\", description = \"Si es true, solo productos nuevos\", example = \"true\")\r\n          @RequestParam(name = \"new\", required = false)\r\n          Boolean isNew,\r\n      @ParameterObject @PageableDefault(size = 12) Pageable pageable) {\r\n\r\n    var filter =\r\n        new CatalogFilter(\r\n            searchQuery,\r\n            categorySlug,\r\n            pageable.getPageNumber(),\r\n            pageable.getPageSize(),\r\n            pageable.getSort(),\r\n            featured,\r\n            dailyMenu,\r\n            isNew,\r\n            availableOnly,\r\n            tagSlugs);\r\n\r\n    return ResponseEntity.ok(catalogService.getProducts(filter));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Detalle de producto por slug\",\r\n      description =\r\n          \"\"\"\r\n       Devuelve el detalle completo de un producto activo identificado por su slug.\r\n       Endpoint pblico: no requiere autenticacin.\r\n       \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Detalle de producto\",\r\n            content =\r\n                @Content(\r\n                    mediaType = \"application/json\",\r\n                    schema = @Schema(implementation = ProductDetailResponse.class))),\r\n        @ApiResponse(responseCode = \"404\", description = \"Producto no encontrado\")\r\n      })\r\n  @GetMapping(\"/products/{slug}\")\r\n  public ResponseEntity<ProductDetailResponse> getProductBySlug(\r\n      @Parameter(description = \"Slug del producto\", example = \"milanesa-clasica\")\r\n          @PathVariable(\"slug\")\r\n          String slug) {\r\n    return ResponseEntity.ok(catalogService.getProductBySlug(slug));\r\n  }\r\n}\r\n",
      "info": {
        "size": 6496,
        "last_modified": "2026-02-01T22:28:36.531809",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\CatalogFilter.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/dto/CatalogFilter.java\r\npackage com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.util.List;\r\nimport org.springframework.data.domain.Sort;\r\n\r\n@Schema(description = \"Filtros para bsqueda de productos del catlogo pblico\")\r\npublic record CatalogFilter(\r\n    @Schema(\r\n            description = \"Texto de bsqueda (busca en nombre, descripcin y tags)\",\r\n            example = \"milanesa\")\r\n        String searchQuery,\r\n    @Schema(description = \"Slug de la categora a filtrar (opcional)\", example = \"empanadas\")\r\n        String categorySlug,\r\n    @Schema(description = \"Nmero de pgina (0-based)\", example = \"0\") int page,\r\n    @Schema(description = \"Tamao de pgina\", example = \"12\") int size,\r\n    Sort sort,\r\n    @Schema(\r\n            description = \"Filtrar solo productos con al menos una variante destacada\",\r\n            example = \"true\")\r\n        Boolean featured,\r\n    @Schema(\r\n            description =\r\n                \"Filtrar solo productos cuyo men del da est activo (al menos una variante)\",\r\n            example = \"true\")\r\n        Boolean dailyMenu,\r\n    @Schema(\r\n            description =\r\n                \"Filtrar solo productos \\\"nuevos\\\" (al menos una variante marcada como nueva)\",\r\n            example = \"true\")\r\n        Boolean isNew,\r\n    @Schema(\r\n            description = \"Si true, solo productos activos con variantes disponibles\",\r\n            example = \"true\")\r\n        Boolean availableOnly,\r\n    @Schema(\r\n            description =\r\n                \"Lista de slugs de tags para filtrar (AND). Ej: [\\\"vegetariano\\\", \\\"sin-azucar\\\"]\",\r\n            example = \"[\\\"vegetariano\\\", \\\"sin-gluten\\\"]\")\r\n        List<String> tagSlugs) {}\r\n",
      "info": {
        "size": 1787,
        "last_modified": "2026-02-01T22:28:36.5398739",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\CatalogImageResponse.java",
      "content": "package com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Imagen de producto para el catlogo pblico\")\r\npublic record CatalogImageResponse(\r\n    @Schema(description = \"Id de la imagen\", example = \"1\") Long id,\r\n    @Schema(\r\n            description = \"URL pblica de la imagen\",\r\n            example = \"https://cdn.lacocinadelicia.com/products/empanada-1.jpg\")\r\n        String url,\r\n    @Schema(description = \"Indica si es la imagen principal\", example = \"true\") boolean isMain,\r\n    @Schema(description = \"Orden de visualizacin\", example = \"0\") int sortOrder,\r\n    @Schema(description = \"Texto alternativo sugerido\", example = \"Milanesa clsica\") String alt) {}\r\n",
      "info": {
        "size": 740,
        "last_modified": "2026-02-01T22:28:36.5448738",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\CatalogVariantResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/dto/CatalogVariantResponse.java\r\npackage com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Variante de producto para el catlogo pblico\")\r\npublic record CatalogVariantResponse(\r\n    @Schema(description = \"Id de la variante\", example = \"101\") Long id,\r\n    @Schema(description = \"Nombre de la variante\", example = \"Docena\") String name,\r\n    @Schema(description = \"Precio vigente de la variante\") MoneyResponse price,\r\n    @Schema(description = \"Indica si la variante maneja stock real\", example = \"true\")\r\n        boolean managesStock,\r\n    @Schema(description = \"Cantidad disponible si maneja stock\", example = \"12\") int stockQuantity,\r\n    @Schema(\r\n            description = \"Etiqueta de disponibilidad para mostrar en la UI\",\r\n            example = \"Disponible\")\r\n        String availabilityLabel) {}\r\n",
      "info": {
        "size": 929,
        "last_modified": "2026-02-01T22:28:36.5498731",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\CategorySummaryResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/dto/CategorySummaryResponse.java\r\npackage com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Resumen de categora para el catlogo pblico\")\r\npublic record CategorySummaryResponse(\r\n    @Schema(description = \"Id de la categora\", example = \"1\") Long id,\r\n    @Schema(description = \"Nombre visible de la categora\", example = \"Platos del da\") String name,\r\n    @Schema(\r\n            description = \"Slug nico de la categora, usado para filtros y URLs amigables\",\r\n            example = \"platos-del-dia\")\r\n        String slug,\r\n    @Schema(\r\n            description = \"Descripcin breve de la categora (opcional)\",\r\n            example = \"Opciones caseras que cambian da a da.\")\r\n        String description) {}\r\n",
      "info": {
        "size": 846,
        "last_modified": "2026-02-01T22:28:36.5548733",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\MoneyResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/dto/MoneyResponse.java\r\npackage com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\n\r\n@Schema(description = \"Representacin de un monto de dinero\")\r\npublic record MoneyResponse(\r\n    @Schema(description = \"Monto numrico\", example = \"120.00\") BigDecimal amount,\r\n    @Schema(description = \"Cdigo de moneda ISO 4217\", example = \"UYU\") String currency) {}\r\n",
      "info": {
        "size": 482,
        "last_modified": "2026-02-01T22:28:36.5598733",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\ProductDetailResponse.java",
      "content": "package com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Detalle completo de un producto para el catlogo pblico\")\r\npublic record ProductDetailResponse(\r\n    @Schema(description = \"Id del producto\", example = \"10\") Long id,\r\n    @Schema(description = \"Slug nico del producto\", example = \"milanesa-clasica\") String slug,\r\n    @Schema(description = \"Nombre del producto\", example = \"Milanesa clsica\") String name,\r\n    @Schema(description = \"Descripcin larga del producto\") String description,\r\n    @Schema(description = \"Descripcin corta\", example = \"Crujiente y deliciosa\")\r\n        String shortDescription,\r\n    @Schema(description = \"Id de la categora\", example = \"1\") Long categoryId,\r\n    @Schema(description = \"Nombre de la categora\", example = \"Platos\") String categoryName,\r\n    @Schema(description = \"Slug de la categora\", example = \"platos\") String categorySlug,\r\n    @Schema(description = \"URL de la imagen principal\") String mainImageUrl,\r\n    @Schema(description = \"Galera de imgenes\") List<CatalogImageResponse> images,\r\n    @Schema(description = \"Precio mnimo entre las variantes visibles\") MoneyResponse fromPrice,\r\n    @Schema(description = \"Variantes disponibles del producto\")\r\n        List<CatalogVariantResponse> variants,\r\n    @Schema(description = \"Slugs de tags asociados\") List<String> tags,\r\n    @Schema(description = \"Indicador de producto destacado\", example = \"true\") boolean featured,\r\n    @Schema(description = \"Indicador de men del da\", example = \"false\") boolean dailyMenu,\r\n    @Schema(description = \"Indicador de producto nuevo\", example = \"false\") boolean isNew,\r\n    @Schema(description = \"Indicador de disponibilidad general\", example = \"true\")\r\n        boolean available,\r\n    @Schema(description = \"Indica si alguna variante maneja stock\", example = \"true\")\r\n        boolean managesStock,\r\n    @Schema(description = \"Indica si el producto es principalmente a pedido\", example = \"true\")\r\n        boolean madeToOrder) {}\r\n",
      "info": {
        "size": 2080,
        "last_modified": "2026-02-01T22:28:36.5648732",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\dto\\ProductSummaryResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/dto/ProductSummaryResponse.java\r\npackage com.cocinadelicia.backend.catalog.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Resumen de producto para el catlogo pblico\")\r\npublic record ProductSummaryResponse(\r\n    @Schema(description = \"Id del producto\", example = \"42\") Long id,\r\n    @Schema(description = \"Nombre del producto\", example = \"Empanadas de carne caseras\")\r\n        String name,\r\n    @Schema(\r\n            description = \"Slug nico del producto, usado para URLs amigables\",\r\n            example = \"empanadas-carne-caseras\")\r\n        String slug,\r\n    @Schema(\r\n            description = \"Descripcin corta pensada para la card del catlogo\",\r\n            example = \"Masa casera, relleno de carne cortada a cuchillo.\")\r\n        String shortDescription,\r\n\r\n    // Categora\r\n    @Schema(description = \"Id de la categora del producto\", example = \"1\") Long categoryId,\r\n    @Schema(description = \"Nombre de la categora\", example = \"Empanadas\") String categoryName,\r\n    @Schema(\r\n            description = \"Slug de la categora (para filtros por categora)\",\r\n            example = \"empanadas\")\r\n        String categorySlug,\r\n\r\n    // Imagen principal\r\n    @Schema(\r\n            description =\r\n                \"URL principal de la imagen del producto (puede ser null si no hay imagen)\",\r\n            example = \"https://cdn.lacocinadelicia.com/products/empanadas-carne-main.jpg\")\r\n        String mainImageUrl,\r\n\r\n    // imagenes\r\n    @Schema(\r\n            description = \"Lista de URLs de imgenes del producto\",\r\n            example =\r\n                \"[\\\"https://cdn.lacocinadelicia.com/products/empanadas-carne-1.jpg\\\", \\\"https://cdn.lacocinadelicia.com/products/empanadas-carne-2.jpg\\\"]\")\r\n        List<String> imageUrls,\r\n\r\n    // Precio \"desde\"\r\n    @Schema(\r\n            description = \"Precio mnimo entre las variantes visibles del producto\",\r\n            example = \"{ \\\"amount\\\": 120.00, \\\"currency\\\": \\\"UYU\\\" }\")\r\n        MoneyResponse fromPrice,\r\n\r\n    // Disponibilidad a alto nivel\r\n    @Schema(\r\n            description =\r\n                \"Indicador de disponibilidad a alto nivel (true: al menos una variante disponible)\",\r\n            example = \"true\")\r\n        boolean available,\r\n    @Schema(\r\n            description =\r\n                \"Indica si el producto es principalmente a pedido (no depende de stock fsico)\",\r\n            example = \"true\")\r\n        boolean madeToOrder,\r\n    @Schema(\r\n            description = \"Indica si alguna variante maneja stock real (true) o no (false)\",\r\n            example = \"false\")\r\n        boolean managesStock,\r\n\r\n    // Flags de marketing\r\n    @Schema(description = \"Indica si el producto est destacado en el catlogo\", example = \"true\")\r\n        boolean featured,\r\n    @Schema(description = \"Indica si el producto forma parte del men del da\", example = \"false\")\r\n        boolean dailyMenu,\r\n    @Schema(description = \"Indica si el producto es \\\"nuevo\\\" en el catlogo\", example = \"true\")\r\n        boolean isNew,\r\n\r\n    // Variantes\r\n    @Schema(description = \"Lista de variantes disponibles para el producto en el catlogo\")\r\n        List<CatalogVariantResponse> variants,\r\n\r\n    // Tags\r\n    @Schema(\r\n            description = \"Lista de slugs de tags asociados al producto\",\r\n            example = \"[\\\"sin-tacc\\\", \\\"picante\\\"]\")\r\n        List<String> tags) {}\r\n",
      "info": {
        "size": 3465,
        "last_modified": "2026-02-01T22:28:36.5698746",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\mapper\\ProductCatalogMapper.java",
      "content": "package com.cocinadelicia.backend.catalog.mapper;\r\n\r\nimport com.cocinadelicia.backend.catalog.dto.*;\r\nimport com.cocinadelicia.backend.common.s3.CdnUrlBuilder;\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductImage;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport com.cocinadelicia.backend.product.model.Tag;\r\nimport com.cocinadelicia.backend.product.service.PriceService;\r\nimport com.cocinadelicia.backend.product.service.dto.PriceInfo;\r\nimport java.util.Comparator;\r\nimport java.util.List;\r\nimport java.util.Objects;\r\nimport java.util.Optional;\r\nimport java.util.Set;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\n@RequiredArgsConstructor\r\n@Log4j2\r\npublic class ProductCatalogMapper {\r\n\r\n  private final CdnUrlBuilder cdnUrlBuilder;\r\n  private final PriceService priceService;\r\n\r\n  public CategorySummaryResponse toCategorySummary(Category category) {\r\n    return new CategorySummaryResponse(\r\n        category.getId(), category.getName(), category.getSlug(), category.getDescription());\r\n  }\r\n\r\n  public ProductSummaryResponse toProductSummary(Product product) {\r\n    var category = product.getCategory();\r\n    String mainImageUrl = resolveMainImageUrl(product);\r\n    List<CatalogImageResponse> images = toImages(product);\r\n    List<String> imageUrls = images.stream().map(CatalogImageResponse::url).toList();\r\n\r\n    List<ProductVariant> activeVariants =\r\n        product.getVariants() == null\r\n            ? List.of()\r\n            : product.getVariants().stream().filter(ProductVariant::isActive).toList();\r\n\r\n    List<CatalogVariantResponse> variants =\r\n        activeVariants.stream().map(this::toCatalogVariant).flatMap(Optional::stream).toList();\r\n\r\n    MoneyResponse fromPrice = computeFromPrice(variants);\r\n\r\n    boolean hasAvailableVariant =\r\n        variants.stream().anyMatch(v -> !\"Sin stock\".equalsIgnoreCase(v.availabilityLabel()));\r\n    boolean managesStock = variants.stream().anyMatch(CatalogVariantResponse::managesStock);\r\n    boolean madeToOrder =\r\n        !variants.isEmpty() ? variants.stream().allMatch(v -> !v.managesStock()) : true;\r\n    boolean available = product.isActive() && (variants.isEmpty() || hasAvailableVariant);\r\n\r\n    boolean featured = activeVariants.stream().anyMatch(ProductVariant::isFeatured);\r\n    boolean dailyMenu = activeVariants.stream().anyMatch(ProductVariant::isDailyMenu);\r\n    boolean isNew = activeVariants.stream().anyMatch(ProductVariant::isNew);\r\n\r\n    List<String> tagSlugs = mapTags(product.getTags());\r\n\r\n    return new ProductSummaryResponse(\r\n        product.getId(),\r\n        product.getName(),\r\n        product.getSlug(),\r\n        buildShortDescription(product.getDescription()),\r\n        category != null ? category.getId() : null,\r\n        category != null ? category.getName() : null,\r\n        category != null ? category.getSlug() : null,\r\n        mainImageUrl,\r\n        imageUrls,\r\n        fromPrice,\r\n        available,\r\n        madeToOrder,\r\n        managesStock,\r\n        featured,\r\n        dailyMenu,\r\n        isNew,\r\n        variants,\r\n        tagSlugs);\r\n  }\r\n\r\n  public ProductDetailResponse toProductDetail(Product product) {\r\n    var category = product.getCategory();\r\n    List<ProductVariant> activeVariants =\r\n        product.getVariants() == null\r\n            ? List.of()\r\n            : product.getVariants().stream().filter(ProductVariant::isActive).toList();\r\n\r\n    List<CatalogVariantResponse> variants =\r\n        activeVariants.stream().map(this::toCatalogVariant).flatMap(Optional::stream).toList();\r\n\r\n    MoneyResponse fromPrice = computeFromPrice(variants);\r\n    boolean hasAvailableVariant =\r\n        variants.stream().anyMatch(v -> !\"Sin stock\".equalsIgnoreCase(v.availabilityLabel()));\r\n    boolean managesStock = variants.stream().anyMatch(CatalogVariantResponse::managesStock);\r\n    boolean madeToOrder =\r\n        !variants.isEmpty() ? variants.stream().allMatch(v -> !v.managesStock()) : true;\r\n    boolean available = product.isActive() && (variants.isEmpty() || hasAvailableVariant);\r\n\r\n    boolean featured = activeVariants.stream().anyMatch(ProductVariant::isFeatured);\r\n    boolean dailyMenu = activeVariants.stream().anyMatch(ProductVariant::isDailyMenu);\r\n    boolean isNew = activeVariants.stream().anyMatch(ProductVariant::isNew);\r\n\r\n    return new ProductDetailResponse(\r\n        product.getId(),\r\n        product.getSlug(),\r\n        product.getName(),\r\n        product.getDescription(),\r\n        buildShortDescription(product.getDescription()),\r\n        category != null ? category.getId() : null,\r\n        category != null ? category.getName() : null,\r\n        category != null ? category.getSlug() : null,\r\n        resolveMainImageUrl(product),\r\n        toImages(product),\r\n        fromPrice,\r\n        variants,\r\n        mapTags(product.getTags()),\r\n        featured,\r\n        dailyMenu,\r\n        isNew,\r\n        available,\r\n        managesStock,\r\n        madeToOrder);\r\n  }\r\n\r\n  private MoneyResponse computeFromPrice(List<CatalogVariantResponse> variants) {\r\n    return variants.stream()\r\n        .map(CatalogVariantResponse::price)\r\n        .filter(Objects::nonNull)\r\n        .min(Comparator.comparing(MoneyResponse::amount))\r\n        .orElse(null);\r\n  }\r\n\r\n  private List<CatalogImageResponse> toImages(Product product) {\r\n    List<ProductImage> images = product.getImages() == null ? List.of() : product.getImages();\r\n    if (images.isEmpty()) return List.of();\r\n\r\n    Comparator<ProductImage> order =\r\n        Comparator.comparing(ProductImage::isMain)\r\n            .reversed()\r\n            .thenComparingInt(ProductImage::getSortOrder)\r\n            .thenComparing(\r\n                ProductImage::getCreatedAt, Comparator.nullsLast(Comparator.naturalOrder()))\r\n            .thenComparing(ProductImage::getId, Comparator.nullsLast(Comparator.naturalOrder()));\r\n\r\n    return images.stream()\r\n        .filter(img -> img.getObjectKey() != null && !img.getObjectKey().isBlank())\r\n        .sorted(order)\r\n        .map(\r\n            img ->\r\n                new CatalogImageResponse(\r\n                    img.getId(),\r\n                    toPublicUrl(img.getObjectKey()),\r\n                    img.isMain(),\r\n                    img.getSortOrder(),\r\n                    product.getName()))\r\n        .filter(img -> img.url() != null && !img.url().isBlank())\r\n        .toList();\r\n  }\r\n\r\n  private String resolveMainImageUrl(Product product) {\r\n    List<ProductImage> images = product.getImages() == null ? List.of() : product.getImages();\r\n    if (images.isEmpty()) return null;\r\n\r\n    Comparator<ProductImage> order =\r\n        Comparator.comparing(ProductImage::isMain)\r\n            .reversed()\r\n            .thenComparingInt(ProductImage::getSortOrder)\r\n            .thenComparing(\r\n                ProductImage::getCreatedAt, Comparator.nullsLast(Comparator.naturalOrder()))\r\n            .thenComparing(ProductImage::getId, Comparator.nullsLast(Comparator.naturalOrder()));\r\n\r\n    return images.stream()\r\n        .filter(img -> img.getObjectKey() != null && !img.getObjectKey().isBlank())\r\n        .sorted(order)\r\n        .map(ProductImage::getObjectKey)\r\n        .map(this::toPublicUrl)\r\n        .filter(url -> url != null && !url.isBlank())\r\n        .findFirst()\r\n        .orElse(null);\r\n  }\r\n\r\n  private Optional<CatalogVariantResponse> toCatalogVariant(ProductVariant variant) {\r\n    Optional<PriceInfo> priceOpt = priceService.getCurrentPriceForVariant(variant.getId());\r\n    if (priceOpt.isEmpty()) return Optional.empty();\r\n\r\n    PriceInfo priceInfo = priceOpt.get();\r\n    MoneyResponse price = new MoneyResponse(priceInfo.amount(), priceInfo.currency().name());\r\n    String availabilityLabel = computeAvailabilityLabel(variant);\r\n\r\n    return Optional.of(\r\n        new CatalogVariantResponse(\r\n            variant.getId(),\r\n            variant.getName(),\r\n            price,\r\n            variant.isManagesStock(),\r\n            variant.getStockQuantity(),\r\n            availabilityLabel));\r\n  }\r\n\r\n  private String computeAvailabilityLabel(ProductVariant variant) {\r\n    if (!variant.isActive()) return \"Sin stock\";\r\n    if (!variant.isManagesStock()) return \"Disponible\";\r\n    return variant.getStockQuantity() > 0 ? \"Disponible\" : \"Sin stock\";\r\n  }\r\n\r\n  private String buildShortDescription(String fullDescription) {\r\n    if (fullDescription == null || fullDescription.isBlank()) return null;\r\n    String trimmed = fullDescription.trim();\r\n    int maxLen = 140;\r\n    if (trimmed.length() <= maxLen) return trimmed;\r\n    return trimmed.substring(0, maxLen).trim() + \"\";\r\n  }\r\n\r\n  private List<String> mapTags(Set<Tag> tags) {\r\n    return tags == null ? List.of() : tags.stream().map(Tag::getSlug).sorted().toList();\r\n  }\r\n\r\n  private String toPublicUrl(String objectKey) {\r\n    if (objectKey == null || objectKey.isBlank()) return null;\r\n    // si ya es absoluta, devolvemos tal cual\r\n    if (objectKey.startsWith(\"http://\") || objectKey.startsWith(\"https://\")) {\r\n      return objectKey;\r\n    }\r\n    String url = cdnUrlBuilder.toPublicUrl(objectKey);\r\n    if (url == null || url.isBlank()) {\r\n      log.debug(\"cdnUrlBuilder returned blank for key={}\", objectKey);\r\n    }\r\n    return url;\r\n  }\r\n}\r\n",
      "info": {
        "size": 9358,
        "last_modified": "2026-02-01T22:28:36.5788726",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\service\\CatalogService.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/service/CatalogService.java\r\npackage com.cocinadelicia.backend.catalog.service;\r\n\r\nimport com.cocinadelicia.backend.catalog.dto.CatalogFilter;\r\nimport com.cocinadelicia.backend.catalog.dto.CategorySummaryResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.ProductDetailResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.ProductSummaryResponse;\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport java.util.List;\r\n\r\npublic interface CatalogService {\r\n\r\n  /** Devuelve las categoras activas/vigentes para el catlogo pblico. */\r\n  List<CategorySummaryResponse> getCategories();\r\n\r\n  /** Devuelve una pgina de productos activos, filtrados opcionalmente por categora. */\r\n  PageResponse<ProductSummaryResponse> getProducts(CatalogFilter filter);\r\n\r\n  /** Obtiene el detalle pblico de un producto por slug. */\r\n  ProductDetailResponse getProductBySlug(String slug);\r\n}\r\n",
      "info": {
        "size": 951,
        "last_modified": "2026-02-01T22:28:36.5868725",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\catalog\\service\\impl\\CatalogServiceImpl.java",
      "content": "// src/main/java/com/cocinadelicia/backend/catalog/service/impl/CatalogServiceImpl.java\r\npackage com.cocinadelicia.backend.catalog.service.impl;\r\n\r\nimport com.cocinadelicia.backend.catalog.dto.*;\r\nimport com.cocinadelicia.backend.catalog.mapper.ProductCatalogMapper;\r\nimport com.cocinadelicia.backend.catalog.service.CatalogService;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.web.PageResponse;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.repository.CategoryRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport com.cocinadelicia.backend.product.repository.spec.ProductSpecifications;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.data.domain.*;\r\nimport org.springframework.data.jpa.domain.Specification;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional(readOnly = true)\r\npublic class CatalogServiceImpl implements CatalogService {\r\n\r\n  private final CategoryRepository categoryRepository;\r\n  private final ProductRepository productRepository;\r\n  private final ProductCatalogMapper productCatalogMapper;\r\n\r\n  @Override\r\n  public List<CategorySummaryResponse> getCategories() {\r\n    var categories = categoryRepository.findAllByOrderByNameAsc();\r\n    log.info(\"Catalog.getCategories count={}\", categories.size());\r\n    return categories.stream().map(productCatalogMapper::toCategorySummary).toList();\r\n  }\r\n\r\n  @Override\r\n  public PageResponse<ProductSummaryResponse> getProducts(CatalogFilter filter) {\r\n    Sort sort =\r\n        filter.sort() != null && filter.sort().isSorted()\r\n            ? filter.sort()\r\n            : Sort.by(Sort.Direction.ASC, \"name\");\r\n\r\n    Pageable pageable = PageRequest.of(filter.page(), filter.size(), sort);\r\n\r\n    Specification<Product> spec = buildSpecification(filter);\r\n\r\n    log.info(\r\n        \"Catalog.getProducts RECIBIDO  searchQuery={} categorySlug={} tagSlugs={} availableOnly={} featured={} dailyMenu={} isNew={} page={} size={}\",\r\n        filter.searchQuery(),\r\n        filter.categorySlug(),\r\n        filter.tagSlugs(),\r\n        filter.availableOnly(),\r\n        filter.featured(),\r\n        filter.dailyMenu(),\r\n        filter.isNew(),\r\n        filter.page(),\r\n        filter.size());\r\n\r\n    Page<Product> page = productRepository.findAll(spec, pageable);\r\n\r\n    log.debug(\r\n        \"Catalog.getProducts RESULTADO  totalElements={} totalPages={} currentPage={} hasContent={}\",\r\n        page.getTotalElements(),\r\n        page.getTotalPages(),\r\n        page.getNumber(),\r\n        page.hasContent());\r\n\r\n    Page<ProductSummaryResponse> mapped = page.map(productCatalogMapper::toProductSummary);\r\n    return PageResponse.from(mapped);\r\n  }\r\n\r\n  @Override\r\n  public ProductDetailResponse getProductBySlug(String slug) {\r\n    log.info(\"Catalog.getProductBySlug slug={}\", slug);\r\n    Product product =\r\n        productRepository\r\n            .findBySlugIgnoreCaseAndIsActiveTrue(slug)\r\n            .orElseThrow(\r\n                () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado.\"));\r\n    return productCatalogMapper.toProductDetail(product);\r\n  }\r\n\r\n  private Specification<Product> buildSpecification(CatalogFilter filter) {\r\n    Specification<Product> spec = ProductSpecifications.isActive();\r\n\r\n    if (filter.searchQuery() != null && !filter.searchQuery().isBlank()) {\r\n      spec = spec.and(ProductSpecifications.searchText(filter.searchQuery()));\r\n      log.debug(\"Aplicado filtro: searchText='{}'\", filter.searchQuery());\r\n    }\r\n\r\n    if (filter.categorySlug() != null && !filter.categorySlug().isBlank()) {\r\n      spec = spec.and(ProductSpecifications.hasCategory(filter.categorySlug()));\r\n      log.debug(\"Aplicado filtro: categorySlug='{}'\", filter.categorySlug());\r\n    }\r\n\r\n    if (filter.tagSlugs() != null && !filter.tagSlugs().isEmpty()) {\r\n      spec = spec.and(ProductSpecifications.hasTags(filter.tagSlugs()));\r\n      log.debug(\"Aplicado filtro: tagSlugs={}\", filter.tagSlugs());\r\n    }\r\n\r\n    if (Boolean.TRUE.equals(filter.availableOnly())) {\r\n      spec = spec.and(ProductSpecifications.hasAvailableVariant());\r\n      log.debug(\"Aplicado filtro: availableOnly=true\");\r\n    }\r\n\r\n    if (Boolean.TRUE.equals(filter.featured())) {\r\n      spec = spec.and(ProductSpecifications.hasFeaturedVariant());\r\n      log.debug(\"Aplicado filtro: featured=true\");\r\n    }\r\n\r\n    if (Boolean.TRUE.equals(filter.dailyMenu())) {\r\n      spec = spec.and(ProductSpecifications.hasDailyMenuVariant());\r\n      log.debug(\"Aplicado filtro: dailyMenu=true\");\r\n    }\r\n\r\n    if (Boolean.TRUE.equals(filter.isNew())) {\r\n      spec = spec.and(ProductSpecifications.hasNewVariant());\r\n      log.debug(\"Aplicado filtro: isNew=true\");\r\n    }\r\n\r\n    return spec;\r\n  }\r\n}\r\n",
      "info": {
        "size": 4995,
        "last_modified": "2026-02-01T22:28:36.5928725",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\CocinaDeLiciaApplication.java",
      "content": "package com.cocinadelicia.backend;\r\n\r\nimport org.springframework.boot.SpringApplication;\r\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\r\n\r\n@SpringBootApplication\r\npublic class CocinaDeLiciaApplication {\r\n\r\n  public static void main(String[] args) {\r\n    SpringApplication.run(CocinaDeLiciaApplication.class, args);\r\n  }\r\n}\r\n",
      "info": {
        "size": 347,
        "last_modified": "2026-02-01T22:28:36.6078726",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\config\\HttpClientConfig.java",
      "content": "package com.cocinadelicia.backend.common.config;\r\n\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Configuration;\r\nimport org.springframework.http.client.SimpleClientHttpRequestFactory;\r\nimport org.springframework.web.client.RestTemplate;\r\n\r\n@Configuration\r\npublic class HttpClientConfig {\r\n\r\n  @Bean\r\n  public RestTemplate restTemplate() {\r\n    var factory = new SimpleClientHttpRequestFactory();\r\n    factory.setConnectTimeout(5000);\r\n    factory.setReadTimeout(5000);\r\n    return new RestTemplate(factory);\r\n  }\r\n}\r\n",
      "info": {
        "size": 571,
        "last_modified": "2026-02-01T22:28:36.6128732",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\config\\SecurityConfig.java",
      "content": "package com.cocinadelicia.backend.common.config;\r\n\r\nimport java.util.Arrays;\r\nimport java.util.Collection;\r\nimport java.util.List;\r\nimport java.util.stream.Collectors;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.context.annotation.*;\r\nimport org.springframework.http.HttpMethod;\r\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\r\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\r\nimport org.springframework.security.core.GrantedAuthority;\r\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\r\nimport org.springframework.security.oauth2.jwt.Jwt;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\r\nimport org.springframework.security.web.SecurityFilterChain;\r\nimport org.springframework.web.cors.*;\r\n\r\n@Configuration\r\n@EnableMethodSecurity\r\nclass SecurityConfig {\r\n\r\n  @Value(\"${cdd.security.groups-claim:cognito:groups}\")\r\n  private String groupsClaim;\r\n\r\n  @Value(\"${cdd.security.required-audience:}\")\r\n  private String requiredAudience;\r\n\r\n  @Bean\r\n  SecurityFilterChain apiSecurityFilterChain(HttpSecurity http) throws Exception {\r\n    http.cors(cors -> {})\r\n        .csrf(csrf -> csrf.disable())\r\n        .headers(h -> h.frameOptions(frame -> frame.sameOrigin())) // H2 en dev\r\n        .authorizeHttpRequests(\r\n            auth ->\r\n                auth.requestMatchers(HttpMethod.OPTIONS, \"/**\")\r\n                    .permitAll()\r\n                    // pblicos\r\n                    .requestMatchers(\r\n                        \"/actuator/health/**\",\r\n                        \"/actuator/info\",\r\n                        \"/v3/api-docs/**\",\r\n                        \"/swagger-ui/**\",\r\n                        \"/swagger-ui.html\",\r\n                        \"/h2-console/**\")\r\n                    .permitAll()\r\n                    // WebSocket\r\n                    .requestMatchers(\"/ws/**\")\r\n                    .permitAll()\r\n\r\n                    // Admin-only\r\n                    .requestMatchers(\"/admin/**\")\r\n                    .hasRole(\"ADMIN\")\r\n                    //  NUEVO: API admin de catlogo\r\n                    .requestMatchers(\"/api/admin/catalog/**\")\r\n                    .hasRole(\"ADMIN\")\r\n\r\n                    // Chef o Admin\r\n                    .requestMatchers(\"/chef/**\")\r\n                    .hasAnyRole(\"CHEF\", \"ADMIN\")\r\n\r\n                    // Endpoints de pedidos para staff\r\n                    .requestMatchers(\r\n                        \"/api/orders/ops/**\", \"/api/orders/admin/**\", \"/api/orders/chef/**\")\r\n                    .hasAnyRole(\"CHEF\", \"ADMIN\")\r\n\r\n                    // Catlogo pblico\r\n                    .requestMatchers(\"/api/catalog/**\")\r\n                    .permitAll()\r\n\r\n                    // Resto de /api requiere token\r\n                    .requestMatchers(\"/api/**\")\r\n                    .authenticated()\r\n                    .anyRequest()\r\n                    .denyAll())\r\n        .oauth2ResourceServer(\r\n            oauth2 ->\r\n                oauth2.jwt(jwt -> jwt.jwtAuthenticationConverter(jwtAuthenticationConverter())));\r\n\r\n    return http.build();\r\n  }\r\n\r\n  //  AHORA ES @Bean  reutilizable desde WebSocket\r\n  @Bean\r\n  JwtAuthenticationConverter jwtAuthenticationConverter() {\r\n    var converter = new JwtAuthenticationConverter();\r\n    converter.setJwtGrantedAuthoritiesConverter(\r\n        jwt -> (Collection<GrantedAuthority>) extractAuthoritiesFromJwt(jwt));\r\n    return converter;\r\n  }\r\n\r\n  private Collection<? extends GrantedAuthority> extractAuthoritiesFromJwt(Jwt jwt) {\r\n    List<String> groups = jwt.getClaimAsStringList(groupsClaim);\r\n    if (groups == null) groups = List.of();\r\n    var roles =\r\n        groups.stream()\r\n            .map(g -> new SimpleGrantedAuthority(\"ROLE_\" + g.toUpperCase()))\r\n            .collect(Collectors.toList());\r\n\r\n    if (requiredAudience != null && !requiredAudience.isBlank()) {\r\n      List<String> aud = jwt.getAudience();\r\n      if (aud == null || !aud.contains(requiredAudience)) {\r\n        // podras loguear o lanzar excepcin si quers fallar duro\r\n      }\r\n    }\r\n    return roles;\r\n  }\r\n\r\n  @Bean\r\n  CorsConfigurationSource corsConfigurationSource() {\r\n    CorsConfiguration cors = new CorsConfiguration();\r\n    cors.setAllowedOriginPatterns(\r\n        List.of(\r\n            \"https://localhost:*\",\r\n            \"https://127.0.0.1:*\",\r\n            \"https://www.lacocinadelicia.com\",\r\n            \"https://cocinadelicia-frontend.netlify.app\",\r\n            \"https://192.168.56.1:*\",\r\n            \"https://192.168.1.4:*\"));\r\n    cors.setAllowedMethods(Arrays.asList(\"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\", \"OPTIONS\"));\r\n    cors.setAllowedHeaders(\r\n        Arrays.asList(\"Authorization\", \"Content-Type\", \"Accept\", \"Origin\", \"X-Requested-With\"));\r\n    cors.setExposedHeaders(List.of(\"Location\"));\r\n\r\n    //  Necesario para SockJS con credenciales\r\n    cors.setAllowCredentials(true);\r\n\r\n    cors.setMaxAge(3600L);\r\n\r\n    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\r\n    source.registerCorsConfiguration(\"/**\", cors);\r\n    return source;\r\n  }\r\n}\r\n",
      "info": {
        "size": 5222,
        "last_modified": "2026-02-01T22:28:36.6168724",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\config\\SecurityConfigLocal.java",
      "content": "package com.cocinadelicia.backend.common.config;\r\n\r\nimport org.springframework.boot.autoconfigure.security.servlet.PathRequest;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Configuration;\r\nimport org.springframework.context.annotation.Profile;\r\nimport org.springframework.core.annotation.Order;\r\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\r\nimport org.springframework.security.web.SecurityFilterChain;\r\n\r\n/**\r\n * Cadena exclusiva para H2 en DEV. Deja pasar /h2-console/** y no interfiere con la cadena\r\n * principal JWT.\r\n */\r\n@Configuration\r\n@Profile(\"local\")\r\nclass SecurityConfigLocal {\r\n\r\n  @Bean\r\n  @Order(0) // esta cadena se evala antes que la principal\r\n  SecurityFilterChain h2ConsoleSecurityFilterChain(HttpSecurity http) throws Exception {\r\n    http.securityMatcher(PathRequest.toH2Console()) // solo aplica a /h2-console/**\r\n        .authorizeHttpRequests(auth -> auth.anyRequest().permitAll())\r\n        .csrf(csrf -> csrf.ignoringRequestMatchers(PathRequest.toH2Console()))\r\n        .headers(headers -> headers.frameOptions(frame -> frame.sameOrigin()));\r\n    // OJO: no formLogin, no oauth2 aqu. Solo excepciona H2.\r\n    return http.build();\r\n  }\r\n}\r\n",
      "info": {
        "size": 1261,
        "last_modified": "2026-02-01T22:28:36.6338757",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\config\\WebSocketConfig.java",
      "content": "package com.cocinadelicia.backend.common.config;\r\n\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.context.annotation.Configuration;\r\nimport org.springframework.messaging.simp.config.ChannelRegistration;\r\nimport org.springframework.messaging.simp.config.MessageBrokerRegistry;\r\nimport org.springframework.web.socket.config.annotation.*;\r\n\r\n@Configuration\r\n@EnableWebSocketMessageBroker\r\n@RequiredArgsConstructor\r\npublic class WebSocketConfig implements WebSocketMessageBrokerConfigurer {\r\n\r\n  private final WebSocketJwtAuthChannelInterceptor webSocketJwtAuthChannelInterceptor;\r\n\r\n  @Override\r\n  public void configureMessageBroker(MessageBrokerRegistry registry) {\r\n    registry.enableSimpleBroker(\"/topic\");\r\n    registry.setApplicationDestinationPrefixes(\"/app\");\r\n  }\r\n\r\n  @Override\r\n  public void registerStompEndpoints(StompEndpointRegistry registry) {\r\n    registry\r\n        .addEndpoint(\"/ws\")\r\n        .setAllowedOriginPatterns(\r\n            \"http://localhost:*\",\r\n            \"https://localhost:*\",\r\n            \"https://192.168.1.4:*\",\r\n            \"http://127.0.0.1:*\",\r\n            \"https://*.onrender.com\",\r\n            \"https://*.lacocinadelicia.com\",\r\n            \"https://cocinadelicia-frontend.netlify.app\")\r\n        .withSockJS();\r\n  }\r\n\r\n  @Override\r\n  public void configureClientInboundChannel(ChannelRegistration registration) {\r\n    //  Aqu enchufamos el interceptor que valida JWT en CONNECT\r\n    registration.interceptors(webSocketJwtAuthChannelInterceptor);\r\n  }\r\n}\r\n",
      "info": {
        "size": 1518,
        "last_modified": "2026-02-01T22:28:36.638381",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\config\\WebSocketJwtAuthChannelInterceptor.java",
      "content": "package com.cocinadelicia.backend.common.config;\r\n\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.messaging.*;\r\nimport org.springframework.messaging.simp.stomp.StompCommand;\r\nimport org.springframework.messaging.simp.stomp.StompHeaderAccessor;\r\nimport org.springframework.messaging.support.ChannelInterceptor;\r\nimport org.springframework.messaging.support.MessageHeaderAccessor;\r\nimport org.springframework.security.authentication.AbstractAuthenticationToken;\r\nimport org.springframework.security.core.Authentication;\r\nimport org.springframework.security.core.context.SecurityContextHolder;\r\nimport org.springframework.security.oauth2.jwt.*;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\r\nimport org.springframework.stereotype.Component;\r\nimport org.springframework.util.StringUtils;\r\n\r\n@Log4j2\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class WebSocketJwtAuthChannelInterceptor implements ChannelInterceptor {\r\n\r\n  private final JwtDecoder jwtDecoder;\r\n  private final JwtAuthenticationConverter jwtAuthenticationConverter;\r\n\r\n  @Override\r\n  public Message<?> preSend(Message<?> message, MessageChannel channel) {\r\n    StompHeaderAccessor accessor =\r\n        MessageHeaderAccessor.getAccessor(message, StompHeaderAccessor.class);\r\n\r\n    if (accessor == null) {\r\n      return message;\r\n    }\r\n\r\n    // Solo nos interesa el frame CONNECT\r\n    if (StompCommand.CONNECT.equals(accessor.getCommand())) {\r\n      List<String> authHeaders = accessor.getNativeHeader(\"Authorization\");\r\n      String authHeader =\r\n          (authHeaders != null && !authHeaders.isEmpty()) ? authHeaders.get(0) : null;\r\n\r\n      if (!StringUtils.hasText(authHeader) || !authHeader.startsWith(\"Bearer \")) {\r\n        log.warn(\"[WS] CONNECT sin Authorization Bearer: headers={}\", authHeaders);\r\n        throw new AccessDeniedException(\"Missing or invalid Authorization header in CONNECT\");\r\n      }\r\n\r\n      String tokenValue = authHeader.substring(7);\r\n\r\n      try {\r\n        Jwt jwt = jwtDecoder.decode(tokenValue);\r\n        Authentication authentication = jwtAuthenticationConverter.convert(jwt);\r\n        if (authentication instanceof AbstractAuthenticationToken authToken) {\r\n          authToken.setAuthenticated(true);\r\n          accessor.setUser(authToken);\r\n          SecurityContextHolder.getContext().setAuthentication(authToken);\r\n\r\n          log.debug(\"[WS] Usuario autenticado en STOMP CONNECT: {}\", authToken.getName());\r\n        }\r\n      } catch (JwtException ex) {\r\n        log.warn(\"[WS] JWT invlido en CONNECT: {}\", ex.getMessage());\r\n        throw new AccessDeniedException(\"Invalid JWT token\");\r\n      }\r\n    }\r\n\r\n    return message;\r\n  }\r\n\r\n  // Excepcin custom simple\r\n  private static class AccessDeniedException extends MessagingException {\r\n    public AccessDeniedException(String description) {\r\n      super(description);\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 2978,
        "last_modified": "2026-02-01T22:28:36.643385",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\exception\\BadRequestException.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/exception/BadRequestException.java\r\npackage com.cocinadelicia.backend.common.exception;\r\n\r\npublic class BadRequestException extends RuntimeException implements DomainException {\r\n  private final String code;\r\n\r\n  public BadRequestException(String message) {\r\n    super(message);\r\n    this.code = null;\r\n  }\r\n\r\n  public BadRequestException(String code, String message) {\r\n    super(message);\r\n    this.code = code;\r\n  }\r\n\r\n  @Override\r\n  public String code() {\r\n    return code;\r\n  }\r\n}\r\n",
      "info": {
        "size": 537,
        "last_modified": "2026-02-01T22:28:36.6503844",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\exception\\DomainException.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/exception/DomainException.java\r\npackage com.cocinadelicia.backend.common.exception;\r\n\r\npublic interface DomainException {\r\n  String code(); // ej.: \"ORDER_ITEMS_EMPTY\", \"PRICE_NOT_FOUND\"\r\n}\r\n",
      "info": {
        "size": 241,
        "last_modified": "2026-02-01T22:28:36.6553848",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\exception\\ForbiddenException.java",
      "content": "package com.cocinadelicia.backend.common.exception;\r\n\r\n/**\r\n * Excepcin para indicar que el usuario no tiene permisos para acceder a un recurso. Se mapea a\r\n * HTTP 403 Forbidden.\r\n */\r\npublic class ForbiddenException extends RuntimeException implements DomainException {\r\n  private final String code;\r\n\r\n  public ForbiddenException(String message) {\r\n    super(message);\r\n    this.code = \"FORBIDDEN\";\r\n  }\r\n\r\n  public ForbiddenException(String code, String message) {\r\n    super(message);\r\n    this.code = code;\r\n  }\r\n\r\n  @Override\r\n  public String code() {\r\n    return code;\r\n  }\r\n}\r\n",
      "info": {
        "size": 588,
        "last_modified": "2026-02-01T22:28:36.6593846",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\exception\\NotFoundException.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/exception/NotFoundException.java\r\npackage com.cocinadelicia.backend.common.exception;\r\n\r\npublic class NotFoundException extends RuntimeException implements DomainException {\r\n  private final String code;\r\n\r\n  public NotFoundException(String message) {\r\n    super(message);\r\n    this.code = null;\r\n  }\r\n\r\n  public NotFoundException(String code, String message) {\r\n    super(message);\r\n    this.code = code;\r\n  }\r\n\r\n  @Override\r\n  public String code() {\r\n    return code;\r\n  }\r\n}\r\n",
      "info": {
        "size": 529,
        "last_modified": "2026-02-01T22:28:36.6633837",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\BaseAudit.java",
      "content": "package com.cocinadelicia.backend.common.model;\r\n\r\nimport jakarta.persistence.*;\r\nimport java.time.Instant;\r\nimport lombok.Getter;\r\nimport lombok.Setter;\r\n\r\n@MappedSuperclass\r\n@Getter\r\n@Setter\r\npublic abstract class BaseAudit {\r\n\r\n  @Column(name = \"created_at\", nullable = false, updatable = false)\r\n  private Instant createdAt;\r\n\r\n  @Column(name = \"updated_at\", nullable = false)\r\n  private Instant updatedAt;\r\n\r\n  @Column(name = \"deleted_at\")\r\n  private Instant deletedAt;\r\n\r\n  @PrePersist\r\n  protected void onCreate() {\r\n    Instant now = Instant.now();\r\n    if (createdAt == null) createdAt = now;\r\n    updatedAt = now;\r\n  }\r\n\r\n  @PreUpdate\r\n  protected void onUpdate() {\r\n    updatedAt = Instant.now();\r\n  }\r\n}\r\n",
      "info": {
        "size": 717,
        "last_modified": "2026-02-01T22:28:36.6715736",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\CurrencyCode.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum CurrencyCode {\r\n  UYU,\r\n  USD\r\n}\r\n",
      "info": {
        "size": 103,
        "last_modified": "2026-02-01T22:28:36.6765737",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\FulfillmentType.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum FulfillmentType {\r\n  PICKUP,\r\n  DELIVERY\r\n}\r\n",
      "info": {
        "size": 114,
        "last_modified": "2026-02-01T22:28:36.6805729",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\OrderStatus.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum OrderStatus {\r\n  CREATED,\r\n  CONFIRMED,\r\n  PREPARING,\r\n  READY,\r\n  OUT_FOR_DELIVERY,\r\n  DELIVERED,\r\n  CANCELLED\r\n}\r\n",
      "info": {
        "size": 185,
        "last_modified": "2026-02-01T22:28:36.684573",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\PaymentMethod.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum PaymentMethod {\r\n  CASH,\r\n  BANK_TRANSFER,\r\n  MERCADOPAGO,\r\n  CREDIT_CARD,\r\n  DEBIT_CARD\r\n}\r\n",
      "info": {
        "size": 162,
        "last_modified": "2026-02-01T22:28:36.688573",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\PaymentStatus.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum PaymentStatus {\r\n  PENDING,\r\n  AUTHORIZED,\r\n  PAID,\r\n  FAILED,\r\n  REFUNDED,\r\n  CANCELLED\r\n}\r\n",
      "info": {
        "size": 162,
        "last_modified": "2026-02-01T22:28:36.6925731",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\model\\enums\\RoleName.java",
      "content": "package com.cocinadelicia.backend.common.model.enums;\r\n\r\npublic enum RoleName {\r\n  ADMIN,\r\n  CHEF,\r\n  COURIER,\r\n  CUSTOMER\r\n}\r\n",
      "info": {
        "size": 127,
        "last_modified": "2026-02-01T22:28:36.6975743",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\s3\\CdnUrlBuilder.java",
      "content": "package com.cocinadelicia.backend.common.s3;\r\n\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\npublic class CdnUrlBuilder {\r\n\r\n  private final String cdnBaseUrl;\r\n\r\n  public CdnUrlBuilder(@Value(\"${app.cdn.base-url:}\") String cdnBaseUrl) {\r\n    this.cdnBaseUrl = cdnBaseUrl;\r\n  }\r\n\r\n  public String toPublicUrl(String objectKey) {\r\n    if (objectKey == null || objectKey.isBlank()) return null;\r\n\r\n    //  si no hay base url configurada, devolvemos el key para debug/fallback\r\n    if (cdnBaseUrl == null || cdnBaseUrl.isBlank()) return objectKey;\r\n\r\n    String base = cdnBaseUrl;\r\n    String path = objectKey;\r\n\r\n    if (base.endsWith(\"/\")) base = base.substring(0, base.length() - 1);\r\n    if (path.startsWith(\"/\")) path = path.substring(1);\r\n\r\n    return base + \"/\" + path;\r\n  }\r\n}\r\n",
      "info": {
        "size": 865,
        "last_modified": "2026-02-01T22:28:36.7095741",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\s3\\ImagePresignService.java",
      "content": "package com.cocinadelicia.backend.common.s3;\r\n\r\nimport java.time.Duration;\r\nimport java.util.Map;\r\nimport java.util.Set;\r\nimport java.util.UUID;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.web.server.ResponseStatusException;\r\nimport software.amazon.awssdk.services.s3.model.PutObjectRequest;\r\nimport software.amazon.awssdk.services.s3.presigner.S3Presigner;\r\nimport software.amazon.awssdk.services.s3.presigner.model.PutObjectPresignRequest;\r\n\r\n@Service\r\npublic class ImagePresignService {\r\n\r\n  private static final Set<String> ALLOWED_CONTENT_TYPES =\r\n      Set.of(\"image/jpeg\", \"image/png\", \"image/webp\");\r\n\r\n  private final S3Presigner presigner;\r\n  private final String bucket;\r\n  private final String cdnBaseUrl;\r\n\r\n  public ImagePresignService(\r\n      S3Presigner presigner,\r\n      @Value(\"${app.s3.images-bucket}\") String bucket,\r\n      @Value(\"${app.cdn.base-url}\") String cdnBaseUrl) {\r\n    this.presigner = presigner;\r\n    this.bucket = bucket;\r\n    this.cdnBaseUrl = cdnBaseUrl;\r\n  }\r\n\r\n  public PresignResult presignProductImageUpload(long productId, String contentType) {\r\n    if (contentType == null || !ALLOWED_CONTENT_TYPES.contains(contentType)) {\r\n      throw new ResponseStatusException(\r\n          HttpStatus.BAD_REQUEST, \"Tipo de imagen no permitido: \" + contentType);\r\n    }\r\n\r\n    String ext =\r\n        switch (contentType) {\r\n          case \"image/jpeg\" -> \"jpg\";\r\n          case \"image/png\" -> \"png\";\r\n          case \"image/webp\" -> \"webp\";\r\n          default -> \"bin\";\r\n        };\r\n\r\n    String objectKey = \"products/\" + productId + \"/\" + UUID.randomUUID() + \".\" + ext;\r\n\r\n    PutObjectRequest putObjectRequest =\r\n        PutObjectRequest.builder().bucket(bucket).key(objectKey).contentType(contentType).build();\r\n\r\n    PutObjectPresignRequest presignRequest =\r\n        PutObjectPresignRequest.builder()\r\n            .signatureDuration(Duration.ofMinutes(10))\r\n            .putObjectRequest(putObjectRequest)\r\n            .build();\r\n\r\n    String uploadUrl = presigner.presignPutObject(presignRequest).url().toString();\r\n    String publicUrl = joinUrl(cdnBaseUrl, objectKey);\r\n\r\n    return new PresignResult(uploadUrl, objectKey, publicUrl, Map.of(\"Content-Type\", contentType));\r\n  }\r\n\r\n  private static String joinUrl(String base, String path) {\r\n    if (base.endsWith(\"/\")) base = base.substring(0, base.length() - 1);\r\n    if (path.startsWith(\"/\")) path = path.substring(1);\r\n    return base + \"/\" + path;\r\n  }\r\n\r\n  public record PresignResult(\r\n      String uploadUrl, String objectKey, String publicUrl, Map<String, String> requiredHeaders) {}\r\n}\r\n",
      "info": {
        "size": 2715,
        "last_modified": "2026-02-01T22:28:36.7150419",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\s3\\S3PresignerConfig.java",
      "content": "package com.cocinadelicia.backend.common.s3;\r\n\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Configuration;\r\nimport software.amazon.awssdk.regions.Region;\r\nimport software.amazon.awssdk.services.s3.presigner.S3Presigner;\r\n\r\n@Configuration\r\npublic class S3PresignerConfig {\r\n\r\n  @Bean\r\n  public S3Presigner s3Presigner(@Value(\"${app.s3.region:us-east-1}\") String region) {\r\n    return S3Presigner.builder()\r\n        .region(Region.of(region))\r\n        // Credenciales: IAM Role / env vars / instance profile (default chain)\r\n        .build();\r\n  }\r\n}\r\n",
      "info": {
        "size": 665,
        "last_modified": "2026-02-01T22:28:36.7200661",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\web\\ApiError.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/web/ApiError.java\r\npackage com.cocinadelicia.backend.common.web;\r\n\r\nimport java.time.Instant;\r\n\r\n/** Error estndar. \"code\" es opcional y solo se enva para excepciones con cdigo de dominio. */\r\npublic record ApiError(\r\n    Instant timestamp,\r\n    int status,\r\n    String error,\r\n    String message,\r\n    String path,\r\n    String code // <- NUEVO (puede ser null)\r\n    ) {\r\n  public static ApiError of(int status, String error, String message, String path) {\r\n    return new ApiError(Instant.now(), status, error, message, path, null);\r\n  }\r\n\r\n  public static ApiError of(int status, String error, String message, String path, String code) {\r\n    return new ApiError(Instant.now(), status, error, message, path, code);\r\n  }\r\n}\r\n",
      "info": {
        "size": 782,
        "last_modified": "2026-02-01T22:28:36.7290691",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\web\\GlobalExceptionHandler.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/web/GlobalExceptionHandler.java\r\npackage com.cocinadelicia.backend.common.web;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.ForbiddenException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.user.service.UserService.EmailConflictException;\r\nimport com.cocinadelicia.backend.user.service.UserService.MissingEmailException;\r\nimport java.util.HashMap;\r\nimport java.util.Map;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.security.access.AccessDeniedException;\r\nimport org.springframework.security.authorization.AuthorizationDeniedException;\r\nimport org.springframework.validation.FieldError;\r\nimport org.springframework.web.bind.MethodArgumentNotValidException;\r\nimport org.springframework.web.bind.annotation.ExceptionHandler;\r\nimport org.springframework.web.bind.annotation.ResponseStatus;\r\nimport org.springframework.web.bind.annotation.RestControllerAdvice;\r\nimport org.springframework.web.context.request.WebRequest;\r\nimport org.springframework.web.servlet.NoHandlerFoundException;\r\n\r\n@Log4j2\r\n@RestControllerAdvice\r\npublic class GlobalExceptionHandler {\r\n\r\n  // 1) Conflicto de email (409)\r\n  @ExceptionHandler(EmailConflictException.class)\r\n  @ResponseStatus(HttpStatus.CONFLICT)\r\n  public ApiError handleEmailConflict(EmailConflictException ex, WebRequest request) {\r\n    log.warn(\"Email conflict: {}\", ex.getMessage());\r\n    return ApiError.of(\r\n        HttpStatus.CONFLICT.value(),\r\n        \"Conflict\",\r\n        ex.getMessage(),\r\n        getPath(request),\r\n        \"EMAIL_CONFLICT\");\r\n  }\r\n\r\n  // 2) Falta de email (400)\r\n  @ExceptionHandler(MissingEmailException.class)\r\n  @ResponseStatus(HttpStatus.BAD_REQUEST)\r\n  public ApiError handleMissingEmail(MissingEmailException ex, WebRequest request) {\r\n    log.info(\"Missing email: {}\", ex.getMessage());\r\n    return ApiError.of(\r\n        HttpStatus.BAD_REQUEST.value(),\r\n        \"Bad Request\",\r\n        ex.getMessage(),\r\n        getPath(request),\r\n        \"MISSING_EMAIL\");\r\n  }\r\n\r\n  // 3) Validaciones @Valid (DTOs)  400 con \"fields\"\r\n  @ExceptionHandler(MethodArgumentNotValidException.class)\r\n  @ResponseStatus(HttpStatus.BAD_REQUEST)\r\n  public Map<String, Object> handleValidation(\r\n      MethodArgumentNotValidException ex, WebRequest request) {\r\n\r\n    Map<String, String> fieldErrors = new HashMap<>();\r\n    for (var error : ex.getBindingResult().getAllErrors()) {\r\n      String fieldName = error instanceof FieldError fe ? fe.getField() : error.getObjectName();\r\n      String message = error.getDefaultMessage();\r\n      fieldErrors.put(fieldName, message);\r\n    }\r\n\r\n    log.info(\"Validation error on {}: {}\", getPath(request), fieldErrors);\r\n\r\n    Map<String, Object> body = new HashMap<>();\r\n    body.put(\"timestamp\", java.time.Instant.now());\r\n    body.put(\"status\", HttpStatus.BAD_REQUEST.value());\r\n    body.put(\"error\", \"Bad Request\");\r\n    body.put(\"message\", \"Validation failed\");\r\n    body.put(\"path\", getPath(request));\r\n    body.put(\"fields\", fieldErrors);\r\n    return body;\r\n  }\r\n\r\n  // 4) 404 de controlador (endpoint inexistente)\r\n  @ExceptionHandler(NoHandlerFoundException.class)\r\n  @ResponseStatus(HttpStatus.NOT_FOUND)\r\n  public ApiError handleNotFoundEndpoint(NoHandlerFoundException ex, WebRequest request) {\r\n    log.warn(\"No handler found for {} {}\", ex.getHttpMethod(), ex.getRequestURL());\r\n    return ApiError.of(\r\n        HttpStatus.NOT_FOUND.value(),\r\n        \"Not Found\",\r\n        \"El recurso solicitado no existe\",\r\n        getPath(request));\r\n  }\r\n\r\n  // 5) BadRequest de negocio  con code dominio (ej: ORDER_ITEMS_EMPTY, INVALID_STATUS_TRANSITION)\r\n  @ExceptionHandler(BadRequestException.class)\r\n  @ResponseStatus(HttpStatus.BAD_REQUEST)\r\n  public ApiError handleBadRequest(BadRequestException ex, WebRequest request) {\r\n    log.info(\"BadRequest code={} msg={} path={}\", ex.code(), ex.getMessage(), getPath(request));\r\n    return ApiError.of(\r\n        HttpStatus.BAD_REQUEST.value(),\r\n        \"Bad Request\",\r\n        ex.getMessage(),\r\n        getPath(request),\r\n        ex.code());\r\n  }\r\n\r\n  // 6) NotFound de negocio  con code dominio (ej: ORDER_NOT_FOUND)\r\n  @ExceptionHandler(NotFoundException.class)\r\n  @ResponseStatus(HttpStatus.NOT_FOUND)\r\n  public ApiError handleNotFoundBusiness(NotFoundException ex, WebRequest request) {\r\n    log.warn(\"NotFound code={} msg={} path={}\", ex.code(), ex.getMessage(), getPath(request));\r\n    return ApiError.of(\r\n        HttpStatus.NOT_FOUND.value(), \"Not Found\", ex.getMessage(), getPath(request), ex.code());\r\n  }\r\n\r\n  // 6b) Forbidden de negocio (ej: ownership validation)\r\n  @ExceptionHandler(ForbiddenException.class)\r\n  @ResponseStatus(HttpStatus.FORBIDDEN)\r\n  public ApiError handleForbiddenBusiness(ForbiddenException ex, WebRequest request) {\r\n    log.warn(\"Forbidden code={} msg={} path={}\", ex.code(), ex.getMessage(), getPath(request));\r\n    return ApiError.of(\r\n        HttpStatus.FORBIDDEN.value(), \"Forbidden\", ex.getMessage(), getPath(request), ex.code());\r\n  }\r\n\r\n  // 7) Access Denied (403)\r\n  @ExceptionHandler({AccessDeniedException.class, AuthorizationDeniedException.class})\r\n  @ResponseStatus(HttpStatus.FORBIDDEN)\r\n  public ApiError handleAccessDenied(Exception ex, WebRequest request) {\r\n    log.warn(\"AccessDenied on {}: {}\", getPath(request), ex.getMessage());\r\n    return ApiError.of(\r\n        HttpStatus.FORBIDDEN.value(),\r\n        \"Forbidden\",\r\n        \"No tiene permisos para realizar esta accin.\",\r\n        getPath(request),\r\n        \"ACCESS_DENIED\");\r\n  }\r\n\r\n  // 8) Fallback genrico (500)\r\n  @ExceptionHandler(Exception.class)\r\n  public ResponseEntity<ApiError> handleGeneric(Exception ex, WebRequest request) {\r\n    log.error(\"Unexpected error on {}: {}\", getPath(request), ex.getMessage(), ex);\r\n    ApiError body =\r\n        ApiError.of(\r\n            HttpStatus.INTERNAL_SERVER_ERROR.value(),\r\n            \"Internal Server Error\",\r\n            \"Ocurri un error inesperado. Si persiste, contacte al administrador.\",\r\n            getPath(request));\r\n    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(body);\r\n  }\r\n\r\n  private String getPath(WebRequest request) {\r\n    String desc = request.getDescription(false); // \"uri=/api/orders/1\"\r\n    return desc != null && desc.startsWith(\"uri=\") ? desc.substring(4) : desc;\r\n  }\r\n}\r\n",
      "info": {
        "size": 6529,
        "last_modified": "2026-02-01T22:28:36.733069",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\web\\PageResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/common/web/PageResponse.java\r\npackage com.cocinadelicia.backend.common.web;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.util.List;\r\nimport org.springframework.data.domain.Page;\r\n\r\n@Schema(description = \"Respuesta paginada genrica\")\r\npublic record PageResponse<T>(\r\n    @Schema(description = \"Contenido de la pgina\") List<T> content,\r\n    @Schema(description = \"Nmero de pgina (0-based)\", example = \"0\") int page,\r\n    @Schema(description = \"Tamao de pgina\", example = \"20\") int size,\r\n    @Schema(description = \"Cantidad total de elementos\", example = \"125\") long totalElements,\r\n    @Schema(description = \"Cantidad total de pginas\", example = \"7\") int totalPages) {\r\n\r\n  public static <T> PageResponse<T> from(Page<T> p) {\r\n    return new PageResponse<>(\r\n        p.getContent(), p.getNumber(), p.getSize(), p.getTotalElements(), p.getTotalPages());\r\n  }\r\n}\r\n",
      "info": {
        "size": 940,
        "last_modified": "2026-02-01T22:28:36.7380687",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\common\\web\\WebSocketInfoController.java",
      "content": "package com.cocinadelicia.backend.common.web;\r\n\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.web.bind.annotation.GetMapping;\r\nimport org.springframework.web.bind.annotation.RequestMapping;\r\nimport org.springframework.web.bind.annotation.RestController;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/system\")\r\n@Tag(name = \"system\", description = \"Endpoints de sistema y metadatos\")\r\npublic class WebSocketInfoController {\r\n\r\n  @Schema(description = \"Informacin bsica sobre el endpoint WebSocket/STOMP\")\r\n  public record WebSocketInfoResponse(\r\n      @Schema(example = \"/ws\") String endpoint,\r\n      @Schema(example = \"/topic/orders\") String ordersTopic,\r\n      @Schema(example = \"/app\") String applicationPrefix,\r\n      @Schema(example = \"ORDER_UPDATED\") String exampleEventType) {}\r\n\r\n  @GetMapping(\"/ws-info\")\r\n  @Operation(\r\n      summary = \"Informacin del endpoint WebSocket\",\r\n      description =\r\n          \"\"\"\r\n      Devuelve los valores configurados para el endpoint STOMP:\r\n      - endpoint: path para conectar (ej. ws://host:port/ws)\r\n      - ordersTopic: tpico donde se publican actualizaciones de pedidos\r\n      - applicationPrefix: prefijo para destinos de aplicacin\r\n      - exampleEventType: tipo de evento estndar para actualizaciones de pedido\r\n      \"\"\")\r\n  public ResponseEntity<WebSocketInfoResponse> getWebSocketInfo() {\r\n    return ResponseEntity.ok(\r\n        new WebSocketInfoResponse(\"/ws\", \"/topic/orders\", \"/app\", \"ORDER_UPDATED\"));\r\n  }\r\n}\r\n",
      "info": {
        "size": 1656,
        "last_modified": "2026-02-01T22:28:36.7425766",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\config\\OpenApiConfig.java",
      "content": "package com.cocinadelicia.backend.config;\r\n\r\nimport io.swagger.v3.oas.models.Components;\r\nimport io.swagger.v3.oas.models.ExternalDocumentation;\r\nimport io.swagger.v3.oas.models.OpenAPI;\r\nimport io.swagger.v3.oas.models.info.Contact;\r\nimport io.swagger.v3.oas.models.info.Info;\r\nimport io.swagger.v3.oas.models.security.SecurityRequirement;\r\nimport io.swagger.v3.oas.models.security.SecurityScheme;\r\nimport io.swagger.v3.oas.models.servers.Server;\r\nimport java.util.List;\r\nimport org.springdoc.core.models.GroupedOpenApi;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Configuration;\r\n\r\n@Configuration\r\npublic class OpenApiConfig {\r\n\r\n  @Value(\"${app.openapi.server.dev:http://localhost:8080}\")\r\n  private String devServerUrl;\r\n\r\n  @Value(\"${app.openapi.server.prod:https://api.lacocinadelicia.com}\")\r\n  private String prodServerUrl;\r\n\r\n  @Bean\r\n  public OpenAPI cocinaDeLiciaOpenAPI(\r\n      @Value(\"${spring.application.name:CocinaDeLicia}\") String appName,\r\n      @Value(\"${app.version:v1.0.0}\") String appVersion) {\r\n\r\n    final String securitySchemeName = \"bearer-jwt\";\r\n\r\n    return new OpenAPI()\r\n        .info(\r\n            new Info()\r\n                .title(appName + \"  API\")\r\n                .description(\r\n                    \"APIs del backend (Pedidos, Productos, Usuarios, etc.). \"\r\n                        + \"Documentacin generada automticamente con Springdoc OpenAPI.\")\r\n                .version(appVersion)\r\n                .contact(new Contact().name(\"Cocina DeLicia\").email(\"soporte@lacocinadelicia.com\")))\r\n        .servers(\r\n            List.of(\r\n                new Server().url(devServerUrl).description(\"Desarrollo\"),\r\n                new Server().url(prodServerUrl).description(\"Produccin\")))\r\n        .externalDocs(\r\n            new ExternalDocumentation()\r\n                .description(\"Convenciones & Sprints\")\r\n                .url(\"https://tu-docs-o-notion\"))\r\n        //  Seguridad: esquema Bearer y requirement por defecto\r\n        .components(\r\n            new Components()\r\n                .addSecuritySchemes(\r\n                    securitySchemeName,\r\n                    new SecurityScheme()\r\n                        .name(securitySchemeName)\r\n                        .type(SecurityScheme.Type.HTTP)\r\n                        .scheme(\"bearer\")\r\n                        .bearerFormat(\"JWT\")))\r\n        .addSecurityItem(new SecurityRequirement().addList(securitySchemeName));\r\n  }\r\n\r\n  /** Grupo general: muestra todos los endpoints bajo /api/**. til como vista completa. */\r\n  @Bean\r\n  public GroupedOpenApi publicApi() {\r\n    return GroupedOpenApi.builder().group(\"public\").pathsToMatch(\"/api/**\").build();\r\n  }\r\n\r\n  /** Grupo especfico para endpoints de pedidos. Filtra por path /api/orders/**. */\r\n  @Bean\r\n  public GroupedOpenApi ordersApi() {\r\n    return GroupedOpenApi.builder().group(\"orders\").pathsToMatch(\"/api/orders/**\").build();\r\n  }\r\n\r\n  /** Grupo especfico para endpoints de usuarios. Filtra por path /api/users/**. */\r\n  @Bean\r\n  public GroupedOpenApi usersApi() {\r\n    return GroupedOpenApi.builder().group(\"users\").pathsToMatch(\"/api/users/**\").build();\r\n  }\r\n}\r\n",
      "info": {
        "size": 3247,
        "last_modified": "2026-02-01T22:28:36.7545927",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\adapter\\JpaPriceHistoryAdapter.java",
      "content": "package com.cocinadelicia.backend.order.adapter;\r\n\r\nimport com.cocinadelicia.backend.order.port.PriceQueryPort;\r\nimport com.cocinadelicia.backend.product.repository.PriceHistoryRepository;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.Optional;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class JpaPriceHistoryAdapter implements PriceQueryPort {\r\n\r\n  private final PriceHistoryRepository priceHistoryRepository;\r\n\r\n  @Override\r\n  public Optional<BigDecimal> findActivePriceByVariantId(Long productVariantId) {\r\n    return priceHistoryRepository.findActivePrice(productVariantId, Instant.now());\r\n  }\r\n}\r\n",
      "info": {
        "size": 727,
        "last_modified": "2026-02-01T22:28:36.7625926",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\controller\\OrderAdminController.java",
      "content": "package com.cocinadelicia.backend.order.admin.controller;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.admin.dto.CreateOrderAdminRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderAdminResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderFilterRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderStatsResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderCustomerRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderDetailsRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderItemsRequest;\r\nimport com.cocinadelicia.backend.order.admin.service.OrderAdminService;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.Parameter;\r\nimport io.swagger.v3.oas.annotations.security.SecurityRequirement;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport jakarta.validation.Valid;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springdoc.core.annotations.ParameterObject;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.domain.Sort;\r\nimport org.springframework.data.web.PageableDefault;\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.security.access.prepost.PreAuthorize;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/admin/orders\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"Admin Orders\", description = \"Gestin de pedidos para administradores\")\r\n@SecurityRequirement(name = \"bearer-jwt\")\r\n@PreAuthorize(\"hasRole('ADMIN')\")\r\npublic class OrderAdminController {\r\n\r\n  private final OrderAdminService orderAdminService;\r\n\r\n  @PostMapping\r\n  @Operation(\r\n      summary = \"Crear orden en nombre de un cliente (Admin)\",\r\n      description =\r\n          \"\"\"\r\n      Permite al administrador crear una orden en nombre de un cliente.\r\n      Requiere el email del cliente (debe existir en el sistema).\r\n      til para rdenes telefnicas o por otros canales.\r\n      \"\"\")\r\n  public ResponseEntity<OrderAdminResponse> createOrderForUser(\r\n      @Valid @RequestBody CreateOrderAdminRequest request) {\r\n    return ResponseEntity.status(HttpStatus.CREATED)\r\n        .body(orderAdminService.createOrderForUser(request));\r\n  }\r\n\r\n  @GetMapping\r\n  @Operation(\r\n      summary = \"Listar todas las rdenes con filtros avanzados\",\r\n      description =\r\n          \"Obtiene lista paginada de rdenes con filtros por estado, fecha, usuario, chef, monto, etc.\")\r\n  public ResponseEntity<Page<OrderAdminResponse>> getAllOrders(\r\n      @ParameterObject @Valid OrderFilterRequest filters,\r\n      @ParameterObject\r\n          @PageableDefault(size = 20, sort = \"createdAt\", direction = Sort.Direction.DESC)\r\n          Pageable pageable) {\r\n    return ResponseEntity.ok(orderAdminService.getAllOrders(filters, pageable));\r\n  }\r\n\r\n  @GetMapping(\"/{id}\")\r\n  @Operation(\r\n      summary = \"Obtener detalle completo de una orden\",\r\n      description =\r\n          \"Incluye historial de cambios de estado, datos del usuario, chef asignado, etc.\")\r\n  public ResponseEntity<OrderAdminResponse> getOrderById(@PathVariable Long id) {\r\n    return ResponseEntity.ok(orderAdminService.getOrderById(id));\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/status\")\r\n  @Operation(\r\n      summary = \"Actualizar estado de una orden\",\r\n      description =\r\n          \"Permite cambiar el estado de una orden. Admin puede hacer cualquier transicin vlida.\")\r\n  public ResponseEntity<OrderAdminResponse> updateStatus(\r\n      @PathVariable Long id,\r\n      @Parameter(description = \"Nuevo estado\", required = true) @RequestParam OrderStatus status,\r\n      @Parameter(description = \"Razn del cambio (opcional)\") @RequestParam(required = false)\r\n          String reason) {\r\n    return ResponseEntity.ok(orderAdminService.updateStatus(id, status, reason));\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/assign-chef\")\r\n  @Operation(\r\n      summary = \"Asignar chef a una orden\",\r\n      description = \"Asigna un chef especfico para preparar la orden\")\r\n  public ResponseEntity<OrderAdminResponse> assignChef(\r\n      @PathVariable Long id,\r\n      @Parameter(description = \"Email del chef\", required = true) @RequestParam String chefEmail) {\r\n    return ResponseEntity.ok(orderAdminService.assignChef(id, chefEmail));\r\n  }\r\n\r\n  @DeleteMapping(\"/{id}\")\r\n  @Operation(\r\n      summary = \"Eliminar orden (soft delete)\",\r\n      description = \"Marca la orden como eliminada y cambia su estado a CANCELLED\")\r\n  public ResponseEntity<Void> deleteOrder(@PathVariable Long id) {\r\n    orderAdminService.deleteOrder(id);\r\n    return ResponseEntity.noContent().build();\r\n  }\r\n\r\n  @GetMapping(\"/stats\")\r\n  @Operation(\r\n      summary = \"Obtener estadsticas de rdenes\",\r\n      description =\r\n          \"KPIs para dashboard: rdenes por estado, ingresos del da, ticket promedio, etc.\")\r\n  public ResponseEntity<OrderStatsResponse> getStats() {\r\n    return ResponseEntity.ok(orderAdminService.getStats());\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/items\")\r\n  @Operation(\r\n      summary = \"Reemplazar tems de la orden\",\r\n      description =\r\n          \"Permite al admin modificar los tems y recalcular totales mientras la orden est editable\")\r\n  public ResponseEntity<OrderAdminResponse> updateItems(\r\n      @PathVariable Long id, @Valid @RequestBody UpdateOrderItemsRequest request) {\r\n    return ResponseEntity.ok(orderAdminService.updateItems(id, request));\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/details\")\r\n  @Operation(\r\n      summary = \"Actualizar detalles del pedido\",\r\n      description =\r\n          \"Permite cambiar notas, fulfillment, envo y fecha solicitada mientras est editable\")\r\n  public ResponseEntity<OrderAdminResponse> updateDetails(\r\n      @PathVariable Long id, @Valid @RequestBody UpdateOrderDetailsRequest request) {\r\n    return ResponseEntity.ok(orderAdminService.updateDetails(id, request));\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/customer\")\r\n  @Operation(summary = \"Cambiar el cliente de la orden\")\r\n  public ResponseEntity<OrderAdminResponse> updateCustomer(\r\n      @PathVariable Long id, @Valid @RequestBody UpdateOrderCustomerRequest request) {\r\n    return ResponseEntity.ok(orderAdminService.updateCustomer(id, request));\r\n  }\r\n}\r\n",
      "info": {
        "size": 6333,
        "last_modified": "2026-02-01T22:28:36.7695933",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\CreateOrderAdminRequest.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemRequest;\r\nimport com.cocinadelicia.backend.order.dto.ShippingAddressRequest;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.Valid;\r\nimport jakarta.validation.constraints.Email;\r\nimport jakarta.validation.constraints.NotBlank;\r\nimport jakarta.validation.constraints.NotEmpty;\r\nimport jakarta.validation.constraints.NotNull;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Request para que Admin cree una orden en nombre de un cliente\")\r\npublic record CreateOrderAdminRequest(\r\n    @Schema(\r\n            description = \"Email del cliente para quien se crea la orden\",\r\n            example = \"cliente@example.com\",\r\n            required = true)\r\n        @NotBlank(message = \"El email del cliente es obligatorio\") @Email(message = \"Debe ser un email vlido\") String userEmail,\r\n    @Schema(description = \"Tipo de cumplimiento del pedido\", example = \"DELIVERY\", required = true)\r\n        @NotNull(message = \"El tipo de fulfillment es obligatorio\") FulfillmentType fulfillment,\r\n    @Schema(description = \"Lista de items del pedido\", required = true)\r\n        @NotEmpty(message = \"Debe incluir al menos un item\") @Valid List<OrderItemRequest> items,\r\n    @Schema(description = \"Datos de envo (requerido si fulfillment=DELIVERY)\") @Valid ShippingAddressRequest shipping,\r\n    @Schema(\r\n            description = \"Notas adicionales del pedido\",\r\n            example = \"Entregar en horario de oficina\")\r\n        String notes,\r\n    @Schema(\r\n            description = \"Fecha/hora deseada de entrega o retiro\",\r\n            example = \"2026-01-25T20:00:00Z\")\r\n        Instant requestedAt,\r\n    @Schema(description = \"Email del chef asignado (opcional)\", example = \"chef@example.com\")\r\n        @Email(message = \"Debe ser un email vlido\") String assignedChefEmail) {}\r\n",
      "info": {
        "size": 1996,
        "last_modified": "2026-02-01T22:28:36.7775927",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\OrderAdminResponse.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Respuesta completa de orden para administradores (incluye datos sensibles)\")\r\npublic record OrderAdminResponse(\r\n    @Schema(description = \"Id del pedido\", example = \"42\") Long id,\r\n    @Schema(description = \"ID del usuario que cre la orden\", example = \"123\") Long userId,\r\n    @Schema(description = \"Email del usuario\", example = \"cliente@example.com\") String userEmail,\r\n    @Schema(description = \"Estado actual del pedido\", example = \"PREPARING\") OrderStatus status,\r\n    @Schema(description = \"Tipo de cumplimiento\", example = \"DELIVERY\") FulfillmentType fulfillment,\r\n    @Schema(description = \"Moneda\", example = \"UYU\") CurrencyCode currency,\r\n    @Schema(description = \"Subtotal\", example = \"900.00\") BigDecimal subtotalAmount,\r\n    @Schema(description = \"Impuestos\", example = \"0.00\") BigDecimal taxAmount,\r\n    @Schema(description = \"Descuentos\", example = \"0.00\") BigDecimal discountAmount,\r\n    @Schema(description = \"Total final\", example = \"900.00\") BigDecimal totalAmount,\r\n    @Schema(description = \"Nombre de envo\") String shipName,\r\n    @Schema(description = \"Telfono de envo\") String shipPhone,\r\n    @Schema(description = \"Direccin lnea 1\") String shipLine1,\r\n    @Schema(description = \"Direccin lnea 2\") String shipLine2,\r\n    @Schema(description = \"Ciudad\") String shipCity,\r\n    @Schema(description = \"Regin/Departamento\") String shipRegion,\r\n    @Schema(description = \"Cdigo postal\") String shipPostalCode,\r\n    @Schema(description = \"Referencia de envo\") String shipReference,\r\n    @Schema(description = \"Notas del pedido\") String notes,\r\n    @Schema(description = \"Fecha/hora solicitada de entrega\") Instant requestedAt,\r\n    @Schema(description = \"Fecha/hora real de entrega\") Instant deliveredAt,\r\n    @Schema(description = \"Email del chef asignado\") String assignedChefEmail,\r\n    @Schema(description = \"tems del pedido\") List<OrderItemResponse> items,\r\n    @Schema(description = \"Fecha de creacin\") Instant createdAt,\r\n    @Schema(description = \"Fecha de ltima actualizacin\") Instant updatedAt,\r\n    @Schema(description = \"Fecha de eliminacin (soft delete)\") Instant deletedAt,\r\n    @Schema(description = \"Usuario que elimin la orden\") String deletedBy,\r\n    @Schema(description = \"Historial de cambios de estado\")\r\n        List<StatusHistoryEntry> statusHistory) {\r\n\r\n  @Schema(description = \"Entrada del historial de cambios de estado\")\r\n  public record StatusHistoryEntry(\r\n      @Schema(description = \"Estado anterior\") OrderStatus fromStatus,\r\n      @Schema(description = \"Estado nuevo\") OrderStatus toStatus,\r\n      @Schema(description = \"Usuario que realiz el cambio\") String changedBy,\r\n      @Schema(description = \"Fecha/hora del cambio\") Instant changedAt,\r\n      @Schema(description = \"Razn del cambio\") String reason) {}\r\n}\r\n",
      "info": {
        "size": 3281,
        "last_modified": "2026-02-01T22:28:36.7815923",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\OrderFilterRequest.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\nimport java.time.LocalDate;\r\nimport lombok.*;\r\n\r\n@Schema(description = \"Filtros para bsqueda avanzada de rdenes (Admin)\")\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\npublic class OrderFilterRequest {\r\n\r\n  @Schema(description = \"Filtrar por estado\", example = \"PREPARING\")\r\n  private OrderStatus status;\r\n\r\n  @Schema(description = \"Fecha de creacin desde (inclusive)\", example = \"2026-01-01\")\r\n  private LocalDate createdAfter;\r\n\r\n  @Schema(description = \"Fecha de creacin hasta (inclusive)\", example = \"2026-01-31\")\r\n  private LocalDate createdBefore;\r\n\r\n  @Schema(description = \"Filtrar por email de usuario\", example = \"cliente@example.com\")\r\n  private String userEmail;\r\n\r\n  @Schema(description = \"Filtrar por email de chef asignado\", example = \"chef@example.com\")\r\n  private String assignedChefEmail;\r\n\r\n  @Schema(description = \"Monto mnimo\", example = \"100.00\")\r\n  private BigDecimal minAmount;\r\n\r\n  @Schema(description = \"Monto mximo\", example = \"5000.00\")\r\n  private BigDecimal maxAmount;\r\n\r\n  @Schema(description = \"Incluir rdenes eliminadas (soft delete)\", example = \"false\")\r\n  @Builder.Default\r\n  private Boolean includeDeleted = false;\r\n}\r\n",
      "info": {
        "size": 1394,
        "last_modified": "2026-02-01T22:28:36.7855925",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\OrderStatsResponse.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\n\r\n@Schema(description = \"Estadsticas de rdenes para dashboard admin\")\r\npublic record OrderStatsResponse(\r\n    @Schema(description = \"Total de rdenes activas\") long totalActiveOrders,\r\n    @Schema(description = \"rdenes en estado CREATED\") long ordersCreated,\r\n    @Schema(description = \"rdenes en estado CONFIRMED\") long ordersConfirmed,\r\n    @Schema(description = \"rdenes en estado PREPARING\") long ordersPreparing,\r\n    @Schema(description = \"rdenes en estado READY\") long ordersReady,\r\n    @Schema(description = \"rdenes en estado OUT_FOR_DELIVERY\") long ordersOutForDelivery,\r\n    @Schema(description = \"rdenes entregadas hoy\") long ordersDeliveredToday,\r\n    @Schema(description = \"rdenes canceladas hoy\") long ordersCANCELLEDToday,\r\n    @Schema(description = \"Ingresos totales del da (entregadas)\") BigDecimal revenueDeliveredToday,\r\n    @Schema(description = \"Ticket promedio del da\") BigDecimal averageTicketToday,\r\n    @Schema(description = \"Ingresos de rdenes solicitadas hoy (excluye CREATED/CANCELLED)\")\r\n        BigDecimal revenueTotalToday) {}\r\n",
      "info": {
        "size": 1219,
        "last_modified": "2026-02-01T22:28:36.7895927",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\UpdateOrderCustomerRequest.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.Email;\r\nimport jakarta.validation.constraints.NotBlank;\r\n\r\n@Schema(description = \"Request para cambiar el cliente asociado a una orden\")\r\npublic record UpdateOrderCustomerRequest(\r\n    @Schema(\r\n            description = \"Email del nuevo cliente\",\r\n            example = \"cliente@example.com\",\r\n            required = true)\r\n        @NotBlank(message = \"El email del cliente es obligatorio\") @Email(message = \"Debe ser un email vlido\") String userEmail) {}\r\n",
      "info": {
        "size": 604,
        "last_modified": "2026-02-01T22:28:36.7935924",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\UpdateOrderDetailsRequest.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.order.dto.ShippingAddressRequest;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.Valid;\r\nimport java.time.Instant;\r\n\r\n@Schema(description = \"Request para actualizar detalles del pedido (Admin)\")\r\npublic record UpdateOrderDetailsRequest(\r\n    @Schema(description = \"Tipo de cumplimiento\", example = \"DELIVERY\") FulfillmentType fulfillment,\r\n    @Schema(description = \"Direccin de envo si aplica\") @Valid ShippingAddressRequest shipping,\r\n    @Schema(description = \"Notas del pedido\", example = \"Entregar en horario de oficina\")\r\n        String notes,\r\n    @Schema(\r\n            description = \"Fecha/hora solicitada de entrega o retiro\",\r\n            example = \"2026-01-25T20:00:00Z\")\r\n        Instant requestedAt) {}\r\n",
      "info": {
        "size": 910,
        "last_modified": "2026-02-01T22:28:36.7970828",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\dto\\UpdateOrderItemsRequest.java",
      "content": "package com.cocinadelicia.backend.order.admin.dto;\r\n\r\nimport com.cocinadelicia.backend.order.dto.OrderItemRequest;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.Valid;\r\nimport jakarta.validation.constraints.NotEmpty;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Request para reemplazar todos los tems de una orden (Admin)\")\r\npublic record UpdateOrderItemsRequest(\r\n    @Schema(description = \"Lista completa de tems\", required = true)\r\n        @NotEmpty(message = \"Debe incluir al menos un tem\") @Valid List<OrderItemRequest> items) {}\r\n",
      "info": {
        "size": 580,
        "last_modified": "2026-02-01T22:28:36.8020827",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\mapper\\OrderAdminMapper.java",
      "content": "package com.cocinadelicia.backend.order.admin.mapper;\r\n\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderAdminResponse;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderStatusHistory;\r\nimport java.util.List;\r\n\r\npublic final class OrderAdminMapper {\r\n\r\n  private OrderAdminMapper() {}\r\n\r\n  public static OrderAdminResponse toAdminResponse(\r\n      CustomerOrder order, List<OrderStatusHistory> statusHistory) {\r\n\r\n    List<OrderItemResponse> itemDtos =\r\n        order.getItems().stream().map(OrderAdminMapper::toItemResponse).toList();\r\n\r\n    List<OrderAdminResponse.StatusHistoryEntry> historyDtos =\r\n        statusHistory.stream().map(OrderAdminMapper::toHistoryEntry).toList();\r\n\r\n    return new OrderAdminResponse(\r\n        order.getId(),\r\n        order.getUser().getId(),\r\n        order.getUser().getEmail(),\r\n        order.getStatus(),\r\n        order.getFulfillment(),\r\n        order.getCurrency(),\r\n        order.getSubtotalAmount(),\r\n        order.getTaxAmount(),\r\n        order.getDiscountAmount(),\r\n        order.getTotalAmount(),\r\n        order.getShipName(),\r\n        order.getShipPhone(),\r\n        order.getShipLine1(),\r\n        order.getShipLine2(),\r\n        order.getShipCity(),\r\n        order.getShipRegion(),\r\n        order.getShipPostalCode(),\r\n        order.getShipReference(),\r\n        order.getNotes(),\r\n        order.getRequestedAt(),\r\n        order.getDeliveredAt(),\r\n        order.getAssignedChefEmail(),\r\n        itemDtos,\r\n        order.getCreatedAt(),\r\n        order.getUpdatedAt(),\r\n        order.getDeletedAt(),\r\n        order.getDeletedBy(),\r\n        historyDtos);\r\n  }\r\n\r\n  private static OrderItemResponse toItemResponse(\r\n      com.cocinadelicia.backend.order.model.OrderItem item) {\r\n    return new OrderItemResponse(\r\n        item.getId(),\r\n        item.getProduct().getId(),\r\n        item.getProductVariant().getId(),\r\n        item.getProductName(),\r\n        item.getVariantName(),\r\n        item.getUnitPrice(),\r\n        item.getQuantity(),\r\n        item.getLineTotal());\r\n  }\r\n\r\n  private static OrderAdminResponse.StatusHistoryEntry toHistoryEntry(OrderStatusHistory history) {\r\n    return new OrderAdminResponse.StatusHistoryEntry(\r\n        history.getFromStatus(),\r\n        history.getToStatus(),\r\n        history.getChangedBy(),\r\n        history.getChangedAt(),\r\n        history.getReason());\r\n  }\r\n}\r\n",
      "info": {
        "size": 2473,
        "last_modified": "2026-02-01T22:28:36.8090828",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\service\\impl\\OrderAdminServiceImpl.java",
      "content": "package com.cocinadelicia.backend.order.admin.service.impl;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.admin.dto.CreateOrderAdminRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderAdminResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderFilterRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderStatsResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderCustomerRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderDetailsRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderItemsRequest;\r\nimport com.cocinadelicia.backend.order.admin.mapper.OrderAdminMapper;\r\nimport com.cocinadelicia.backend.order.admin.service.OrderAdminService;\r\nimport com.cocinadelicia.backend.order.domain.OrderStatusTransition;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemRequest;\r\nimport com.cocinadelicia.backend.order.events.OrderWebSocketPublisher;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderItem;\r\nimport com.cocinadelicia.backend.order.model.OrderStatusHistory;\r\nimport com.cocinadelicia.backend.order.port.PriceQueryPort;\r\nimport com.cocinadelicia.backend.order.repository.CustomerOrderRepository;\r\nimport com.cocinadelicia.backend.order.repository.OrderStatusHistoryRepository;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductVariantRepository;\r\nimport com.cocinadelicia.backend.user.model.AppUser;\r\nimport com.cocinadelicia.backend.user.repository.UserRepository;\r\nimport com.cocinadelicia.backend.user.service.CurrentUserService;\r\nimport jakarta.transaction.Transactional;\r\nimport java.math.BigDecimal;\r\nimport java.math.RoundingMode;\r\nimport java.time.Instant;\r\nimport java.time.LocalDate;\r\nimport java.time.ZoneId;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.jpa.domain.Specification;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Log4j2\r\n@Service\r\n@RequiredArgsConstructor\r\n@Transactional\r\npublic class OrderAdminServiceImpl implements OrderAdminService {\r\n\r\n  private final CustomerOrderRepository orderRepository;\r\n  private final OrderStatusHistoryRepository statusHistoryRepository;\r\n  private final UserRepository userRepository;\r\n  private final ProductRepository productRepository;\r\n  private final ProductVariantRepository productVariantRepository;\r\n  private final PriceQueryPort priceQueryPort;\r\n  private final CurrentUserService currentUserService;\r\n  private final OrderWebSocketPublisher orderWebSocketPublisher;\r\n\r\n  private static final BigDecimal ZERO = new BigDecimal(\"0.00\");\r\n\r\n  @Override\r\n  public OrderAdminResponse createOrderForUser(CreateOrderAdminRequest request) {\r\n    // 1. Validaciones\r\n    if (request.items() == null || request.items().isEmpty()) {\r\n      throw new BadRequestException(\"ORDER_ITEMS_EMPTY\", \"Debe agregar al menos un tem.\");\r\n    }\r\n\r\n    for (OrderItemRequest it : request.items()) {\r\n      if (it.quantity() <= 0) {\r\n        throw new BadRequestException(\r\n            \"INVALID_QUANTITY\", \"La cantidad de cada tem debe ser >= 1.\");\r\n      }\r\n    }\r\n\r\n    if (request.fulfillment() == FulfillmentType.DELIVERY) {\r\n      var s = request.shipping();\r\n      if (s == null\r\n          || isBlank(s.name())\r\n          || isBlank(s.phone())\r\n          || isBlank(s.line1())\r\n          || isBlank(s.city())) {\r\n        throw new BadRequestException(\r\n            \"DELIVERY_ADDRESS_REQUIRED\",\r\n            \"Complete los datos de envo (nombre, telfono, direccin y ciudad).\");\r\n      }\r\n    }\r\n\r\n    // 2. Buscar o crear usuario por email\r\n    AppUser user =\r\n        userRepository\r\n            .findByEmail(request.userEmail())\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"USER_NOT_FOUND\",\r\n                        \"Usuario no encontrado con email: \" + request.userEmail()));\r\n\r\n    // 3. Crear orden base\r\n    CustomerOrder order =\r\n        CustomerOrder.builder()\r\n            .user(user)\r\n            .status(OrderStatus.CREATED)\r\n            .fulfillment(request.fulfillment())\r\n            .notes(request.notes())\r\n            .requestedAt(request.requestedAt())\r\n            .assignedChefEmail(request.assignedChefEmail())\r\n            .build();\r\n\r\n    // 4. Snapshot shipping si DELIVERY\r\n    if (request.fulfillment() == FulfillmentType.DELIVERY) {\r\n      var s = request.shipping();\r\n      order.setShipName(s.name());\r\n      order.setShipPhone(s.phone());\r\n      order.setShipLine1(s.line1());\r\n      order.setShipLine2(s.line2());\r\n      order.setShipCity(s.city());\r\n      order.setShipRegion(s.region());\r\n      order.setShipPostalCode(s.postalCode());\r\n      order.setShipReference(s.reference());\r\n    }\r\n\r\n    // 5. Procesar items y calcular totales\r\n    BigDecimal subtotal = ZERO;\r\n\r\n    for (OrderItemRequest it : request.items()) {\r\n      Product product =\r\n          productRepository\r\n              .findById(it.productId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado.\"));\r\n\r\n      ProductVariant variant =\r\n          productVariantRepository\r\n              .findById(it.productVariantId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"VARIANT_NOT_FOUND\", \"Variante no encontrada.\"));\r\n\r\n      if (variant.getProduct() == null || !variant.getProduct().getId().equals(product.getId())) {\r\n        throw new BadRequestException(\r\n            \"VARIANT_MISMATCH\", \"La variante no pertenece al producto indicado.\");\r\n      }\r\n\r\n      BigDecimal unitPrice =\r\n          priceQueryPort\r\n              .findActivePriceByVariantId(variant.getId())\r\n              .orElseThrow(\r\n                  () ->\r\n                      new BadRequestException(\r\n                          \"PRICE_NOT_FOUND\",\r\n                          \"No hay precio vigente para la variante seleccionada.\"));\r\n\r\n      unitPrice = unitPrice.setScale(2, RoundingMode.HALF_UP);\r\n      BigDecimal lineTotal =\r\n          unitPrice.multiply(BigDecimal.valueOf(it.quantity())).setScale(2, RoundingMode.HALF_UP);\r\n      subtotal = subtotal.add(lineTotal);\r\n\r\n      OrderItem item =\r\n          OrderItem.builder()\r\n              .order(order)\r\n              .product(product)\r\n              .productVariant(variant)\r\n              .productName(product.getName())\r\n              .variantName(variant.getName())\r\n              .unitPrice(unitPrice)\r\n              .quantity(it.quantity())\r\n              .lineTotal(lineTotal)\r\n              .build();\r\n\r\n      order.addItem(item);\r\n    }\r\n\r\n    // 6. Totales\r\n    order.setSubtotalAmount(subtotal);\r\n    order.setTaxAmount(ZERO);\r\n    order.setDiscountAmount(ZERO);\r\n    order.setTotalAmount(subtotal);\r\n\r\n    // 7. Persistir\r\n    CustomerOrder saved = orderRepository.save(order);\r\n\r\n    // 8. Registrar en historial\r\n    String adminEmail = currentUserService.getCurrentUserEmail();\r\n    OrderStatusHistory historyEntry =\r\n        OrderStatusHistory.builder()\r\n            .orderId(saved.getId())\r\n            .fromStatus(null)\r\n            .toStatus(OrderStatus.CREATED)\r\n            .changedBy(adminEmail)\r\n            .changedAt(Instant.now())\r\n            .reason(\"Orden creada por administrador\")\r\n            .build();\r\n    statusHistoryRepository.save(historyEntry);\r\n\r\n    log.info(\r\n        \"OrderCreatedByAdmin orderId={} userEmail={} adminEmail={} items={} total={}\",\r\n        saved.getId(),\r\n        request.userEmail(),\r\n        adminEmail,\r\n        saved.getItems().size(),\r\n        saved.getTotalAmount());\r\n\r\n    // 9. Retornar response\r\n    List<OrderStatusHistory> history =\r\n        statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(saved.getId());\r\n    return OrderAdminMapper.toAdminResponse(saved, history);\r\n  }\r\n\r\n  @Override\r\n  public Page<OrderAdminResponse> getAllOrders(OrderFilterRequest filters, Pageable pageable) {\r\n    Specification<CustomerOrder> spec = buildSpecification(filters);\r\n\r\n    Page<CustomerOrder> ordersPage = orderRepository.findAll(spec, pageable);\r\n\r\n    return ordersPage.map(\r\n        order -> {\r\n          List<OrderStatusHistory> history =\r\n              statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(order.getId());\r\n          return OrderAdminMapper.toAdminResponse(order, history);\r\n        });\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse getOrderById(Long id) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(id)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + id));\r\n\r\n    List<OrderStatusHistory> history =\r\n        statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(id);\r\n\r\n    return OrderAdminMapper.toAdminResponse(order, history);\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse updateStatus(Long orderId, OrderStatus newStatus, String reason) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    OrderStatus oldStatus = order.getStatus();\r\n\r\n    // Validar transicin\r\n    OrderStatusTransition.validateTransition(oldStatus, newStatus);\r\n\r\n    // Actualizar estado\r\n    order.setStatus(newStatus);\r\n\r\n    // Si se marca como entregada, registrar timestamp\r\n    if (newStatus == OrderStatus.DELIVERED && order.getDeliveredAt() == null) {\r\n      order.setDeliveredAt(Instant.now());\r\n    }\r\n\r\n    CustomerOrder saved = orderRepository.save(order);\r\n\r\n    // Registrar en historial\r\n    String changedBy = currentUserService.getCurrentUserEmail();\r\n    OrderStatusHistory historyEntry =\r\n        OrderStatusHistory.builder()\r\n            .orderId(orderId)\r\n            .fromStatus(oldStatus)\r\n            .toStatus(newStatus)\r\n            .changedBy(changedBy)\r\n            .changedAt(Instant.now())\r\n            .reason(reason)\r\n            .build();\r\n\r\n    statusHistoryRepository.save(historyEntry);\r\n\r\n    log.info(\r\n        \"OrderStatusChanged orderId={} from={} to={} by={} reason={}\",\r\n        orderId,\r\n        oldStatus,\r\n        newStatus,\r\n        changedBy,\r\n        reason);\r\n\r\n    // Publicar evento WebSocket (convertir a OrderResponse para compatibilidad)\r\n    List<OrderStatusHistory> fullHistory =\r\n        statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(orderId);\r\n    OrderAdminResponse response = OrderAdminMapper.toAdminResponse(saved, fullHistory);\r\n\r\n    // No publicamos admin response por WebSocket, usamos la versin estndar\r\n    // orderWebSocketPublisher.publishOrderUpdated(response);\r\n\r\n    return response;\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse assignChef(Long orderId, String chefEmail) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    order.setAssignedChefEmail(chefEmail);\r\n    CustomerOrder saved = orderRepository.save(order);\r\n\r\n    String adminEmail = currentUserService.getCurrentUserEmail();\r\n    log.info(\"ChefAssigned orderId={} chefEmail={} by={}\", orderId, chefEmail, adminEmail);\r\n\r\n    List<OrderStatusHistory> history =\r\n        statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(orderId);\r\n\r\n    return OrderAdminMapper.toAdminResponse(saved, history);\r\n  }\r\n\r\n  @Override\r\n  public void deleteOrder(Long orderId) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    String deletedBy = currentUserService.getCurrentUserEmail();\r\n    order.softDelete(deletedBy);\r\n    orderRepository.save(order);\r\n\r\n    log.info(\"OrderDeleted orderId={} by={}\", orderId, deletedBy);\r\n  }\r\n\r\n  @Override\r\n  public OrderStatsResponse getStats() {\r\n    LocalDate today = LocalDate.now(ZoneId.of(\"America/Montevideo\"));\r\n    Instant startOfDay = today.atStartOfDay(ZoneId.of(\"America/Montevideo\")).toInstant();\r\n    Instant endOfDay = today.plusDays(1).atStartOfDay(ZoneId.of(\"America/Montevideo\")).toInstant();\r\n\r\n    // Conteo por estado (solo no eliminadas)\r\n    Specification<CustomerOrder> notDeleted = (root, query, cb) -> cb.isNull(root.get(\"deletedAt\"));\r\n\r\n    long totalActive = orderRepository.count(notDeleted);\r\n\r\n    Specification<CustomerOrder> created =\r\n        notDeleted.and((root, query, cb) -> cb.equal(root.get(\"status\"), OrderStatus.CREATED));\r\n    long createdCount = orderRepository.count(created);\r\n\r\n    Specification<CustomerOrder> confirmed =\r\n        notDeleted.and((root, query, cb) -> cb.equal(root.get(\"status\"), OrderStatus.CONFIRMED));\r\n    long confirmedCount = orderRepository.count(confirmed);\r\n\r\n    Specification<CustomerOrder> preparing =\r\n        notDeleted.and((root, query, cb) -> cb.equal(root.get(\"status\"), OrderStatus.PREPARING));\r\n    long preparingCount = orderRepository.count(preparing);\r\n\r\n    Specification<CustomerOrder> ready =\r\n        notDeleted.and((root, query, cb) -> cb.equal(root.get(\"status\"), OrderStatus.READY));\r\n    long readyCount = orderRepository.count(ready);\r\n\r\n    Specification<CustomerOrder> outForDelivery =\r\n        notDeleted.and(\r\n            (root, query, cb) -> cb.equal(root.get(\"status\"), OrderStatus.OUT_FOR_DELIVERY));\r\n    long outForDeliveryCount = orderRepository.count(outForDelivery);\r\n\r\n    // Entregadas hoy\r\n    Specification<CustomerOrder> deliveredToday =\r\n        (root, query, cb) ->\r\n            cb.and(\r\n                cb.equal(root.get(\"status\"), OrderStatus.DELIVERED),\r\n                cb.between(root.get(\"deliveredAt\"), startOfDay, endOfDay));\r\n    long deliveredTodayCount = orderRepository.count(deliveredToday);\r\n\r\n    // Ingresos de pedidos solicitados hoy (excluye CANCELLED)\r\n    Specification<CustomerOrder> requestedTodayActive =\r\n        notDeleted.and(\r\n            (root, query, cb) -> cb.and(cb.between(root.get(\"requestedAt\"), startOfDay, endOfDay)));\r\n    long requestedTodayActiveCount = orderRepository.count(requestedTodayActive);\r\n\r\n    // Canceladas hoy\r\n    Specification<CustomerOrder> CANCELLEDToday =\r\n        (root, query, cb) ->\r\n            cb.and(\r\n                cb.equal(root.get(\"status\"), OrderStatus.CANCELLED),\r\n                cb.between(root.get(\"updatedAt\"), startOfDay, endOfDay));\r\n    long CANCELLEDTodayCount = orderRepository.count(CANCELLEDToday);\r\n\r\n    List<CustomerOrder> requestedTodayOrders = orderRepository.findAll(requestedTodayActive);\r\n    BigDecimal revenueTotalToday =\r\n        requestedTodayOrders.stream()\r\n            .map(CustomerOrder::getTotalAmount)\r\n            .reduce(ZERO, BigDecimal::add);\r\n\r\n    // Ingresos del da (suma de totalAmount de rdenes entregadas hoy)\r\n    List<CustomerOrder> deliveredOrders = orderRepository.findAll(deliveredToday);\r\n    BigDecimal revenueDeliveredToday =\r\n        deliveredOrders.stream()\r\n            .map(CustomerOrder::getTotalAmount)\r\n            .reduce(BigDecimal.ZERO, BigDecimal::add);\r\n\r\n    // Ticket promedio\r\n    BigDecimal avgTicket = BigDecimal.ZERO;\r\n    if (requestedTodayActiveCount > 0) {\r\n      avgTicket =\r\n          revenueTotalToday.divide(\r\n              BigDecimal.valueOf(requestedTodayActiveCount), 2, java.math.RoundingMode.HALF_UP);\r\n    }\r\n\r\n    return new OrderStatsResponse(\r\n        totalActive,\r\n        createdCount,\r\n        confirmedCount,\r\n        preparingCount,\r\n        readyCount,\r\n        outForDeliveryCount,\r\n        deliveredTodayCount,\r\n        CANCELLEDTodayCount,\r\n        revenueDeliveredToday,\r\n        avgTicket,\r\n        revenueTotalToday);\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse updateItems(Long orderId, UpdateOrderItemsRequest request) {\r\n    if (request == null || request.items() == null || request.items().isEmpty()) {\r\n      throw new BadRequestException(\"ORDER_ITEMS_EMPTY\", \"Debe agregar al menos un tem.\");\r\n    }\r\n\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    ensureEditable(order);\r\n\r\n    order.getItems().clear();\r\n\r\n    BigDecimal subtotal = ZERO;\r\n\r\n    for (OrderItemRequest it : request.items()) {\r\n      if (it.quantity() <= 0) {\r\n        throw new BadRequestException(\r\n            \"INVALID_QUANTITY\", \"La cantidad de cada tem debe ser >= 1.\");\r\n      }\r\n\r\n      Product product =\r\n          productRepository\r\n              .findById(it.productId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado.\"));\r\n\r\n      ProductVariant variant =\r\n          productVariantRepository\r\n              .findById(it.productVariantId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"VARIANT_NOT_FOUND\", \"Variante no encontrada.\"));\r\n\r\n      if (variant.getProduct() == null || !variant.getProduct().getId().equals(product.getId())) {\r\n        throw new BadRequestException(\r\n            \"VARIANT_MISMATCH\", \"La variante no pertenece al producto indicado.\");\r\n      }\r\n\r\n      BigDecimal unitPrice =\r\n          priceQueryPort\r\n              .findActivePriceByVariantId(variant.getId())\r\n              .orElseThrow(\r\n                  () ->\r\n                      new BadRequestException(\r\n                          \"PRICE_NOT_FOUND\",\r\n                          \"No hay precio vigente para la variante seleccionada.\"))\r\n              .setScale(2, RoundingMode.HALF_UP);\r\n\r\n      BigDecimal lineTotal =\r\n          unitPrice.multiply(BigDecimal.valueOf(it.quantity())).setScale(2, RoundingMode.HALF_UP);\r\n      subtotal = subtotal.add(lineTotal);\r\n\r\n      OrderItem item =\r\n          OrderItem.builder()\r\n              .order(order)\r\n              .product(product)\r\n              .productVariant(variant)\r\n              .productName(product.getName())\r\n              .variantName(variant.getName())\r\n              .unitPrice(unitPrice)\r\n              .quantity(it.quantity())\r\n              .lineTotal(lineTotal)\r\n              .build();\r\n\r\n      order.addItem(item);\r\n    }\r\n\r\n    order.setSubtotalAmount(subtotal);\r\n    order.setTaxAmount(ZERO);\r\n    order.setDiscountAmount(ZERO);\r\n    order.setTotalAmount(subtotal);\r\n\r\n    CustomerOrder saved = orderRepository.save(order);\r\n    log.info(\r\n        \"OrderItemsUpdated orderId={} items={} total={}\",\r\n        orderId,\r\n        saved.getItems().size(),\r\n        subtotal);\r\n    return toAdminResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse updateDetails(Long orderId, UpdateOrderDetailsRequest request) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    ensureEditable(order);\r\n\r\n    if (request == null) {\r\n      return toAdminResponse(order);\r\n    }\r\n\r\n    FulfillmentType newFulfillment =\r\n        request.fulfillment() != null ? request.fulfillment() : order.getFulfillment();\r\n\r\n    if (request.shipping() != null && newFulfillment != FulfillmentType.DELIVERY) {\r\n      throw new BadRequestException(\r\n          \"SHIPPING_NOT_ALLOWED\", \"Solo puede agregar envo cuando fulfillment es DELIVERY.\");\r\n    }\r\n\r\n    if (newFulfillment == FulfillmentType.DELIVERY) {\r\n      var s = request.shipping();\r\n      if (s == null) {\r\n        boolean hasShippingSnapshot =\r\n            !isBlank(order.getShipName())\r\n                && !isBlank(order.getShipPhone())\r\n                && !isBlank(order.getShipLine1())\r\n                && !isBlank(order.getShipCity());\r\n        if (!hasShippingSnapshot) {\r\n          throw new BadRequestException(\r\n              \"DELIVERY_ADDRESS_REQUIRED\",\r\n              \"Complete los datos de envo (nombre, telfono, direccin y ciudad).\");\r\n        }\r\n      } else {\r\n        if (isBlank(s.name()) || isBlank(s.phone()) || isBlank(s.line1()) || isBlank(s.city())) {\r\n          throw new BadRequestException(\r\n              \"DELIVERY_ADDRESS_REQUIRED\",\r\n              \"Complete los datos de envo (nombre, telfono, direccin y ciudad).\");\r\n        }\r\n        order.setShipName(s.name());\r\n        order.setShipPhone(s.phone());\r\n        order.setShipLine1(s.line1());\r\n        order.setShipLine2(s.line2());\r\n        order.setShipCity(s.city());\r\n        order.setShipRegion(s.region());\r\n        order.setShipPostalCode(s.postalCode());\r\n        order.setShipReference(s.reference());\r\n      }\r\n    } else {\r\n      order.setShipName(null);\r\n      order.setShipPhone(null);\r\n      order.setShipLine1(null);\r\n      order.setShipLine2(null);\r\n      order.setShipCity(null);\r\n      order.setShipRegion(null);\r\n      order.setShipPostalCode(null);\r\n      order.setShipReference(null);\r\n    }\r\n\r\n    if (request.notes() != null) {\r\n      order.setNotes(request.notes());\r\n    }\r\n\r\n    if (request.requestedAt() != null) {\r\n      order.setRequestedAt(request.requestedAt());\r\n    }\r\n\r\n    order.setFulfillment(newFulfillment);\r\n\r\n    CustomerOrder saved = orderRepository.save(order);\r\n    log.info(\"OrderDetailsUpdated orderId={} fulfillment={}\", orderId, newFulfillment);\r\n    return toAdminResponse(saved);\r\n  }\r\n\r\n  @Override\r\n  public OrderAdminResponse updateCustomer(Long orderId, UpdateOrderCustomerRequest request) {\r\n    if (request == null || isBlank(request.userEmail())) {\r\n      throw new BadRequestException(\"USER_EMAIL_REQUIRED\", \"El email del cliente es obligatorio.\");\r\n    }\r\n\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    ensureEditable(order);\r\n\r\n    AppUser user =\r\n        userRepository\r\n            .findByEmail(request.userEmail())\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"USER_NOT_FOUND\",\r\n                        \"Usuario no encontrado con email: \" + request.userEmail()));\r\n\r\n    order.setUser(user);\r\n    CustomerOrder saved = orderRepository.save(order);\r\n    log.info(\"OrderCustomerUpdated orderId={} newUserEmail={}\", orderId, request.userEmail());\r\n    return toAdminResponse(saved);\r\n  }\r\n\r\n  private void ensureEditable(CustomerOrder order) {\r\n    OrderStatus status = order.getStatus();\r\n    if (status != OrderStatus.CREATED\r\n        && status != OrderStatus.CONFIRMED\r\n        && status != OrderStatus.PREPARING) {\r\n      throw new BadRequestException(\r\n          \"ORDER_NOT_EDITABLE\",\r\n          \"Solo se pueden editar rdenes en estado CREATED, CONFIRMED o PREPARING.\");\r\n    }\r\n  }\r\n\r\n  private OrderAdminResponse toAdminResponse(CustomerOrder order) {\r\n    List<OrderStatusHistory> history =\r\n        statusHistoryRepository.findByOrderIdOrderByChangedAtDesc(order.getId());\r\n    return OrderAdminMapper.toAdminResponse(order, history);\r\n  }\r\n\r\n  private Specification<CustomerOrder> buildSpecification(OrderFilterRequest filters) {\r\n    List<Specification<CustomerOrder>> specs = new ArrayList<>();\r\n\r\n    if (filters.getStatus() != null) {\r\n      specs.add((root, query, cb) -> cb.equal(root.get(\"status\"), filters.getStatus()));\r\n    }\r\n\r\n    if (filters.getUserEmail() != null && !filters.getUserEmail().isBlank()) {\r\n      specs.add(\r\n          (root, query, cb) ->\r\n              cb.like(\r\n                  cb.lower(root.get(\"user\").get(\"email\")),\r\n                  \"%\" + filters.getUserEmail().toLowerCase() + \"%\"));\r\n    }\r\n\r\n    if (filters.getAssignedChefEmail() != null && !filters.getAssignedChefEmail().isBlank()) {\r\n      specs.add(\r\n          (root, query, cb) ->\r\n              cb.like(\r\n                  cb.lower(root.get(\"assignedChefEmail\")),\r\n                  \"%\" + filters.getAssignedChefEmail().toLowerCase() + \"%\"));\r\n    }\r\n\r\n    if (filters.getCreatedAfter() != null) {\r\n      Instant start =\r\n          filters.getCreatedAfter().atStartOfDay(ZoneId.of(\"America/Montevideo\")).toInstant();\r\n      specs.add((root, query, cb) -> cb.greaterThanOrEqualTo(root.get(\"createdAt\"), start));\r\n    }\r\n\r\n    if (filters.getCreatedBefore() != null) {\r\n      Instant end =\r\n          filters\r\n              .getCreatedBefore()\r\n              .plusDays(1)\r\n              .atStartOfDay(ZoneId.of(\"America/Montevideo\"))\r\n              .toInstant();\r\n      specs.add((root, query, cb) -> cb.lessThan(root.get(\"createdAt\"), end));\r\n    }\r\n\r\n    if (filters.getMinAmount() != null) {\r\n      specs.add(\r\n          (root, query, cb) ->\r\n              cb.greaterThanOrEqualTo(root.get(\"totalAmount\"), filters.getMinAmount()));\r\n    }\r\n\r\n    if (filters.getMaxAmount() != null) {\r\n      specs.add(\r\n          (root, query, cb) ->\r\n              cb.lessThanOrEqualTo(root.get(\"totalAmount\"), filters.getMaxAmount()));\r\n    }\r\n\r\n    // Por defecto NO mostrar eliminadas\r\n    if (filters.getIncludeDeleted() == null || !filters.getIncludeDeleted()) {\r\n      specs.add((root, query, cb) -> cb.isNull(root.get(\"deletedAt\")));\r\n    }\r\n\r\n    // Combinar todas las especificaciones con AND\r\n    if (specs.isEmpty()) {\r\n      return null;\r\n    }\r\n    return specs.stream().reduce(Specification::and).orElse(null);\r\n  }\r\n\r\n  private boolean isBlank(String s) {\r\n    return s == null || s.isBlank();\r\n  }\r\n}\r\n",
      "info": {
        "size": 25873,
        "last_modified": "2026-02-01T22:28:36.8170837",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\admin\\service\\OrderAdminService.java",
      "content": "package com.cocinadelicia.backend.order.admin.service;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.admin.dto.CreateOrderAdminRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderAdminResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderFilterRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.OrderStatsResponse;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderCustomerRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderDetailsRequest;\r\nimport com.cocinadelicia.backend.order.admin.dto.UpdateOrderItemsRequest;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\n\r\npublic interface OrderAdminService {\r\n\r\n  /** Crea una orden en nombre de un cliente (Admin). */\r\n  OrderAdminResponse createOrderForUser(CreateOrderAdminRequest request);\r\n\r\n  /** Obtiene todas las rdenes con filtros avanzados. */\r\n  Page<OrderAdminResponse> getAllOrders(OrderFilterRequest filters, Pageable pageable);\r\n\r\n  /** Obtiene detalle completo de una orden (incluye datos sensibles). */\r\n  OrderAdminResponse getOrderById(Long id);\r\n\r\n  /** Actualiza el estado de una orden (Admin puede hacer cualquier transicin vlida). */\r\n  OrderAdminResponse updateStatus(Long orderId, OrderStatus newStatus, String reason);\r\n\r\n  /** Asigna un chef a una orden. */\r\n  OrderAdminResponse assignChef(Long orderId, String chefEmail);\r\n\r\n  /** Elimina una orden (soft delete). */\r\n  void deleteOrder(Long orderId);\r\n\r\n  /** Obtiene estadsticas de rdenes para dashboard. */\r\n  OrderStatsResponse getStats();\r\n\r\n  /** Reemplaza los tems de la orden y recalcula totales (solo estados editables). */\r\n  OrderAdminResponse updateItems(Long orderId, UpdateOrderItemsRequest request);\r\n\r\n  /** Actualiza notas, fulfillment, envo y requestedAt de la orden. */\r\n  OrderAdminResponse updateDetails(Long orderId, UpdateOrderDetailsRequest request);\r\n\r\n  /** Cambia el cliente asociado a la orden. */\r\n  OrderAdminResponse updateCustomer(Long orderId, UpdateOrderCustomerRequest request);\r\n}\r\n",
      "info": {
        "size": 2126,
        "last_modified": "2026-02-01T22:28:36.8240852",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\chef\\controller\\OrderChefController.java",
      "content": "package com.cocinadelicia.backend.order.chef.controller;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.chef.dto.OrderChefResponse;\r\nimport com.cocinadelicia.backend.order.chef.service.OrderChefService;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.Parameter;\r\nimport io.swagger.v3.oas.annotations.security.SecurityRequirement;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springdoc.core.annotations.ParameterObject;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.domain.Sort;\r\nimport org.springframework.data.web.PageableDefault;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.security.access.prepost.PreAuthorize;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/chef/orders\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"Chef Orders\", description = \"Gestin de pedidos para chefs\")\r\n@SecurityRequirement(name = \"bearer-jwt\")\r\n@PreAuthorize(\"hasRole('CHEF')\")\r\npublic class OrderChefController {\r\n\r\n  private final OrderChefService orderChefService;\r\n\r\n  @GetMapping\r\n  @Operation(\r\n      summary = \"Obtener rdenes asignadas al chef\",\r\n      description = \"Lista todas las rdenes asignadas al chef autenticado\")\r\n  public ResponseEntity<Page<OrderChefResponse>> getAssignedOrders(\r\n      @ParameterObject\r\n          @PageableDefault(size = 20, sort = \"createdAt\", direction = Sort.Direction.DESC)\r\n          Pageable pageable) {\r\n    return ResponseEntity.ok(orderChefService.getAssignedOrders(pageable));\r\n  }\r\n\r\n  @GetMapping(\"/active\")\r\n  @Operation(\r\n      summary = \"Obtener rdenes activas\",\r\n      description =\r\n          \"Lista solo las rdenes en estados CONFIRMED, PREPARING, READY asignadas al chef\")\r\n  public ResponseEntity<Page<OrderChefResponse>> getActiveOrders(\r\n      @ParameterObject\r\n          @PageableDefault(size = 20, sort = \"createdAt\", direction = Sort.Direction.ASC)\r\n          Pageable pageable) {\r\n    return ResponseEntity.ok(orderChefService.getActiveOrders(pageable));\r\n  }\r\n\r\n  @PatchMapping(\"/{id}/status\")\r\n  @Operation(\r\n      summary = \"Actualizar estado de una orden\",\r\n      description = \"Chef solo puede cambiar de CONFIRMED  PREPARING o PREPARING  READY\")\r\n  public ResponseEntity<OrderChefResponse> updateStatus(\r\n      @PathVariable Long id,\r\n      @Parameter(description = \"Nuevo estado\", required = true) @RequestParam OrderStatus status) {\r\n    return ResponseEntity.ok(orderChefService.updateStatus(id, status));\r\n  }\r\n}\r\n",
      "info": {
        "size": 2694,
        "last_modified": "2026-02-01T22:28:36.8350867",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\chef\\dto\\OrderChefResponse.java",
      "content": "package com.cocinadelicia.backend.order.chef.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Respuesta de orden para chef (informacin esencial de preparacin)\")\r\npublic record OrderChefResponse(\r\n    @Schema(description = \"ID del pedido\", example = \"42\") Long id,\r\n    @Schema(description = \"Estado actual\", example = \"PREPARING\") OrderStatus status,\r\n    @Schema(description = \"Notas especiales del pedido\") String notes,\r\n    @Schema(description = \"tems a preparar\") List<OrderItemResponse> items,\r\n    @Schema(description = \"Fecha de creacin\") Instant createdAt,\r\n    @Schema(description = \"Fecha de ltima actualizacin\") Instant updatedAt,\r\n    @Schema(description = \"Hora solicitada de entrega/retiro\") Instant requestedAt) {}\r\n",
      "info": {
        "size": 960,
        "last_modified": "2026-02-01T22:28:36.8425929",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\chef\\mapper\\OrderChefMapper.java",
      "content": "package com.cocinadelicia.backend.order.chef.mapper;\r\n\r\nimport com.cocinadelicia.backend.order.chef.dto.OrderChefResponse;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderItem;\r\nimport java.util.List;\r\n\r\npublic final class OrderChefMapper {\r\n\r\n  private OrderChefMapper() {}\r\n\r\n  public static OrderChefResponse toChefResponse(CustomerOrder order) {\r\n    List<OrderItemResponse> itemDtos =\r\n        order.getItems().stream().map(OrderChefMapper::toItemResponse).toList();\r\n\r\n    return new OrderChefResponse(\r\n        order.getId(),\r\n        order.getStatus(),\r\n        order.getNotes(),\r\n        itemDtos,\r\n        order.getCreatedAt(),\r\n        order.getUpdatedAt(),\r\n        order.getRequestedAt());\r\n  }\r\n\r\n  private static OrderItemResponse toItemResponse(OrderItem item) {\r\n    return new OrderItemResponse(\r\n        item.getId(),\r\n        item.getProduct().getId(),\r\n        item.getProductVariant().getId(),\r\n        item.getProductName(),\r\n        item.getVariantName(),\r\n        item.getUnitPrice(),\r\n        item.getQuantity(),\r\n        item.getLineTotal());\r\n  }\r\n}\r\n",
      "info": {
        "size": 1206,
        "last_modified": "2026-02-01T22:28:36.8495926",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\chef\\service\\impl\\OrderChefServiceImpl.java",
      "content": "package com.cocinadelicia.backend.order.chef.service.impl;\r\n\r\nimport com.cocinadelicia.backend.common.exception.ForbiddenException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.chef.dto.OrderChefResponse;\r\nimport com.cocinadelicia.backend.order.chef.mapper.OrderChefMapper;\r\nimport com.cocinadelicia.backend.order.chef.service.OrderChefService;\r\nimport com.cocinadelicia.backend.order.domain.OrderStatusTransition;\r\nimport com.cocinadelicia.backend.order.events.OrderWebSocketPublisher;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderStatusHistory;\r\nimport com.cocinadelicia.backend.order.repository.CustomerOrderRepository;\r\nimport com.cocinadelicia.backend.order.repository.OrderStatusHistoryRepository;\r\nimport com.cocinadelicia.backend.user.service.CurrentUserService;\r\nimport jakarta.transaction.Transactional;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.jpa.domain.Specification;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Log4j2\r\n@Service\r\n@RequiredArgsConstructor\r\n@Transactional\r\npublic class OrderChefServiceImpl implements OrderChefService {\r\n\r\n  private final CustomerOrderRepository orderRepository;\r\n  private final OrderStatusHistoryRepository statusHistoryRepository;\r\n  private final CurrentUserService currentUserService;\r\n  private final OrderWebSocketPublisher orderWebSocketPublisher;\r\n\r\n  @Override\r\n  public Page<OrderChefResponse> getAssignedOrders(Pageable pageable) {\r\n    String chefEmail = currentUserService.getCurrentUserEmail();\r\n\r\n    Specification<CustomerOrder> spec =\r\n        (root, query, cb) ->\r\n            cb.and(\r\n                cb.equal(root.get(\"assignedChefEmail\"), chefEmail),\r\n                cb.isNull(root.get(\"deletedAt\")));\r\n\r\n    Page<CustomerOrder> orders = orderRepository.findAll(spec, pageable);\r\n\r\n    return orders.map(OrderChefMapper::toChefResponse);\r\n  }\r\n\r\n  @Override\r\n  public Page<OrderChefResponse> getActiveOrders(Pageable pageable) {\r\n    String chefEmail = currentUserService.getCurrentUserEmail();\r\n\r\n    List<OrderStatus> activeStatuses =\r\n        List.of(OrderStatus.CONFIRMED, OrderStatus.PREPARING, OrderStatus.READY);\r\n\r\n    Specification<CustomerOrder> spec =\r\n        (root, query, cb) ->\r\n            cb.and(\r\n                cb.equal(root.get(\"assignedChefEmail\"), chefEmail),\r\n                root.get(\"status\").in(activeStatuses),\r\n                cb.isNull(root.get(\"deletedAt\")));\r\n\r\n    Page<CustomerOrder> orders = orderRepository.findAll(spec, pageable);\r\n\r\n    return orders.map(OrderChefMapper::toChefResponse);\r\n  }\r\n\r\n  @Override\r\n  public OrderChefResponse updateStatus(Long orderId, OrderStatus newStatus) {\r\n    String chefEmail = currentUserService.getCurrentUserEmail();\r\n\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    // Validar que la orden est asignada al chef actual\r\n    if (order.getAssignedChefEmail() == null || !order.getAssignedChefEmail().equals(chefEmail)) {\r\n      throw new ForbiddenException(\"This order is not assigned to you\");\r\n    }\r\n\r\n    OrderStatus oldStatus = order.getStatus();\r\n\r\n    // Validar que el chef puede hacer esta transicin\r\n    OrderStatusTransition.validateChefTransition(oldStatus, newStatus);\r\n\r\n    // Actualizar estado\r\n    order.setStatus(newStatus);\r\n    CustomerOrder saved = orderRepository.save(order);\r\n\r\n    // Registrar en historial\r\n    OrderStatusHistory historyEntry =\r\n        OrderStatusHistory.builder()\r\n            .orderId(orderId)\r\n            .fromStatus(oldStatus)\r\n            .toStatus(newStatus)\r\n            .changedBy(chefEmail)\r\n            .changedAt(Instant.now())\r\n            .reason(\"Chef status update\")\r\n            .build();\r\n\r\n    statusHistoryRepository.save(historyEntry);\r\n\r\n    log.info(\r\n        \"ChefOrderStatusChanged orderId={} from={} to={} by={}\",\r\n        orderId,\r\n        oldStatus,\r\n        newStatus,\r\n        chefEmail);\r\n\r\n    // Retornar response\r\n    OrderChefResponse response = OrderChefMapper.toChefResponse(saved);\r\n\r\n    return response;\r\n  }\r\n}\r\n",
      "info": {
        "size": 4503,
        "last_modified": "2026-02-01T22:28:36.8575929",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\chef\\service\\OrderChefService.java",
      "content": "package com.cocinadelicia.backend.order.chef.service;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.chef.dto.OrderChefResponse;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\n\r\npublic interface OrderChefService {\r\n\r\n  /** Obtiene rdenes asignadas al chef actual. */\r\n  Page<OrderChefResponse> getAssignedOrders(Pageable pageable);\r\n\r\n  /** Obtiene solo rdenes activas (CONFIRMED, PREPARING, READY). */\r\n  Page<OrderChefResponse> getActiveOrders(Pageable pageable);\r\n\r\n  /** Actualiza el estado de una orden (Chef solo puede hacer transiciones permitidas). */\r\n  OrderChefResponse updateStatus(Long orderId, OrderStatus newStatus);\r\n}\r\n",
      "info": {
        "size": 751,
        "last_modified": "2026-02-01T22:28:36.8645929",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\controller\\OrderController.java",
      "content": "package com.cocinadelicia.backend.order.controller;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.common.web.ApiError;\r\nimport com.cocinadelicia.backend.order.domain.OrderOwnershipValidator;\r\nimport com.cocinadelicia.backend.order.dto.CreateOrderRequest;\r\nimport com.cocinadelicia.backend.order.dto.OrderCancelRequest;\r\nimport com.cocinadelicia.backend.order.dto.OrderFilter;\r\nimport com.cocinadelicia.backend.order.dto.OrderPageResponse;\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\nimport com.cocinadelicia.backend.order.dto.UpdateOrderStatusRequest;\r\nimport com.cocinadelicia.backend.order.service.OrderService;\r\nimport com.cocinadelicia.backend.user.service.CurrentUserService;\r\nimport com.cocinadelicia.backend.user.service.UserService;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.Parameter;\r\nimport io.swagger.v3.oas.annotations.media.Content;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport io.swagger.v3.oas.annotations.responses.ApiResponse;\r\nimport io.swagger.v3.oas.annotations.security.SecurityRequirement;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport jakarta.validation.Valid;\r\nimport java.time.LocalDate;\r\nimport java.time.format.DateTimeParseException;\r\nimport java.util.Arrays;\r\nimport java.util.List;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springdoc.core.annotations.ParameterObject;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.PageRequest;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.domain.Sort;\r\nimport org.springframework.data.web.PageableDefault;\r\nimport org.springframework.http.HttpStatus;\r\nimport org.springframework.http.ResponseEntity;\r\nimport org.springframework.security.access.prepost.PreAuthorize;\r\nimport org.springframework.security.core.annotation.AuthenticationPrincipal;\r\nimport org.springframework.security.oauth2.jwt.Jwt;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@Log4j2\r\n@RestController\r\n@RequestMapping(\"/api/orders\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"orders\", description = \"Operaciones de pedidos del usuario autenticado y backoffice\")\r\n@SecurityRequirement(name = \"bearer-jwt\")\r\npublic class OrderController {\r\n\r\n  private final OrderService orderService;\r\n  private final UserService userService;\r\n  private final CurrentUserService currentUserService;\r\n  private final OrderOwnershipValidator ownershipValidator;\r\n\r\n  // ---------- Cliente autenticado ----------\r\n  @Operation(\r\n      summary = \"Crear un nuevo pedido\",\r\n      description =\r\n          \"\"\"\r\n        Crea un nuevo pedido asociado al usuario autenticado (Cognito).\r\n        Requiere token JWT vlido. El subtotal y total se calculan en base a los precios vigentes de cada variante.\r\n        \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"201\",\r\n            description = \"Pedido creado correctamente\",\r\n            content = @Content(schema = @Schema(implementation = OrderResponse.class))),\r\n        @ApiResponse(\r\n            responseCode = \"400\",\r\n            description = \"Request invlido (validacin de negocio o @Valid)\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(responseCode = \"401\", description = \"No autenticado\")\r\n      })\r\n  @PostMapping\r\n  public ResponseEntity<OrderResponse> createOrder(\r\n      @AuthenticationPrincipal Jwt jwt, @Valid @RequestBody CreateOrderRequest request) {\r\n    Long appUserId = currentUserService.getOrCreateCurrentUserId();\r\n    return ResponseEntity.status(HttpStatus.CREATED)\r\n        .body(orderService.createOrder(request, appUserId));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Obtener detalle de un pedido propio\",\r\n      description =\r\n          \"\"\"\r\n        Devuelve el detalle de un pedido perteneciente al usuario autenticado.\r\n        Si el pedido no existe o no pertenece al usuario, devuelve 404.\r\n        SEGURIDAD: Validacin de ownership implementada.\r\n        \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pedido encontrado\",\r\n            content = @Content(schema = @Schema(implementation = OrderResponse.class))),\r\n        @ApiResponse(\r\n            responseCode = \"404\",\r\n            description = \"Pedido no encontrado o no pertenece al usuario\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"403\",\r\n            description = \"Sin permisos para acceder a este pedido\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class)))\r\n      })\r\n  @GetMapping(\"/{id}\")\r\n  public ResponseEntity<OrderResponse> getOrderById(\r\n      @AuthenticationPrincipal Jwt jwt, @PathVariable Long id) {\r\n    Long appUserId = userService.resolveUserIdFromJwt(jwt);\r\n\r\n    // CRTICO: Validar ownership antes de retornar\r\n    ownershipValidator.validateOwnershipAndNotDeleted(id, appUserId);\r\n\r\n    return ResponseEntity.ok(orderService.getOrderById(id, appUserId));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Obtener pedido activo actual\",\r\n      description =\r\n          \"Devuelve el pedido activo (no DELIVERED ni CANCELLED) ms reciente del usuario\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pedido activo encontrado\",\r\n            content = @Content(schema = @Schema(implementation = OrderResponse.class))),\r\n        @ApiResponse(responseCode = \"204\", description = \"No hay pedidos activos\")\r\n      })\r\n  @GetMapping(\"/current\")\r\n  public ResponseEntity<OrderResponse> getCurrentOrder(@AuthenticationPrincipal Jwt jwt) {\r\n    Long appUserId = currentUserService.getOrCreateCurrentUserId();\r\n    return orderService\r\n        .getCurrentOrder(appUserId)\r\n        .map(ResponseEntity::ok)\r\n        .orElse(ResponseEntity.noContent().build());\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Obtener historial de pedidos\",\r\n      description = \"Lista paginada de todos los pedidos del usuario (incluye finalizados)\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Historial de pedidos\",\r\n            content = @Content(schema = @Schema(implementation = Page.class)))\r\n      })\r\n  @GetMapping(\"/history\")\r\n  public ResponseEntity<Page<OrderResponse>> getOrderHistory(\r\n      @AuthenticationPrincipal Jwt jwt,\r\n      @ParameterObject\r\n          @PageableDefault(size = 10, sort = \"createdAt\", direction = Sort.Direction.DESC)\r\n          Pageable pageable) {\r\n    Long appUserId = currentUserService.getOrCreateCurrentUserId();\r\n    return ResponseEntity.ok(orderService.getMyOrders(appUserId, pageable));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Listar mis pedidos\",\r\n      description =\r\n          \"\"\"\r\n        Lista paginada de pedidos del usuario autenticado, ordenados por defecto por createdAt DESC.\r\n        \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pgina de pedidos del usuario\",\r\n            content = @Content(schema = @Schema(implementation = Page.class)))\r\n      })\r\n  @GetMapping(\"/mine\")\r\n  public ResponseEntity<Page<OrderResponse>> getMyOrders(\r\n      @AuthenticationPrincipal Jwt jwt,\r\n      @ParameterObject\r\n          @PageableDefault(size = 10, sort = \"createdAt\", direction = Sort.Direction.DESC)\r\n          Pageable pageable) {\r\n    Long appUserId = currentUserService.getOrCreateCurrentUserId();\r\n    return ResponseEntity.ok(orderService.getMyOrders(appUserId, pageable));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Cancelar un pedido\",\r\n      description =\r\n          \"\"\"\r\n        Permite al cliente cancelar su pedido. Solo se pueden cancelar pedidos en estado CREATED o CONFIRMED.\r\n        \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pedido cancelado exitosamente\",\r\n            content = @Content(schema = @Schema(implementation = OrderResponse.class))),\r\n        @ApiResponse(\r\n            responseCode = \"400\",\r\n            description = \"No se puede cancelar el pedido en su estado actual\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"404\",\r\n            description = \"Pedido no encontrado\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"403\",\r\n            description = \"Sin permisos para cancelar este pedido\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class)))\r\n      })\r\n  @PatchMapping(\"/{id}/cancel\")\r\n  public ResponseEntity<OrderResponse> cancelOrder(\r\n      @AuthenticationPrincipal Jwt jwt,\r\n      @PathVariable Long id,\r\n      @Valid @RequestBody OrderCancelRequest request) {\r\n    Long appUserId = currentUserService.getOrCreateCurrentUserId();\r\n\r\n    // Validar ownership\r\n    ownershipValidator.validateOwnershipAndNotDeleted(id, appUserId);\r\n\r\n    String reason = request != null ? request.reason() : null;\r\n    return ResponseEntity.ok(orderService.cancelOrder(id, reason, appUserId));\r\n  }\r\n\r\n  // ---------- Staff (ADMIN o CHEF) ----------\r\n  @Operation(\r\n      summary = \"Listar pedidos para backoffice / vista Chef\",\r\n      description =\r\n          \"\"\"\r\n      Lista paginada de pedidos para backoffice (Admin/Chef).\r\n\r\n      Casos de uso:\r\n      - Vista administrativa general.\r\n      - Vista de Chef con filtros por estado y fecha.\r\n\r\n      Filtros opcionales:\r\n      - status: lista CSV de estados (CREATED, PREPARING, READY, etc.).\r\n      - from / to: fechas YYYY-MM-DD (ambas inclusivas, zona America/Montevideo).\r\n      \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Pgina de pedidos filtrados\",\r\n            content = @Content(schema = @Schema(implementation = OrderPageResponse.class))),\r\n        @ApiResponse(\r\n            responseCode = \"400\",\r\n            description = \"Filtro invlido (status o fecha con formato incorrecto)\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"403\",\r\n            description = \"Sin permisos (requiere rol ADMIN o CHEF)\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"401\",\r\n            description = \"No autenticado\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class)))\r\n      })\r\n  @GetMapping({\"/ops\", \"/admin\", \"/chef\"})\r\n  @PreAuthorize(\"hasRole('ADMIN') or hasRole('CHEF')\")\r\n  public ResponseEntity<OrderPageResponse<OrderResponse>> listForBackoffice(\r\n      @AuthenticationPrincipal Jwt jwt,\r\n      @Parameter(\r\n              description =\r\n                  \"Estados CSV. Ej: CREATED,PREPARING,READY. Usa valores del enum OrderStatus.\",\r\n              example = \"PREPARING,READY\")\r\n          @RequestParam(name = \"status\", required = false)\r\n          String statusCsv,\r\n      @Parameter(\r\n              description = \"Fecha desde (inclusive), formato YYYY-MM-DD.\",\r\n              example = \"2025-11-01\")\r\n          @RequestParam(name = \"from\", required = false)\r\n          String fromStr,\r\n      @Parameter(\r\n              description = \"Fecha hasta (inclusive), formato YYYY-MM-DD.\",\r\n              example = \"2025-11-30\")\r\n          @RequestParam(name = \"to\", required = false)\r\n          String toStr,\r\n      @ParameterObject\r\n          @PageableDefault(size = 20, sort = \"createdAt\", direction = Sort.Direction.DESC)\r\n          Pageable pageable) {\r\n\r\n    Pageable safe = safePageable(pageable, 50);\r\n    List<OrderStatus> statuses = parseStatuses(statusCsv);\r\n    LocalDate from = parseDate(fromStr);\r\n    LocalDate to = parseDate(toStr);\r\n\r\n    String performer = jwt.getClaimAsString(\"email\");\r\n    if (performer == null || performer.isBlank()) {\r\n      performer = jwt.getSubject();\r\n    }\r\n\r\n    log.info(\r\n        \"ChefOrdersList performer={} statusFilter={} from={} to={} page={} size={}\",\r\n        performer,\r\n        statuses,\r\n        from,\r\n        to,\r\n        safe.getPageNumber(),\r\n        safe.getPageSize());\r\n\r\n    var filter = new OrderFilter(statuses, from, to, null);\r\n    var page = orderService.findOrders(filter, safe);\r\n    return ResponseEntity.ok(OrderPageResponse.from(page));\r\n  }\r\n\r\n  @Operation(\r\n      summary = \"Cambiar estado de un pedido (ADMIN o CHEF)\",\r\n      description =\r\n          \"\"\"\r\n      Cambia el estado de un pedido existente. Requiere rol ADMIN o CHEF.\r\n\r\n      Estados vlidos (enum OrderStatus):\r\n      - CREATED\r\n      - CONFIRMED\r\n      - PREPARING\r\n      - READY\r\n      - OUT_FOR_DELIVERY\r\n      - DELIVERED\r\n      - CANCELLED\r\n\r\n      Las transiciones vlidas se validan en el backend.\r\n      Ejemplos tpicos:\r\n      - CREATED -> PREPARING (vlida)\r\n      - PREPARING -> READY (vlida)\r\n      - READY -> DELIVERED (vlida)\r\n      - CREATED -> DELIVERED (invlida  400 INVALID_STATUS_TRANSITION)\r\n      \"\"\",\r\n      responses = {\r\n        @ApiResponse(\r\n            responseCode = \"200\",\r\n            description = \"Estado actualizado correctamente\",\r\n            content = @Content(schema = @Schema(implementation = OrderResponse.class))),\r\n        @ApiResponse(\r\n            responseCode = \"400\",\r\n            description = \"Transicin invlida o request invlido\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"404\",\r\n            description = \"Pedido no encontrado\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"403\",\r\n            description = \"Sin permisos (requiere rol ADMIN o CHEF)\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class))),\r\n        @ApiResponse(\r\n            responseCode = \"401\",\r\n            description = \"No autenticado\",\r\n            content = @Content(schema = @Schema(implementation = ApiError.class)))\r\n      })\r\n  @PatchMapping(\"/{id}/status\")\r\n  @PreAuthorize(\"hasRole('ADMIN') or hasRole('CHEF')\")\r\n  public ResponseEntity<OrderResponse> updateStatus(\r\n      @AuthenticationPrincipal Jwt jwt,\r\n      @PathVariable Long id,\r\n      @Valid @RequestBody UpdateOrderStatusRequest body) {\r\n    String performer = jwt.getClaimAsString(\"email\");\r\n    if (performer == null || performer.isBlank()) {\r\n      performer = jwt.getSubject();\r\n    }\r\n    return ResponseEntity.ok(orderService.updateStatus(id, performer, body));\r\n  }\r\n\r\n  // ---------- Helpers ----------\r\n  private Long resolveAppUserId(Jwt jwt) {\r\n    return userService.resolveUserIdFromJwt(jwt);\r\n  }\r\n\r\n  private Pageable safePageable(Pageable pageable, int maxSize) {\r\n    int size = Math.min(pageable.getPageSize(), maxSize);\r\n    return PageRequest.of(pageable.getPageNumber(), size, pageable.getSort());\r\n  }\r\n\r\n  private List<OrderStatus> parseStatuses(String statusCsv) {\r\n    if (statusCsv == null || statusCsv.isBlank()) return null;\r\n    try {\r\n      return Arrays.stream(statusCsv.split(\",\"))\r\n          .map(String::trim)\r\n          .filter(s -> !s.isBlank())\r\n          .map(String::toUpperCase)\r\n          .map(OrderStatus::valueOf)\r\n          .distinct()\r\n          .toList();\r\n    } catch (IllegalArgumentException ex) {\r\n      throw new BadRequestException(\r\n          \"INVALID_STATUS\", \"Algn estado no es vlido. Use valores del enum OrderStatus.\");\r\n    }\r\n  }\r\n\r\n  private LocalDate parseDate(String value) {\r\n    if (value == null || value.isBlank()) return null;\r\n    try {\r\n      return LocalDate.parse(value);\r\n    } catch (DateTimeParseException ex) {\r\n      throw new BadRequestException(\"INVALID_DATE\", \"Las fechas deben tener formato YYYY-MM-DD.\");\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 16106,
        "last_modified": "2026-02-01T22:28:36.8755927",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\domain\\OrderOwnershipValidator.java",
      "content": "package com.cocinadelicia.backend.order.domain;\r\n\r\nimport com.cocinadelicia.backend.common.exception.ForbiddenException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.repository.CustomerOrderRepository;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.stereotype.Component;\r\n\r\n/**\r\n * Validador de ownership de rdenes. CRTICO: Previene que usuarios accedan a rdenes de otros\r\n * usuarios.\r\n */\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class OrderOwnershipValidator {\r\n\r\n  private final CustomerOrderRepository orderRepository;\r\n\r\n  /**\r\n   * Valida que el usuario actual es dueo de la orden.\r\n   *\r\n   * @param orderId ID de la orden\r\n   * @param appUserId ID del usuario actual\r\n   * @throws NotFoundException si la orden no existe\r\n   * @throws ForbiddenException si el usuario no es dueo\r\n   */\r\n  public void validateOwnership(Long orderId, Long appUserId) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    if (!order.getUser().getId().equals(appUserId)) {\r\n      throw new ForbiddenException(\"You don't have permission to access this order\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida ownership y que la orden no est eliminada.\r\n   *\r\n   * @param orderId ID de la orden\r\n   * @param appUserId ID del usuario actual\r\n   * @throws NotFoundException si la orden no existe o est eliminada\r\n   * @throws ForbiddenException si el usuario no es dueo\r\n   */\r\n  public void validateOwnershipAndNotDeleted(Long orderId, Long appUserId) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    if (order.isDeleted()) {\r\n      throw new NotFoundException(\"Order not found with id: \" + orderId);\r\n    }\r\n\r\n    if (!order.getUser().getId().equals(appUserId)) {\r\n      throw new ForbiddenException(\"You don't have permission to access this order\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Obtiene orden validando ownership.\r\n   *\r\n   * @param orderId ID de la orden\r\n   * @param appUserId ID del usuario actual\r\n   * @return La orden si existe y pertenece al usuario\r\n   * @throws NotFoundException si la orden no existe\r\n   * @throws ForbiddenException si el usuario no es dueo\r\n   */\r\n  public CustomerOrder getOrderWithOwnership(Long orderId, Long appUserId) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    if (!order.getUser().getId().equals(appUserId)) {\r\n      throw new ForbiddenException(\"You don't have permission to access this order\");\r\n    }\r\n\r\n    return order;\r\n  }\r\n\r\n  /**\r\n   * Obtiene orden validando ownership y que no est eliminada.\r\n   *\r\n   * @param orderId ID de la orden\r\n   * @param appUserId ID del usuario actual\r\n   * @return La orden si existe, pertenece al usuario y no est eliminada\r\n   * @throws NotFoundException si la orden no existe o est eliminada\r\n   * @throws ForbiddenException si el usuario no es dueo\r\n   */\r\n  public CustomerOrder getOrderWithOwnershipAndNotDeleted(Long orderId, Long appUserId) {\r\n    CustomerOrder order =\r\n        orderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"Order not found with id: \" + orderId));\r\n\r\n    if (order.isDeleted()) {\r\n      throw new NotFoundException(\"Order not found with id: \" + orderId);\r\n    }\r\n\r\n    if (!order.getUser().getId().equals(appUserId)) {\r\n      throw new ForbiddenException(\"You don't have permission to access this order\");\r\n    }\r\n\r\n    return order;\r\n  }\r\n}\r\n",
      "info": {
        "size": 3867,
        "last_modified": "2026-02-01T22:28:36.8835924",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\domain\\OrderStatusTransition.java",
      "content": "package com.cocinadelicia.backend.order.domain;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport java.util.EnumSet;\r\nimport java.util.Map;\r\nimport java.util.Set;\r\nimport lombok.extern.log4j.Log4j2;\r\n\r\n/**\r\n * Mquina de estados para transiciones de OrderStatus. Define qu transiciones son vlidas y para\r\n * qu roles.\r\n */\r\n@Log4j2\r\npublic class OrderStatusTransition {\r\n\r\n  // Transiciones vlidas globales\r\n  private static final Map<OrderStatus, Set<OrderStatus>> ALLOWED_TRANSITIONS =\r\n      Map.of(\r\n          OrderStatus.CREATED, EnumSet.of(OrderStatus.CONFIRMED, OrderStatus.CANCELLED),\r\n          OrderStatus.CONFIRMED, EnumSet.of(OrderStatus.PREPARING, OrderStatus.CANCELLED),\r\n          OrderStatus.PREPARING, EnumSet.of(OrderStatus.READY, OrderStatus.CANCELLED),\r\n          OrderStatus.READY,\r\n              EnumSet.of(\r\n                  OrderStatus.OUT_FOR_DELIVERY, OrderStatus.DELIVERED, OrderStatus.CANCELLED),\r\n          OrderStatus.OUT_FOR_DELIVERY, EnumSet.of(OrderStatus.DELIVERED, OrderStatus.CANCELLED),\r\n          OrderStatus.DELIVERED, EnumSet.noneOf(OrderStatus.class),\r\n          OrderStatus.CANCELLED, EnumSet.noneOf(OrderStatus.class));\r\n\r\n  // Transiciones permitidas para CLIENTE (solo cancelar)\r\n  private static final Map<OrderStatus, Set<OrderStatus>> CLIENT_TRANSITIONS =\r\n      Map.of(\r\n          OrderStatus.CREATED, EnumSet.of(OrderStatus.CANCELLED),\r\n          OrderStatus.CONFIRMED, EnumSet.of(OrderStatus.CANCELLED));\r\n\r\n  // Transiciones permitidas para CHEF (preparacin)\r\n  private static final Map<OrderStatus, Set<OrderStatus>> CHEF_TRANSITIONS =\r\n      Map.of(\r\n          OrderStatus.CONFIRMED, EnumSet.of(OrderStatus.PREPARING),\r\n          OrderStatus.PREPARING, EnumSet.of(OrderStatus.READY));\r\n\r\n  /**\r\n   * Valida que la transicin sea permitida globalmente.\r\n   *\r\n   * @throws BadRequestException si la transicin no es vlida\r\n   */\r\n  public static void validateTransition(OrderStatus from, OrderStatus to) {\r\n    Set<OrderStatus> allowedStates =\r\n        ALLOWED_TRANSITIONS.getOrDefault(from, EnumSet.noneOf(OrderStatus.class));\r\n\r\n    if (!allowedStates.contains(to)) {\r\n      throw new BadRequestException(\r\n          String.format(\r\n              \"INVALID_STATUS_TRANSITION\", \"Invalid status transition from %s to %s\", from, to));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida que un cliente pueda hacer esta transicin.\r\n   *\r\n   * @throws BadRequestException si el cliente no puede hacer la transicin\r\n   */\r\n  public static void validateClientTransition(OrderStatus from, OrderStatus to) {\r\n    Set<OrderStatus> allowedStates =\r\n        CLIENT_TRANSITIONS.getOrDefault(from, EnumSet.noneOf(OrderStatus.class));\r\n\r\n    if (!allowedStates.contains(to)) {\r\n      throw new BadRequestException(\r\n          String.format(\r\n              \"FORBIDDEN_TRANSITION\", \"Client cannot transition order from %s to %s\", from, to));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Valida que un chef pueda hacer esta transicin.\r\n   *\r\n   * @throws BadRequestException si el chef no puede hacer la transicin\r\n   */\r\n  public static void validateChefTransition(OrderStatus from, OrderStatus to) {\r\n    Set<OrderStatus> allowedStates =\r\n        CHEF_TRANSITIONS.getOrDefault(from, EnumSet.noneOf(OrderStatus.class));\r\n\r\n    if (!allowedStates.contains(to)) {\r\n      throw new BadRequestException(\r\n          String.format(\r\n              \"FORBIDDEN_TRANSITION\", \"Chef cannot transition order from %s to %s\", from, to));\r\n    }\r\n  }\r\n\r\n  /** Verifica si el cliente puede cancelar la orden en el estado actual. */\r\n  public static boolean canClientCancel(OrderStatus status) {\r\n    return status == OrderStatus.CREATED || status == OrderStatus.CONFIRMED;\r\n  }\r\n\r\n  /** Verifica si el estado es terminal (no permite ms transiciones). */\r\n  public static boolean isTerminalStatus(OrderStatus status) {\r\n    return status == OrderStatus.DELIVERED || status == OrderStatus.CANCELLED;\r\n  }\r\n\r\n  /** Obtiene los estados permitidos desde el estado actual. */\r\n  public static Set<OrderStatus> getAllowedNextStates(OrderStatus current) {\r\n    return ALLOWED_TRANSITIONS.getOrDefault(current, EnumSet.noneOf(OrderStatus.class));\r\n  }\r\n}\r\n",
      "info": {
        "size": 4255,
        "last_modified": "2026-02-01T22:28:36.8875925",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\domain\\OrderStatusTransitionValidator.java",
      "content": "// src/main/java/com/cocinadelicia/backend/order/domain/OrderStatusTransitionValidator.java\r\npackage com.cocinadelicia.backend.order.domain;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport java.util.EnumMap;\r\nimport java.util.EnumSet;\r\nimport java.util.Map;\r\nimport java.util.Set;\r\n\r\npublic final class OrderStatusTransitionValidator {\r\n\r\n  private static final Map<OrderStatus, Set<OrderStatus>> ALLOWED =\r\n      new EnumMap<>(OrderStatus.class);\r\n\r\n  static {\r\n    // MVP del sprint (sin CONFIRMED y sin OUT_FOR_DELIVERY en UI, pero dejamos habilitado hacia\r\n    // DELIVERED)\r\n    ALLOWED.put(OrderStatus.CREATED, EnumSet.of(OrderStatus.PREPARING, OrderStatus.CANCELLED));\r\n    ALLOWED.put(OrderStatus.PREPARING, EnumSet.of(OrderStatus.READY, OrderStatus.CANCELLED));\r\n    ALLOWED.put(OrderStatus.READY, EnumSet.of(OrderStatus.DELIVERED, OrderStatus.OUT_FOR_DELIVERY));\r\n    // Estados terminales o que no usamos en este sprint\r\n    ALLOWED.put(OrderStatus.DELIVERED, EnumSet.noneOf(OrderStatus.class));\r\n    ALLOWED.put(OrderStatus.CANCELLED, EnumSet.noneOf(OrderStatus.class));\r\n    ALLOWED.put(OrderStatus.CONFIRMED, EnumSet.of(OrderStatus.PREPARING, OrderStatus.CANCELLED));\r\n    ALLOWED.put(OrderStatus.OUT_FOR_DELIVERY, EnumSet.of(OrderStatus.DELIVERED));\r\n  }\r\n\r\n  private OrderStatusTransitionValidator() {}\r\n\r\n  public static void validateOrThrow(OrderStatus current, OrderStatus next) {\r\n    var allowed = ALLOWED.getOrDefault(current, Set.of());\r\n    if (!allowed.contains(next)) {\r\n      // Code estandarizado para front/toasts y tests\r\n      throw new BadRequestException(\r\n          \"INVALID_STATUS_TRANSITION\", \"No se puede pasar de \" + current + \" a \" + next);\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 1796,
        "last_modified": "2026-02-01T22:28:36.8915929",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\CreateOrderRequest.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.Valid;\r\nimport jakarta.validation.constraints.*;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Payload para crear un nuevo pedido\")\r\npublic record CreateOrderRequest(\r\n    @Schema(\r\n            description = \"Modalidad de cumplimiento del pedido\",\r\n            example = \"DELIVERY\",\r\n            allowableValues = {\"PICKUP\", \"DELIVERY\"})\r\n        @NotNull(message = \"fulfillment es obligatorio\") FulfillmentType fulfillment,\r\n    @Schema(\r\n            description = \"tems del pedido. Debe contener al menos un tem.\",\r\n            example =\r\n                \"\"\"\r\n            [\r\n              { \"productId\": 1, \"productVariantId\": 10, \"quantity\": 2 },\r\n              { \"productId\": 2, \"productVariantId\": 20, \"quantity\": 1 }\r\n            ]\r\n            \"\"\")\r\n        @NotEmpty(message = \"items no puede estar vaco\") @Size(max = 50, message = \"items excede el mximo permitido (50)\")\r\n        @Valid List<OrderItemRequest> items,\r\n    @Schema(description = \"Notas opcionales del cliente\", example = \"Sin cebolla y poco picante\")\r\n        @Size(max = 500, message = \"notes excede el mximo permitido (500)\")\r\n        String notes,\r\n    @Schema(\r\n            description =\r\n                \"Fecha/hora deseada de entrega o retiro en formato ISO-8601. \"\r\n                    + \"Por ejemplo: 2025-11-22T20:30:00Z\",\r\n            example = \"2025-11-22T20:30:00Z\")\r\n        // Podras agregar @FutureOrPresent si ms adelante quieres validar que no sea pasado\r\n        Instant requestedAt,\r\n\r\n    // Solo requerido si fulfillment == DELIVERY (se valida en el servicio)\r\n    @Schema(description = \"Datos de envo, requeridos cuando fulfillment = DELIVERY\") @Valid ShippingAddressRequest shipping) {}\r\n",
      "info": {
        "size": 1928,
        "last_modified": "2026-02-01T22:28:36.8985926",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderCancelRequest.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.Size;\r\n\r\n@Schema(description = \"Request para cancelar una orden\")\r\npublic record OrderCancelRequest(\r\n    @Schema(description = \"Razn de la cancelacin (opcional)\", example = \"Cambi de opinin\")\r\n        @Size(max = 500, message = \"Cancellation reason must not exceed 500 characters\") String reason) {}\r\n",
      "info": {
        "size": 448,
        "last_modified": "2026-02-01T22:28:36.9025926",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderFilter.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.time.LocalDate;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Filtro interno para bsqueda de pedidos\")\r\npublic record OrderFilter(\r\n    @Schema(\r\n            description = \"Estados del pedido a filtrar. Null o vaco => sin filtro.\",\r\n            example = \"[\\\"CREATED\\\", \\\"PREPARING\\\"]\")\r\n        List<OrderStatus> statuses, // null o vaco => sin filtro\r\n    @Schema(description = \"Fecha desde (inclusive)\", example = \"2025-11-01\")\r\n        LocalDate from, // inclusive\r\n    @Schema(description = \"Fecha hasta (inclusive)\", example = \"2025-11-30\")\r\n        LocalDate to, // inclusive\r\n    @Schema(description = \"Id de usuario (para futuros filtros por usuario)\", example = \"123\")\r\n        Long userId // opcional (para futuros filtros por usuario)\r\n    ) {}\r\n",
      "info": {
        "size": 946,
        "last_modified": "2026-02-01T22:28:36.9065925",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderItemRequest.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.Max;\r\nimport jakarta.validation.constraints.Min;\r\nimport jakarta.validation.constraints.NotNull;\r\n\r\n@Schema(description = \"tem del pedido en el request de creacin\")\r\npublic record OrderItemRequest(\r\n    @Schema(description = \"Id del producto\", example = \"1\")\r\n        @NotNull(message = \"productId es obligatorio\") Long productId,\r\n    @Schema(description = \"Id de la variante del producto\", example = \"10\")\r\n        @NotNull(message = \"productVariantId es obligatorio\") Long productVariantId,\r\n    @Schema(\r\n            description = \"Cantidad de unidades para este tem\",\r\n            example = \"2\",\r\n            minimum = \"1\",\r\n            maximum = \"99\")\r\n        @Min(value = 1, message = \"quantity debe ser >= 1\") @Max(value = 99, message = \"quantity excede el mximo permitido (99)\")\r\n        int quantity) {}\r\n",
      "info": {
        "size": 962,
        "last_modified": "2026-02-01T22:28:36.9115971",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderItemResponse.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\n\r\n@Schema(description = \"tem del pedido en la respuesta\")\r\npublic record OrderItemResponse(\r\n    @Schema(description = \"Id interno del tem de pedido\", example = \"101\") Long id,\r\n    @Schema(description = \"Id del producto\", example = \"1\") Long productId,\r\n    @Schema(description = \"Id de la variante del producto\", example = \"10\") Long productVariantId,\r\n    @Schema(description = \"Nombre del producto\", example = \"Pizza Muzarella\") String productName,\r\n    @Schema(description = \"Nombre de la variante\", example = \"Grande\") String variantName,\r\n    @Schema(description = \"Precio unitario de la variante\", example = \"450.00\")\r\n        BigDecimal unitPrice,\r\n    @Schema(description = \"Cantidad de unidades\", example = \"2\") int quantity,\r\n    @Schema(description = \"Total de la lnea (unitPrice  quantity)\", example = \"900.00\")\r\n        BigDecimal lineTotal) {}\r\n",
      "info": {
        "size": 999,
        "last_modified": "2026-02-01T22:28:36.9155935",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderPageResponse.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Respuesta paginada genrica de pedidos\")\r\npublic record OrderPageResponse<T>(\r\n    @Schema(description = \"Contenido de la pgina\") List<T> content,\r\n    @Schema(description = \"Nmero de pgina (0-based)\", example = \"0\") int page,\r\n    @Schema(description = \"Tamao de pgina\", example = \"20\") int size,\r\n    @Schema(description = \"Cantidad total de elementos\", example = \"125\") long totalElements,\r\n    @Schema(description = \"Cantidad total de pginas\", example = \"7\") int totalPages) {\r\n\r\n  public static <T> OrderPageResponse<T> from(org.springframework.data.domain.Page<T> p) {\r\n    return new OrderPageResponse<>(\r\n        p.getContent(), p.getNumber(), p.getSize(), p.getTotalElements(), p.getTotalPages());\r\n  }\r\n}\r\n",
      "info": {
        "size": 878,
        "last_modified": "2026-02-01T22:28:36.9195931",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\OrderResponse.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\n\r\n@Schema(description = \"Respuesta estndar de un pedido\")\r\npublic record OrderResponse(\r\n    @Schema(description = \"Id del pedido\", example = \"42\") Long id,\r\n    @Schema(\r\n            description = \"Estado actual del pedido\",\r\n            example = \"CREATED\",\r\n            allowableValues = {\r\n              \"CREATED\",\r\n              \"CONFIRMED\",\r\n              \"PREPARING\",\r\n              \"READY\",\r\n              \"OUT_FOR_DELIVERY\",\r\n              \"DELIVERED\",\r\n              \"CANCELLED\"\r\n            })\r\n        OrderStatus status,\r\n    @Schema(\r\n            description = \"Tipo de cumplimiento del pedido\",\r\n            example = \"DELIVERY\",\r\n            allowableValues = {\"PICKUP\", \"DELIVERY\"})\r\n        FulfillmentType fulfillment,\r\n    @Schema(description = \"Moneda del pedido\", example = \"UYU\") CurrencyCode currency,\r\n    @Schema(description = \"Subtotal del pedido\", example = \"900.00\") BigDecimal subtotalAmount,\r\n    @Schema(description = \"Impuestos aplicados\", example = \"0.00\") BigDecimal taxAmount,\r\n    @Schema(description = \"Descuentos aplicados\", example = \"0.00\") BigDecimal discountAmount,\r\n    @Schema(description = \"Total final del pedido\", example = \"900.00\") BigDecimal totalAmount,\r\n\r\n    // Snapshot de envo\r\n    @Schema(description = \"Nombre de la persona que recibe el envo\", example = \"Juan Prez\")\r\n        String shipName,\r\n    @Schema(description = \"Telfono de contacto del envo\", example = \"099123456\") String shipPhone,\r\n    @Schema(description = \"Direccin lnea 1\", example = \"Av. Siempre Viva 742\") String shipLine1,\r\n    @Schema(description = \"Direccin lnea 2 (opcional)\", example = \"Apartamento 201\")\r\n        String shipLine2,\r\n    @Schema(description = \"Ciudad del envo\", example = \"Montevideo\") String shipCity,\r\n    @Schema(description = \"Regin / Departamento\", example = \"Canelones\") String shipRegion,\r\n    @Schema(description = \"Cdigo postal\", example = \"15000\") String shipPostalCode,\r\n    @Schema(\r\n            description = \"Referencia adicional para el envo\",\r\n            example = \"Portn negro, timbre rojo\")\r\n        String shipReference,\r\n    @Schema(description = \"Notas del pedido\", example = \"Entregar entre 20:00 y 20:30\")\r\n        String notes,\r\n    @Schema(\r\n            description = \"Fecha/hora deseada de entrega o retiro (UTC)\",\r\n            example = \"2025-11-22T20:30:00Z\")\r\n        Instant requestedAt,\r\n    @Schema(\r\n            description =\r\n                \"Fecha/hora real de entrega (UTC), solo se completa cuando status = DELIVERED\",\r\n            example = \"2025-11-22T20:52:00Z\")\r\n        Instant deliveredAt,\r\n    @Schema(description = \"tems del pedido\") List<OrderItemResponse> items,\r\n    @Schema(description = \"Fecha de creacin del pedido (UTC)\", example = \"2025-11-12T14:32:10Z\")\r\n        Instant createdAt,\r\n    @Schema(\r\n            description = \"Fecha de ltima actualizacin del pedido (UTC)\",\r\n            example = \"2025-11-12T15:10:00Z\")\r\n        Instant updatedAt) {}\r\n",
      "info": {
        "size": 3374,
        "last_modified": "2026-02-01T22:28:36.9235964",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\ShippingAddressRequest.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.NotBlank;\r\nimport jakarta.validation.constraints.Pattern;\r\nimport jakarta.validation.constraints.Size;\r\n\r\n@Schema(description = \"Direccin de envo para pedidos con fulfillment = DELIVERY\")\r\npublic record ShippingAddressRequest(\r\n    @Schema(description = \"Nombre del destinatario del envo\", example = \"Juan Prez\")\r\n        @NotBlank @Size(max = 191) String name,\r\n    @Schema(description = \"Telfono de contacto\", example = \"099123456\")\r\n        @NotBlank @Size(max = 50) @Pattern(regexp = \"^[0-9 +()-]{6,50}$\", message = \"phone no vlido\")\r\n        String phone,\r\n    @Schema(description = \"Direccin principal\", example = \"Av. Siempre Viva 742\")\r\n        @NotBlank @Size(max = 191) String line1,\r\n    @Schema(description = \"Direccin adicional (opcional)\", example = \"Apartamento 201\")\r\n        @Size(max = 191) String line2,\r\n    @Schema(description = \"Ciudad\", example = \"Montevideo\") @NotBlank @Size(max = 100) String city,\r\n    @Schema(description = \"Regin / Departamento\", example = \"Canelones\") @Size(max = 100) String region,\r\n    @Schema(description = \"Cdigo postal\", example = \"15000\") @Size(max = 20) String postalCode,\r\n    @Schema(description = \"Referencia adicional\", example = \"Portn negro, timbre rojo\")\r\n        @Size(max = 191) String reference) {}\r\n",
      "info": {
        "size": 1424,
        "last_modified": "2026-02-01T22:28:36.9275964",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\dto\\UpdateOrderStatusRequest.java",
      "content": "package com.cocinadelicia.backend.order.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Payload para actualizar el estado de un pedido\")\r\npublic record UpdateOrderStatusRequest(\r\n    @Schema(\r\n            description = \"Nuevo estado del pedido\",\r\n            example = \"PREPARING\",\r\n            allowableValues = {\r\n              \"CREATED\",\r\n              \"CONFIRMED\",\r\n              \"PREPARING\",\r\n              \"READY\",\r\n              \"OUT_FOR_DELIVERY\",\r\n              \"DELIVERED\",\r\n              \"CANCELLED\"\r\n            })\r\n        OrderStatus status,\r\n    @Schema(\r\n            description = \"Nota opcional para auditora o contexto del cambio\",\r\n            example = \"Cliente llam y pidi prioridad por horario\")\r\n        String note) {}\r\n",
      "info": {
        "size": 853,
        "last_modified": "2026-02-01T22:28:36.9305966",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\events\\OrderEventPayload.java",
      "content": "package com.cocinadelicia.backend.order.events;\r\n\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\n\r\n/**\r\n * Envoltura estndar para eventos WebSocket.\r\n *\r\n * <p>type: tipo de evento, ej: \"ORDER_UPDATED\" payload: contenido del evento, en nuestro caso un\r\n * OrderResponse\r\n */\r\npublic record OrderEventPayload(String type, OrderResponse payload) {}\r\n",
      "info": {
        "size": 363,
        "last_modified": "2026-02-01T22:28:36.9380993",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\events\\OrderWebSocketPublisher.java",
      "content": "package com.cocinadelicia.backend.order.events;\r\n\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.messaging.simp.SimpMessagingTemplate;\r\nimport org.springframework.stereotype.Component;\r\n\r\n/**\r\n * Publica eventos WebSocket hacia /topic/orders. Todos los eventos usan estructura: { type: \"...\",\r\n * payload: OrderResponse }\r\n */\r\n@Log4j2\r\n@Component\r\n@RequiredArgsConstructor\r\npublic class OrderWebSocketPublisher {\r\n\r\n  public static final String ORDERS_TOPIC = \"/topic/orders\";\r\n\r\n  private final SimpMessagingTemplate messagingTemplate;\r\n\r\n  /** Enva un evento ORDER_UPDATED a todos los clientes suscriptos. */\r\n  public void publishOrderUpdated(OrderResponse order) {\r\n    if (order == null || order.id() == null) {\r\n      log.warn(\"Intento de publicar ORDER_UPDATED con order nulo o sin id\");\r\n      return;\r\n    }\r\n\r\n    OrderEventPayload event = new OrderEventPayload(\"ORDER_UPDATED\", order);\r\n\r\n    log.debug(\r\n        \"Publishing ORDER_UPDATED event for orderId={} to topic={}\", order.id(), ORDERS_TOPIC);\r\n\r\n    messagingTemplate.convertAndSend(ORDERS_TOPIC, event);\r\n  }\r\n}\r\n",
      "info": {
        "size": 1202,
        "last_modified": "2026-02-01T22:28:36.9421027",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\mapper\\OrderMapper.java",
      "content": "package com.cocinadelicia.backend.order.mapper;\r\n\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderItem;\r\nimport java.util.List;\r\n\r\npublic final class OrderMapper {\r\n\r\n  private OrderMapper() {}\r\n\r\n  public static OrderResponse toResponse(CustomerOrder order) {\r\n    List<OrderItemResponse> itemDtos =\r\n        order.getItems().stream().map(OrderMapper::toItemResponse).toList();\r\n\r\n    return new OrderResponse(\r\n        order.getId(),\r\n        order.getStatus(),\r\n        order.getFulfillment(),\r\n        order.getCurrency(),\r\n        order.getSubtotalAmount(),\r\n        order.getTaxAmount(),\r\n        order.getDiscountAmount(),\r\n        order.getTotalAmount(),\r\n        order.getShipName(),\r\n        order.getShipPhone(),\r\n        order.getShipLine1(),\r\n        order.getShipLine2(),\r\n        order.getShipCity(),\r\n        order.getShipRegion(),\r\n        order.getShipPostalCode(),\r\n        order.getShipReference(),\r\n        order.getNotes(),\r\n        order.getRequestedAt(),\r\n        order.getDeliveredAt(),\r\n        itemDtos,\r\n        order.getCreatedAt(),\r\n        order.getUpdatedAt());\r\n  }\r\n\r\n  private static OrderItemResponse toItemResponse(OrderItem item) {\r\n    return new OrderItemResponse(\r\n        item.getId(),\r\n        item.getProduct().getId(),\r\n        item.getProductVariant().getId(),\r\n        item.getProductName(),\r\n        item.getVariantName(),\r\n        item.getUnitPrice(),\r\n        item.getQuantity(),\r\n        item.getLineTotal());\r\n  }\r\n}\r\n",
      "info": {
        "size": 1656,
        "last_modified": "2026-02-01T22:28:36.9491024",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\model\\CustomerOrder.java",
      "content": "package com.cocinadelicia.backend.order.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.user.model.AppUser;\r\nimport jakarta.persistence.*;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"customer_order\",\r\n    indexes = {\r\n      @Index(name = \"ix_order_user_created\", columnList = \"user_id, created_at\"),\r\n      @Index(name = \"ix_order_status_created\", columnList = \"status, created_at\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE customer_order SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class CustomerOrder extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"user_id\", nullable = false)\r\n  private AppUser user;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 50)\r\n  @Builder.Default\r\n  private OrderStatus status = OrderStatus.CREATED;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 20)\r\n  private FulfillmentType fulfillment;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 10)\r\n  @Builder.Default\r\n  private CurrencyCode currency = CurrencyCode.UYU;\r\n\r\n  @Column(name = \"subtotal_amount\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal subtotalAmount = BigDecimal.ZERO;\r\n\r\n  @Column(name = \"tax_amount\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal taxAmount = BigDecimal.ZERO;\r\n\r\n  @Column(name = \"discount_amount\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal discountAmount = BigDecimal.ZERO;\r\n\r\n  @Column(name = \"total_amount\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal totalAmount = BigDecimal.ZERO;\r\n\r\n  // Snapshot envo (solo si DELIVERY)\r\n  @Column(name = \"ship_name\", length = 191)\r\n  private String shipName;\r\n\r\n  @Column(name = \"ship_phone\", length = 50)\r\n  private String shipPhone;\r\n\r\n  @Column(name = \"ship_line1\", length = 191)\r\n  private String shipLine1;\r\n\r\n  @Column(name = \"ship_line2\", length = 191)\r\n  private String shipLine2;\r\n\r\n  @Column(name = \"ship_city\", length = 100)\r\n  private String shipCity;\r\n\r\n  @Column(name = \"ship_region\", length = 100)\r\n  private String shipRegion;\r\n\r\n  @Column(name = \"ship_postal_code\", length = 20)\r\n  private String shipPostalCode;\r\n\r\n  @Column(name = \"ship_reference\", length = 191)\r\n  private String shipReference;\r\n\r\n  @Column(name = \"notes\", columnDefinition = \"text\")\r\n  private String notes;\r\n\r\n  @Column(name = \"requested_at\")\r\n  private Instant requestedAt;\r\n\r\n  @Column(name = \"delivered_at\")\r\n  private Instant deliveredAt;\r\n\r\n  @Column(name = \"deleted_by\")\r\n  private String deletedBy;\r\n\r\n  @Column(name = \"assigned_chef_email\")\r\n  private String assignedChefEmail;\r\n\r\n  @OneToMany(mappedBy = \"order\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @Builder.Default\r\n  private List<OrderItem> items = new ArrayList<>();\r\n\r\n  @OneToMany(mappedBy = \"order\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @Builder.Default\r\n  private List<Payment> payments = new ArrayList<>();\r\n\r\n  // Helpers\r\n  public void addItem(OrderItem item) {\r\n    items.add(item);\r\n    item.setOrder(this);\r\n  }\r\n\r\n  public void addPayment(Payment p) {\r\n    payments.add(p);\r\n    p.setOrder(this);\r\n  }\r\n\r\n  public boolean isDeleted() {\r\n    return getDeletedAt() != null;\r\n  }\r\n\r\n  public void softDelete(String deletedBy) {\r\n    setDeletedAt(Instant.now());\r\n    this.deletedBy = deletedBy;\r\n    this.status = OrderStatus.CANCELLED;\r\n  }\r\n}\r\n",
      "info": {
        "size": 4048,
        "last_modified": "2026-02-01T22:28:36.9561461",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\model\\OrderItem.java",
      "content": "package com.cocinadelicia.backend.order.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport jakarta.persistence.*;\r\nimport java.math.BigDecimal;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(name = \"order_item\", indexes = @Index(name = \"ix_order_item_order\", columnList = \"order_id\"))\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE order_item SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class OrderItem extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"order_id\", nullable = false)\r\n  private CustomerOrder order;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"product_id\", nullable = false)\r\n  private Product product;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"product_variant_id\", nullable = false)\r\n  private ProductVariant productVariant;\r\n\r\n  @Column(name = \"product_name\", length = 191, nullable = false)\r\n  private String productName;\r\n\r\n  @Column(name = \"variant_name\", length = 191, nullable = false)\r\n  private String variantName;\r\n\r\n  @Column(name = \"unit_price\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal unitPrice;\r\n\r\n  @Column(nullable = false)\r\n  private Integer quantity = 1;\r\n\r\n  @Column(name = \"line_total\", precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal lineTotal;\r\n}\r\n",
      "info": {
        "size": 1697,
        "last_modified": "2026-02-01T22:28:36.9601026",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\model\\OrderStatusHistory.java",
      "content": "package com.cocinadelicia.backend.order.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport jakarta.persistence.*;\r\nimport java.time.Instant;\r\nimport lombok.*;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"order_status_history\",\r\n    indexes = {\r\n      @Index(name = \"idx_order_status_history_order_id\", columnList = \"order_id\"),\r\n      @Index(name = \"idx_order_status_history_changed_at\", columnList = \"changed_at\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\npublic class OrderStatusHistory {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @Column(name = \"order_id\", nullable = false)\r\n  private Long orderId;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(name = \"from_status\", length = 30)\r\n  private OrderStatus fromStatus;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(name = \"to_status\", nullable = false, length = 30)\r\n  private OrderStatus toStatus;\r\n\r\n  @Column(name = \"changed_by\", nullable = false)\r\n  private String changedBy;\r\n\r\n  @Column(name = \"changed_at\", nullable = false)\r\n  private Instant changedAt;\r\n\r\n  @Column(name = \"reason\", length = 500)\r\n  private String reason;\r\n\r\n  @PrePersist\r\n  protected void onCreate() {\r\n    if (changedAt == null) {\r\n      changedAt = Instant.now();\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 1311,
        "last_modified": "2026-02-01T22:28:36.9641028",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\model\\Payment.java",
      "content": "package com.cocinadelicia.backend.order.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport com.cocinadelicia.backend.common.model.enums.PaymentMethod;\r\nimport com.cocinadelicia.backend.common.model.enums.PaymentStatus;\r\nimport jakarta.persistence.*;\r\nimport java.math.BigDecimal;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"payment\",\r\n    indexes = {\r\n      @Index(name = \"ix_payment_order\", columnList = \"order_id\"),\r\n      @Index(name = \"ix_payment_status_created\", columnList = \"status, created_at\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE payment SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class Payment extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"order_id\", nullable = false)\r\n  private CustomerOrder order;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 30)\r\n  private PaymentMethod method;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 30)\r\n  @Builder.Default\r\n  private PaymentStatus status = PaymentStatus.PENDING;\r\n\r\n  @Column(precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal amount;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 10)\r\n  @Builder.Default\r\n  private CurrencyCode currency = CurrencyCode.UYU;\r\n\r\n  @Column(name = \"provider_tx_id\", length = 191)\r\n  private String providerTxId;\r\n\r\n  @Column(length = 255)\r\n  private String note;\r\n}\r\n",
      "info": {
        "size": 1763,
        "last_modified": "2026-02-01T22:28:36.968103",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\port\\PriceQueryPort.java",
      "content": "package com.cocinadelicia.backend.order.port;\r\n\r\nimport java.math.BigDecimal;\r\nimport java.util.Optional;\r\n\r\npublic interface PriceQueryPort {\r\n  /**\r\n   * Devuelve el precio vigente (decimal 10,2) para una variante. Vigente = valid_from <= now AND\r\n   * (valid_to IS NULL OR valid_to > now).\r\n   */\r\n  Optional<BigDecimal> findActivePriceByVariantId(Long productVariantId);\r\n}\r\n",
      "info": {
        "size": 379,
        "last_modified": "2026-02-01T22:28:36.9751493",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\repository\\CustomerOrderRepository.java",
      "content": "package com.cocinadelicia.backend.order.repository;\r\n\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport java.util.Optional;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.jpa.repository.*;\r\nimport org.springframework.data.repository.query.Param;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface CustomerOrderRepository\r\n    extends JpaRepository<CustomerOrder, Long>, JpaSpecificationExecutor<CustomerOrder> {\r\n\r\n  Page<CustomerOrder> findByUser_Id(Long userId, Pageable pageable);\r\n\r\n  Optional<CustomerOrder> findByIdAndUser_Id(Long orderId, Long userId);\r\n\r\n  @Query(\r\n      \"\"\"\r\n            select o\r\n            from CustomerOrder o\r\n            left join fetch o.items i\r\n            left join fetch o.payments p\r\n            where o.id = :orderId and o.user.id = :userId\r\n            \"\"\")\r\n  Optional<CustomerOrder> findDetailedByIdAndUserId(\r\n      @Param(\"orderId\") Long orderId, @Param(\"userId\") Long userId);\r\n}\r\n",
      "info": {
        "size": 1060,
        "last_modified": "2026-02-01T22:28:36.983102",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\repository\\OrderItemRepository.java",
      "content": "package com.cocinadelicia.backend.order.repository;\r\n\r\nimport com.cocinadelicia.backend.order.model.OrderItem;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface OrderItemRepository extends JpaRepository<OrderItem, Long> {}\r\n",
      "info": {
        "size": 321,
        "last_modified": "2026-02-01T22:28:36.9871022",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\repository\\OrderStatusHistoryRepository.java",
      "content": "package com.cocinadelicia.backend.order.repository;\r\n\r\nimport com.cocinadelicia.backend.order.model.OrderStatusHistory;\r\nimport java.util.List;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface OrderStatusHistoryRepository extends JpaRepository<OrderStatusHistory, Long> {\r\n\r\n  List<OrderStatusHistory> findByOrderIdOrderByChangedAtDesc(Long orderId);\r\n\r\n  List<OrderStatusHistory> findByOrderIdOrderByChangedAtAsc(Long orderId);\r\n}\r\n",
      "info": {
        "size": 531,
        "last_modified": "2026-02-01T22:28:36.9911029",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\repository\\PaymentRepository.java",
      "content": "package com.cocinadelicia.backend.order.repository;\r\n\r\nimport com.cocinadelicia.backend.order.model.Payment;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface PaymentRepository extends JpaRepository<Payment, Long> {}\r\n",
      "info": {
        "size": 315,
        "last_modified": "2026-02-01T22:28:36.9951026",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\repository\\spec\\OrderSpecifications.java",
      "content": "// src/main/java/com/cocinadelicia/backend/order/repository/spec/OrderSpecifications.java\r\npackage com.cocinadelicia.backend.order.repository.spec;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\nimport org.springframework.data.jpa.domain.Specification;\r\n\r\npublic class OrderSpecifications {\r\n\r\n  public static Specification<CustomerOrder> statusIn(List<OrderStatus> statuses) {\r\n    if (statuses == null || statuses.isEmpty()) return null;\r\n    return (root, q, cb) -> root.get(\"status\").in(statuses);\r\n  }\r\n\r\n  public static Specification<CustomerOrder> createdAtGte(Instant fromInclusive) {\r\n    if (fromInclusive == null) return null;\r\n    return (root, q, cb) -> cb.greaterThanOrEqualTo(root.get(\"createdAt\"), fromInclusive);\r\n  }\r\n\r\n  public static Specification<CustomerOrder> createdAtLt(Instant toExclusive) {\r\n    if (toExclusive == null) return null;\r\n    return (root, q, cb) -> cb.lessThan(root.get(\"createdAt\"), toExclusive);\r\n  }\r\n\r\n  public static Specification<CustomerOrder> userIdEq(Long userId) {\r\n    if (userId == null) return null;\r\n    return (root, q, cb) -> cb.equal(root.get(\"user\").get(\"id\"), userId);\r\n  }\r\n}\r\n",
      "info": {
        "size": 1272,
        "last_modified": "2026-02-01T22:28:36.9991026",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\service\\impl\\OrderServiceImpl.java",
      "content": "package com.cocinadelicia.backend.order.service.impl;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.domain.OrderStatusTransitionValidator;\r\nimport com.cocinadelicia.backend.order.dto.CreateOrderRequest;\r\nimport com.cocinadelicia.backend.order.dto.OrderFilter;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemRequest;\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\nimport com.cocinadelicia.backend.order.dto.UpdateOrderStatusRequest;\r\nimport com.cocinadelicia.backend.order.events.OrderWebSocketPublisher;\r\nimport com.cocinadelicia.backend.order.mapper.OrderMapper;\r\nimport com.cocinadelicia.backend.order.model.CustomerOrder;\r\nimport com.cocinadelicia.backend.order.model.OrderItem;\r\nimport com.cocinadelicia.backend.order.model.OrderStatusHistory;\r\nimport com.cocinadelicia.backend.order.port.PriceQueryPort;\r\nimport com.cocinadelicia.backend.order.repository.CustomerOrderRepository;\r\nimport com.cocinadelicia.backend.order.repository.OrderItemRepository;\r\nimport com.cocinadelicia.backend.order.repository.OrderStatusHistoryRepository;\r\nimport com.cocinadelicia.backend.order.repository.spec.OrderSpecifications;\r\nimport com.cocinadelicia.backend.order.service.OrderService;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport com.cocinadelicia.backend.product.repository.ProductRepository;\r\nimport com.cocinadelicia.backend.product.repository.ProductVariantRepository;\r\nimport com.cocinadelicia.backend.user.model.AppUser;\r\nimport com.cocinadelicia.backend.user.repository.UserRepository;\r\nimport jakarta.transaction.Transactional;\r\nimport java.math.BigDecimal;\r\nimport java.math.RoundingMode;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.jpa.domain.Specification;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Log4j2\r\n@Service\r\n@RequiredArgsConstructor\r\n@Transactional\r\npublic class OrderServiceImpl implements OrderService {\r\n\r\n  private final UserRepository userRepository;\r\n  private final ProductRepository productRepository;\r\n  private final ProductVariantRepository productVariantRepository;\r\n\r\n  private final CustomerOrderRepository customerOrderRepository;\r\n  private final OrderItemRepository orderItemRepository; // no se usa explcitamente\r\n  private final OrderStatusHistoryRepository statusHistoryRepository;\r\n  private final PriceQueryPort priceQueryPort;\r\n\r\n  private final OrderWebSocketPublisher orderWebSocketPublisher;\r\n\r\n  private static final BigDecimal ZERO = new BigDecimal(\"0.00\");\r\n\r\n  @Override\r\n  public OrderResponse createOrder(CreateOrderRequest request, Long appUserId) {\r\n    // 1 Validaciones mnimas del payload (con cdigos)\r\n    if (request.items() == null || request.items().isEmpty()) {\r\n      throw new BadRequestException(\"ORDER_ITEMS_EMPTY\", \"Debe agregar al menos un tem.\");\r\n    }\r\n\r\n    for (OrderItemRequest it : request.items()) {\r\n      if (it.quantity() <= 0) {\r\n        throw new BadRequestException(\r\n            \"INVALID_QUANTITY\", \"La cantidad de cada tem debe ser >= 1.\");\r\n      }\r\n    }\r\n\r\n    if (request.fulfillment() == null) {\r\n      throw new BadRequestException(\r\n          \"FULFILLMENT_REQUIRED\", \"El tipo de fulfillment es obligatorio.\");\r\n    }\r\n\r\n    if (request.fulfillment() == FulfillmentType.DELIVERY) {\r\n      var s = request.shipping();\r\n      if (s == null\r\n          || isBlank(s.name())\r\n          || isBlank(s.phone())\r\n          || isBlank(s.line1())\r\n          || isBlank(s.city())) {\r\n        throw new BadRequestException(\r\n            \"DELIVERY_ADDRESS_REQUIRED\",\r\n            \"Complete los datos de envo (nombre, telfono, direccin y ciudad).\");\r\n      }\r\n    }\r\n\r\n    // 2 Usuario (dueo del pedido)\r\n    AppUser user =\r\n        userRepository\r\n            .findById(appUserId)\r\n            .orElseThrow(() -> new NotFoundException(\"USER_NOT_FOUND\", \"Usuario no encontrado.\"));\r\n\r\n    // 3 Crear entidad base del pedido\r\n    CustomerOrder order =\r\n        CustomerOrder.builder()\r\n            .user(user)\r\n            .status(OrderStatus.CREATED)\r\n            .fulfillment(request.fulfillment())\r\n            .notes(request.notes())\r\n            .requestedAt(request.requestedAt()) //  NUEVO\r\n            .build();\r\n\r\n    // 4 Snapshot shipping si DELIVERY\r\n    if (request.fulfillment() == FulfillmentType.DELIVERY) {\r\n      var s = request.shipping();\r\n      order.setShipName(s.name());\r\n      order.setShipPhone(s.phone());\r\n      order.setShipLine1(s.line1());\r\n      order.setShipLine2(s.line2());\r\n      order.setShipCity(s.city());\r\n      order.setShipRegion(s.region());\r\n      order.setShipPostalCode(s.postalCode());\r\n      order.setShipReference(s.reference());\r\n    }\r\n\r\n    // 5 Armar items: validar producto/variante, obtener precio vigente y calcular totales\r\n    BigDecimal subtotal = ZERO;\r\n\r\n    for (OrderItemRequest it : request.items()) {\r\n      Product product =\r\n          productRepository\r\n              .findById(it.productId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado.\"));\r\n\r\n      ProductVariant variant =\r\n          productVariantRepository\r\n              .findById(it.productVariantId())\r\n              .orElseThrow(\r\n                  () -> new NotFoundException(\"VARIANT_NOT_FOUND\", \"Variante no encontrada.\"));\r\n\r\n      // Validar que la variante pertenezca al producto\r\n      if (variant.getProduct() == null || !variant.getProduct().getId().equals(product.getId())) {\r\n        throw new BadRequestException(\r\n            \"VARIANT_MISMATCH\", \"La variante no pertenece al producto indicado.\");\r\n      }\r\n\r\n      // Precio vigente\r\n      BigDecimal unitPrice =\r\n          priceQueryPort\r\n              .findActivePriceByVariantId(variant.getId())\r\n              .orElseThrow(\r\n                  () ->\r\n                      new BadRequestException(\r\n                          \"PRICE_NOT_FOUND\",\r\n                          \"No hay precio vigente para la variante seleccionada.\"));\r\n\r\n      unitPrice = unitPrice.setScale(2, RoundingMode.HALF_UP);\r\n      BigDecimal lineTotal =\r\n          unitPrice.multiply(BigDecimal.valueOf(it.quantity())).setScale(2, RoundingMode.HALF_UP);\r\n      subtotal = subtotal.add(lineTotal);\r\n\r\n      OrderItem item =\r\n          OrderItem.builder()\r\n              .order(order)\r\n              .product(product)\r\n              .productVariant(variant)\r\n              .productName(product.getName())\r\n              .variantName(variant.getName())\r\n              .unitPrice(unitPrice)\r\n              .quantity(it.quantity())\r\n              .lineTotal(lineTotal)\r\n              .build();\r\n\r\n      order.addItem(item);\r\n    }\r\n\r\n    // 6 Totales (por ahora tax=0 y discount=0)\r\n    order.setSubtotalAmount(subtotal);\r\n    order.setTaxAmount(ZERO);\r\n    order.setDiscountAmount(ZERO);\r\n    order.setTotalAmount(subtotal);\r\n\r\n    // 7 Persistir (Cascade guarda items)\r\n    CustomerOrder saved = customerOrderRepository.save(order);\r\n\r\n    // 8 Armar respuesta DTO (cannica)\r\n    OrderResponse response = OrderMapper.toResponse(saved);\r\n\r\n    // 9 Logging de auditora (INFO)\r\n    log.info(\r\n        \"OrderCreated orderId={} userId={} userEmail={} fulfillment={} items={} total={}\",\r\n        saved.getId(),\r\n        user.getId(),\r\n        user.getEmail(),\r\n        saved.getFulfillment(),\r\n        saved.getItems() != null ? saved.getItems().size() : 0,\r\n        saved.getTotalAmount());\r\n\r\n    // 10 Publicar evento en tiempo real\r\n    orderWebSocketPublisher.publishOrderUpdated(response);\r\n\r\n    // 11 Devolver respuesta DTO\r\n    return response;\r\n  }\r\n\r\n  // ==== Mtodos de lectura ====\r\n\r\n  @Override\r\n  public OrderResponse getOrderById(Long orderId, Long appUserId) {\r\n    CustomerOrder o =\r\n        customerOrderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"ORDER_NOT_FOUND\", \"Pedido no encontrado.\"));\r\n\r\n    if (!o.getUser().getId().equals(appUserId)) {\r\n      throw new NotFoundException(\r\n          \"ORDER_NOT_FOUND\", \"Pedido no pertenece al usuario.\"); // 404 para ocultar\r\n    }\r\n    return OrderMapper.toResponse(o);\r\n  }\r\n\r\n  @Override\r\n  public Page<OrderResponse> getMyOrders(Long appUserId, Pageable pageable) {\r\n    return customerOrderRepository.findByUser_Id(appUserId, pageable).map(OrderMapper::toResponse);\r\n  }\r\n\r\n  @Override\r\n  public Page<OrderResponse> getAllOrders(Pageable pageable) {\r\n    return customerOrderRepository.findAll(pageable).map(OrderMapper::toResponse);\r\n  }\r\n\r\n  @Override\r\n  public OrderResponse updateStatus(\r\n      Long orderId, String performedBy, UpdateOrderStatusRequest request) {\r\n\r\n    if (request == null || request.status() == null) {\r\n      throw new BadRequestException(\"STATUS_REQUIRED\", \"El estado es obligatorio.\");\r\n    }\r\n\r\n    CustomerOrder order =\r\n        customerOrderRepository\r\n            .findById(orderId)\r\n            .orElseThrow(() -> new NotFoundException(\"ORDER_NOT_FOUND\", \"Pedido no encontrado.\"));\r\n\r\n    OrderStatus current = order.getStatus();\r\n    OrderStatus next = request.status();\r\n\r\n    //  Validar transicin con logging de WARN si falla\r\n    try {\r\n      OrderStatusTransitionValidator.validateOrThrow(current, next);\r\n    } catch (BadRequestException ex) {\r\n      log.warn(\r\n          \"InvalidOrderStatusTransition orderId={} from={} to={} by={} reason={} code={}\",\r\n          order.getId(),\r\n          current,\r\n          next,\r\n          performedBy,\r\n          ex.getMessage(),\r\n          ex.code());\r\n      throw ex;\r\n    }\r\n\r\n    //  Transicin vlida  aplicar cambio de estado\r\n    order.setStatus(next);\r\n\r\n    if (next == OrderStatus.DELIVERED && order.getDeliveredAt() == null) {\r\n      order.setDeliveredAt(java.time.Instant.now());\r\n    }\r\n\r\n    CustomerOrder saved = customerOrderRepository.save(order);\r\n\r\n    OrderResponse response = OrderMapper.toResponse(saved);\r\n\r\n    log.info(\r\n        \"OrderStatusChanged orderId={} oldStatus={} newStatus={} by={} note={}\",\r\n        saved.getId(),\r\n        current,\r\n        next,\r\n        performedBy,\r\n        request.note());\r\n\r\n    orderWebSocketPublisher.publishOrderUpdated(response);\r\n\r\n    return response;\r\n  }\r\n\r\n  @Override\r\n  public Page<OrderResponse> findOrders(OrderFilter filter, Pageable pageable) {\r\n    Specification<CustomerOrder> spec = Specification.allOf();\r\n\r\n    if (filter != null) {\r\n      if (filter.statuses() != null && !filter.statuses().isEmpty()) {\r\n        spec = spec.and(OrderSpecifications.statusIn(filter.statuses()));\r\n      }\r\n      // Fechas YYYY-MM-DD inclusivas  [from 00:00, to+1d 00:00) en zona app\r\n      java.time.ZoneId APP_ZONE = java.time.ZoneId.of(\"America/Montevideo\");\r\n      java.time.Instant fromInstant = null;\r\n      java.time.Instant toExclusive = null;\r\n\r\n      if (filter.from() != null) {\r\n        fromInstant = filter.from().atStartOfDay(APP_ZONE).toInstant();\r\n        spec = spec.and(OrderSpecifications.createdAtGte(fromInstant));\r\n      }\r\n      if (filter.to() != null) {\r\n        toExclusive = filter.to().plusDays(1).atStartOfDay(APP_ZONE).toInstant();\r\n        spec = spec.and(OrderSpecifications.createdAtLt(toExclusive));\r\n      }\r\n      if (filter.userId() != null) {\r\n        spec = spec.and(OrderSpecifications.userIdEq(filter.userId()));\r\n      }\r\n    }\r\n    // fallback de orden si no viene en pageable\r\n    Pageable effective = pageable;\r\n    if (effective.getSort().isUnsorted()) {\r\n      effective =\r\n          org.springframework.data.domain.PageRequest.of(\r\n              pageable.getPageNumber(),\r\n              pageable.getPageSize(),\r\n              org.springframework.data.domain.Sort.by(\"createdAt\").descending());\r\n    }\r\n\r\n    return customerOrderRepository.findAll(spec, effective).map(OrderMapper::toResponse);\r\n  }\r\n\r\n  @Override\r\n  public Optional<OrderResponse> getCurrentOrder(Long appUserId) {\r\n    // Buscar rdenes activas (no DELIVERED ni CANCELLED)\r\n    List<OrderStatus> activeStatuses =\r\n        List.of(\r\n            OrderStatus.CREATED,\r\n            OrderStatus.CONFIRMED,\r\n            OrderStatus.PREPARING,\r\n            OrderStatus.READY,\r\n            OrderStatus.OUT_FOR_DELIVERY);\r\n\r\n    Specification<CustomerOrder> spec =\r\n        OrderSpecifications.userIdEq(appUserId)\r\n            .and(OrderSpecifications.statusIn(activeStatuses))\r\n            .and((root, query, cb) -> cb.isNull(root.get(\"deletedAt\")));\r\n\r\n    org.springframework.data.domain.Pageable pageable =\r\n        org.springframework.data.domain.PageRequest.of(\r\n            0, 1, org.springframework.data.domain.Sort.by(\"createdAt\").descending());\r\n\r\n    Page<CustomerOrder> page = customerOrderRepository.findAll(spec, pageable);\r\n\r\n    return page.hasContent()\r\n        ? Optional.of(OrderMapper.toResponse(page.getContent().get(0)))\r\n        : Optional.empty();\r\n  }\r\n\r\n  @Override\r\n  public OrderResponse cancelOrder(Long orderId, String reason, Long appUserId) {\r\n    CustomerOrder order =\r\n        customerOrderRepository\r\n            .findByIdAndUser_Id(orderId, appUserId)\r\n            .orElseThrow(\r\n                () ->\r\n                    new NotFoundException(\r\n                        \"ORDER_NOT_FOUND\", \"Pedido no encontrado o no pertenece al usuario.\"));\r\n\r\n    if (order.isDeleted()) {\r\n      throw new NotFoundException(\"ORDER_NOT_FOUND\", \"Pedido no encontrado.\");\r\n    }\r\n\r\n    OrderStatus current = order.getStatus();\r\n\r\n    // Validar que el cliente puede cancelar\r\n    if (!com.cocinadelicia.backend.order.domain.OrderStatusTransition.canClientCancel(current)) {\r\n      throw new BadRequestException(\r\n          \"CANNOT_CANCEL_ORDER\",\r\n          String.format(\r\n              \"No se puede cancelar un pedido en estado %s. Solo se pueden cancelar pedidos CREATED o CONFIRMED.\",\r\n              current));\r\n    }\r\n\r\n    // Cambiar estado a CANCELLED\r\n    order.setStatus(OrderStatus.CANCELLED);\r\n    CustomerOrder saved = customerOrderRepository.save(order);\r\n\r\n    // Registrar en historial\r\n    OrderStatusHistory historyEntry =\r\n        OrderStatusHistory.builder()\r\n            .orderId(orderId)\r\n            .fromStatus(current)\r\n            .toStatus(OrderStatus.CANCELLED)\r\n            .changedBy(order.getUser().getEmail())\r\n            .changedAt(java.time.Instant.now())\r\n            .reason(reason != null ? reason : \"Cliente cancel el pedido\")\r\n            .build();\r\n    statusHistoryRepository.save(historyEntry);\r\n\r\n    OrderResponse response = OrderMapper.toResponse(saved);\r\n\r\n    log.info(\r\n        \"OrderCANCELLED orderId={} userId={} previousStatus={} reason={}\",\r\n        orderId,\r\n        appUserId,\r\n        current,\r\n        reason);\r\n\r\n    orderWebSocketPublisher.publishOrderUpdated(response);\r\n\r\n    return response;\r\n  }\r\n\r\n  // === Helpers ===\r\n  private boolean isBlank(String s) {\r\n    return s == null || s.isBlank();\r\n  }\r\n}\r\n",
      "info": {
        "size": 15380,
        "last_modified": "2026-02-01T22:28:37.0091025",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\order\\service\\OrderService.java",
      "content": "// src/main/java/com/cocinadelicia/backend/order/service/OrderService.java\r\npackage com.cocinadelicia.backend.order.service;\r\n\r\nimport com.cocinadelicia.backend.order.dto.*;\r\nimport java.util.Optional;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Service\r\npublic interface OrderService {\r\n  OrderResponse createOrder(CreateOrderRequest request, Long appUserId);\r\n\r\n  OrderResponse getOrderById(Long orderId, Long appUserId);\r\n\r\n  Page<OrderResponse> getAllOrders(Pageable pageable);\r\n\r\n  Page<OrderResponse> getMyOrders(Long appUserId, Pageable pageable);\r\n\r\n  OrderResponse updateStatus(Long orderId, String performedBy, UpdateOrderStatusRequest request);\r\n\r\n  Page<OrderResponse> findOrders(OrderFilter filter, Pageable pageable);\r\n\r\n  /** Obtiene la orden activa del usuario (no DELIVERED ni CANCELLED). */\r\n  Optional<OrderResponse> getCurrentOrder(Long appUserId);\r\n\r\n  /** Cancela una orden del cliente (solo si el estado lo permite). */\r\n  OrderResponse cancelOrder(Long orderId, String reason, Long appUserId);\r\n}\r\n",
      "info": {
        "size": 1126,
        "last_modified": "2026-02-01T22:28:37.0161026",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\CategoryAdminRequest.java",
      "content": "package com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.NotBlank;\r\nimport jakarta.validation.constraints.Size;\r\n\r\n@Schema(description = \"Payload para crear/actualizar categora (admin)\")\r\npublic record CategoryAdminRequest(\r\n    @NotBlank @Size(max = 191) @Schema(description = \"Nombre visible de la categora\", example = \"Empanadas\")\r\n        String name,\r\n    @NotBlank @Size(max = 191) @Schema(description = \"Slug nico (URL friendly)\", example = \"empanadas\")\r\n        String slug,\r\n    @Size(max = 500) @Schema(\r\n            description = \"Descripcin corta de la categora\",\r\n            example = \"Variedad de empanadas caseras\")\r\n        String description) {}\r\n",
      "info": {
        "size": 758,
        "last_modified": "2026-02-01T22:28:37.0261052",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\CategoryAdminResponse.java",
      "content": "package com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Categora para administracin\")\r\npublic record CategoryAdminResponse(Long id, String name, String slug, String description) {}\r\n",
      "info": {
        "size": 257,
        "last_modified": "2026-02-01T22:28:37.0301055",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\ProductAdminRequest.java",
      "content": "package com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.DecimalMin;\r\nimport jakarta.validation.constraints.NotBlank;\r\nimport jakarta.validation.constraints.NotNull;\r\nimport jakarta.validation.constraints.Size;\r\nimport java.math.BigDecimal;\r\n\r\n@Schema(description = \"Payload para crear/actualizar producto (admin)\")\r\npublic record ProductAdminRequest(\r\n    @NotNull @Schema(description = \"ID de la categora asociada\", example = \"1\") Long categoryId,\r\n    @NotBlank @Size(max = 191) @Schema(description = \"Nombre del producto\", example = \"Empanadas surtidas\")\r\n        String name,\r\n    @NotBlank @Size(max = 191) @Schema(description = \"Slug nico del producto\", example = \"empanadas-surtidas\")\r\n        String slug,\r\n    @Schema(\r\n            description = \"Descripcin larga del producto\",\r\n            example = \"Docena de empanadas surtidas caseras\")\r\n        String description,\r\n    @NotNull @DecimalMin(\"0.00\") @Schema(description = \"Tasa de impuesto en porcentaje\", example = \"22.00\")\r\n        BigDecimal taxRatePercent,\r\n    @Schema(description = \"Si el producto est activo o no\", example = \"true\") Boolean isActive) {}\r\n",
      "info": {
        "size": 1218,
        "last_modified": "2026-02-01T22:28:37.0341058",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\ProductAdminResponse.java",
      "content": "package com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport java.math.BigDecimal;\r\n\r\n@Schema(description = \"Producto para administracin\")\r\npublic record ProductAdminResponse(\r\n    Long id,\r\n    Long categoryId,\r\n    String categoryName,\r\n    String name,\r\n    String slug,\r\n    String description,\r\n    BigDecimal taxRatePercent,\r\n    boolean isActive,\r\n    int variantsCount,\r\n    boolean featured,\r\n    boolean dailyMenu,\r\n    boolean isNew) {}\r\n",
      "info": {
        "size": 499,
        "last_modified": "2026-02-01T22:28:37.0476334",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\ProductVariantAdminRequest.java",
      "content": "package com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\nimport jakarta.validation.constraints.Min;\r\nimport jakarta.validation.constraints.NotBlank;\r\nimport jakarta.validation.constraints.Size;\r\n\r\n@Schema(description = \"Payload para crear/actualizar variante de producto\")\r\npublic record ProductVariantAdminRequest(\r\n    @NotBlank @Size(max = 191) @Schema(description = \"Nombre de la variante\", example = \"Carne suave\")\r\n        String name,\r\n    @Size(max = 191) @Schema(description = \"SKU nico (opcional)\", example = \"EMP-CARNE-SUAVE\")\r\n        String sku,\r\n    @Schema(description = \"Si la variante est activa\", example = \"true\") Boolean isActive,\r\n    @Schema(description = \"Si maneja stock\", example = \"true\") Boolean managesStock,\r\n    @Min(0) @Schema(description = \"Cantidad en stock (si maneja stock)\", example = \"12\")\r\n        Integer stockQuantity) {}\r\n",
      "info": {
        "size": 912,
        "last_modified": "2026-02-01T22:28:37.0516332",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\dto\\ProductVariantAdminResponse.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/dto/ProductVariantAdminResponse.java\r\npackage com.cocinadelicia.backend.product.dto;\r\n\r\nimport io.swagger.v3.oas.annotations.media.Schema;\r\n\r\n@Schema(description = \"Variante de producto para administracin\")\r\npublic record ProductVariantAdminResponse(\r\n    Long id, String name, String sku, boolean isActive, boolean managesStock, int stockQuantity) {}\r\n",
      "info": {
        "size": 406,
        "last_modified": "2026-02-01T22:28:37.0566334",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\mapper\\CategoryAdminMapper.java",
      "content": "package com.cocinadelicia.backend.product.mapper;\r\n\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.CategoryAdminResponse;\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\npublic class CategoryAdminMapper {\r\n\r\n  public CategoryAdminResponse toResponse(Category entity) {\r\n    if (entity == null) return null;\r\n    return new CategoryAdminResponse(\r\n        entity.getId(), entity.getName(), entity.getSlug(), entity.getDescription());\r\n  }\r\n\r\n  public void updateEntityFromRequest(CategoryAdminRequest req, Category entity) {\r\n    if (req.name() != null) entity.setName(req.name());\r\n    if (req.slug() != null) entity.setSlug(req.slug());\r\n    if (req.description() != null) entity.setDescription(req.description());\r\n  }\r\n\r\n  public Category toNewEntity(CategoryAdminRequest req) {\r\n    Category category = new Category();\r\n    category.setName(req.name());\r\n    category.setSlug(req.slug());\r\n    category.setDescription(req.description());\r\n    return category;\r\n  }\r\n}\r\n",
      "info": {
        "size": 1115,
        "last_modified": "2026-02-01T22:28:37.0636332",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\mapper\\ProductAdminMapper.java",
      "content": "package com.cocinadelicia.backend.product.mapper;\r\n\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductAdminResponse;\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport java.util.List;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\npublic class ProductAdminMapper {\r\n\r\n  public ProductAdminResponse toResponse(Product entity) {\r\n    if (entity == null) return null;\r\n\r\n    Category category = entity.getCategory();\r\n    List<ProductVariant> variants = entity.getVariants() != null ? entity.getVariants() : List.of();\r\n\r\n    int variantsCount = variants.size();\r\n\r\n    boolean featured = variants.stream().anyMatch(ProductVariant::isFeatured);\r\n\r\n    boolean dailyMenu = variants.stream().anyMatch(ProductVariant::isDailyMenu);\r\n\r\n    boolean isNew = variants.stream().anyMatch(ProductVariant::isNew);\r\n\r\n    return new ProductAdminResponse(\r\n        entity.getId(),\r\n        category != null ? category.getId() : null,\r\n        category != null ? category.getName() : null,\r\n        entity.getName(),\r\n        entity.getSlug(),\r\n        entity.getDescription(),\r\n        entity.getTaxRatePercent(),\r\n        entity.isActive(),\r\n        variantsCount,\r\n        featured,\r\n        dailyMenu,\r\n        isNew);\r\n  }\r\n\r\n  public void updateEntityFromRequest(ProductAdminRequest req, Product entity, Category category) {\r\n    if (category != null) {\r\n      entity.setCategory(category);\r\n    }\r\n    if (req.name() != null) entity.setName(req.name());\r\n    if (req.slug() != null) entity.setSlug(req.slug());\r\n    if (req.description() != null) entity.setDescription(req.description());\r\n    if (req.taxRatePercent() != null) entity.setTaxRatePercent(req.taxRatePercent());\r\n    if (req.isActive() != null) entity.setActive(req.isActive());\r\n  }\r\n\r\n  public Product toNewEntity(ProductAdminRequest req, Category category) {\r\n    Product product = new Product();\r\n    product.setCategory(category);\r\n    product.setName(req.name());\r\n    product.setSlug(req.slug());\r\n    product.setDescription(req.description());\r\n    product.setTaxRatePercent(req.taxRatePercent());\r\n    product.setActive(req.isActive() != null ? req.isActive() : true);\r\n    return product;\r\n  }\r\n}\r\n",
      "info": {
        "size": 2386,
        "last_modified": "2026-02-01T22:28:37.066633",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\mapper\\ProductVariantMapper.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/mapper/ProductVariantMapper.java\r\npackage com.cocinadelicia.backend.product.mapper;\r\n\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminRequest;\r\nimport com.cocinadelicia.backend.product.dto.ProductVariantAdminResponse;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport org.springframework.stereotype.Component;\r\n\r\n@Component\r\npublic class ProductVariantMapper {\r\n\r\n  public ProductVariantAdminResponse toAdminResponse(ProductVariant entity) {\r\n    return new ProductVariantAdminResponse(\r\n        entity.getId(),\r\n        entity.getName(),\r\n        entity.getSku(),\r\n        entity.isActive(),\r\n        entity.isManagesStock(),\r\n        entity.getStockQuantity());\r\n  }\r\n\r\n  public void updateEntityFromRequest(ProductVariantAdminRequest req, ProductVariant entity) {\r\n    if (req.name() != null) entity.setName(req.name());\r\n    if (req.sku() != null) entity.setSku(req.sku());\r\n    if (req.isActive() != null) entity.setActive(req.isActive());\r\n    if (req.managesStock() != null) entity.setManagesStock(req.managesStock());\r\n    if (req.stockQuantity() != null) entity.setStockQuantity(req.stockQuantity());\r\n  }\r\n\r\n  public ProductVariant toNewEntity(ProductVariantAdminRequest req) {\r\n    ProductVariant variant = new ProductVariant();\r\n    variant.setName(req.name());\r\n    variant.setSku(req.sku());\r\n    variant.setActive(req.isActive() != null ? req.isActive() : true);\r\n    variant.setManagesStock(req.managesStock() != null ? req.managesStock() : false);\r\n    variant.setStockQuantity(req.stockQuantity() != null ? req.stockQuantity() : 0);\r\n    return variant;\r\n  }\r\n}\r\n",
      "info": {
        "size": 1671,
        "last_modified": "2026-02-01T22:28:37.0706331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\Category.java",
      "content": "package com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"category\",\r\n    uniqueConstraints = {\r\n      @UniqueConstraint(name = \"uk_category_name\", columnNames = \"name\"),\r\n      @UniqueConstraint(name = \"uk_category_slug\", columnNames = \"slug\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE category SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class Category extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String name;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String slug;\r\n\r\n  @Column(columnDefinition = \"text\")\r\n  private String description;\r\n}\r\n",
      "info": {
        "size": 1005,
        "last_modified": "2026-02-01T22:28:37.0776331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\PriceHistory.java",
      "content": "package com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport jakarta.persistence.*;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"price_history\",\r\n    indexes = {\r\n      @Index(name = \"ix_price_hist_from\", columnList = \"product_variant_id, valid_from\"),\r\n      @Index(name = \"ix_price_hist_to\", columnList = \"product_variant_id, valid_to\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE price_history SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class PriceHistory extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"product_variant_id\", nullable = false)\r\n  private ProductVariant productVariant;\r\n\r\n  @Column(precision = 10, scale = 2, nullable = false)\r\n  private BigDecimal price;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 10)\r\n  @Builder.Default\r\n  private CurrencyCode currency = CurrencyCode.UYU;\r\n\r\n  @Column(name = \"valid_from\", nullable = false)\r\n  private Instant validFrom;\r\n\r\n  @Column(name = \"valid_to\")\r\n  private Instant validTo;\r\n}\r\n",
      "info": {
        "size": 1462,
        "last_modified": "2026-02-01T22:28:37.0816331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\Product.java",
      "content": "package com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport java.util.ArrayList;\r\nimport java.util.HashSet;\r\nimport java.util.List;\r\nimport java.util.Set;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.BatchSize;\r\nimport org.hibernate.annotations.JdbcTypeCode;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\nimport org.hibernate.type.SqlTypes;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"product\",\r\n    uniqueConstraints = @UniqueConstraint(name = \"uk_product_slug\", columnNames = \"slug\"))\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE product SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class Product extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"category_id\", nullable = false)\r\n  private Category category;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String name;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String slug;\r\n\r\n  @JdbcTypeCode(SqlTypes.LONGVARCHAR)\r\n  @jakarta.persistence.Column(columnDefinition = \"text\")\r\n  private String description;\r\n\r\n  @Column(name = \"tax_rate_percent\", precision = 5, scale = 2, nullable = false)\r\n  private java.math.BigDecimal taxRatePercent;\r\n\r\n  @Column(name = \"is_active\", nullable = false)\r\n  private boolean isActive = true;\r\n\r\n  @OneToMany(mappedBy = \"product\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @BatchSize(size = 20)\r\n  @Builder.Default\r\n  private List<ProductVariant> variants = new ArrayList<>();\r\n\r\n  @OneToMany(mappedBy = \"product\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @OrderBy(\"sortOrder ASC, id ASC\")\r\n  @BatchSize(size = 20)\r\n  @Builder.Default\r\n  private List<ProductImage> images = new ArrayList<>();\r\n\r\n  // M:N sin campos extra usando join table product_tag\r\n  @ManyToMany\r\n  @JoinTable(\r\n      name = \"product_tag\",\r\n      joinColumns = @JoinColumn(name = \"product_id\"),\r\n      inverseJoinColumns = @JoinColumn(name = \"tag_id\"),\r\n      uniqueConstraints =\r\n          @UniqueConstraint(\r\n              name = \"uk_product_tag\",\r\n              columnNames = {\"product_id\", \"tag_id\"}))\r\n  @BatchSize(size = 20)\r\n  @Builder.Default\r\n  private Set<Tag> tags = new HashSet<>();\r\n}\r\n",
      "info": {
        "size": 2428,
        "last_modified": "2026-02-01T22:28:37.0856334",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\ProductImage.java",
      "content": "package com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"product_image\",\r\n    uniqueConstraints = {\r\n      @UniqueConstraint(\r\n          name = \"uk_product_image_product_key\",\r\n          columnNames = {\"product_id\", \"object_key\"})\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE product_image SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class ProductImage extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"product_id\", nullable = false)\r\n  private Product product;\r\n\r\n  /**\r\n   * Clave estable del objeto en S3, ej: products/{productId}/{uuid}.webp No guardamos la URL\r\n   * completa para poder cambiar a CloudFront sin tocar la BD.\r\n   */\r\n  @Column(name = \"object_key\", length = 512, nullable = false)\r\n  private String objectKey;\r\n\r\n  /** Marca si es la imagen principal del producto. */\r\n  @Column(name = \"is_main\", nullable = false)\r\n  @Builder.Default\r\n  private boolean isMain = false;\r\n\r\n  /** Orden visual dentro de la galera. */\r\n  @Column(name = \"sort_order\", nullable = false)\r\n  @Builder.Default\r\n  private int sortOrder = 0;\r\n}\r\n",
      "info": {
        "size": 1478,
        "last_modified": "2026-02-01T22:28:37.088633",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\ProductVariant.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/model/ProductVariant.java\r\npackage com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.BatchSize;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"product_variant\",\r\n    uniqueConstraints = @UniqueConstraint(name = \"uk_variant_sku\", columnNames = \"sku\"))\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE product_variant SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class ProductVariant extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"product_id\", nullable = false)\r\n  private Product product;\r\n\r\n  @Column(length = 191)\r\n  private String sku;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String name;\r\n\r\n  @Column(name = \"is_active\", nullable = false)\r\n  @Builder.Default\r\n  private boolean isActive = true;\r\n\r\n  //  Manejo de stock\r\n  @Column(name = \"manages_stock\", nullable = false)\r\n  @Builder.Default\r\n  private boolean managesStock = false;\r\n\r\n  @Column(name = \"stock_quantity\", nullable = false)\r\n  @Builder.Default\r\n  private int stockQuantity = 0;\r\n\r\n  //  NUEVO: flags de visibilidad / marketing\r\n  @Column(name = \"is_featured\", nullable = false)\r\n  @Builder.Default\r\n  private boolean featured = false;\r\n\r\n  @Column(name = \"is_daily_menu\", nullable = false)\r\n  @Builder.Default\r\n  private boolean dailyMenu = false;\r\n\r\n  @Column(name = \"is_new\", nullable = false)\r\n  @Builder.Default\r\n  private boolean isNew = false;\r\n\r\n  @OneToMany(mappedBy = \"productVariant\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @BatchSize(size = 50)\r\n  @Builder.Default\r\n  private List<PriceHistory> priceHistory = new ArrayList<>();\r\n\r\n  // Helper opcional para disponibilidad a nivel dominio\r\n  @Transient\r\n  public boolean isAvailable() {\r\n    if (!isActive()) return false;\r\n    if (!managesStock) return true;\r\n    return stockQuantity > 0;\r\n  }\r\n}\r\n",
      "info": {
        "size": 2283,
        "last_modified": "2026-02-01T22:28:37.0926375",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\model\\Tag.java",
      "content": "package com.cocinadelicia.backend.product.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"tag\",\r\n    uniqueConstraints = {\r\n      @UniqueConstraint(name = \"uk_tag_name\", columnNames = \"name\"),\r\n      @UniqueConstraint(name = \"uk_tag_slug\", columnNames = \"slug\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE tag SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class Tag extends BaseAudit {\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String name;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String slug;\r\n}\r\n",
      "info": {
        "size": 895,
        "last_modified": "2026-02-01T22:28:37.0966364",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\CategoryRepository.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/repository/CategoryRepository.java\r\npackage com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.Category;\r\nimport java.util.List;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\n\r\npublic interface CategoryRepository extends JpaRepository<Category, Long> {\r\n\r\n  /**\r\n   * Devuelve todas las categoras NO eliminadas (gracias a @Where) ordenadas por nombre ascendente.\r\n   */\r\n  List<Category> findAllByOrderByNameAsc();\r\n\r\n  /** til si ms adelante quers validar que exista una categora por slug. */\r\n  boolean existsBySlugIgnoreCase(String slug);\r\n}\r\n",
      "info": {
        "size": 670,
        "last_modified": "2026-02-01T22:28:37.1036334",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\PriceHistoryRepository.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/repository/PriceHistoryRepository.java\r\npackage com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.PriceHistory;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport java.util.Set;\r\nimport org.springframework.data.jpa.repository.*;\r\nimport org.springframework.data.repository.query.Param;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface PriceHistoryRepository extends JpaRepository<PriceHistory, Long> {\r\n\r\n  @Query(\r\n\"\"\"\r\n  select ph.price\r\n  from PriceHistory ph\r\n  where ph.productVariant.id = :variantId\r\n    and ph.validFrom <= :now\r\n    and (ph.validTo is null or ph.validTo > :now)\r\n  order by ph.validFrom desc\r\n\"\"\")\r\n  Optional<BigDecimal> findActivePrice(\r\n      @Param(\"variantId\") Long variantId, @Param(\"now\") Instant now);\r\n\r\n  @Query(\r\n\"\"\"\r\n  select ph\r\n  from PriceHistory ph\r\n  where ph.productVariant.id = :variantId\r\n    and ph.validFrom <= :now\r\n    and (ph.validTo is null or ph.validTo > :now)\r\n  order by ph.validFrom desc\r\n\"\"\")\r\n  Optional<PriceHistory> findActivePriceEntry(\r\n      @Param(\"variantId\") Long variantId, @Param(\"now\") Instant now);\r\n\r\n  /**\r\n   * Query batch optimizada para obtener precios actuales de mltiples variantes. Reduce N+1 queries\r\n   * a una sola consulta.\r\n   */\r\n  @Query(\r\n\"\"\"\r\n  select ph\r\n  from PriceHistory ph\r\n  where ph.productVariant.id in :variantIds\r\n    and ph.validFrom <= :now\r\n    and (ph.validTo is null or ph.validTo > :now)\r\n  order by ph.productVariant.id, ph.validFrom desc\r\n\"\"\")\r\n  List<PriceHistory> findCurrentPricesForVariants(\r\n      @Param(\"variantIds\") Set<Long> variantIds, @Param(\"now\") Instant now);\r\n\r\n  /** Sobrecarga con timestamp actual por defecto. */\r\n  default List<PriceHistory> findCurrentPricesForVariants(Set<Long> variantIds) {\r\n    return findCurrentPricesForVariants(variantIds, Instant.now());\r\n  }\r\n}\r\n",
      "info": {
        "size": 1998,
        "last_modified": "2026-02-01T22:28:37.1066338",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\ProductImageRepository.java",
      "content": "package com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.ProductImage;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface ProductImageRepository extends JpaRepository<ProductImage, Long> {\r\n\r\n  //  Orden: sortOrder ASC y luego createdAt ASC (si tu BaseAudit no tiene createdAt, ver preguntas\r\n  // al final)\r\n  List<ProductImage> findByProduct_IdOrderBySortOrderAscCreatedAtAsc(Long productId);\r\n\r\n  Optional<ProductImage> findFirstByProduct_IdAndIsMainTrue(Long productId);\r\n\r\n  boolean existsByProduct_IdAndIsMainTrue(Long productId);\r\n}\r\n",
      "info": {
        "size": 739,
        "last_modified": "2026-02-01T22:28:37.1106331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\ProductRepository.java",
      "content": "package com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport org.springframework.data.domain.Page;\r\nimport org.springframework.data.domain.Pageable;\r\nimport org.springframework.data.jpa.repository.EntityGraph;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.data.jpa.repository.JpaSpecificationExecutor;\r\nimport org.springframework.data.jpa.repository.Query;\r\nimport org.springframework.data.repository.query.Param;\r\n\r\npublic interface ProductRepository\r\n    extends JpaRepository<Product, Long>, JpaSpecificationExecutor<Product> {\r\n\r\n  Page<Product> findByIsActiveTrue(Pageable pageable);\r\n\r\n  Page<Product> findByIsActiveTrueAndCategory_SlugIgnoreCase(String slug, Pageable pageable);\r\n\r\n  Page<Product> findByCategory_Id(Long categoryId, Pageable pageable);\r\n\r\n  Page<Product> findByIsActive(boolean isActive, Pageable pageable);\r\n\r\n  Page<Product> findByCategory_IdAndIsActive(Long categoryId, boolean isActive, Pageable pageable);\r\n\r\n  boolean existsByCategory_Id(Long categoryId);\r\n\r\n  /**\r\n   * Query optimizada con fetch joins para evitar N+1 queries en catlogo. Carga productos con sus\r\n   * variantes y precios actuales en una sola consulta.\r\n   */\r\n  @Query(\r\n      \"\"\"\r\n      SELECT DISTINCT p FROM Product p\r\n      LEFT JOIN FETCH p.variants v\r\n      LEFT JOIN FETCH p.category\r\n      WHERE p.deletedAt IS NULL\r\n      AND p.isActive = true\r\n      ORDER BY p.name\r\n      \"\"\")\r\n  List<Product> findAllActiveWithVariantsAndCategory();\r\n\r\n  /** Obtiene IDs de productos activos para paginacin manual optimizada. */\r\n  @Query(\r\n      \"\"\"\r\n      SELECT p.id FROM Product p\r\n      WHERE p.deletedAt IS NULL\r\n      AND p.isActive = true\r\n      ORDER BY p.name\r\n      \"\"\")\r\n  List<Long> findAllActiveProductIds(Pageable pageable);\r\n\r\n  /** Carga productos por IDs con fetch joins (segunda query de paginacin optimizada). */\r\n  @Query(\r\n      \"\"\"\r\n      SELECT DISTINCT p FROM Product p\r\n      LEFT JOIN FETCH p.variants v\r\n      LEFT JOIN FETCH p.category\r\n      LEFT JOIN FETCH p.images\r\n      LEFT JOIN FETCH p.tags\r\n      WHERE p.id IN :ids\r\n      ORDER BY p.name\r\n      \"\"\")\r\n  List<Product> findByIdsWithFetchJoins(@Param(\"ids\") List<Long> ids);\r\n\r\n  @EntityGraph(attributePaths = {\"category\", \"variants\", \"tags\"})\r\n  Optional<Product> findBySlugIgnoreCaseAndIsActiveTrue(String slug);\r\n}\r\n",
      "info": {
        "size": 2461,
        "last_modified": "2026-02-01T22:28:37.1146332",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\ProductVariantRepository.java",
      "content": "package com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface ProductVariantRepository extends JpaRepository<ProductVariant, Long> {}\r\n",
      "info": {
        "size": 340,
        "last_modified": "2026-02-01T22:28:37.1186331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\spec\\ProductSpecifications.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/repository/spec/ProductSpecifications.java\r\npackage com.cocinadelicia.backend.product.repository.spec;\r\n\r\nimport com.cocinadelicia.backend.product.model.Product;\r\nimport com.cocinadelicia.backend.product.model.ProductVariant;\r\nimport com.cocinadelicia.backend.product.model.Tag;\r\nimport jakarta.persistence.criteria.*;\r\nimport org.springframework.data.jpa.domain.Specification;\r\n\r\npublic class ProductSpecifications {\r\n\r\n  public static Specification<Product> isActive() {\r\n    return (root, query, cb) -> cb.isTrue(root.get(\"isActive\"));\r\n  }\r\n\r\n  public static Specification<Product> hasCategory(String categorySlug) {\r\n    if (categorySlug == null || categorySlug.isBlank()) return null;\r\n    return (root, query, cb) ->\r\n        cb.equal(cb.lower(root.get(\"category\").get(\"slug\")), categorySlug.toLowerCase().trim());\r\n  }\r\n\r\n  public static Specification<Product> searchText(String searchQuery) {\r\n    if (searchQuery == null || searchQuery.isBlank()) return null;\r\n\r\n    String pattern = \"%\" + searchQuery.toLowerCase().trim() + \"%\";\r\n\r\n    return (root, query, cb) -> {\r\n      Predicate namePredicate = cb.like(cb.lower(root.get(\"name\")), pattern);\r\n      Predicate descriptionPredicate = cb.like(cb.lower(root.get(\"description\")), pattern);\r\n\r\n      Join<Product, Tag> tagsJoin = root.join(\"tags\", JoinType.LEFT);\r\n      Predicate tagPredicate = cb.like(cb.lower(tagsJoin.get(\"name\")), pattern);\r\n\r\n      query.distinct(true);\r\n\r\n      return cb.or(namePredicate, descriptionPredicate, tagPredicate);\r\n    };\r\n  }\r\n\r\n  public static Specification<Product> hasFeaturedVariant() {\r\n    return (root, query, cb) -> {\r\n      Subquery<Long> subquery = query.subquery(Long.class);\r\n      Root<ProductVariant> variantRoot = subquery.from(ProductVariant.class);\r\n      subquery.select(variantRoot.get(\"product\").get(\"id\"));\r\n      subquery.where(\r\n          cb.and(\r\n              cb.equal(variantRoot.get(\"product\").get(\"id\"), root.get(\"id\")),\r\n              cb.isTrue(variantRoot.get(\"featured\")),\r\n              cb.isTrue(variantRoot.get(\"isActive\"))));\r\n\r\n      return cb.exists(subquery);\r\n    };\r\n  }\r\n\r\n  public static Specification<Product> hasDailyMenuVariant() {\r\n    return (root, query, cb) -> {\r\n      Subquery<Long> subquery = query.subquery(Long.class);\r\n      Root<ProductVariant> variantRoot = subquery.from(ProductVariant.class);\r\n      subquery.select(variantRoot.get(\"product\").get(\"id\"));\r\n      subquery.where(\r\n          cb.and(\r\n              cb.equal(variantRoot.get(\"product\").get(\"id\"), root.get(\"id\")),\r\n              cb.isTrue(variantRoot.get(\"dailyMenu\")),\r\n              cb.isTrue(variantRoot.get(\"isActive\"))));\r\n\r\n      return cb.exists(subquery);\r\n    };\r\n  }\r\n\r\n  public static Specification<Product> hasNewVariant() {\r\n    return (root, query, cb) -> {\r\n      Subquery<Long> subquery = query.subquery(Long.class);\r\n      Root<ProductVariant> variantRoot = subquery.from(ProductVariant.class);\r\n      subquery.select(variantRoot.get(\"product\").get(\"id\"));\r\n      subquery.where(\r\n          cb.and(\r\n              cb.equal(variantRoot.get(\"product\").get(\"id\"), root.get(\"id\")),\r\n              cb.isTrue(variantRoot.get(\"isNew\")),\r\n              cb.isTrue(variantRoot.get(\"isActive\"))));\r\n\r\n      return cb.exists(subquery);\r\n    };\r\n  }\r\n\r\n  public static Specification<Product> hasAvailableVariant() {\r\n    return (root, query, cb) -> {\r\n      Subquery<Long> subquery = query.subquery(Long.class);\r\n      Root<ProductVariant> variantRoot = subquery.from(ProductVariant.class);\r\n      subquery.select(variantRoot.get(\"product\").get(\"id\"));\r\n\r\n      Predicate isActiveVariant = cb.isTrue(variantRoot.get(\"isActive\"));\r\n      Predicate doesNotManageStock = cb.isFalse(variantRoot.get(\"managesStock\"));\r\n      Predicate hasStock = cb.greaterThan(variantRoot.get(\"stockQuantity\"), 0);\r\n      Predicate availablePredicate = cb.or(doesNotManageStock, hasStock);\r\n\r\n      subquery.where(\r\n          cb.and(\r\n              cb.equal(variantRoot.get(\"product\").get(\"id\"), root.get(\"id\")),\r\n              isActiveVariant,\r\n              availablePredicate));\r\n\r\n      return cb.exists(subquery);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Filtra productos que tengan TODOS los tags especificados (slug). Si la lista est vaca,\r\n   * devuelve null (sin filtro).\r\n   */\r\n  public static Specification<Product> hasTags(java.util.List<String> tagSlugs) {\r\n    if (tagSlugs == null || tagSlugs.isEmpty()) return null;\r\n\r\n    return (root, query, cb) -> {\r\n      // Normalizar slugs a lowercase\r\n      java.util.List<String> normalizedSlugs =\r\n          tagSlugs.stream()\r\n              .filter(s -> s != null && !s.isBlank())\r\n              .map(String::trim)\r\n              .map(String::toLowerCase)\r\n              .distinct()\r\n              .toList();\r\n\r\n      if (normalizedSlugs.isEmpty()) return null;\r\n\r\n      // Para cada tag requerido, verificamos que el producto lo tenga\r\n      Predicate[] tagPredicates = new Predicate[normalizedSlugs.size()];\r\n\r\n      for (int i = 0; i < normalizedSlugs.size(); i++) {\r\n        String tagSlug = normalizedSlugs.get(i);\r\n\r\n        // Subquery: EXISTS (SELECT 1 FROM product_tag pt JOIN tag t WHERE pt.product_id =\r\n        // product.id AND t.slug = ?)\r\n        Subquery<Long> subquery = query.subquery(Long.class);\r\n        Root<Product> subProduct = subquery.from(Product.class);\r\n        Join<Product, Tag> subTagJoin = subProduct.join(\"tags\", JoinType.INNER);\r\n\r\n        subquery.select(cb.literal(1L));\r\n        subquery.where(\r\n            cb.and(\r\n                cb.equal(subProduct.get(\"id\"), root.get(\"id\")),\r\n                cb.equal(cb.lower(subTagJoin.get(\"slug\")), tagSlug)));\r\n\r\n        tagPredicates[i] = cb.exists(subquery);\r\n      }\r\n\r\n      // El producto debe tener TODOS los tags (AND)\r\n      return cb.and(tagPredicates);\r\n    };\r\n  }\r\n}\r\n",
      "info": {
        "size": 5863,
        "last_modified": "2026-02-01T22:28:37.1226331",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\repository\\TagRepository.java",
      "content": "package com.cocinadelicia.backend.product.repository;\r\n\r\nimport com.cocinadelicia.backend.product.model.Tag;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\n\r\ninterface TagRepository extends JpaRepository<Tag, Long> {}\r\n",
      "info": {
        "size": 236,
        "last_modified": "2026-02-01T22:28:37.1296367",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\service\\dto\\PriceInfo.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/service/dto/PriceInfo.java\r\npackage com.cocinadelicia.backend.product.service.dto;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\n\r\n/**\r\n * Informacin de precio vigente para una variante. Usado internamente por el dominio (no es DTO de\r\n * API).\r\n */\r\npublic record PriceInfo(\r\n    BigDecimal amount, CurrencyCode currency, Instant validFrom, Instant validTo) {}\r\n",
      "info": {
        "size": 497,
        "last_modified": "2026-02-01T22:28:37.1366367",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\service\\impl\\PriceServiceImpl.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/service/impl/PriceServiceImpl.java\r\npackage com.cocinadelicia.backend.product.service.impl;\r\n\r\nimport com.cocinadelicia.backend.product.repository.PriceHistoryRepository;\r\nimport com.cocinadelicia.backend.product.service.PriceService;\r\nimport com.cocinadelicia.backend.product.service.dto.PriceInfo;\r\nimport java.time.Instant;\r\nimport java.util.Optional;\r\nimport lombok.RequiredArgsConstructor;\r\nimport lombok.extern.log4j.Log4j2;\r\nimport org.springframework.stereotype.Service;\r\nimport org.springframework.transaction.annotation.Transactional;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\n@Log4j2\r\n@Transactional(readOnly = true)\r\npublic class PriceServiceImpl implements PriceService {\r\n\r\n  private final PriceHistoryRepository priceHistoryRepository;\r\n\r\n  @Override\r\n  public Optional<PriceInfo> getCurrentPriceForVariant(Long variantId) {\r\n    Instant now = Instant.now();\r\n    return priceHistoryRepository\r\n        .findActivePriceEntry(variantId, now)\r\n        .map(\r\n            ph ->\r\n                new PriceInfo(ph.getPrice(), ph.getCurrency(), ph.getValidFrom(), ph.getValidTo()));\r\n  }\r\n}\r\n",
      "info": {
        "size": 1149,
        "last_modified": "2026-02-01T22:28:37.1441164",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\product\\service\\PriceService.java",
      "content": "// src/main/java/com/cocinadelicia/backend/product/service/PriceService.java\r\npackage com.cocinadelicia.backend.product.service;\r\n\r\nimport com.cocinadelicia.backend.product.service.dto.PriceInfo;\r\nimport java.util.Optional;\r\n\r\npublic interface PriceService {\r\n\r\n  /**\r\n   * Devuelve el precio vigente para una variante, si existe.\r\n   *\r\n   * <p>Regla de negocio: - validFrom <= now - validTo is null OR validTo > now\r\n   */\r\n  Optional<PriceInfo> getCurrentPriceForVariant(Long variantId);\r\n}\r\n",
      "info": {
        "size": 495,
        "last_modified": "2026-02-01T22:28:37.1513308",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\AdminPingController.java",
      "content": "package com.cocinadelicia.backend.user;\r\n\r\nimport org.springframework.security.access.prepost.PreAuthorize;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/admin\")\r\nclass AdminPingController {\r\n\r\n  @GetMapping(\"/ping\")\r\n  @PreAuthorize(\"hasRole('ADMIN')\")\r\n  public String pingAdmin() {\r\n    return \"pong-admin\";\r\n  }\r\n}\r\n",
      "info": {
        "size": 367,
        "last_modified": "2026-02-01T22:28:37.1617918",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\controller\\UserController.java",
      "content": "// src/main/java/com/cocinadelicia/backend/user/controller/UserController.java\r\npackage com.cocinadelicia.backend.user.controller;\r\n\r\nimport com.cocinadelicia.backend.user.dto.UserResponseDTO;\r\nimport com.cocinadelicia.backend.user.service.UserService;\r\nimport io.swagger.v3.oas.annotations.Operation;\r\nimport io.swagger.v3.oas.annotations.security.SecurityRequirement;\r\nimport io.swagger.v3.oas.annotations.tags.Tag;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\r\nimport org.springframework.web.bind.annotation.*;\r\n\r\n@RestController\r\n@RequestMapping(\"/api/users\")\r\n@RequiredArgsConstructor\r\n@Tag(name = \"users\", description = \"Perfil del usuario autenticado\")\r\n@SecurityRequirement(name = \"bearer-jwt\")\r\npublic class UserController {\r\n\r\n  private final UserService userService;\r\n\r\n  @GetMapping(\"/me\")\r\n  @Operation(summary = \"Devuelve el perfil app_user del usuario autenticado (crea si no existe)\")\r\n  public UserResponseDTO me(JwtAuthenticationToken auth) {\r\n    // Reutiliza tu registro/actualizacin centralizado\r\n    return userService.registerOrUpdateFromToken(null, auth);\r\n  }\r\n}\r\n",
      "info": {
        "size": 1185,
        "last_modified": "2026-02-01T22:28:37.1657919",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\dto\\UserRegistrationDTO.java",
      "content": "package com.cocinadelicia.backend.user.dto;\r\n\r\nimport lombok.Data;\r\n\r\n@Data\r\npublic class UserRegistrationDTO {\r\n  // Opcionales (el backend tomar sub/email de JWT)\r\n  private String firstName;\r\n  private String lastName;\r\n  private String phone;\r\n}\r\n",
      "info": {
        "size": 253,
        "last_modified": "2026-02-01T22:28:37.1719771",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\dto\\UserResponseDTO.java",
      "content": "package com.cocinadelicia.backend.user.dto;\r\n\r\nimport java.util.Set;\r\nimport lombok.Builder;\r\nimport lombok.Value;\r\n\r\n@Value\r\n@Builder\r\npublic class UserResponseDTO {\r\n  Long id;\r\n  String cognitoUserId;\r\n  String email;\r\n  String firstName;\r\n  String lastName;\r\n  String phone;\r\n  Set<String> roles; // 'ADMIN','CHEF','COURIER','CUSTOMER'\r\n}\r\n",
      "info": {
        "size": 344,
        "last_modified": "2026-02-01T22:28:37.1759772",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\model\\AppUser.java",
      "content": "package com.cocinadelicia.backend.user.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport java.util.HashSet;\r\nimport java.util.Set;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"app_user\",\r\n    uniqueConstraints = {\r\n      @UniqueConstraint(name = \"uk_user_cognito\", columnNames = \"cognito_user_id\"),\r\n      @UniqueConstraint(name = \"uk_user_email\", columnNames = \"email\")\r\n    })\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE app_user SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class AppUser extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @Column(name = \"cognito_user_id\", length = 191, nullable = false)\r\n  private String cognitoUserId;\r\n\r\n  @Column(name = \"first_name\", length = 191)\r\n  private String firstName;\r\n\r\n  @Column(name = \"last_name\", length = 191)\r\n  private String lastName;\r\n\r\n  @Column(length = 191, nullable = false)\r\n  private String email;\r\n\r\n  @Column(length = 50)\r\n  private String phone;\r\n\r\n  @Column(name = \"is_active\", nullable = false)\r\n  private boolean isActive = true;\r\n\r\n  // Conveniencia para navegar roles\r\n  @OneToMany(mappedBy = \"user\", cascade = CascadeType.ALL, orphanRemoval = true)\r\n  @Builder.Default\r\n  private Set<UserRole> roles = new HashSet<>();\r\n}\r\n",
      "info": {
        "size": 1494,
        "last_modified": "2026-02-01T22:28:37.182977",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\model\\CustomerAddress.java",
      "content": "package com.cocinadelicia.backend.user.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport jakarta.persistence.*;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(name = \"customer_address\")\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE customer_address SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class CustomerAddress extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY)\r\n  @JoinColumn(name = \"user_id\", nullable = false)\r\n  private AppUser user;\r\n\r\n  @Column(length = 100)\r\n  private String label;\r\n\r\n  @Column(name = \"line1\", length = 191, nullable = false)\r\n  private String line1;\r\n\r\n  @Column(name = \"line2\", length = 191)\r\n  private String line2;\r\n\r\n  @Column(length = 100, nullable = false)\r\n  private String city;\r\n\r\n  @Column(length = 100)\r\n  private String region;\r\n\r\n  @Column(name = \"postal_code\", length = 20)\r\n  private String postalCode;\r\n\r\n  @Column(length = 191)\r\n  private String reference;\r\n}\r\n",
      "info": {
        "size": 1192,
        "last_modified": "2026-02-01T22:28:37.1869771",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\model\\Role.java",
      "content": "package com.cocinadelicia.backend.user.model;\r\n\r\nimport com.cocinadelicia.backend.common.model.BaseAudit;\r\nimport com.cocinadelicia.backend.common.model.enums.RoleName;\r\nimport jakarta.persistence.*;\r\nimport lombok.*;\r\nimport org.hibernate.annotations.SQLDelete;\r\nimport org.hibernate.annotations.Where;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"role\",\r\n    uniqueConstraints = @UniqueConstraint(name = \"uk_role_name\", columnNames = \"name\"))\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\n@SQLDelete(sql = \"UPDATE role SET deleted_at = NOW() WHERE id = ?\")\r\n@Where(clause = \"deleted_at IS NULL\")\r\npublic class Role extends BaseAudit {\r\n\r\n  @Id\r\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\r\n  private Long id;\r\n\r\n  @Enumerated(EnumType.STRING)\r\n  @Column(nullable = false, length = 50)\r\n  private RoleName name;\r\n\r\n  @Column(length = 255)\r\n  private String description;\r\n}\r\n",
      "info": {
        "size": 897,
        "last_modified": "2026-02-01T22:28:37.1909771",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\model\\UserRole.java",
      "content": "package com.cocinadelicia.backend.user.model;\r\n\r\nimport jakarta.persistence.*;\r\nimport java.time.Instant;\r\nimport lombok.*;\r\n\r\n@Entity\r\n@Table(\r\n    name = \"user_role\",\r\n    uniqueConstraints =\r\n        @UniqueConstraint(\r\n            name = \"uk_user_role\",\r\n            columnNames = {\"user_id\", \"role_id\"}))\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\n@Builder\r\npublic class UserRole {\r\n\r\n  @EmbeddedId private UserRoleId id;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY, optional = false)\r\n  @MapsId(\"userId\")\r\n  @JoinColumn(name = \"user_id\", nullable = false)\r\n  private AppUser user;\r\n\r\n  @ManyToOne(fetch = FetchType.LAZY, optional = false)\r\n  @MapsId(\"roleId\")\r\n  @JoinColumn(name = \"role_id\", nullable = false)\r\n  private Role role;\r\n\r\n  @Column(name = \"assigned_at\", nullable = false)\r\n  private Instant assignedAt;\r\n\r\n  /** Conveniencia: permite new UserRole(user, role) */\r\n  public UserRole(AppUser user, Role role) {\r\n    this.user = user;\r\n    this.role = role;\r\n    this.id =\r\n        new UserRoleId(user != null ? user.getId() : null, role != null ? role.getId() : null);\r\n  }\r\n\r\n  @PrePersist\r\n  void onCreate() {\r\n    if (this.id == null) {\r\n      this.id =\r\n          new UserRoleId(user != null ? user.getId() : null, role != null ? role.getId() : null);\r\n    }\r\n    if (this.assignedAt == null) {\r\n      this.assignedAt = Instant.now();\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 1384,
        "last_modified": "2026-02-01T22:28:37.1949823",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\model\\UserRoleId.java",
      "content": "package com.cocinadelicia.backend.user.model;\r\n\r\nimport jakarta.persistence.Embeddable;\r\nimport java.io.Serializable;\r\nimport java.util.Objects;\r\nimport lombok.*;\r\n\r\n@Embeddable\r\n@Getter\r\n@Setter\r\n@NoArgsConstructor\r\n@AllArgsConstructor\r\npublic class UserRoleId implements Serializable {\r\n  private Long userId;\r\n  private Long roleId;\r\n\r\n  @Override\r\n  public boolean equals(Object o) {\r\n    if (this == o) return true;\r\n    if (!(o instanceof UserRoleId that)) return false;\r\n    return Objects.equals(userId, that.userId) && Objects.equals(roleId, that.roleId);\r\n  }\r\n\r\n  @Override\r\n  public int hashCode() {\r\n    return Objects.hash(userId, roleId);\r\n  }\r\n}\r\n",
      "info": {
        "size": 663,
        "last_modified": "2026-02-01T22:28:37.198977",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\repository\\CustomerAddressRepository.java",
      "content": "package com.cocinadelicia.backend.user.repository;\r\n\r\nimport com.cocinadelicia.backend.user.model.CustomerAddress;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\n\r\ninterface CustomerAddressRepository extends JpaRepository<CustomerAddress, Long> {}\r\n",
      "info": {
        "size": 266,
        "last_modified": "2026-02-01T22:28:37.2059771",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\repository\\RoleRepository.java",
      "content": "package com.cocinadelicia.backend.user.repository;\r\n\r\nimport com.cocinadelicia.backend.common.model.enums.RoleName;\r\nimport com.cocinadelicia.backend.user.model.Role;\r\nimport java.util.Collection;\r\nimport java.util.List;\r\nimport java.util.Optional;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\n\r\npublic interface RoleRepository extends JpaRepository<Role, Long> {\r\n  Optional<Role> findByName(RoleName name);\r\n\r\n  // Buscar todos los roles cuyo name  {ADMIN, CHEF, ...}\r\n  List<Role> findByNameIn(Collection<RoleName> names);\r\n}\r\n",
      "info": {
        "size": 552,
        "last_modified": "2026-02-01T22:28:37.2099769",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\repository\\UserRepository.java",
      "content": "package com.cocinadelicia.backend.user.repository;\r\n\r\nimport com.cocinadelicia.backend.user.model.AppUser;\r\nimport java.util.Optional;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\nimport org.springframework.stereotype.Repository;\r\n\r\n@Repository\r\npublic interface UserRepository extends JpaRepository<AppUser, Long> {\r\n  Optional<AppUser> findByCognitoUserId(String cognitoUserId);\r\n\r\n  Optional<AppUser> findByEmail(String email);\r\n}\r\n",
      "info": {
        "size": 454,
        "last_modified": "2026-02-01T22:28:37.213983",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\repository\\UserRoleRepository.java",
      "content": "package com.cocinadelicia.backend.user.repository;\r\n\r\nimport com.cocinadelicia.backend.user.model.UserRole;\r\nimport com.cocinadelicia.backend.user.model.UserRoleId;\r\nimport org.springframework.data.jpa.repository.JpaRepository;\r\n\r\npublic interface UserRoleRepository extends JpaRepository<UserRole, UserRoleId> {\r\n  boolean existsByUserIdAndRoleId(Long userId, Long roleId);\r\n}\r\n",
      "info": {
        "size": 379,
        "last_modified": "2026-02-01T22:28:37.2179768",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\service\\CurrentUserService.java",
      "content": "// src/main/java/com/cocinadelicia/backend/user/service/CurrentUserService.java\r\npackage com.cocinadelicia.backend.user.service;\r\n\r\npublic interface CurrentUserService {\r\n  Long getOrCreateCurrentUserId(); // id en app_user\r\n\r\n  String getCurrentUserEmail(); // email del usuario autenticado\r\n}\r\n",
      "info": {
        "size": 296,
        "last_modified": "2026-02-01T22:28:37.2249793",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\service\\impl\\CurrentUserServiceImpl.java",
      "content": "// src/main/java/com/cocinadelicia/backend/user/service/impl/CurrentUserServiceImpl.java\r\npackage com.cocinadelicia.backend.user.service.impl;\r\n\r\nimport com.cocinadelicia.backend.user.dto.UserRegistrationDTO;\r\nimport com.cocinadelicia.backend.user.service.CurrentUserService;\r\nimport com.cocinadelicia.backend.user.service.UserService;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.security.core.Authentication;\r\nimport org.springframework.security.core.context.SecurityContextHolder;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\npublic class CurrentUserServiceImpl implements CurrentUserService {\r\n\r\n  private final UserService userService;\r\n\r\n  @Override\r\n  public Long getOrCreateCurrentUserId() {\r\n    Authentication auth = SecurityContextHolder.getContext().getAuthentication();\r\n    if (!(auth instanceof JwtAuthenticationToken jwtAuth)) {\r\n      throw new IllegalStateException(\"No JWT authentication present.\");\r\n    }\r\n    // Reutiliza tu lgica centralizada (crea o actualiza y nos devuelve el id)\r\n    var dto = userService.registerOrUpdateFromToken((UserRegistrationDTO) null, jwtAuth);\r\n    return dto.getId();\r\n  }\r\n\r\n  @Override\r\n  public String getCurrentUserEmail() {\r\n    Authentication auth = SecurityContextHolder.getContext().getAuthentication();\r\n    if (!(auth instanceof JwtAuthenticationToken jwtAuth)) {\r\n      throw new IllegalStateException(\"No JWT authentication present.\");\r\n    }\r\n    String email = jwtAuth.getToken().getClaimAsString(\"email\");\r\n    if (email == null || email.isBlank()) {\r\n      email = jwtAuth.getToken().getSubject();\r\n    }\r\n    return email;\r\n  }\r\n}\r\n",
      "info": {
        "size": 1769,
        "last_modified": "2026-02-01T22:28:37.2289799",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\service\\impl\\UserServiceImpl.java",
      "content": "package com.cocinadelicia.backend.user.service.impl;\r\n\r\nimport com.cocinadelicia.backend.auth.cognito.CognitoUserInfoClient;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.model.enums.RoleName;\r\nimport com.cocinadelicia.backend.user.dto.UserRegistrationDTO;\r\nimport com.cocinadelicia.backend.user.dto.UserResponseDTO;\r\nimport com.cocinadelicia.backend.user.model.AppUser;\r\nimport com.cocinadelicia.backend.user.model.Role;\r\nimport com.cocinadelicia.backend.user.model.UserRole;\r\nimport com.cocinadelicia.backend.user.repository.RoleRepository;\r\nimport com.cocinadelicia.backend.user.repository.UserRepository;\r\nimport com.cocinadelicia.backend.user.repository.UserRoleRepository;\r\nimport com.cocinadelicia.backend.user.service.UserService;\r\nimport jakarta.transaction.Transactional;\r\nimport java.util.*;\r\nimport java.util.stream.Collectors;\r\nimport lombok.RequiredArgsConstructor;\r\nimport org.springframework.security.oauth2.jwt.Jwt;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\r\nimport org.springframework.stereotype.Service;\r\n\r\n@Service\r\n@RequiredArgsConstructor\r\npublic class UserServiceImpl implements UserService {\r\n\r\n  private final UserRepository userRepo;\r\n  private final RoleRepository roleRepo;\r\n  private final UserRoleRepository userRoleRepo;\r\n  private final CognitoUserInfoClient userInfoClient;\r\n\r\n  @Override\r\n  @Transactional\r\n  public UserResponseDTO registerOrUpdateFromToken(\r\n      UserRegistrationDTO body, JwtAuthenticationToken auth) {\r\n\r\n    var jwt = auth.getToken();\r\n\r\n    final String sub = jwt.getClaimAsString(\"sub\");\r\n    @SuppressWarnings(\"unchecked\")\r\n    final List<String> groups =\r\n        Optional.ofNullable((List<String>) jwt.getClaim(\"cognito:groups\")).orElseGet(List::of);\r\n\r\n    final String accessTokenValue = jwt.getTokenValue();\r\n    Map<String, Object> userInfo = userInfoClient.fetchUserInfo(accessTokenValue);\r\n\r\n    String rawEmail = asString(userInfo.get(\"email\"));\r\n    String givenName =\r\n        firstNonBlank(\r\n            asString(userInfo.get(\"given_name\")), body != null ? body.getFirstName() : null);\r\n    String familyName =\r\n        firstNonBlank(\r\n            asString(userInfo.get(\"family_name\")), body != null ? body.getLastName() : null);\r\n    String phone =\r\n        firstNonBlank(\r\n            asString(userInfo.get(\"phone_number\")), body != null ? body.getPhone() : null);\r\n\r\n    if (rawEmail == null || rawEmail.isBlank()) {\r\n      throw new UserService.MissingEmailException(\r\n          \"Cognito userInfo did not return email. Ensure scopes 'email profile' and attribute mapping are configured for the App Client/IdP.\");\r\n    }\r\n\r\n    final String email = rawEmail.trim().toLowerCase(Locale.ROOT);\r\n\r\n    Optional<AppUser> bySub = userRepo.findByCognitoUserId(sub);\r\n    Optional<AppUser> byEmail = userRepo.findByEmail(email);\r\n\r\n    if (bySub.isPresent()) {\r\n      AppUser u = bySub.get();\r\n      if (byEmail.isPresent() && !Objects.equals(byEmail.get().getId(), u.getId())) {\r\n        throw new UserService.EmailConflictException(email);\r\n      }\r\n      if (givenName != null && !givenName.isBlank()) u.setFirstName(givenName);\r\n      if (familyName != null && !familyName.isBlank()) u.setLastName(familyName);\r\n      if (phone != null && !phone.isBlank()) u.setPhone(phone);\r\n      u.setEmail(email);\r\n\r\n      addMissingRoles(u, groups);\r\n      AppUser saved = userRepo.save(u);\r\n      return toDto(saved);\r\n    }\r\n\r\n    if (byEmail.isPresent()) {\r\n      throw new UserService.EmailConflictException(email);\r\n    }\r\n\r\n    AppUser created =\r\n        AppUser.builder()\r\n            .cognitoUserId(sub)\r\n            .email(email)\r\n            .firstName(Objects.requireNonNullElse(givenName, \"\"))\r\n            .lastName(Objects.requireNonNullElse(familyName, \"\"))\r\n            .phone(phone)\r\n            .isActive(true)\r\n            .build();\r\n\r\n    created = userRepo.save(created);\r\n    addMissingRoles(created, groups);\r\n    created = userRepo.save(created);\r\n\r\n    return toDto(created);\r\n  }\r\n\r\n  @Override\r\n  public Long resolveUserIdFromJwt(Jwt jwt) {\r\n    final String sub = jwt.getClaim(\"sub\");\r\n    return userRepo\r\n        .findByCognitoUserId(sub)\r\n        .map(AppUser::getId)\r\n        .orElseThrow(\r\n            () -> new NotFoundException(\"Usuario no registrado en app_user para sub=\" + sub));\r\n  }\r\n\r\n  /* ===== Helpers ===== */\r\n\r\n  private void addMissingRoles(AppUser user, List<String> groups) {\r\n    if (groups == null || groups.isEmpty()) return;\r\n\r\n    Set<RoleName> requested =\r\n        groups.stream()\r\n            .filter(Objects::nonNull)\r\n            .map(String::trim)\r\n            .map(String::toUpperCase)\r\n            .map(\r\n                s -> {\r\n                  try {\r\n                    return RoleName.valueOf(s);\r\n                  } catch (IllegalArgumentException ex) {\r\n                    return null;\r\n                  }\r\n                })\r\n            .filter(Objects::nonNull)\r\n            .collect(Collectors.toCollection(LinkedHashSet::new));\r\n\r\n    if (requested.isEmpty()) return;\r\n\r\n    List<Role> existing = roleRepo.findByNameIn(requested);\r\n    if (existing.isEmpty()) return;\r\n\r\n    Map<RoleName, Role> roleByName =\r\n        existing.stream().collect(Collectors.toMap(Role::getName, r -> r));\r\n\r\n    for (RoleName rn : requested) {\r\n      Role r = roleByName.get(rn);\r\n      if (r == null) continue;\r\n      boolean hasIt =\r\n          user.getRoles().stream().anyMatch(ur -> ur.getRole().getId().equals(r.getId()));\r\n      if (!hasIt) {\r\n        UserRole ur = new UserRole(user, r);\r\n        user.getRoles().add(ur);\r\n        // si tens cascada en AppUser.roles, alcanza con agregar al set.\r\n        // Si no, persist explcitamente: userRoleRepo.save(ur);\r\n      }\r\n    }\r\n  }\r\n\r\n  private UserResponseDTO toDto(AppUser u) {\r\n    Set<String> roleNames =\r\n        u.getRoles().stream()\r\n            .map(ur -> ur.getRole().getName().name())\r\n            .collect(Collectors.toCollection(LinkedHashSet::new));\r\n\r\n    return UserResponseDTO.builder()\r\n        .id(u.getId())\r\n        .cognitoUserId(u.getCognitoUserId())\r\n        .email(u.getEmail())\r\n        .firstName(u.getFirstName())\r\n        .lastName(u.getLastName())\r\n        .phone(u.getPhone())\r\n        .roles(roleNames)\r\n        .build();\r\n  }\r\n\r\n  private static String firstNonBlank(String a, String b) {\r\n    if (a != null && !a.isBlank()) return a;\r\n    if (b != null && !b.isBlank()) return b;\r\n    return null;\r\n  }\r\n\r\n  private static String asString(Object o) {\r\n    return o == null ? null : o.toString();\r\n  }\r\n}\r\n",
      "info": {
        "size": 6637,
        "last_modified": "2026-02-01T22:28:37.2329813",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\java\\com\\cocinadelicia\\backend\\user\\service\\UserService.java",
      "content": "package com.cocinadelicia.backend.user.service;\r\n\r\nimport com.cocinadelicia.backend.user.dto.UserRegistrationDTO;\r\nimport com.cocinadelicia.backend.user.dto.UserResponseDTO;\r\nimport org.springframework.security.oauth2.jwt.Jwt;\r\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\r\n\r\npublic interface UserService {\r\n\r\n  UserResponseDTO registerOrUpdateFromToken(UserRegistrationDTO body, JwtAuthenticationToken auth);\r\n\r\n  // 409\r\n  class EmailConflictException extends RuntimeException {\r\n    public EmailConflictException(String email) {\r\n      super(\"Email already in use: \" + email);\r\n    }\r\n  }\r\n\r\n  Long resolveUserIdFromJwt(Jwt jwt);\r\n\r\n  // 400\r\n  class MissingEmailException extends RuntimeException {\r\n    public MissingEmailException(String msg) {\r\n      super(msg);\r\n    }\r\n  }\r\n}\r\n",
      "info": {
        "size": 839,
        "last_modified": "2026-02-01T22:28:37.2396956",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\resources\\application-dev.yml",
      "content": "# src/main/resources/application-dev.yml\r\nserver:\r\n#  port: 8080\r\n  port: ${SERVER_PORT:8080}\r\n\r\nspring:\r\n  datasource:\r\n    url: ${SPRING_DATASOURCE_URL}\r\n    username: ${SPRING_DATASOURCE_USERNAME}\r\n    password: ${SPRING_DATASOURCE_PASSWORD}\r\n    driver-class-name: org.postgresql.Driver\r\n    hikari:\r\n      maximum-pool-size: 10\r\n      minimum-idle: 2 # mantener algunas conexiones listas\r\n      idle-timeout: 60000 # 60s\r\n      connection-timeout: 30000 # 30s\r\n      max-lifetime: 1800000     # 30min (debe ser menor al timeout del server)\r\n      leak-detection-threshold: 20000   # (opcional) 20s para detectar conexiones no cerradas en dev/staging\r\n\r\n  #    url: jdbc:mysql://${HOST_HOSTINGER}:3306/${NOMBRE_DB}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true\r\n#    username: ${USUARIO_DB}\r\n#    password: ${PASSWORD_DB}\r\n#    driver-class-name: com.mysql.cj.jdbc.Driver\r\n#    hikari:\r\n#      maximum-pool-size: 5\r\n#      minimum-idle: 0\r\n#      idle-timeout: 30000      # 30s\r\n#      max-lifetime: 30000      # 30s < timeout del server\r\n#      validation-timeout: 5000 # 5s\r\n\r\n  jpa:\r\n    hibernate:\r\n#      ddl-auto: none          # seguimos dejando Flyway como owner del schema\r\n    ddl-auto: validate  # en dev cloud podemos recrear la BD en cada arranque\r\n    show-sql: true            # en dev cloud conviene ver SQL\r\n    properties:\r\n      hibernate:\r\n        format_sql: true\r\n        dialect: org.hibernate.dialect.PostgreSQLDialect\r\n    open-in-view: false\r\n\r\n  flyway:\r\n    enabled: true\r\n    locations: classpath:db/migration\r\n    baseline-on-migrate: false\r\n    validate-on-migrate: true\r\n    clean-disabled: false     # en dev pods permitir limpiar si quers\r\n\r\n  security:\r\n    oauth2:\r\n      resourceserver:\r\n        jwt:\r\n          issuer-uri: https://cognito-idp.${AWS_REGION}.amazonaws.com/${COGNITO_USER_POOL_ID}\r\n\r\ncdd:\r\n  security:\r\n    groups-claim: cognito:groups\r\n    required-audience: ${COGNITO_APP_CLIENT_ID:}\r\n\r\napp:\r\n  s3:\r\n    images-bucket: cocinadelicia-images-dev\r\n  openapi:\r\n    server:\r\n      dev: https://cocinadelicia-backend.onrender.com\r\n      prod: https://api.lacocinadelicia.com\r\n  cdn:\r\n    base-url: https://cocinadelicia-images-dev.s3.us-east-1.amazonaws.com\r\n\r\nlogging:\r\n  config: classpath:log4j2-spring.xml\r\n  level:\r\n    root: INFO\r\n    org.springframework.web: DEBUG\r\n    org.hibernate.SQL: DEBUG\r\n    org.hibernate.type.descriptor.sql.BasicBinder: TRACE\r\n",
      "info": {
        "size": 2431,
        "last_modified": "2026-02-01T22:28:37.2626952",
        "mime_type": "text/x-yaml",
        "extension": ".yml"
      }
    },
    {
      "path": "main\\resources\\application-local.yml",
      "content": "# src/main/resources/application-local.yml\r\nserver:\r\n  port: 8443\r\n  ssl:\r\n    enabled: true\r\n    key-store: classpath:ssl/cdd-local.p12\r\n    key-store-password: changeit123   # <= usa el password que pusiste en keytool\r\n    key-store-type: PKCS12\r\n    key-alias: cdd-local\r\n    client-auth: none\r\n\r\nspring:\r\n  h2:\r\n    console:\r\n      enabled: true\r\n      path: /h2-console\r\n      settings:\r\n        web-allow-others: true\r\n\r\n  datasource:\r\n    url: jdbc:h2:mem:cdd;DB_CLOSE_DELAY=-1;MODE=PostgreSQL;DATABASE_TO_LOWER=true\r\n    driver-class-name: org.h2.Driver\r\n    username: sa\r\n    password:\r\n\r\n  jpa:\r\n    hibernate:\r\n      ddl-auto: none\r\n    show-sql: true\r\n    properties:\r\n      hibernate:\r\n        jdbc.time_zone: UTC\r\n        format_sql: true\r\n        dialect: org.hibernate.dialect.PostgreSQLDialect\r\n    open-in-view: false\r\n\r\n  flyway:\r\n    enabled: true\r\n\r\n  security:\r\n    oauth2:\r\n      resourceserver:\r\n        jwt:\r\n          issuer-uri: https://cognito-idp.${AWS_REGION}.amazonaws.com/${COGNITO_USER_POOL_ID}\r\n\r\ncdd:\r\n  security:\r\n    groups-claim: cognito:groups\r\n    required-audience: ${COGNITO_APP_CLIENT_ID:}\r\n\r\napp:\r\n  s3:\r\n    images-bucket: cocinadelicia-images-dev\r\n  openapi:\r\n    server:\r\n      dev: https://192.168.1.4:8443\r\n      prod: https://api.lacocinadelicia.com\r\n  cdn:\r\n    base-url: https://cocinadelicia-images-dev.s3.us-east-1.amazonaws.com\r\n\r\nlogging:\r\n  config: classpath:log4j2-spring.xml\r\n",
      "info": {
        "size": 1435,
        "last_modified": "2026-02-01T22:28:37.2667847",
        "mime_type": "text/x-yaml",
        "extension": ".yml"
      }
    },
    {
      "path": "main\\resources\\application-prod.yml",
      "content": "# src/main/resources/application-prod.yml\r\nserver:\r\n  port: ${SERVER_PORT:8080}\r\n\r\nspring:\r\n  datasource:\r\n    url: ${SPRING_DATASOURCE_URL}\r\n    username: ${SPRING_DATASOURCE_USERNAME}\r\n    password: ${SPRING_DATASOURCE_PASSWORD}\r\n    driver-class-name: org.postgresql.Driver\r\n    hikari:\r\n      #  Clave para que Aurora pueda pausar\r\n#      minimum-idle: 0            # antes: 2 (esto mantena 2 conexiones abiertas SIEMPRE)\r\n      maximum-pool-size: 10\r\n      minimum-idle: 2 # mantener algunas conexiones listas\r\n      idle-timeout: 60000 # 60s\r\n      connection-timeout: 30000 # 30s\r\n      max-lifetime: 1800000     # 30min (debe ser menor al timeout del server)\r\n      leak-detection-threshold: 20000   # (opcional) 20s para detectar conexiones no cerradas en dev/staging\r\n\r\n  jpa:\r\n    hibernate:\r\n      ddl-auto: none\r\n    open-in-view: false\r\n    show-sql: false\r\n    properties:\r\n      hibernate:\r\n        dialect: org.hibernate.dialect.PostgreSQLDialect\r\n        format_sql: false\r\n\r\n\r\n  flyway:\r\n    enabled: true\r\n    locations: classpath:db/migration\r\n    baseline-on-migrate: false\r\n    validate-on-migrate: true\r\n    clean-disabled: true\r\n#    clean-on-validation-error: true\r\n\r\n  security:\r\n    oauth2:\r\n      resourceserver:\r\n        jwt:\r\n          issuer-uri: https://cognito-idp.${AWS_REGION}.amazonaws.com/${COGNITO_USER_POOL_ID}\r\n\r\ncdd:\r\n  security:\r\n    groups-claim: cognito:groups\r\n    # Opcional: valida la audiencia (app client id) si quers ser ms estricto:\r\n    required-audience: ${COGNITO_APP_CLIENT_ID:}\r\n\r\n#  LOGGING: nivel DEBUG para ver exactamente por qu valida/migra mal\r\nlogging:\r\n  config: classpath:log4j2-spring-prod.xml\r\n  level:\r\n    org.flywaydb: DEBUG\r\n    org.hibernate.SQL: DEBUG\r\n    org.hibernate.type.descriptor.sql.BasicBinder: TRACE\r\n# application-prod.yml\r\napp:\r\n  s3:\r\n    images-bucket: cocinadelicia-images-prod\r\n  openapi:\r\n    server:\r\n      dev: https://api.lacocinadelicia.com   # opcional (puede apuntar a prod)\r\n      prod: https://api.lacocinadelicia.com\r\n  cdn:\r\n    base-url: https://dk9xtqc3ymebu.cloudfront.net\r\n\r\nmanagement:\r\n  health:\r\n    db:\r\n      enabled: false   # health no consulta la DB\r\n  endpoint:\r\n    health:\r\n      show-details: never\r\n\r\n#Opcin mejor (health groups: liveness/readiness)\r\n#\r\n#  Hac que el ALB / pipeline consulte /actuator/health/liveness (no DB)\r\n#\r\n#  Dej la DB solo para /actuator/health/readiness si quers un chequeo profundo.\r\n#\r\n#management:\r\n#  endpoint:\r\n#    health:\r\n#      probes:\r\n#        enabled: true\r\n#  endpoints:\r\n#    web:\r\n#      exposure:\r\n#        include: health,info\r\n#  health:\r\n#    db:\r\n#      enabled: true\r\n",
      "info": {
        "size": 2662,
        "last_modified": "2026-02-01T22:28:37.2699986",
        "mime_type": "text/x-yaml",
        "extension": ".yml"
      }
    },
    {
      "path": "main\\resources\\application-test.yml",
      "content": "# src/test/resources/application-test.yml\r\nspring:\r\n  security:\r\n    oauth2:\r\n      resourceserver:\r\n        jwt:\r\n          jwk-set-uri: http://localhost:0/fake-jwks\r\n\r\n  #  DB embebida para que @SpringBootTest cargue contexto en CI\r\n  datasource:\r\n    url: jdbc:h2:mem:cdd_test;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE\r\n    driver-class-name: org.h2.Driver\r\n    username: sa\r\n    password:\r\n\r\n  jpa:\r\n    hibernate:\r\n      ddl-auto: none\r\n    open-in-view: false\r\n\r\n  #  si tus migraciones son Postgres-only, en tests es mejor apagar Flyway\r\n  flyway:\r\n    enabled: false\r\n\r\napp:\r\n  s3:\r\n    images-bucket: fake-bucket-for-tests\r\n  cdn:\r\n    base-url: http://localhost:0/fake-cdn-url-for-tests\r\n",
      "info": {
        "size": 719,
        "last_modified": "2026-02-01T22:28:37.2739984",
        "mime_type": "text/x-yaml",
        "extension": ".yml"
      }
    },
    {
      "path": "main\\resources\\application.yml",
      "content": "# src/main/resources/application.yml\r\nspring:\r\n  application:\r\n    name: CocinaDeLicia\r\n  profiles:\r\n    # local: local\r\n    # dev: dev\r\n    # prod: prod\r\n    default: local\r\n\r\n  flyway:\r\n    enabled: true\r\n    locations: classpath:db/migration\r\n    baseline-on-migrate: false\r\n    validate-on-migrate: true\r\n    clean-disabled: false\r\n\r\n  mvc:\r\n    throw-exception-if-no-handler-found: true\r\n  web:\r\n    resources:\r\n      add-mappings: false\r\n\r\nserver:\r\n  forward-headers-strategy: framework\r\n\r\nmanagement:\r\n  endpoints:\r\n    web:\r\n      exposure:\r\n        include: health,info\r\n  endpoint:\r\n    health:\r\n      probes:\r\n        enabled: true\r\n      show-details: always\r\n\r\ncognito:\r\n  # valor por defecto, lo sobreescriben los profiles\r\n  domain: ${COGNITO_DOMAIN:cdd-auth.auth.us-east-1.amazoncognito.com}\r\n\r\napp:\r\n  s3:\r\n    region: us-east-1\r\n\r\nspringdoc:\r\n  swagger-ui:\r\n    urlsPrimaryName: public",
      "info": {
        "size": 903,
        "last_modified": "2026-02-01T22:28:37.278",
        "mime_type": "text/x-yaml",
        "extension": ".yml"
      }
    },
    {
      "path": "main\\resources\\db\\migration\\V1__init_schema.sql",
      "content": "-- =========================================\r\n-- Cocina DeLicia - PostgreSQL Init Schema (consolidado)\r\n-- Incluye: V3 + V6 + V8 + V9 + V11 (MySQL/H2 -> PostgreSQL)\r\n-- Convenciones: snake_case, soft delete, CHECK enums\r\n-- =========================================\r\n\r\n-- ===============================\r\n-- Catlogo\r\n-- ===============================\r\n\r\nCREATE TABLE IF NOT EXISTS category (\r\n  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  name        VARCHAR(191) NOT NULL UNIQUE,\r\n  slug        VARCHAR(191) NOT NULL UNIQUE,\r\n  description TEXT,\r\n  created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at  TIMESTAMP\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS tag (\r\n  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  name        VARCHAR(191) NOT NULL UNIQUE,\r\n  slug        VARCHAR(191) NOT NULL UNIQUE,\r\n  created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at  TIMESTAMP\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS product (\r\n  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  category_id      BIGINT NOT NULL,\r\n  name             VARCHAR(191) NOT NULL,\r\n  slug             VARCHAR(191) NOT NULL UNIQUE,\r\n  description      TEXT,\r\n  tax_rate_percent NUMERIC(5,2) NOT NULL,\r\n  is_active        BOOLEAN NOT NULL DEFAULT TRUE,\r\n  created_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at       TIMESTAMP,\r\n  CONSTRAINT fk_product_category\r\n    FOREIGN KEY (category_id) REFERENCES category(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS product_tag (\r\n  product_id BIGINT NOT NULL,\r\n  tag_id     BIGINT NOT NULL,\r\n  CONSTRAINT pk_product_tag PRIMARY KEY (product_id, tag_id),\r\n  CONSTRAINT fk_pt_product FOREIGN KEY (product_id) REFERENCES product(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT fk_pt_tag FOREIGN KEY (tag_id) REFERENCES tag(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS product_variant (\r\n  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  product_id     BIGINT NOT NULL,\r\n  sku            VARCHAR(191) UNIQUE,\r\n  name           VARCHAR(191) NOT NULL,\r\n  is_active      BOOLEAN NOT NULL DEFAULT TRUE,\r\n\r\n  -- V8 stock\r\n  manages_stock  BOOLEAN NOT NULL DEFAULT FALSE,\r\n  stock_quantity INT NOT NULL DEFAULT 0,\r\n\r\n  -- V9 marketing flags\r\n  is_featured    BOOLEAN NOT NULL DEFAULT FALSE,\r\n  is_daily_menu  BOOLEAN NOT NULL DEFAULT FALSE,\r\n  is_new         BOOLEAN NOT NULL DEFAULT FALSE,\r\n\r\n  created_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at     TIMESTAMP,\r\n\r\n  CONSTRAINT fk_variant_product\r\n    FOREIGN KEY (product_id) REFERENCES product(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n\r\n  CONSTRAINT chk_variant_stock_quantity_non_negative\r\n    CHECK (stock_quantity >= 0)\r\n);\r\n\r\n-- currency_code: UYU, USD\r\nCREATE TABLE IF NOT EXISTS price_history (\r\n  id                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  product_variant_id BIGINT NOT NULL,\r\n  price              NUMERIC(10,2) NOT NULL,\r\n  currency           VARCHAR(3) NOT NULL,\r\n  valid_from         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  valid_to           TIMESTAMP,\r\n  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at         TIMESTAMP,\r\n  CONSTRAINT fk_ph_variant FOREIGN KEY (product_variant_id) REFERENCES product_variant(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT chk_currency CHECK (currency IN ('UYU','USD'))\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_ph_variant_from ON price_history (product_variant_id, valid_from);\r\nCREATE INDEX IF NOT EXISTS idx_ph_variant_to   ON price_history (product_variant_id, valid_to);\r\n\r\n-- ===============================\r\n-- Usuarios y Roles (Cognito + BD)\r\n-- ===============================\r\n\r\nCREATE TABLE IF NOT EXISTS app_user (\r\n  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  cognito_user_id VARCHAR(191) NOT NULL UNIQUE,\r\n  first_name      VARCHAR(191) NOT NULL,\r\n  last_name       VARCHAR(191) NOT NULL,\r\n  email           VARCHAR(191) NOT NULL UNIQUE,\r\n  phone           VARCHAR(50),\r\n  is_active       BOOLEAN NOT NULL DEFAULT TRUE,\r\n  created_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at      TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at      TIMESTAMP\r\n);\r\n\r\n-- role_name: ADMIN, CHEF, COURIER, CUSTOMER\r\nCREATE TABLE IF NOT EXISTS role (\r\n  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  name        VARCHAR(50) NOT NULL UNIQUE,\r\n  description VARCHAR(255),\r\n  created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at  TIMESTAMP,\r\n  CONSTRAINT chk_role_name CHECK (name IN ('ADMIN','CHEF','COURIER','CUSTOMER'))\r\n);\r\n\r\nCREATE TABLE IF NOT EXISTS user_role (\r\n  user_id     BIGINT NOT NULL,\r\n  role_id     BIGINT NOT NULL,\r\n  assigned_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  CONSTRAINT pk_user_role PRIMARY KEY (user_id, role_id),\r\n  CONSTRAINT fk_ur_user FOREIGN KEY (user_id) REFERENCES app_user(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT fk_ur_role FOREIGN KEY (role_id) REFERENCES role(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT\r\n);\r\n\r\n-- ===============================\r\n-- Pedidos / Checkout\r\n-- ===============================\r\n\r\nCREATE TABLE IF NOT EXISTS customer_address (\r\n  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  user_id     BIGINT NOT NULL,\r\n  label       VARCHAR(100),\r\n  line1       VARCHAR(191) NOT NULL,\r\n  line2       VARCHAR(191),\r\n  city        VARCHAR(100) NOT NULL,\r\n  region      VARCHAR(100),\r\n  postal_code VARCHAR(20),\r\n  reference   VARCHAR(191),\r\n  created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at  TIMESTAMP,\r\n  CONSTRAINT fk_address_user FOREIGN KEY (user_id) REFERENCES app_user(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT\r\n);\r\n\r\n-- order_status: CREATED, CONFIRMED, PREPARING, READY, OUT_FOR_DELIVERY, DELIVERED, CANCELLED\r\n-- fulfillment_type: PICKUP, DELIVERY\r\n-- currency_code: UYU, USD\r\nCREATE TABLE IF NOT EXISTS customer_order (\r\n  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  user_id           BIGINT NOT NULL,\r\n  status           VARCHAR(30) NOT NULL,\r\n  fulfillment      VARCHAR(30) NOT NULL,\r\n  currency         VARCHAR(3)  NOT NULL,\r\n  subtotal_amount  NUMERIC(10,2) NOT NULL DEFAULT 0.00,\r\n  tax_amount       NUMERIC(10,2) NOT NULL DEFAULT 0.00,\r\n  discount_amount  NUMERIC(10,2) NOT NULL DEFAULT 0.00,\r\n  total_amount     NUMERIC(10,2) NOT NULL DEFAULT 0.00,\r\n\r\n  ship_name        VARCHAR(191),\r\n  ship_phone       VARCHAR(50),\r\n  ship_line1       VARCHAR(191),\r\n  ship_line2       VARCHAR(191),\r\n  ship_city        VARCHAR(100),\r\n  ship_region      VARCHAR(100),\r\n  ship_postal_code VARCHAR(20),\r\n  ship_reference   VARCHAR(191),\r\n\r\n  notes            TEXT,\r\n\r\n  -- V6 (consolidado)\r\n  requested_at     TIMESTAMP NULL,\r\n  delivered_at     TIMESTAMP NULL,\r\n\r\n  created_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at       TIMESTAMP,\r\n\r\n  CONSTRAINT fk_order_user FOREIGN KEY (user_id) REFERENCES app_user(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n\r\n  CONSTRAINT chk_order_status CHECK (\r\n    status IN ('CREATED','CONFIRMED','PREPARING','READY','OUT_FOR_DELIVERY','DELIVERED','CANCELLED')\r\n  ),\r\n  CONSTRAINT chk_fulfillment CHECK (fulfillment IN ('PICKUP','DELIVERY')),\r\n  CONSTRAINT chk_order_currency CHECK (currency IN ('UYU','USD'))\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_order_user_created    ON customer_order (user_id, created_at);\r\nCREATE INDEX IF NOT EXISTS idx_order_status_created  ON customer_order (status, created_at);\r\nCREATE INDEX IF NOT EXISTS idx_order_requested_at    ON customer_order (requested_at);\r\n\r\nCREATE TABLE IF NOT EXISTS order_item (\r\n  id                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  order_id           BIGINT NOT NULL,\r\n  product_id         BIGINT NOT NULL,\r\n  product_variant_id BIGINT NOT NULL,\r\n  product_name       VARCHAR(191) NOT NULL,\r\n  variant_name       VARCHAR(191) NOT NULL,\r\n  unit_price         NUMERIC(10,2) NOT NULL,\r\n  quantity           INT NOT NULL DEFAULT 1,\r\n  line_total         NUMERIC(10,2) NOT NULL,\r\n  created_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at         TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at         TIMESTAMP,\r\n  CONSTRAINT fk_item_order   FOREIGN KEY (order_id) REFERENCES customer_order(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT fk_item_product FOREIGN KEY (product_id) REFERENCES product(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT fk_item_variant FOREIGN KEY (product_variant_id) REFERENCES product_variant(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_item_order ON order_item (order_id);\r\n\r\n-- payment_method: CASH, BANK_TRANSFER, MERCADOPAGO, CREDIT_CARD, DEBIT_CARD\r\n-- payment_status: PENDING, AUTHORIZED, PAID, FAILED, REFUNDED, CANCELLED\r\n-- currency_code: UYU, USD\r\nCREATE TABLE IF NOT EXISTS payment (\r\n  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  order_id       BIGINT NOT NULL,\r\n  method         VARCHAR(30) NOT NULL,\r\n  status         VARCHAR(30) NOT NULL,\r\n  amount         NUMERIC(10,2) NOT NULL,\r\n  currency       VARCHAR(3) NOT NULL,\r\n  provider_tx_id VARCHAR(191),\r\n  note           VARCHAR(255),\r\n  created_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at     TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at     TIMESTAMP,\r\n  CONSTRAINT fk_payment_order FOREIGN KEY (order_id) REFERENCES customer_order(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n  CONSTRAINT chk_payment_method CHECK (\r\n    method IN ('CASH','BANK_TRANSFER','MERCADOPAGO','CREDIT_CARD','DEBIT_CARD')\r\n  ),\r\n  CONSTRAINT chk_payment_status CHECK (\r\n    status IN ('PENDING','AUTHORIZED','PAID','FAILED','REFUNDED','CANCELLED')\r\n  ),\r\n  CONSTRAINT chk_payment_currency CHECK (currency IN ('UYU','USD'))\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_payment_order          ON payment (order_id);\r\nCREATE INDEX IF NOT EXISTS idx_payment_status_created ON payment (status, created_at);\r\n\r\n-- ===============================\r\n-- Imgenes de producto (V11 consolidado)\r\n-- ===============================\r\n\r\nCREATE TABLE IF NOT EXISTS product_image (\r\n  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  product_id BIGINT NOT NULL,\r\n\r\n  object_key VARCHAR(512) NOT NULL,\r\n  is_main    BOOLEAN NOT NULL DEFAULT FALSE,\r\n  sort_order INT NOT NULL DEFAULT 0,\r\n\r\n  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  deleted_at TIMESTAMP,\r\n\r\n  CONSTRAINT fk_product_image_product\r\n    FOREIGN KEY (product_id) REFERENCES product(id)\r\n    ON UPDATE RESTRICT ON DELETE RESTRICT,\r\n\r\n  CONSTRAINT chk_product_image_sort_order_non_negative\r\n    CHECK (sort_order >= 0),\r\n\r\n  CONSTRAINT uk_product_image_product_key\r\n    UNIQUE (product_id, object_key)\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_product_image_product ON product_image (product_id);\r\nCREATE INDEX IF NOT EXISTS idx_product_image_main    ON product_image (product_id, is_main);\r\nCREATE INDEX IF NOT EXISTS idx_product_image_sort    ON product_image (product_id, sort_order);\r\n",
      "info": {
        "size": 11810,
        "last_modified": "2026-02-01T22:28:37.281999",
        "mime_type": "text/x-sql",
        "extension": ".sql"
      }
    },
    {
      "path": "main\\resources\\db\\migration\\V2__seed_demo.sql",
      "content": "-- =========================================\r\n-- Cocina DeLicia - H2 Seed Demo (consolidado y expandido)\r\n-- Datos limpios normalizados del men completo\r\n-- =========================================\r\n\r\n-- ===============================\r\n-- 1) Catlogo: categoras y tags\r\n-- ===============================\r\nINSERT INTO category (id, name, slug, description)\r\nVALUES\r\n  (1,  'Empanadas',           'empanadas',           'Empanadas caseras de diversos sabores'),\r\n  (2,  'Pastas',              'pastas',              'Pastas frescas, canelones, ravioles, oquis y tallarines'),\r\n  (3,  'Postres',             'postres',             'Dulces y postres caseros'),\r\n  (4,  'Milanesas',           'milanesas',           'Milanesas caseras de carne, pollo, pescado y vegetales'),\r\n  (5,  'Ensaladas',           'ensaladas',           'Ensaladas frescas y livianas'),\r\n  (6,  'Platos Principales',  'platos-principales',  'Churrascos, pecetos, matambres, bondiolaas y ms'),\r\n  (7,  'Guisos y Cazuelas',   'guisos-cazuelas',     'Guisos de lentejas, mondongo, estofados'),\r\n  (8,  'Tartas y Tortillas',  'tartas-tortillas',    'Tartas de J&Q, zapallito, puerro, pascualina'),\r\n  (9,  'Pastel y Polenta',    'pastel-polenta',      'Pasteles y polentas rellenas'),\r\n  (10, 'Verduras',            'verduras',            'Verduras al horno, rellenas, salteadas'),\r\n  (11, 'Panadera y Pizzas',  'panaderia-pizzas',    'Pan casero, pizzas, fain, pre-pizzas'),\r\n  (12, 'Extras',              'extras',              'Guarniciones, propinas y adicionales')\r\n;\r\n\r\nINSERT INTO tag (id, name, slug)\r\nVALUES\r\n  (1, 'Vegetariano',  'vegetariano'),\r\n  (2, 'Vegano',       'vegano'),\r\n  (3, 'Sin TACC',     'sin-tacc'),\r\n  (4, 'Light',        'light'),\r\n  (5, 'Picante',      'picante'),\r\n  (6, 'Sin Azcar',   'sin-azucar'),\r\n  (7, 'Entero',       'entero'),\r\n  (8, 'Sin Panceta',  'sin-panceta')\r\n;\r\n\r\n-- ===============================\r\n-- 2) Productos (men completo normalizado)\r\n-- ===============================\r\n\r\n-- EMPANADAS (categora 1)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (1,  1, 'Empanada de Carne',           'empanada-carne',           'Empanada de carne cortada a cuchillo', 10.00, TRUE),\r\n  (2,  1, 'Empanada de Jamn y Queso',   'empanada-jamon-queso',     'Empanada de jamn y queso', 10.00, TRUE),\r\n  (3,  1, 'Empanada Caprese',            'empanada-caprese',         'Mozzarella, tomate y albahaca', 10.00, TRUE),\r\n  (4,  1, 'Empanada de Verdura',         'empanada-verdura',         'Verduras salteadas con especias', 10.00, TRUE),\r\n  (5,  1, 'Empanada de Atn',            'empanada-atun',            'Atn con vegetales', 10.00, TRUE),\r\n  (6,  1, 'Empanada de Pollo',           'empanada-pollo',           'Pollo desmenuzado', 10.00, TRUE),\r\n  (7,  1, 'Empanada de Verdura y Ricota','empanada-verdura-ricota',  'Verduras con ricota y queso', 10.00, TRUE),\r\n  (8,  1, 'Empanada de Carne y Pasas',   'empanada-carne-pasas',     'Carne con pasas de uva', 10.00, TRUE),\r\n  (9,  1, 'Empanada de Queso y Choclo',  'empanada-queso-choclo',    'Queso con granos de choclo', 10.00, TRUE);\r\n\r\n-- PASTAS (categora 2)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (10, 2, 'Canelones de Carne',          'canelones-carne',          'Canelones rellenos de carne', 10.00, TRUE),\r\n  (11, 2, 'Canelones de Verdura',        'canelones-verdura',        'Canelones de verdura', 10.00, TRUE),\r\n  (12, 2, 'Canelones de Pollo',          'canelones-pollo',          'Canelones rellenos de pollo', 10.00, TRUE),\r\n  (13, 2, 'Canelones de Choclo',         'canelones-choclo',         'Canelones de choclo cremoso', 10.00, TRUE),\r\n  (14, 2, 'Canelones Mixtos',            'canelones-mixtos',         'Canelones de pollo y choclo', 10.00, TRUE),\r\n  (15, 2, 'Ravioles de Verdura',         'ravioles-verdura',         'Ravioles rellenos de verdura', 10.00, TRUE),\r\n  (16, 2, 'Ravioles Caprese',            'ravioles-caprese',         'Ravioles de mozzarella y tomate', 10.00, TRUE),\r\n  (17, 2, 'Ravioles de Calabaza',        'ravioles-calabaza',        'Ravioles de calabaza y mozzarella', 10.00, TRUE),\r\n  (18, 2, 'oquis de Papa',              'noquis-papa',              'oquis caseros de papa', 10.00, TRUE),\r\n  (19, 2, 'oquis de Espinaca',          'noquis-espinaca',          'oquis de espinaca', 10.00, TRUE),\r\n  (20, 2, 'Tallarines',                  'tallarines',               'Tallarines frescos', 10.00, TRUE),\r\n  (21, 2, 'Tallarines de Espinaca',      'tallarines-espinaca',      'Tallarines de espinaca', 10.00, TRUE),\r\n  (22, 2, 'Tallarines de Verdura',       'tallarines-verdura',       'Tallarines con vegetales', 10.00, TRUE),\r\n  (23, 2, 'Lasagna',                     'lasagna',                  'Lasagna de carne', 10.00, TRUE),\r\n  (24, 2, 'Lasagna de Verdura',          'lasagna-verdura',          'Lasagna de verduras', 10.00, TRUE),\r\n  (25, 2, 'Lasagna de Berenjena',        'lasagna-berenjena',        'Lasagna con berenjenas', 10.00, TRUE),\r\n  (26, 2, 'Lasagna de Pollo y Choclo',   'lasagna-pollo-choclo',     'Lasagna mixta de pollo y choclo', 10.00, TRUE);\r\n\r\n-- POSTRES (categora 3)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (28, 3, 'Flan Casero',                 'flan-casero',              'Flan de huevo con caramelo', 10.00, TRUE),\r\n  (29, 3, 'Chaj',                       'chaja',                    'Postre uruguayo con merengue y duraznos', 10.00, TRUE),\r\n  (30, 3, 'Lemon Pie',                   'lemon-pie',                'Tarta de limn con merengue', 10.00, TRUE),\r\n  (31, 3, 'Cheesecake',                  'cheesecake',               'Tarta de queso', 10.00, TRUE),\r\n  (32, 3, 'Cheesecake de Frutilla',      'cheesecake-frutilla',      'Cheesecake con frutillas', 10.00, TRUE),\r\n  (33, 3, 'Cheesecake de Frutos Rojos',  'cheesecake-frutos-rojos',  'Cheesecake con frutos rojos', 10.00, TRUE),\r\n  (34, 3, 'Cheesecake de Oreo',          'cheesecake-oreo',          'Cheesecake con galletas oreo', 10.00, TRUE),\r\n  (35, 3, 'Arroz con Leche',             'arroz-leche',              'Arroz con leche casero', 10.00, TRUE),\r\n  (36, 3, 'Crumble de Manzana',          'crumble-manzana',          'Crumble de manzana con canela', 10.00, TRUE),\r\n  (37, 3, 'Mousse de Chocolate',         'mousse-chocolate',         'Mousse cremoso de chocolate', 10.00, TRUE),\r\n  (38, 3, 'Mousse de Frutilla',          'mousse-frutilla',          'Mousse de frutilla', 10.00, TRUE),\r\n  (39, 3, 'Brownie',                     'brownie',                  'Brownie de chocolate con dulce de leche', 10.00, TRUE),\r\n  (40, 3, 'Pastafrola',                  'pastafrola',               'Pastafrola de membrillo', 10.00, TRUE),\r\n  (41, 3, 'Torta de Chocolate',          'torta-chocolate',          'Torta hmeda de chocolate', 10.00, TRUE),\r\n  (42, 3, 'Torta de Banana y Zanahoria', 'torta-banana-zanahoria',   'Torta saludable de banana y zanahoria', 10.00, TRUE),\r\n  (43, 3, 'Torta de Avena y Banana',     'torta-avena-banana',       'Torta fit de avena y banana', 10.00, TRUE),\r\n  (44, 3, 'Torta Negra Maluca',          'torta-negra-maluca',       'Torta hmeda de chocolate intenso', 10.00, TRUE),\r\n  (45, 3, 'Delicia de Chocolate',        'delicia-chocolate',        'Postre cremoso de chocolate', 10.00, TRUE),\r\n  (46, 3, 'Tarteleta de Frutilla',       'tarteleta-frutilla',       'Tarteleta con crema y frutilla', 10.00, TRUE),\r\n  (47, 3, 'Tarta de Crema y Frutilla',   'tarta-crema-frutilla',     'Tarta grande de crema pastelera y frutilla', 10.00, TRUE),\r\n  (48, 3, 'Noiset',                      'noiset',                   'Postre de nuez y chocolate', 10.00, TRUE),\r\n  (49, 3, 'Ensalada de Frutas',          'ensalada-frutas',          'Ensalada de frutas frescas', 10.00, TRUE),\r\n  (50, 3, 'Torta de Cumpleaos',         'torta-cumpleanos',         'Torta personalizada para eventos', 10.00, TRUE);\r\n\r\n-- MILANESAS (categora 4)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (51, 4, 'Milanesa de Carne',           'milanesa-carne',           'Milanesa de carne vacuna', 10.00, TRUE),\r\n  (52, 4, 'Milanesa de Pollo',           'milanesa-pollo',           'Milanesa de pechuga de pollo', 10.00, TRUE),\r\n  (53, 4, 'Milanesa de Pescado',         'milanesa-pescado',         'Milanesa de filete de pescado', 10.00, TRUE),\r\n  (54, 4, 'Milanesa de Soja',            'milanesa-soja',            'Milanesa vegetariana de soja', 10.00, TRUE),\r\n  (55, 4, 'Milanesa de Berenjena',       'milanesa-berenjena',       'Milanesa de berenjena', 10.00, TRUE),\r\n  (56, 4, 'Milanesa de Zapallito',       'milanesa-zapallito',       'Milanesa de zapallito', 10.00, TRUE),\r\n  (57, 4, 'Milanesa de Zucchini',        'milanesa-zucchini',        'Milanesa de zucchini', 10.00, TRUE),\r\n  (58, 4, 'Milanesa Napolitana',         'milanesa-napolitana',      'Milanesa con salsa, jamn y muzzarella', 10.00, TRUE),\r\n  (59, 4, 'Milanesa al Pan',             'milanesa-pan',             'Milanesa servida en pan', 10.00, TRUE),\r\n  (60, 4, 'Milanesa en 2 Panes',         'milanesa-2-panes',         'Milanesa doble en pan', 10.00, TRUE);\r\n\r\n-- ENSALADAS (categora 5)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (61, 5, 'Ensalada Mixta',              'ensalada-mixta',           'Lechuga, tomate, cebolla, zanahoria', 10.00, TRUE),\r\n  (62, 5, 'Ensalada Rusa',               'ensalada-rusa',            'Papa, zanahoria, arvejas y mayonesa', 10.00, TRUE),\r\n  (63, 5, 'Ensalada Alemana',            'ensalada-alemana',         'Papa, pepinillos y mayonesa', 10.00, TRUE),\r\n  (64, 5, 'Ensalada Csar',              'ensalada-cesar',           'Lechuga, pollo, queso parmesano', 10.00, TRUE),\r\n  (65, 5, 'Ensalada de Repollo',         'ensalada-repollo',         'Repollo con zanahoria', 10.00, TRUE),\r\n  (66, 5, 'Ensalada de Vegetales',       'ensalada-vegetales',       'Mix de vegetales frescos', 10.00, TRUE),\r\n  (67, 5, 'Ensalada de Pollo y Palta',   'ensalada-pollo-palta',     'Pollo, palta, pepino y choclo', 10.00, TRUE),\r\n  (68, 5, 'Ensalada de Quinoa',          'ensalada-quinoa',          'Quinoa con vegetales', 10.00, TRUE),\r\n  (69, 5, 'Ensalada de Brcoli',         'ensalada-brocoli',         'Brcoli, lechuga y choclo', 10.00, TRUE),\r\n  (70, 5, 'Salpicn de Pollo',           'salpicon-pollo',           'Ensalada fra de pollo desmenuzado', 10.00, TRUE);\r\n\r\n-- PLATOS PRINCIPALES (categora 6)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (71, 6, 'Churrasco',                   'churrasco',                'Churrasco a la plancha', 10.00, TRUE),\r\n  (72, 6, 'Churrasco Encebollado',       'churrasco-encebollado',    'Churrasco con cebolla salteada', 10.00, TRUE),\r\n  (73, 6, 'Bife a la Portuguesa',        'bife-portuguesa',          'Bife con huevo frito', 10.00, TRUE),\r\n  (74, 6, 'Colita de Cuadril',           'colita-cuadril',           'Colita de cuadril al horno', 10.00, TRUE),\r\n  (75, 6, 'Peceto',                      'peceto',                   'Peceto mechado', 10.00, TRUE),\r\n  (76, 6, 'Matambre a la Leche',         'matambre-leche',           'Matambre cocido en leche', 10.00, TRUE),\r\n  (77, 6, 'Matambre Relleno',            'matambre-relleno',         'Matambre arrollado con verduras', 10.00, TRUE),\r\n  (78, 6, 'Bondiola Estofada',           'bondiola-estofada',        'Bondiola de cerdo estofada', 10.00, TRUE),\r\n  (79, 6, 'Bondiola Rellena',            'bondiola-rellena',         'Bondiola rellena con especias', 10.00, TRUE),\r\n  (80, 6, 'Costillas de Cerdo',          'costillas-cerdo',          'Costillas al horno con especias', 10.00, TRUE),\r\n  (81, 6, 'Pamplonas',                   'pamplonas',                'Carne arrollada con jamn y queso', 10.00, TRUE),\r\n  (82, 6, 'Arrollado de Carne',          'arrollado-carne',          'Carne arrollada al horno', 10.00, TRUE),\r\n  (83, 6, 'Pan de Carne',                'pan-carne',                'Pan de carne con verduras', 10.00, TRUE),\r\n  (84, 6, 'Lengua a la Vinagreta',       'lengua-vinagreta',         'Lengua cocida con vinagreta', 10.00, TRUE),\r\n  (85, 6, 'Muslo de Pollo',              'muslo-pollo',              'Muslo al horno con especias', 10.00, TRUE),\r\n  (86, 6, 'Pechuga de Pollo',            'pechuga-pollo',            'Pechuga a la plancha', 10.00, TRUE),\r\n  (87, 6, 'Pechuga Rellena',             'pechuga-rellena',          'Pechuga rellena con jamn y queso', 10.00, TRUE),\r\n  (88, 6, 'Pollo Arrollado',             'pollo-arrollado',          'Pollo arrollado al horno', 10.00, TRUE),\r\n  (89, 6, 'Strogonoff de Pollo',         'strogonoff-pollo',         'Pollo en salsa cremosa', 10.00, TRUE),\r\n  (90, 6, 'Strogonoff de Carne',         'strogonoff-carne',         'Carne en salsa cremosa', 10.00, TRUE),\r\n  (91, 6, 'Chop Suey de Pollo',          'chop-suey-pollo',          'Pollo salteado con vegetales al wok', 10.00, TRUE),\r\n  (92, 6, 'Chop Suey de Cerdo',          'chop-suey-cerdo',          'Cerdo salteado con vegetales', 10.00, TRUE),\r\n  (93, 6, 'Chop Suey de Carne',          'chop-suey-carne',          'Carne salteada con vegetales', 10.00, TRUE),\r\n  (94, 6, 'Pescado a la Plancha',        'pescado-plancha',          'Filete de pescado a la plancha', 10.00, TRUE),\r\n  (95, 6, 'Miniaturas de Pescado',       'miniaturas-pescado',       'Bocaditos de pescado rebozados', 10.00, TRUE),\r\n  (96, 6, 'Albndigas',                  'albondigas',               'Albndigas de carne en salsa', 10.00, TRUE),\r\n  (97, 6, 'Hamburguesas',                'hamburguesas',             'Hamburguesas caseras de carne', 10.00, TRUE),\r\n  (98, 6, 'Hamburguesas Veganas',        'hamburguesas-veganas',     'Hamburguesas vegetales', 10.00, TRUE),\r\n  (99, 6, 'Hamburguesas Vegetarianas',   'hamburguesas-vegetarianas','Hamburguesas de garbanzo y espinaca', 10.00, TRUE),\r\n  (100,6, 'Hamburguesa Escondida',       'hamburguesa-escondida',    'Hamburguesa con queso dentro', 10.00, TRUE),\r\n  (101,6, 'Chivito al Plato',            'chivito-plato',            'Chivito uruguayo completo', 10.00, TRUE),\r\n  (102,6, 'Chivito',                     'chivito',                  'Chivito en pan', 10.00, TRUE);\r\n\r\n-- GUISOS Y CAZUELAS (categora 7)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (103,7, 'Guiso de Lentejas',           'guiso-lentejas',           'Guiso casero de lentejas', 10.00, TRUE),\r\n  (104,7, 'Guiso de Campo',              'guiso-campo',              'Guiso de campo con verduras', 10.00, TRUE),\r\n  (105,7, 'Cazuela de Mondongo',         'cazuela-mondongo',         'Cazuela de mondongo tradicional', 10.00, TRUE),\r\n  (106,7, 'Feijoada',                    'feijoada',                 'Guiso brasileo de porotos negros', 10.00, TRUE),\r\n  (107,7, 'Carne Estofada',              'carne-estofada',           'Carne estofada con verduras', 10.00, TRUE),\r\n  (108,7, 'Estofado de Verduras',        'estofado-verduras',        'Estofado vegetariano', 10.00, TRUE),\r\n  (109,7, 'Sopa de Verduras',            'sopa-verduras',            'Sopa de verduras casera', 10.00, TRUE),\r\n  (110,7, 'Sopa de Pollo',               'sopa-pollo',               'Sopa de pollo con fideos', 10.00, TRUE),\r\n  (111,7, 'Puchero',                     'puchero',                  'Puchero tradicional uruguayo', 10.00, TRUE);\r\n\r\n-- TARTAS Y TORTILLAS (categora 8)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (112,8, 'Tarta de Jamn y Queso',      'tarta-jamon-queso',        'Tarta clsica de jamn y queso', 10.00, TRUE),\r\n  (113,8, 'Tarta de Zapallito',          'tarta-zapallito',          'Tarta de zapallitos verdes', 10.00, TRUE),\r\n  (114,8, 'Tarta de Puerro',             'tarta-puerro',             'Tarta de puerros', 10.00, TRUE),\r\n  (115,8, 'Tarta de Atn',               'tarta-atun',               'Tarta de atn con vegetales', 10.00, TRUE),\r\n  (116,8, 'Tarta Caprese',               'tarta-caprese',            'Tarta de tomate, mozzarella y albahaca', 10.00, TRUE),\r\n  (117,8, 'Tarta de Pollo',              'tarta-pollo',              'Tarta de pollo desmenuzado', 10.00, TRUE),\r\n  (118,8, 'Tarta Napolitana',            'tarta-napolitana',         'Tarta con salsa, jamn y queso', 10.00, TRUE),\r\n  (119,8, 'Tarta de Queso y Cebolla',    'tarta-queso-cebolla',      'Tarta de queso y cebolla caramelizada', 10.00, TRUE),\r\n  (120,8, 'Pascualina',                  'pascualina',               'Tarta de espinaca y huevo', 10.00, TRUE),\r\n  (121,8, 'Tortilla de Papa',            'tortilla-papa',            'Tortilla espaola de papa', 10.00, TRUE),\r\n  (122,8, 'Tortilla de Verdura',         'tortilla-verdura',         'Tortilla de verduras variadas', 10.00, TRUE);\r\n\r\n-- PASTEL Y POLENTA (categora 9)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (123,9, 'Pastel de Verdura',           'pastel-verdura',           'Pastel de verdura al horno', 10.00, TRUE),\r\n  (124,9, 'Pastel de Carne',             'pastel-carne',             'Pastel de carne con pur', 10.00, TRUE),\r\n  (125,9, 'Pastel de Calabaza',          'pastel-calabaza',          'Pastel de calabaza', 10.00, TRUE),\r\n  (126,9, 'Pastel de Papa y Verdura',    'pastel-papa-verdura',      'Pastel combinado', 10.00, TRUE),\r\n  (127,9, 'Polenta Rellena',             'polenta-rellena',          'Polenta con carne y queso', 10.00, TRUE);\r\n\r\n-- VERDURAS (categora 10)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (128,10,'Verduras Salteadas',          'verduras-salteadas',       'Mix de verduras salteadas', 10.00, TRUE),\r\n  (129,10,'Verduras al Horno',           'verduras-horno',           'Verduras asadas al horno', 10.00, TRUE),\r\n  (130,10,'Verduras al Wok',             'verduras-wok',             'Verduras salteadas al wok', 10.00, TRUE),\r\n  (131,10,'Verduras a la Plancha',       'verduras-plancha',         'Verduras grilladas', 10.00, TRUE),\r\n  (132,10,'Zapallito Relleno',           'zapallito-relleno',        'Zapallito relleno gratinado', 10.00, TRUE),\r\n  (133,10,'Zapallitos Rellenos',         'zapallitos-rellenos',      'Zapallitos rellenos diversos', 10.00, TRUE),\r\n  (134,10,'Morrn Relleno',              'morron-relleno',           'Morrn relleno de verdura o carne', 10.00, TRUE),\r\n  (135,10,'Tomates Rellenos',            'tomates-rellenos',         'Tomates rellenos de atn', 10.00, TRUE),\r\n  (136,10,'Zucchini Relleno',            'zucchini-relleno',         'Zucchini gratinado relleno', 10.00, TRUE),\r\n  (137,10,'Calabaza a la Plancha',       'calabaza-plancha',         'Rodajas de calabaza grilladas', 10.00, TRUE),\r\n  (138,10,'Papas al Horno',              'papas-horno',              'Papas al horno con especias', 10.00, TRUE),\r\n  (139,10,'Papas Noiset',                'papas-noiset',             'Papas noisette doradas', 10.00, TRUE),\r\n  (140,10,'Croquetas de Espinaca',       'croquetas-espinaca',       'Croquetas de espinaca y queso', 10.00, TRUE),\r\n  (141,10,'Croquetas de Verdura',        'croquetas-verdura',        'Croquetas vegetales', 10.00, TRUE),\r\n  (142,10,'Croquetas de Arroz',          'croquetas-arroz',          'Croquetas de arroz y perejil', 10.00, TRUE),\r\n  (143,10,'Croquetas de Papa',           'croquetas-papa',           'Croquetas de papa', 10.00, TRUE),\r\n  (144,10,'Souffl de Zapallito',        'souffle-zapallito',        'Souffl de zapallito', 10.00, TRUE),\r\n  (145,10,'Souffl de Calabaza',         'souffle-calabaza',         'Souffl de calabaza', 10.00, TRUE),\r\n  (146,10,'Souffl de Verdura',          'souffle-verdura',          'Souffl de verduras variadas', 10.00, TRUE),\r\n  (147,10,'Arrollados Primavera',        'arrollados-primavera',     'Arrollados primavera fritos', 10.00, TRUE),\r\n  (148,10,'Aritos de Cebolla',           'aritos-cebolla',           'Aros de cebolla rebozados', 10.00, TRUE),\r\n  (149,10,'Budin de Verdura',            'budin-verdura',            'Budn de verduras', 10.00, TRUE);\r\n\r\n-- PANADERA Y PIZZAS (categora 11)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (150,11,'Pan Casero',                  'pan-casero',               'Pan casero artesanal', 10.00, TRUE),\r\n  (151,11,'Pizza',                       'pizza',                    'Pizza comn con muzzarella', 10.00, TRUE),\r\n  (152,11,'Pizza Rellena',               'pizza-rellena',            'Pizza rellena de jamn, queso y morrn', 10.00, TRUE),\r\n  (153,11,'Pizza con Anan',             'pizza-anana',              'Pizza con anan y jamn', 10.00, TRUE),\r\n  (154,11,'Pizza con Anchoas',           'pizza-anchoas',            'Pizza con muzzarella y anchoas', 10.00, TRUE),\r\n  (155,11,'Figazza',                     'figazza',                  'Fugazza con cebolla', 10.00, TRUE),\r\n  (156,11,'Fain',                       'faina',                    'Fain de harina de garbanzo', 10.00, TRUE),\r\n  (157,11,'Pre-Pizza',                   'pre-pizza',                'Pre-pizza grande para cocinar', 10.00, TRUE),\r\n  (158,11,'Scones de Queso',             'scones-queso',             'Scones salados de queso', 10.00, TRUE),\r\n  (159,11,'Risoles de Pollo',            'risoles-pollo',            'Risoles rellenos de pollo', 10.00, TRUE),\r\n  (160,11,'Risoles de Jamn y Queso',    'risoles-jamon-queso',      'Risoles de J&Q', 10.00, TRUE),\r\n  (161,11,'Risoles de Carne',            'risoles-carne',            'Risoles de carne', 10.00, TRUE),\r\n  (162,11,'Risoles de Queso y Choclo',   'risoles-queso-choclo',     'Risoles de queso y choclo', 10.00, TRUE);\r\n\r\n-- EXTRAS (categora 12)\r\nINSERT INTO product (id, category_id, name, slug, description, tax_rate_percent, is_active) VALUES\r\n  (163,12,'Propina',                     'propina',                  'Propina opcional', 0.00, TRUE),\r\n  (164,12,'Arroz Blanco',                'arroz-blanco',             'Porcin de arroz', 10.00, TRUE),\r\n  (165,12,'Papas Fritas',                'papas-fritas',             'Porcin de papas fritas', 10.00, TRUE),\r\n  (166,12,'Pur de Papa',                'pure-papa',                'Pur de papa', 10.00, TRUE),\r\n  (167,12,'Pur de Calabaza',            'pure-calabaza',            'Pur de calabaza', 10.00, TRUE),\r\n  (168,12,'Pur de Boniato',             'pure-boniato',             'Pur de boniato', 10.00, TRUE);\r\n\r\n-- Product  Tags\r\nINSERT INTO product_tag (product_id, tag_id) VALUES\r\n  -- Vegetarianos\r\n  (3,1), (4,1), (7,1), (9,1), (11,1), (13,1), (14,1), (15,1), (16,1), (19,1), (22,1), (24,1), (25,1),\r\n  (54,1), (55,1), (56,1), (57,1), (61,1), (62,1), (63,1), (66,1), (68,1), (69,1),\r\n  (98,1), (99,1), (100,1), (108,1), (109,1), (113,1), (114,1), (116,1), (119,1), (120,1), (122,1),\r\n  (123,1), (125,1), (126,1), (127,1), (128,1), (129,1), (130,1), (131,1), (132,1), (133,1), (134,1), (136,1),\r\n  (140,1), (141,1), (144,1), (145,1), (146,1), (147,1),\r\n  -- Veganos\r\n  (98,2), (109,2), (128,2), (130,2), (131,2),\r\n  -- Light\r\n  (61,4), (66,4), (67,4), (68,4), (69,4), (70,4), (109,4),\r\n  -- Sin azcar\r\n  (35,6), (37,6), (38,6),\r\n  -- Entero\r\n  (29,7), (40,7), (41,7), (42,7), (43,7), (47,7), (50,7), (77,7), (88,7), (112,7), (113,7), (114,7), (115,7), (116,7), (117,7), (120,7);\r\n\r\n-- ===============================\r\n-- 3) Variantes de producto (con guarniciones y tamaos)\r\n-- ===============================\r\n\r\n-- EMPANADAS (1-9): Unidad y Docena\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, stock_quantity, is_featured, is_daily_menu, is_new) VALUES\r\n  (1,  1, 'EMP-CAR-U',    'Unidad',  TRUE, TRUE,  100, FALSE, TRUE,  FALSE),\r\n  (2,  1, 'EMP-CAR-D',    'Docena',  TRUE, TRUE,  20,  FALSE, FALSE, FALSE),\r\n  (3,  2, 'EMP-JYQ-U',    'Unidad',  TRUE, TRUE,  80,  FALSE, FALSE, FALSE),\r\n  (4,  2, 'EMP-JYQ-D',    'Docena',  TRUE, TRUE,  15,  FALSE, FALSE, FALSE),\r\n  (5,  3, 'EMP-CAP-U',    'Unidad',  TRUE, TRUE,  60,  TRUE,  FALSE, FALSE),\r\n  (6,  3, 'EMP-CAP-D',    'Docena',  TRUE, TRUE,  10,  FALSE, FALSE, FALSE),\r\n  (7,  4, 'EMP-VER-U',    'Unidad',  TRUE, TRUE,  90,  FALSE, FALSE, FALSE),\r\n  (8,  4, 'EMP-VER-D',    'Docena',  TRUE, TRUE,  18,  FALSE, FALSE, FALSE),\r\n  (9,  5, 'EMP-ATU-U',    'Unidad',  TRUE, TRUE,  50,  FALSE, FALSE, FALSE),\r\n  (10, 5, 'EMP-ATU-D',    'Docena',  TRUE, TRUE,  8,   FALSE, FALSE, FALSE),\r\n  (11, 6, 'EMP-POL-U',    'Unidad',  TRUE, TRUE,  70,  FALSE, FALSE, FALSE),\r\n  (12, 6, 'EMP-POL-D',    'Docena',  TRUE, TRUE,  12,  FALSE, FALSE, FALSE),\r\n  (13, 7, 'EMP-VRI-U',    'Unidad',  TRUE, TRUE,  60,  FALSE, FALSE, FALSE),\r\n  (14, 7, 'EMP-VRI-D',    'Docena',  TRUE, TRUE,  10,  FALSE, FALSE, FALSE),\r\n  (15, 8, 'EMP-CPU-U',    'Unidad',  TRUE, TRUE,  40,  FALSE, FALSE, TRUE),\r\n  (16, 8, 'EMP-CPU-D',    'Docena',  TRUE, TRUE,  5,   FALSE, FALSE, TRUE),\r\n  (17, 9, 'EMP-QCH-U',    'Unidad',  TRUE, TRUE,  50,  FALSE, FALSE, TRUE),\r\n  (18, 9, 'EMP-QCH-D',    'Docena',  TRUE, TRUE,  8,   FALSE, FALSE, TRUE);\r\n\r\n-- PASTAS (10-27): Porcin individual o con salsa\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured, is_daily_menu) VALUES\r\n  (19, 10, 'CAN-CAR-P',   'Porcin', TRUE, FALSE, FALSE, TRUE),\r\n  (20, 11, 'CAN-VER-P',   'Porcin', TRUE, FALSE, FALSE, TRUE),\r\n  (21, 11, 'CAN-VER-S',   'Porcin chica', TRUE, FALSE, FALSE, FALSE),\r\n  (22, 12, 'CAN-POL-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (23, 13, 'CAN-CHO-P',   'Porcin', TRUE, FALSE, TRUE,  TRUE),\r\n  (24, 14, 'CAN-MIX-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (25, 15, 'RAV-VER-BOL', 'Con bolognesa', TRUE, FALSE, FALSE, FALSE),\r\n  (26, 15, 'RAV-VER-SAL', 'Con salsa', TRUE, FALSE, FALSE, FALSE),\r\n  (27, 16, 'RAV-CAP-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (28, 17, 'RAV-CAL-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (29, 18, 'NOQ-PAP-BOL', 'Con bolognesa', TRUE, FALSE, TRUE,  TRUE),\r\n  (30, 18, 'NOQ-PAP-SAL', 'Con salsa', TRUE, FALSE, FALSE, FALSE),\r\n  (31, 18, 'NOQ-PAP-TUC', 'Con tuco de pollo', TRUE, FALSE, FALSE, TRUE),\r\n  (32, 18, 'NOQ-PAP-RSA', 'Con salsa rosa', TRUE, FALSE, FALSE, FALSE),\r\n  (33, 18, 'NOQ-PAP-XL',  'XL con bolognesa', TRUE, FALSE, FALSE, FALSE),\r\n  (34, 19, 'NOQ-ESP-BOL', 'Con bolognesa', TRUE, FALSE, FALSE, FALSE),\r\n  (35, 19, 'NOQ-ESP-SAL', 'Con salsa', TRUE, FALSE, FALSE, FALSE),\r\n  (36, 19, 'NOQ-ESP-TUC', 'Con tuco de pollo', TRUE, FALSE, FALSE, FALSE),\r\n  (37, 20, 'TAL-BOL',     'Con bolognesa', TRUE, FALSE, FALSE, FALSE),\r\n  (38, 20, 'TAL-CAR',     'Con caruso', TRUE, FALSE, FALSE, FALSE),\r\n  (39, 20, 'TAL-TUC',     'Con tuco de pollo', TRUE, FALSE, FALSE, FALSE),\r\n  (40, 20, 'TAL-RSA',     'Con salsa rosa', TRUE, FALSE, FALSE, FALSE),\r\n  (41, 21, 'TAL-ESP-BOL', 'De espinaca con bolognesa', TRUE, FALSE, FALSE, FALSE),\r\n  (42, 21, 'TAL-ESP-SAL', 'De espinaca con salsa', TRUE, FALSE, FALSE, FALSE),\r\n  (43, 22, 'TAL-VER-WOK', 'Con verduras al wok', TRUE, FALSE, FALSE, FALSE),\r\n  (44, 23, 'LAS-CAR-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (45, 24, 'LAS-VER-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (46, 25, 'LAS-BER-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (47, 26, 'LAS-PCH-P',   'Porcin', TRUE, FALSE, FALSE, FALSE);\r\n\r\n-- POSTRES (28-50): Individual o Entero\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured, is_daily_menu) VALUES\r\n  (50, 28, 'FLA-IND',     'Individual', TRUE, FALSE, FALSE, TRUE),\r\n  (51, 28, 'FLA-ENT',     'Entero',     TRUE, FALSE, FALSE, FALSE),\r\n  (52, 29, 'CHA-IND',     'Individual', TRUE, FALSE, TRUE,  FALSE),\r\n  (53, 29, 'CHA-20CM',    '20cm',       TRUE, FALSE, FALSE, FALSE),\r\n  (54, 29, 'CHA-25CM',    '25cm',       TRUE, FALSE, TRUE,  FALSE),\r\n  (55, 29, 'CHA-ENT',     'Entero',     TRUE, FALSE, FALSE, FALSE),\r\n  (56, 30, 'LEM-IND',     'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (57, 31, 'CHE-IND',     'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (58, 32, 'CHE-FRU-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (59, 33, 'CHE-FRO-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (60, 34, 'CHE-ORE-IND', 'Individual', TRUE, FALSE, TRUE,  FALSE),\r\n  (61, 35, 'ARR-LEC-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (62, 35, 'ARR-LEC-SC',  'Sin azcar', TRUE, FALSE, FALSE, FALSE),\r\n  (63, 36, 'CRU-MAN-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (64, 37, 'MOU-CHO-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (65, 37, 'MOU-CHO-SA',  'Sin azcar', TRUE, FALSE, FALSE, FALSE),\r\n  (66, 38, 'MOU-FRU-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (67, 39, 'BRO-IND',     'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (68, 40, 'PAS-ENT',     'Entera',     TRUE, FALSE, FALSE, FALSE),\r\n  (69, 40, 'PAS-IND',     'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (70, 41, 'TOR-CHO-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (71, 41, 'TOR-CHO-ENT', 'Entera',     TRUE, FALSE, FALSE, FALSE),\r\n  (72, 42, 'TOR-BAN-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (73, 42, 'TOR-BAN-ENT', 'Entera',     TRUE, FALSE, FALSE, FALSE),\r\n  (74, 43, 'TOR-AVE-IND', 'Individual', TRUE, FALSE, TRUE,  TRUE),\r\n  (75, 43, 'TOR-AVE-ENT', 'Entera',     TRUE, FALSE, FALSE, FALSE),\r\n  (76, 44, 'TOR-NEG-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (77, 45, 'DEL-CHO-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (78, 46, 'TAR-FRU-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (79, 47, 'TAR-CRE-ENT', 'Entera',     TRUE, FALSE, FALSE, FALSE),\r\n  (80, 48, 'NOI-POR',     'Porcin',    TRUE, FALSE, FALSE, FALSE),\r\n  (81, 49, 'ENS-FRU-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (82, 50, 'TOR-CUM-CH',  'Chica',      TRUE, FALSE, FALSE, FALSE),\r\n  (83, 50, 'TOR-CUM-GR',  'Grande',     TRUE, FALSE, TRUE,  FALSE);\r\n\r\n-- MILANESAS (51-60): Variantes con guarniciones\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured, is_daily_menu) VALUES\r\n  (84,  51, 'MIL-CAR-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (85,  51, 'MIL-CAR-PUR', 'Con pur', TRUE, FALSE, FALSE, TRUE),\r\n  (86,  51, 'MIL-CAR-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (87,  51, 'MIL-CAR-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (88,  51, 'MIL-CAR-PYB', 'Con papas y boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (89,  51, 'MIL-CAR-MIX', 'Con ensalada mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (90,  51, 'MIL-CAR-REP', 'Con ensalada de repollo', TRUE, FALSE, FALSE, FALSE),\r\n  (91,  51, 'MIL-CAR-CRO', 'Con croquetas', TRUE, FALSE, FALSE, FALSE),\r\n  (92,  51, 'MIL-CAR-NOI', 'Con papas noiset', TRUE, FALSE, FALSE, FALSE),\r\n  (93,  52, 'MIL-POL-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (94,  52, 'MIL-POL-PUR', 'Con pur', TRUE, FALSE, TRUE,  TRUE),\r\n  (95,  52, 'MIL-POL-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (96,  52, 'MIL-POL-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (97,  52, 'MIL-POL-PYB', 'Con papas y boniatos', TRUE, FALSE, FALSE, TRUE),\r\n  (98,  52, 'MIL-POL-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (99,  52, 'MIL-POL-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (100, 53, 'MIL-PES-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (101, 53, 'MIL-PES-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (102, 53, 'MIL-PES-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (103, 53, 'MIL-PES-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (104, 53, 'MIL-PES-ALE', 'Con ensalada alemana', TRUE, FALSE, TRUE,  FALSE),\r\n  (105, 53, 'MIL-PES-REP', 'Con ensalada de repollo', TRUE, FALSE, FALSE, FALSE),\r\n  (106, 54, 'MIL-SOJ-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (107, 54, 'MIL-SOJ-PUR', 'Con pur', TRUE, FALSE, TRUE,  TRUE),\r\n  (108, 54, 'MIL-SOJ-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (109, 54, 'MIL-SOJ-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (110, 54, 'MIL-SOJ-VER', 'Con verdura salteada', TRUE, FALSE, FALSE, FALSE),\r\n  (111, 54, 'MIL-SOJ-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (112, 55, 'MIL-BER-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (113, 55, 'MIL-BER-VER', 'Con verduras a la plancha', TRUE, FALSE, FALSE, FALSE),\r\n  (114, 55, 'MIL-BER-PYB', 'Con papas y boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (115, 55, 'MIL-BER-ALE', 'Con ensalada alemana', TRUE, FALSE, FALSE, FALSE),\r\n  (116, 55, 'MIL-BER-ENS', 'Con ensalada cocida', TRUE, FALSE, FALSE, FALSE),\r\n  (117, 56, 'MIL-ZAP-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (118, 56, 'MIL-ZAP-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (119, 57, 'MIL-ZUC-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (120, 58, 'MIL-NAP-CAR', 'De carne', TRUE, FALSE, TRUE,  TRUE),\r\n  (121, 58, 'MIL-NAP-POL', 'De pollo', TRUE, FALSE, FALSE, FALSE),\r\n  (122, 58, 'MIL-NAP-FRI', 'Con fritas', TRUE, FALSE, TRUE,  FALSE),\r\n  (123, 58, 'MIL-NAP-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (124, 58, 'MIL-NAP-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (125, 59, 'MIL-PAN-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (126, 60, 'MIL-2PA-P',   'Porcin', TRUE, FALSE, FALSE, FALSE);\r\n\r\n-- ENSALADAS (61-70): Porciones individuales\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock) VALUES\r\n  (127, 61, 'ENS-MIX-IND', 'Individual', TRUE, FALSE),\r\n  (128, 62, 'ENS-RUS-IND', 'Individual', TRUE, FALSE),\r\n  (129, 63, 'ENS-ALE-IND', 'Individual', TRUE, FALSE),\r\n  (130, 64, 'ENS-CES-IND', 'Individual', TRUE, FALSE),\r\n  (131, 65, 'ENS-REP-IND', 'Individual', TRUE, FALSE),\r\n  (132, 66, 'ENS-VEG-IND', 'Individual', TRUE, FALSE),\r\n  (133, 67, 'ENS-PPA-IND', 'Individual', TRUE, FALSE),\r\n  (134, 68, 'ENS-QUI-IND', 'Individual', TRUE, FALSE),\r\n  (135, 69, 'ENS-BRO-IND', 'Individual', TRUE, FALSE),\r\n  (136, 70, 'SAL-POL-IND', 'Individual', TRUE, FALSE);\r\n\r\n-- PLATOS PRINCIPALES (71-102): Variantes con guarniciones\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured, is_daily_menu) VALUES\r\n  (137, 71, 'CHU-ENS',     'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (138, 71, 'CHU-PUR-FRI', 'Con pur y fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (139, 72, 'CHU-ENC-PYB', 'Con papas, boniatos, rusa y huevos', TRUE, FALSE, TRUE,  FALSE),\r\n  (140, 73, 'BIF-POR-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (141, 74, 'COL-CUA-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (142, 74, 'COL-CUA-BON', 'Con boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (143, 75, 'PEC-PUR',     'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (144, 75, 'PEC-GUI',     'Con guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (145, 76, 'MAT-LEC-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (146, 76, 'MAT-LEC-BON', 'Con boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (147, 76, 'MAT-LEC-XL',  'XL con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (148, 77, 'MAT-REL-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (149, 77, 'MAT-REL-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (150, 77, 'MAT-REL-PYB', 'Con papas y boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (151, 77, 'MAT-REL-ENT', 'Entero', TRUE, FALSE, TRUE,  FALSE),\r\n  (152, 78, 'BON-EST-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (153, 78, 'BON-EST-ARR', 'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (154, 79, 'BON-REL-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (155, 79, 'BON-REL-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (156, 79, 'BON-REL-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (157, 80, 'COS-CER-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (158, 80, 'COS-CER-PYB', 'Con papas y boniatos', TRUE, FALSE, TRUE,  FALSE),\r\n  (159, 80, 'COS-CER-BON', 'Con boniato', TRUE, FALSE, FALSE, FALSE),\r\n  (160, 81, 'PAM-PUR',     'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (161, 81, 'PAM-MIX',     'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (162, 81, 'PAM-RUS',     'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (163, 81, 'PAM-PYB',     'Con papas y boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (164, 81, 'PAM-ALE',     'Con ensalada alemana', TRUE, FALSE, FALSE, FALSE),\r\n  (165, 82, 'ARR-CAR-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (166, 83, 'PAN-CAR-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (167, 83, 'PAN-CAR-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (168, 84, 'LEN-VIN-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (169, 84, 'LEN-VIN-P',   'Con guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (170, 85, 'MUS-POL-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (171, 85, 'MUS-POL-PUR', 'Con pur', TRUE, FALSE, FALSE, TRUE),\r\n  (172, 85, 'MUS-POL-PYB', 'Con papas y boniatos', TRUE, FALSE, TRUE,  TRUE),\r\n  (173, 85, 'MUS-POL-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (174, 85, 'MUS-POL-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (175, 85, 'MUS-POL-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (176, 85, 'MUS-POL-BON', 'Con boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (177, 85, 'MUS-POL-XL',  'XL con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (178, 86, 'PEC-POL-GUI', 'Con guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (179, 87, 'PEC-REL-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (180, 87, 'PEC-REL-PUR', 'Con pur', TRUE, FALSE, TRUE,  FALSE),\r\n  (181, 87, 'PEC-REL-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (182, 87, 'PEC-REL-PYB', 'Con papas y boniatos', TRUE, FALSE, FALSE, FALSE),\r\n  (183, 87, 'PEC-REL-NAR', 'Con pur naranja', TRUE, FALSE, FALSE, FALSE),\r\n  (184, 88, 'POL-ARR-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (185, 88, 'POL-ARR-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (186, 88, 'POL-ARR-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (187, 88, 'POL-ARR-ENT', 'Entero', TRUE, FALSE, TRUE,  FALSE),\r\n  (188, 89, 'STR-POL-ARR', 'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (189, 89, 'STR-POL-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (190, 90, 'STR-CAR-ARR', 'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (191, 91, 'CHO-POL-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (192, 91, 'CHO-POL-FID', 'Con fideos', TRUE, FALSE, FALSE, FALSE),\r\n  (193, 92, 'CHO-CER-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (194, 93, 'CHO-CAR-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (195, 94, 'PES-PLA-GUI', 'Con guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (196, 94, 'PES-PLA-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (197, 95, 'MIN-PES-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (198, 95, 'MIN-PES-TOR', 'Con tortilla', TRUE, FALSE, FALSE, FALSE),\r\n  (199, 95, 'MIN-PES-REP', 'Con ensalada de repollo', TRUE, FALSE, TRUE,  FALSE),\r\n  (200, 95, 'MIN-PES-RUS', 'Con rusa', TRUE, FALSE, FALSE, FALSE),\r\n  (201, 95, 'MIN-PES-FRI', 'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (202, 95, 'MIN-PES-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (203, 95, 'MIN-PES-ALE', 'Con ensalada alemana', TRUE, FALSE, FALSE, FALSE),\r\n  (204, 95, 'MIN-PES-ARR', 'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (205, 96, 'ALB-PUR',     'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (206, 96, 'ALB-ARR',     'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (207, 96, 'ALB-POR',     'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (208, 97, 'HAM-FRI',     'Con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (209, 97, 'HAM-PUR',     'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (210, 97, 'HAM-ARR',     'Con arroz', TRUE, FALSE, FALSE, FALSE),\r\n  (211, 97, 'HAM-GRA',     'Empanadas con fritas', TRUE, FALSE, FALSE, FALSE),\r\n  (212, 97, 'HAM-PGR',     'Con papas gratinadas', TRUE, FALSE, FALSE, FALSE),\r\n  (213, 98, 'HAM-VEG-RUS', 'Con rusa', TRUE, FALSE, TRUE,  FALSE),\r\n  (214, 98, 'HAM-VEG-PUR', 'Con pur', TRUE, FALSE, FALSE, FALSE),\r\n  (215, 98, 'HAM-VEG-CAL', 'Con calabaza a la plancha', TRUE, FALSE, FALSE, FALSE),\r\n  (216, 99, 'HAM-VET-NOI', 'Con papas noiset', TRUE, FALSE, FALSE, FALSE),\r\n  (217, 99, 'HAM-VET-CAL', 'Con zapallo a la plancha', TRUE, FALSE, FALSE, FALSE),\r\n  (218, 100,'HAM-ESC-NOR', 'Normal', TRUE, FALSE, FALSE, FALSE),\r\n  (219, 100,'HAM-ESC-SPA', 'Sin panceta', TRUE, FALSE, FALSE, FALSE),\r\n  (220, 100,'HAM-ESC-VEG', 'Vegetariana', TRUE, FALSE, TRUE,  FALSE),\r\n  (221, 100,'HAM-ESC-CAR', 'Con carne picada', TRUE, FALSE, FALSE, FALSE),\r\n  (222, 101,'CHI-PLA-P',   'Porcin', TRUE, FALSE, FALSE, FALSE),\r\n  (223, 101,'CHI-PLA-FRI', 'Con fritas', TRUE, FALSE, TRUE,  FALSE),\r\n  (224, 102,'CHI-PAN',     'En pan', TRUE, FALSE, FALSE, FALSE);\r\n\r\n-- GUISOS Y CAZUELAS (103-111): Porciones\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_daily_menu) VALUES\r\n  (225, 103,'GUI-LEN-P',   'Porcin', TRUE, FALSE, TRUE),\r\n  (226, 103,'GUI-LEN-CH',  'Chica', TRUE, FALSE, FALSE),\r\n  (227, 103,'CAZ-LEN-P',   'Cazuela', TRUE, FALSE, FALSE),\r\n  (228, 104,'GUI-CAM-P',   'Porcin', TRUE, FALSE, TRUE),\r\n  (229, 105,'CAZ-MON-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (230, 105,'CAZ-MON-PR',  'Promo', TRUE, FALSE, FALSE),\r\n  (231, 106,'FEI-P',       'Porcin', TRUE, FALSE, FALSE),\r\n  (232, 107,'CAR-EST-P',   'Con verduras', TRUE, FALSE, FALSE),\r\n  (233, 108,'EST-VER-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (234, 109,'SOP-VER-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (235, 109,'SOP-VPO-P',   'Con pollo', TRUE, FALSE, FALSE),\r\n  (236, 110,'SOP-POL-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (237, 111,'PUC-P',       'Porcin', TRUE, FALSE, FALSE);\r\n\r\n-- TARTAS Y TORTILLAS (112-122): Individual y Entera\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured, is_daily_menu) VALUES\r\n  (238, 112,'TAR-JYQ-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (239, 112,'TAR-JYQ-ENT', 'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (240, 113,'TAR-ZAP-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (241, 113,'TAR-ZAP-ENT', 'Entera', TRUE, FALSE, TRUE,  FALSE),\r\n  (242, 114,'TAR-PUE-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (243, 114,'TAR-PUE-ENT', 'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (244, 115,'TAR-ATU-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (245, 115,'TAR-ATU-ENT', 'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (246, 116,'TAR-CAP-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (247, 116,'TAR-CAP-ENT', 'Entera', TRUE, FALSE, TRUE,  FALSE),\r\n  (248, 117,'TAR-POL-ENT', 'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (249, 118,'TAR-NAP-ENT', 'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (250, 119,'TAR-QCE-IND', 'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (251, 120,'PASC-IND',    'Individual', TRUE, FALSE, FALSE, FALSE),\r\n  (252, 120,'PASC-ENT',    'Entera', TRUE, FALSE, FALSE, FALSE),\r\n  (253, 121,'TOR-PAP-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (254, 121,'TOR-PAP-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (255, 121,'TOR-PAP-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (256, 122,'TOR-VER-SG',  'Sin guarnicin', TRUE, FALSE, FALSE, FALSE),\r\n  (257, 122,'TOR-VER-SQU', 'Sin queso con mixta', TRUE, FALSE, FALSE, FALSE),\r\n  (258, 122,'TOR-VER-ENS', 'Con ensalada', TRUE, FALSE, FALSE, FALSE),\r\n  (259, 122,'TOR-VER-MIX', 'Con mixta', TRUE, FALSE, FALSE, FALSE);\r\n\r\n-- PASTEL Y POLENTA (123-127): Porciones\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_daily_menu) VALUES\r\n  (260, 123,'PAS-VER-P',   'Porcin', TRUE, FALSE, TRUE),\r\n  (261, 124,'PAS-CAR-P',   'Porcin', TRUE, FALSE, TRUE),\r\n  (262, 124,'PAS-CAR-BON', 'Con boniatos', TRUE, FALSE, FALSE),\r\n  (263, 125,'PAS-CAL-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (264, 125,'PAS-CAL-VER', 'Y verdura', TRUE, FALSE, FALSE),\r\n  (265, 125,'PAS-CAL-CAR', 'De carne de calabaza', TRUE, FALSE, FALSE),\r\n  (266, 126,'PAS-PPV-P',   'Porcin', TRUE, FALSE, FALSE),\r\n  (267, 127,'POL-REL-P',   'Con carne', TRUE, FALSE, FALSE),\r\n  (268, 127,'POL-REL-SJ',  'Sin jamn', TRUE, FALSE, FALSE),\r\n  (269, 127,'POL-REL-BOL', 'Con bolognesa', TRUE, FALSE, FALSE),\r\n  (270, 127,'POL-REL-PYM', 'Con panceta y muzzarella', TRUE, FALSE, FALSE);\r\n\r\n-- VERDURAS (128-149): Porciones y guarniciones\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock) VALUES\r\n  (271, 128,'VER-SAL-P',   'Porcin', TRUE, FALSE),\r\n  (272, 129,'VER-HOR-P',   'Porcin', TRUE, FALSE),\r\n  (273, 130,'VER-WOK-P',   'Porcin', TRUE, FALSE),\r\n  (274, 131,'VER-PLA-P',   'Porcin', TRUE, FALSE),\r\n  (275, 131,'VER-PLA-XL',  'XL', TRUE, FALSE),\r\n  (276, 132,'ZAP-REL-CHO', 'Con choclo', TRUE, FALSE),\r\n  (277, 132,'ZAP-REL-CAR', 'Con carne', TRUE, FALSE),\r\n  (278, 132,'ZAP-REL-ATU', 'Con atn', TRUE, FALSE),\r\n  (279, 133,'ZAP-REL-VER', 'De verdura', TRUE, FALSE),\r\n  (280, 133,'ZAP-REL-CAP', 'Caprese', TRUE, FALSE),\r\n  (281, 133,'ZAP-REL-CHQ', 'Con choclo y queso', TRUE, FALSE),\r\n  (282, 134,'MOR-REL-VER', 'De verdura', TRUE, FALSE),\r\n  (283, 134,'MOR-REL-CAP', 'Caprese', TRUE, FALSE),\r\n  (284, 134,'MOR-REL-CHO', 'Con choclo', TRUE, FALSE),\r\n  (285, 134,'MOR-REL-MIX', 'Mixto', TRUE, FALSE),\r\n  (286, 135,'TOM-REL-ATU', 'De atn', TRUE, FALSE),\r\n  (287, 136,'ZUC-REL-P',   'Porcin', TRUE, FALSE),\r\n  (288, 137,'CAL-PLA-P',   'Porcin', TRUE, FALSE),\r\n  (289, 138,'PAP-HOR-P',   'Porcin', TRUE, FALSE),\r\n  (290, 139,'PAP-NOI-P',   'Porcin', TRUE, FALSE),\r\n  (291, 140,'CRO-ESP-U',   'Unidad', TRUE, FALSE),\r\n  (292, 140,'CRO-ESP-POR', 'Porcin', TRUE, FALSE),\r\n  (293, 141,'CRO-VER-POR', 'Porcin', TRUE, FALSE),\r\n  (294, 141,'CRO-VER-SQU', 'Sin queso', TRUE, FALSE),\r\n  (295, 142,'CRO-ARR-U',   'Unidad', TRUE, FALSE),\r\n  (296, 142,'CRO-ARR-POR', 'Porcin 8 unidades', TRUE, FALSE),\r\n  (297, 143,'CRO-PAP-POR', 'Porcin', TRUE, FALSE),\r\n  (298, 143,'CRO-PAP-ENS', 'Con ensalada', TRUE, FALSE),\r\n  (299, 144,'SOU-ZAP-P',   'Porcin', TRUE, FALSE),\r\n  (300, 145,'SOU-CAL-P',   'Porcin', TRUE, FALSE),\r\n  (301, 146,'SOU-VER-P',   'Porcin', TRUE, FALSE),\r\n  (302, 147,'ARO-PRI-P',   'Porcin', TRUE, FALSE),\r\n  (303, 147,'ARO-PRI-ARI', 'Con aritos de cebolla', TRUE, FALSE),\r\n  (304, 148,'ARI-CEB-P',   'Porcin', TRUE, FALSE),\r\n  (305, 149,'BUD-VER-P',   'Porcin', TRUE, FALSE);\r\n\r\n-- PANADERA Y PIZZAS (150-162): Individual o Entero\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock, is_featured) VALUES\r\n  (306, 150,'PAN-CAS-CH',  'Chico', TRUE, FALSE, FALSE),\r\n  (307, 150,'PAN-CAS-GR',  'Grande', TRUE, FALSE, FALSE),\r\n  (308, 151,'PIZ-COM-P',   'Comn', TRUE, FALSE, FALSE),\r\n  (309, 151,'PIZ-MUZ-P',   'Con muzzarella', TRUE, FALSE, FALSE),\r\n  (310, 152,'PIZ-REL-P',   'Rellena', TRUE, FALSE, FALSE),\r\n  (311, 153,'PIZ-ANA-P',   'Con anan y jamn', TRUE, FALSE, FALSE),\r\n  (312, 154,'PIZ-ANC-P',   'Con anchoas', TRUE, FALSE, FALSE),\r\n  (313, 155,'FIG-P',       'Porcin', TRUE, FALSE, FALSE),\r\n  (314, 156,'FAI-P',       'Porcin', TRUE, FALSE, FALSE),\r\n  (315, 156,'FAI-CRE-P',   'Con crema de choclo', TRUE, FALSE, FALSE),\r\n  (316, 157,'PRE-PIZ-GR',  'Grande', TRUE, FALSE, FALSE),\r\n  (317, 158,'SCO-QUE-U',   'Unidad', TRUE, FALSE, FALSE),\r\n  (318, 159,'RIS-POL-U',   'Unidad', TRUE, FALSE, FALSE),\r\n  (319, 160,'RIS-JYQ-U',   'Unidad', TRUE, FALSE, FALSE),\r\n  (320, 161,'RIS-CAR-U',   'Unidad', TRUE, FALSE, FALSE),\r\n  (321, 162,'RIS-QCH-U',   'Unidad', TRUE, FALSE, FALSE);\r\n\r\n-- EXTRAS (163-168): Guarniciones y Extras\r\nINSERT INTO product_variant (id, product_id, sku, name, is_active, manages_stock) VALUES\r\n  (322, 163,'PRO-20',      '$20', TRUE, FALSE),\r\n  (323, 163,'PRO-30',      '$30', TRUE, FALSE),\r\n  (324, 163,'PRO-100',     '$100', TRUE, FALSE),\r\n  (325, 164,'ARR-BLA-P',   'Porcin', TRUE, FALSE),\r\n  (326, 165,'PAP-FRI-P',   'Porcin', TRUE, FALSE),\r\n  (327, 166,'PUR-PAP-P',   'Porcin', TRUE, FALSE),\r\n  (328, 167,'PUR-CAL-P',   'Porcin', TRUE, FALSE),\r\n  (329, 168,'PUR-BON-P',   'Porcin', TRUE, FALSE);\r\n\r\n-- ===============================\r\n-- 4) Historial de precios (UYU) - Men completo\r\n-- ===============================\r\n\r\n-- EMPANADAS (1-18)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (1,  1,  80.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (2,  2,  900.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (3,  3,  90.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (4,  4,  1000.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (5,  5,  90.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (6,  6,  1000.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (7,  7,  80.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (8,  8,  900.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (9,  9,  100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (10, 10, 1100.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (11, 11, 80.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (12, 12, 900.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (13, 13, 80.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (14, 14, 900.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (15, 15, 90.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (16, 16, 1000.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (17, 17, 90.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (18, 18, 1000.00,'UYU',CURRENT_TIMESTAMP, NULL);\r\n\r\n-- PASTAS (19-49)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (19, 19, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (20, 20, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (21, 21, 280.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (22, 22, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (23, 23, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (24, 24, 320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (25, 25, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (26, 26, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (27, 27, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (28, 28, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (29, 29, 290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (30, 30, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (31, 31, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (32, 32, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (33, 33, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (34, 34, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (35, 35, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (36, 36, 330.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (37, 37, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (38, 38, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (39, 39, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (40, 40, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (41, 41, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (42, 42, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (43, 43, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (44, 44, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (45, 45, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (46, 46, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (47, 47, 350.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- POSTRES (48-81)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (48, 50, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (49, 51, 600.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (50, 52, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (51, 53, 700.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (52, 54, 1100.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (53, 55, 1000.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (54, 56, 140.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (55, 57, 160.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (56, 58, 180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (57, 59, 180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (58, 60, 200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (59, 61, 100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (60, 62, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (61, 63, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (62, 64, 100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (63, 65, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (64, 66, 150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (65, 67, 140.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (66, 68, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (67, 69, 130.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (68, 70, 160.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (69, 71, 1200.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (70, 72, 200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (71, 73, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (72, 74, 120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (73, 75, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (74, 76, 140.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (75, 77, 180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (76, 78, 100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (77, 79, 850.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (78, 80, 250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (79, 81, 160.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (80, 82, 2600.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (81, 83, 3000.00,'UYU',CURRENT_TIMESTAMP, NULL);\r\n\r\n-- MILANESAS (82-124)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (82,  84, 280.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (83,  85, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (84,  86, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (85,  87, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (86,  88, 300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (87,  89, 320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (88,  90, 320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (89,  91, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (90,  92, 350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (91,  93, 280.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (92,  94, 290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (93,  95, 290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (94,  96, 320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (95,  97, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (96,  98, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (97,  99, 310.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (98, 100,160.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (99, 101,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (100, 102,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (101, 103,450.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (102, 104,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (103, 105,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (104, 106,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (105, 107,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (106, 108,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (107, 109,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (108, 110,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (109, 111,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (110, 112,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (111, 113,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (112, 114,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (113, 115,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (114, 116,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (115, 117,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (116, 118,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (117, 119,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (118, 120,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (119, 121,700.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (120, 122,450.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (121, 123,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (122, 124,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (123, 125,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (124, 126,580.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- ENSALADAS (125-134)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (125, 127,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (126, 128,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (127, 129,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (128, 130,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (129, 131,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (130, 132,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (131, 133,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (132, 134,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (133, 135,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (134, 136,350.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- PLATOS PRINCIPALES (135-222) - Primera parte\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (135, 137,400.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (136, 138,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (137, 139,750.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (138, 140,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (139, 141,430.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (140, 142,400.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (141, 143,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (142, 144,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (143, 145,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (144, 146,370.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (145, 147,450.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (146, 148,330.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (147, 149,380.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (148, 150,380.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (149, 151,1200.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (150, 152,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (151, 153,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (152, 154,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (153, 155,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (154, 156,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (155, 157,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (156, 158,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (157, 159,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (158, 160,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (159, 161,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (160, 162,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (161, 163,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (162, 164,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (163, 165,400.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (164, 166,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (165, 167,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (166, 168,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (167, 169,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (168, 170,270.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (169, 171,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (170, 172,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (171, 173,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (172, 174,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (173, 175,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (174, 176,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (175, 177,450.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (176, 178,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (177, 179,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (178, 180,350.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- PLATOS PRINCIPALES (179-220) - Segunda parte\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (179, 181,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (180, 182,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (181, 183,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (182, 184,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (183, 185,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (184, 186,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (185, 187,1200.00,'UYU',CURRENT_TIMESTAMP, NULL),\r\n  (186, 188,400.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (187, 189,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (188, 190,370.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (189, 191,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (190, 192,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (191, 193,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (192, 194,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (193, 195,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (194, 196,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (195, 197,220.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (196, 198,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (197, 199,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (198, 200,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (199, 201,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (200, 202,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (201, 203,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (202, 204,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (203, 205,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (204, 206,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (205, 207,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (206, 208,390.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (207, 209,370.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (208, 210,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (209, 211,390.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (210, 212,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (211, 213,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (212, 214,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (213, 215,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (214, 216,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (215, 217,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (216, 218,180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (217, 219,180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (218, 220,200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (219, 221,200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (220, 222,450.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (221, 223,520.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (222, 224,580.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- GUISOS Y CAZUELAS (223-235)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (223, 225,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (224, 226,200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (225, 227,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (226, 228,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (227, 229,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (228, 230,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (229, 231,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (230, 232,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (231, 233,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (232, 234,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (233, 235,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (234, 236,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (235, 237,380.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- TARTAS Y TORTILLAS (236-257)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (236, 238,120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (237, 239,550.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (238, 240,200.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (239, 241,550.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (240, 242,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (241, 243,550.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (242, 244,180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (243, 245,700.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (244, 246,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (245, 247,550.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (246, 248,600.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (247, 249,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (248, 250,100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (249, 251,120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (250, 252,380.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (251, 253,160.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (252, 254,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (253, 255,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (254, 256,80.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (255, 257,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (256, 258,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (257, 259,290.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- PASTEL Y POLENTA (258-268)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (258, 260,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (259, 261,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (260, 262,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (261, 263,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (262, 264,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (263, 265,320.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (264, 266,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (265, 267,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (266, 268,330.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (267, 269,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (268, 270,350.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- VERDURAS (269-303)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (269, 271,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (270, 272,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (271, 273,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (272, 274,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (273, 275,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (274, 276,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (275, 277,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (276, 278,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (277, 279,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (278, 280,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (279, 281,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (280, 282,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (281, 283,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (282, 284,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (283, 285,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (284, 286,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (285, 287,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (286, 288,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (287, 289,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (288, 290,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (289, 291,25.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (290, 292,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (291, 293,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (292, 294,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (293, 295,40.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (294, 296,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (295, 297,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (296, 298,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (297, 299,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (298, 300,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (299, 301,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (300, 302,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (301, 303,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (302, 304,290.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (303, 305,130.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- PANADERA Y PIZZAS (304-319)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (304, 306,140.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (305, 307,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (306, 308,250.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (307, 309,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (308, 310,550.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (309, 311,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (310, 312,500.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (311, 313,350.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (312, 314,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (313, 315,400.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (314, 316,180.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (315, 317,25.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (316, 318,100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (317, 319,100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (318, 320,120.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (319, 321,120.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- EXTRAS (320-327)\r\nINSERT INTO price_history (id, product_variant_id, price, currency, valid_from, valid_to) VALUES\r\n  (320, 322,20.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (321, 323,30.00, 'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (322, 324,100.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (323, 325,0.00,  'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (324, 326,300.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (325, 327,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (326, 328,150.00,'UYU', CURRENT_TIMESTAMP, NULL),\r\n  (327, 329,150.00,'UYU', CURRENT_TIMESTAMP, NULL);\r\n\r\n-- ===============================\r\n-- 5) Usuarios y Roles\r\n-- ===============================\r\nINSERT INTO role (id, name, description)\r\nVALUES\r\n  (1, 'ADMIN',    'Administrador'),\r\n  (2, 'CHEF',     'Cocinero'),\r\n  (3, 'COURIER',  'Repartidor'),\r\n  (4, 'CUSTOMER', 'Cliente')\r\n;\r\n\r\nINSERT INTO app_user (id, cognito_user_id, first_name, last_name, email, phone, is_active)\r\nVALUES\r\n  (1, 'cog-admin-001', 'Eduardo', 'Gonzlez', 'admin@cocinadelicia.test',  '+59800000000', TRUE),\r\n  (2, 'cog-chef-001',  'Ana',     'Prez',    'chef@cocinadelicia.test',   '+59800000001', TRUE),\r\n  (3, 'cog-cli-001',   'Juan',    'Lpez',    'juan@cocinadelicia.test',   '+59800000002', TRUE),\r\n  (4, 'cog-cli-002',   'Luca',   'Rodrguez','lucia@cocinadelicia.test',  '+59800000003', TRUE),\r\n  (5, 'cog-cli-003',   'Carlos',  'Silva',    'carlos@cocinadelicia.test', '+59800000004', TRUE),\r\n  (6, 'cog-cli-004',   'Mara',   'Fernndez','maria@cocinadelicia.test',  '+59800000005', TRUE)\r\n;\r\n\r\nINSERT INTO user_role (user_id, role_id, assigned_at) VALUES\r\n  (1, 1, CURRENT_TIMESTAMP),\r\n  (2, 2, CURRENT_TIMESTAMP),\r\n  (3, 4, CURRENT_TIMESTAMP),\r\n  (4, 4, CURRENT_TIMESTAMP),\r\n  (5, 4, CURRENT_TIMESTAMP),\r\n  (6, 4, CURRENT_TIMESTAMP)\r\n;\r\n\r\n-- ===============================\r\n-- 6) Direcciones\r\n-- ===============================\r\nINSERT INTO customer_address (id, user_id, label, line1, line2, city, region, postal_code, reference)\r\nVALUES\r\n  (1, 3, 'Casa',    'Av. Italia 1234', NULL,      'Montevideo', 'Montevideo', '11300', 'Portn negro'),\r\n  (2, 3, 'Trabajo', 'Colonia 555',     'Of. 301', 'Montevideo', 'Montevideo', '11000', 'Recepcin 3er piso'),\r\n  (3, 4, 'Casa',    'Bvar. Artigas 1000', NULL, 'Montevideo', 'Montevideo', '11200', 'Apto 502 Torre Sur'),\r\n  (4, 5, 'Casa',    'Rbla. Rep. del Per 1234', 'Edificio Costa Brava', 'Montevideo', 'Montevideo', '11300', 'Portera 24h'),\r\n  (5, 6, 'Casa',    'Av. Rivera 2500', NULL, 'Montevideo', 'Montevideo', '11300', 'Casa esquina')\r\n;\r\n\r\n-- ===============================\r\n-- 7) Pedidos demo (1..22)\r\n-- ===============================\r\n\r\n-- Pedidos 1 y 2\r\nINSERT INTO customer_order (\r\n  id, user_id, status, fulfillment, currency,\r\n  subtotal_amount, tax_amount, discount_amount, total_amount,\r\n  ship_name, ship_phone, ship_line1, ship_line2, ship_city, ship_region, ship_postal_code, ship_reference,\r\n  notes\r\n) VALUES\r\n  (1, 3, 'CREATED', 'DELIVERY', 'UYU',\r\n   1210.00, 121.00, 0.00, 1331.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo', 'Montevideo', '11300', 'Portn negro',\r\n   'Entrega estimada 20:30'),\r\n\r\n  (2, 3, 'CONFIRMED', 'PICKUP', 'UYU',\r\n   95.00, 9.50, 0.00, 104.50,\r\n   NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,\r\n   'Retira 19:00')\r\n;\r\n\r\n-- Pedidos 3..22\r\nINSERT INTO customer_order (\r\n  id, user_id, status, fulfillment, currency,\r\n  subtotal_amount, tax_amount, discount_amount, total_amount,\r\n  ship_name, ship_phone, ship_line1, ship_line2, ship_city, ship_region, ship_postal_code, ship_reference,\r\n  notes\r\n) VALUES\r\n  (3, 3, 'CREATED', 'DELIVERY', 'UYU', 380.00, 38.00, 0.00, 418.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo','Montevideo','11300','Portn negro',\r\n   'Entrega estimada 20:15'),\r\n\r\n  (4, 4, 'CONFIRMED', 'PICKUP', 'UYU', 1430.00, 143.00, 0.00, 1573.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Retira 19:30'),\r\n\r\n  (5, 5, 'PREPARING', 'DELIVERY', 'UYU', 570.00, 57.00, 0.00, 627.00,\r\n   'Carlos Silva', '+59800000004', 'Rbla. Rep. del Per 1234', 'Edificio Costa Brava',\r\n   'Montevideo','Montevideo','11300','Portera 24h',\r\n   'Priorizar este pedido'),\r\n\r\n  (6, 6, 'READY', 'PICKUP', 'UYU', 580.00, 58.00, 0.00, 638.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Listo para retirar a las 20:00'),\r\n\r\n  (7, 3, 'OUT_FOR_DELIVERY', 'DELIVERY', 'UYU', 770.00, 77.00, 0.00, 847.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo','Montevideo','11300','Portn negro',\r\n   'Repartidor en camino'),\r\n\r\n  (8, 4, 'DELIVERED', 'PICKUP', 'UYU', 990.00, 99.00, 0.00, 1089.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Pedido retirado en mostrador'),\r\n\r\n  (9, 5, 'CANCELLED', 'DELIVERY', 'UYU', 880.00, 88.00, 0.00, 968.00,\r\n   'Carlos Silva', '+59800000004', 'Rbla. Rep. del Per 1234', 'Edificio Costa Brava',\r\n   'Montevideo','Montevideo','11300','Portera 24h',\r\n   'Cancelado por el cliente'),\r\n\r\n  (10, 6, 'CREATED', 'PICKUP', 'UYU', 380.00, 38.00, 0.00, 418.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Retira 21:00'),\r\n\r\n  (11, 3, 'PREPARING', 'DELIVERY', 'UYU', 860.00, 86.00, 0.00, 946.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo','Montevideo','11300','Portn negro',\r\n   'Sin cebolla en las empanadas'),\r\n\r\n  (12, 4, 'READY', 'PICKUP', 'UYU', 840.00, 84.00, 0.00, 924.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Listo para retirar 19:45'),\r\n\r\n  (13, 5, 'DELIVERED', 'DELIVERY', 'UYU', 990.00, 99.00, 0.00, 1089.00,\r\n   'Carlos Silva', '+59800000004', 'Rbla. Rep. del Per 1234', 'Edificio Costa Brava',\r\n   'Montevideo','Montevideo','11300','Portera 24h',\r\n   'Entregado al cliente'),\r\n\r\n  (14, 6, 'OUT_FOR_DELIVERY', 'PICKUP', 'UYU', 945.00, 94.50, 0.00, 1039.50,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Uso interno para pruebas de estado'),\r\n\r\n  (15, 3, 'CONFIRMED', 'DELIVERY', 'UYU', 1050.00, 105.00, 0.00, 1155.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo','Montevideo','11300','Portn negro',\r\n   'Confirmado por WhatsApp'),\r\n\r\n  (16, 4, 'DELIVERED', 'PICKUP', 'UYU', 1180.00, 118.00, 0.00, 1298.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Retirado y abonado en efectivo'),\r\n\r\n  (17, 5, 'CANCELLED', 'DELIVERY', 'UYU', 870.00, 87.00, 0.00, 957.00,\r\n   'Carlos Silva', '+59800000004', 'Rbla. Rep. del Per 1234', 'Edificio Costa Brava',\r\n   'Montevideo','Montevideo','11300','Portera 24h',\r\n   'Cancelado por demora'),\r\n\r\n  (18, 6, 'CREATED', 'PICKUP', 'UYU', 220.00, 22.00, 0.00, 242.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Flan para llevar'),\r\n\r\n  (19, 3, 'PREPARING', 'DELIVERY', 'UYU', 420.00, 42.00, 0.00, 462.00,\r\n   'Juan Lpez', '+59800000002', 'Av. Italia 1234', NULL, 'Montevideo','Montevideo','11300','Portn negro',\r\n   'Milanesa para compartir'),\r\n\r\n  (20, 4, 'READY', 'PICKUP', 'UYU', 570.00, 57.00, 0.00, 627.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Retira 20:15'),\r\n\r\n  (21, 5, 'DELIVERED', 'DELIVERY', 'UYU', 770.00, 77.00, 0.00, 847.00,\r\n   'Carlos Silva', '+59800000004', 'Rbla. Rep. del Per 1234', 'Edificio Costa Brava',\r\n   'Montevideo','Montevideo','11300','Portera 24h',\r\n   'Pedido entregado sin incidentes'),\r\n\r\n  (22, 6, 'CONFIRMED', 'PICKUP', 'UYU', 1280.00, 128.00, 0.00, 1408.00,\r\n   NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 'Confirmado para cumpleaos')\r\n;\r\n\r\n-- ===============================\r\n-- 8) tems de pedidos (1..22)\r\n-- ===============================\r\nINSERT INTO order_item (\r\n  id, order_id, product_id, product_variant_id,\r\n  product_name, variant_name, unit_price, quantity, line_total\r\n) VALUES\r\n  (1, 1, 1, 2, 'Empanada de Carne', 'Docena', 990.00, 1, 990.00),\r\n  (2, 1, 4, 6, 'Flan Casero',       'Porcin', 220.00, 1, 220.00),\r\n  (3, 2, 2, 3, 'Empanada Caprese', 'Unidad', 95.00, 1, 95.00),\r\n\r\n  (4, 3, 1, 1, 'Empanada de Carne', 'Unidad', 95.00, 4, 380.00),\r\n  (5, 4, 1, 2, 'Empanada de Carne', 'Docena', 990.00, 1, 990.00),\r\n  (6, 4, 4, 6, 'Flan Casero',       'Porcin', 220.00, 2, 440.00),\r\n  (7, 5, 2, 3, 'Empanada Caprese',  'Unidad', 95.00, 6, 570.00),\r\n  (8, 6, 3, 5, 'oquis Caseros',    'Porcin 400g', 290.00, 2, 580.00),\r\n  (9, 7, 5, 7, 'Milanesa Napolitana', 'Porcin con guarnicin', 420.00, 1, 420.00),\r\n  (10,7, 6, 8, 'Ensalada Csar',      'Porcin individual',     350.00, 1, 350.00),\r\n  (11,8, 2, 4, 'Empanada Caprese',  'Docena', 990.00, 1, 990.00),\r\n  (12,9, 4, 6, 'Flan Casero',       'Porcin', 220.00, 4, 880.00),\r\n  (13,10,1, 1, 'Empanada de Carne', 'Unidad', 95.00, 2, 190.00),\r\n  (14,10,2, 3, 'Empanada Caprese',  'Unidad', 95.00, 2, 190.00),\r\n  (15,11,3, 5, 'oquis Caseros',    'Porcin 400g', 290.00, 1, 290.00),\r\n  (16,11,4, 6, 'Flan Casero',       'Porcin', 220.00, 1, 220.00),\r\n  (17,11,6, 8, 'Ensalada Csar',    'Porcin individual', 350.00, 1, 350.00),\r\n  (18,12,5, 7, 'Milanesa Napolitana','Porcin con guarnicin', 420.00, 2, 840.00),\r\n  (19,13,1, 2, 'Empanada de Carne', 'Docena', 990.00, 1, 990.00),\r\n  (20,14,2, 3, 'Empanada Caprese',  'Unidad', 95.00, 3, 285.00),\r\n  (21,14,4, 6, 'Flan Casero',       'Porcin', 220.00, 3, 660.00),\r\n  (22,15,6, 8, 'Ensalada Csar',    'Porcin individual', 350.00, 3, 1050.00),\r\n  (23,16,1, 1, 'Empanada de Carne', 'Unidad', 95.00, 1, 95.00),\r\n  (24,16,1, 2, 'Empanada de Carne', 'Docena', 990.00, 1, 990.00),\r\n  (25,16,2, 3, 'Empanada Caprese',  'Unidad', 95.00, 1, 95.00),\r\n  (26,17,3, 5, 'oquis Caseros',    'Porcin 400g', 290.00, 3, 870.00),\r\n  (27,18,4, 6, 'Flan Casero',       'Porcin', 220.00, 1, 220.00),\r\n  (28,19,5, 7, 'Milanesa Napolitana','Porcin con guarnicin', 420.00, 1, 420.00),\r\n  (29,20,1, 1, 'Empanada de Carne', 'Unidad', 95.00, 6, 570.00),\r\n  (30,21,2, 3, 'Empanada Caprese',  'Unidad', 95.00, 2, 190.00),\r\n  (31,21,3, 5, 'oquis Caseros',    'Porcin 400g', 290.00, 2, 580.00),\r\n  (32,22,2, 4, 'Empanada Caprese',  'Docena', 990.00, 1, 990.00),\r\n  (33,22,3, 5, 'oquis Caseros',    'Porcin 400g', 290.00, 1, 290.00)\r\n;\r\n\r\n-- ===============================\r\n-- 9) Pagos de pedidos (1..22)\r\n-- ===============================\r\nINSERT INTO payment (id, order_id, method, status, amount, currency, provider_tx_id, note)\r\nVALUES\r\n  (1, 1, 'MERCADOPAGO', 'PENDING',    1331.00, 'UYU', NULL, 'Link de pago enviado al cliente'),\r\n  (2, 2, 'CASH',        'AUTHORIZED',  104.50, 'UYU', NULL, 'Paga al retirar'),\r\n\r\n  (3,  3, 'MERCADOPAGO', 'PENDING',     418.00,  'UYU', NULL, 'Link de pago enviado (MP)'),\r\n  (4,  4, 'CASH',        'PENDING',    1573.00,  'UYU', NULL, 'Abona al retirar'),\r\n  (5,  5, 'MERCADOPAGO', 'AUTHORIZED',  627.00,  'UYU', 'MP-DEMO-0005', 'Pago autorizado, a capturar al entregar'),\r\n  (6,  6, 'CASH',        'AUTHORIZED',  638.00,  'UYU', NULL, 'Se cobra al entregar en mostrador'),\r\n  (7,  7, 'CREDIT_CARD', 'AUTHORIZED',  847.00,  'UYU', 'CC-DEMO-0007', 'Pago con tarjeta en delivery'),\r\n  (8,  8, 'MERCADOPAGO', 'PAID',       1089.00,  'UYU', 'MP-DEMO-0008', 'Pago online aprobado'),\r\n  (9,  9, 'DEBIT_CARD',  'REFUNDED',    968.00,  'UYU', 'DB-DEMO-0009', 'Pedido cancelado, importe devuelto'),\r\n  (10,10, 'CASH',        'PENDING',     418.00,  'UYU', NULL, 'Paga al retirar'),\r\n  (11,11, 'BANK_TRANSFER','PENDING',    946.00,  'UYU', NULL, 'Transferencia pendiente de confirmacin'),\r\n  (12,12, 'MERCADOPAGO', 'AUTHORIZED',  924.00,  'UYU', 'MP-DEMO-0012', 'Pago autorizado'),\r\n  (13,13, 'CREDIT_CARD', 'PAID',       1089.00,  'UYU', 'CC-DEMO-0013', 'Pago en lnea completo'),\r\n  (14,14, 'DEBIT_CARD',  'AUTHORIZED', 1039.50,  'UYU', 'DB-DEMO-0014', 'Pago autorizado parcialmente'),\r\n  (15,15, 'CASH',        'PENDING',    1155.00,  'UYU', NULL, 'Confirma pago en efectivo al entregar'),\r\n  (16,16, 'BANK_TRANSFER','PAID',      1298.00,  'UYU', NULL, 'Transferencia recibida'),\r\n  (17,17, 'MERCADOPAGO', 'REFUNDED',    957.00,  'UYU', 'MP-DEMO-0017', 'Cancelado y reembolsado'),\r\n  (18,18, 'CREDIT_CARD', 'PENDING',     242.00,  'UYU', 'CC-DEMO-0018', 'Pago en caja al retirar'),\r\n  (19,19, 'CASH',        'AUTHORIZED',  462.00,  'UYU', NULL, 'Pago a contraentrega'),\r\n  (20,20, 'MERCADOPAGO', 'AUTHORIZED',  627.00,  'UYU', 'MP-DEMO-0020', 'Pago online pendiente de captura'),\r\n  (21,21, 'DEBIT_CARD',  'PAID',        847.00,  'UYU', 'DB-DEMO-0021', 'Pago completado con dbito'),\r\n  (22,22, 'BANK_TRANSFER','PENDING',   1408.00,  'UYU', NULL, 'Pendiente de confirmacin de banco')\r\n;\r\n\r\n-- ===============================\r\n-- 10) Patch: requested_at / delivered_at (V7 consolidado)\r\n-- ===============================\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:30:00' WHERE id = 1;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:00:00' WHERE id = 2;\r\n\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:15:00' WHERE id = 3;\r\nUPDATE customer_order SET requested_at = '2026-01-26 16:30:00' WHERE id = 4;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:00:00' WHERE id = 5;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:00:00' WHERE id = 6;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:10:00' WHERE id = 7;\r\n\r\nUPDATE customer_order\r\nSET requested_at = '2026-01-01 19:45:00',\r\n    delivered_at = '2026-01-01 19:50:00'\r\nWHERE id = 8;\r\n\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:00:00' WHERE id = 9;\r\nUPDATE customer_order SET requested_at = '2026-01-26 21:00:00' WHERE id = 10;\r\nUPDATE customer_order SET requested_at = '2026-01-26 23:30:00' WHERE id = 11;\r\nUPDATE customer_order SET requested_at = '2026-01-26 13:45:00' WHERE id = 12;\r\n\r\nUPDATE customer_order\r\nSET requested_at = '2026-01-26 20:00:00',\r\n    delivered_at = '2026-01-26 20:20:00'\r\nWHERE id = 13;\r\n\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:00:00' WHERE id = 14;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:10:00' WHERE id = 15;\r\n\r\nUPDATE customer_order\r\nSET requested_at = '2026-01-26 19:00:00',\r\n    delivered_at = '2026-01-26 19:15:00'\r\nWHERE id = 16;\r\n\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:05:00' WHERE id = 17;\r\nUPDATE customer_order SET requested_at = '2026-01-26 23:00:00' WHERE id = 18;\r\nUPDATE customer_order SET requested_at = '2026-01-26 23:20:00' WHERE id = 19;\r\nUPDATE customer_order SET requested_at = '2026-01-26 22:15:00' WHERE id = 20;\r\n\r\nUPDATE customer_order\r\nSET requested_at = '2026-01-26 23:30:00',\r\n    delivered_at = '2026-01-26 22:45:00'\r\nWHERE id = 21;\r\n\r\nUPDATE customer_order SET requested_at = '2026-01-26 23:00:00' WHERE id = 22;\r\n\r\n-- ===============================\r\n-- 11) Patch: stock + flags marketing (V10 consolidado)\r\n-- ===============================\r\nUPDATE product_variant SET manages_stock = TRUE,  stock_quantity = 40 WHERE id = 1;\r\nUPDATE product_variant SET manages_stock = TRUE,  stock_quantity = 8  WHERE id = 2;\r\nUPDATE product_variant SET manages_stock = TRUE,  stock_quantity = 36 WHERE id = 3;\r\nUPDATE product_variant SET manages_stock = TRUE,  stock_quantity = 0  WHERE id = 4;\r\n\r\nUPDATE product_variant SET manages_stock = FALSE, stock_quantity = 0 WHERE id IN (5, 7, 8);\r\n\r\nUPDATE product_variant SET manages_stock = TRUE,  stock_quantity = 6 WHERE id = 6;\r\n\r\nUPDATE product_variant SET is_daily_menu = TRUE WHERE id IN (1, 5, 7);\r\nUPDATE product_variant SET is_featured  = TRUE WHERE id IN (2, 4, 7, 8);\r\nUPDATE product_variant SET is_new       = TRUE WHERE id IN (7, 8);\r\n\r\n-- ===============================\r\n-- 12) Sync de identidades (H2)\r\n-- ===============================\r\n-- Ajusta los IDENTITY para que los prximos inserts sin ID no choquen\r\nALTER TABLE category          ALTER COLUMN id RESTART WITH 6;\r\nALTER TABLE tag               ALTER COLUMN id RESTART WITH 5;\r\nALTER TABLE product           ALTER COLUMN id RESTART WITH 7;\r\nALTER TABLE product_variant   ALTER COLUMN id RESTART WITH 9;\r\nALTER TABLE price_history     ALTER COLUMN id RESTART WITH 9;\r\nALTER TABLE app_user          ALTER COLUMN id RESTART WITH 7;\r\nALTER TABLE role              ALTER COLUMN id RESTART WITH 5;\r\nALTER TABLE customer_address  ALTER COLUMN id RESTART WITH 6;\r\nALTER TABLE customer_order    ALTER COLUMN id RESTART WITH 23;\r\nALTER TABLE order_item        ALTER COLUMN id RESTART WITH 34;\r\nALTER TABLE payment           ALTER COLUMN id RESTART WITH 23;\r\n\r\n-- Si no inserts imgenes en el seed, pods dejarla en 1\r\nALTER TABLE product_image     ALTER COLUMN id RESTART WITH 1;",
      "info": {
        "size": 82591,
        "last_modified": "2026-02-01T22:28:37.2859989",
        "mime_type": "text/x-sql",
        "extension": ".sql"
      }
    },
    {
      "path": "main\\resources\\db\\migration\\V3__add_order_status_history.sql",
      "content": "-- Migration V3: Add order status history table for audit trail\r\n-- Author: System\r\n-- Date: 2026-01-25\r\n\r\nCREATE TABLE IF NOT EXISTS order_status_history (\r\n  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,\r\n  order_id    BIGINT NOT NULL,\r\n  from_status VARCHAR(30),\r\n  to_status   VARCHAR(30) NOT NULL,\r\n  changed_by  VARCHAR(255) NOT NULL,\r\n  changed_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  reason      VARCHAR(500),\r\n\r\n  CONSTRAINT fk_order_status_history_order FOREIGN KEY (order_id)\r\n    REFERENCES customer_order(id) ON DELETE CASCADE,\r\n\r\n  CONSTRAINT chk_status_history_from CHECK (\r\n    from_status IS NULL OR from_status IN ('CREATED','CONFIRMED','PREPARING','READY','OUT_FOR_DELIVERY','DELIVERED','CANCELLED')\r\n  ),\r\n  CONSTRAINT chk_status_history_to CHECK (\r\n    to_status IN ('CREATED','CONFIRMED','PREPARING','READY','OUT_FOR_DELIVERY','DELIVERED','CANCELLED')\r\n  )\r\n);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_order_status_history_order_id ON order_status_history(order_id);\r\nCREATE INDEX IF NOT EXISTS idx_order_status_history_changed_at ON order_status_history(changed_at);\r\n\r\n-- Add deleted_by column to customer_order if not exists\r\n-- Note: deleted_at already exists in V1\r\nALTER TABLE customer_order ADD COLUMN IF NOT EXISTS deleted_by VARCHAR(255);\r\n\r\n-- Add assigned_chef_email column\r\nALTER TABLE customer_order ADD COLUMN IF NOT EXISTS assigned_chef_email VARCHAR(255);\r\n\r\nCREATE INDEX IF NOT EXISTS idx_order_deleted_at ON customer_order(deleted_at);\r\nCREATE INDEX IF NOT EXISTS idx_order_assigned_chef ON customer_order(assigned_chef_email);\r\n",
      "info": {
        "size": 1594,
        "last_modified": "2026-02-01T22:28:37.2899991",
        "mime_type": "text/x-sql",
        "extension": ".sql"
      }
    },
    {
      "path": "main\\resources\\db\\migration\\V4__seed_real_customers.sql",
      "content": "-- Seed de clientes reales demo (alta de clientes y direcciones)\r\n\r\n-- ===============================\r\n-- 1) Clientes (usuarios Cognito)\r\n-- ===============================\r\nINSERT INTO app_user (id, cognito_user_id, first_name, last_name, email, phone, is_active) VALUES\r\n  (7,  'cog-cli-007',  'Cliente',   'Genrico',             'cliente.base@customers.cdl.test',        '+59820000007', TRUE),\r\n  (8,  'cog-cli-008',  'Andrea',    '',         'andrea.cliente@customers.cdl.test',      '+59820000008', TRUE),\r\n  (9,  'cog-cli-009',  'Liliana',   'Lupas',           'liliana.lupas@customers.cdl.test',       '+59820000009', TRUE),\r\n  (10, 'cog-cli-010',  'Maria',     'Cliente',         'maria.1@customers.cdl.test',             '+59820000010', TRUE),\r\n  (11, 'cog-cli-011',  'Rosario',   'Carniceria Arco', 'rosario.carniceria@customers.cdl.test',  '+59820000011', TRUE),\r\n  (12, 'cog-cli-012',  'Nely',      'Mecanico',        'nely.mecanico@customers.cdl.test',       '+59820000012', TRUE),\r\n  (13, 'cog-cli-013',  'Juana',     'Carvallo',        'juana.carvallo@customers.cdl.test',      '+59820000013', TRUE),\r\n  (14, 'cog-cli-014',  'Iosef',      'Gak',         'iosi@customers.cdl.test',                '+59820000014', TRUE),\r\n  (15, 'cog-cli-015',  'Silvia',    'Rodriguez',       'silvia.rodriguez@customers.cdl.test',    '+59820000015', TRUE),\r\n  (16, 'cog-cli-016',  'Macarena',  'Cliente',         'macarena.cliente@customers.cdl.test',    '+59820000016', TRUE),\r\n  (17, 'cog-cli-017',  'Alicia',    'Peluqueria',      'alicia.peluqueria@customers.cdl.test',   '+59820000017', TRUE),\r\n  (18, 'cog-cli-018',  'Laura',     'Peluqueria',      'laura.peluqueria@customers.cdl.test',    '+59820000018', TRUE),\r\n  (19, 'cog-cli-019',  'Maria',     'Cliente2',        'maria.2@customers.cdl.test',             '+59820000019', TRUE),\r\n  (20, 'cog-cli-020',  'Victoria',  'Manicura',        'victoria.manicura@customers.cdl.test',   '+59820000020', TRUE),\r\n  (21, 'cog-cli-021',  'Estefany',  'Cliente',         'estefany@customers.cdl.test',            '+59820000021', TRUE),\r\n  (22, 'cog-cli-022',  'Alicia',    'Cliente3',        'alicia.extra@customers.cdl.test',        '+59820000022', TRUE),\r\n  (23, 'cog-cli-023',  'Rodrigo',   'Cliente',         'rodrigo@customers.cdl.test',             '+59820000023', TRUE),\r\n  (24, 'cog-cli-024',  'Daniel',    'Barberia',        'daniel.barberia@customers.cdl.test',     '+59820000024', TRUE),\r\n  (25, 'cog-cli-025',  'Vecina',    'De Nely',         'vecina.nely@customers.cdl.test',         '+59820000025', TRUE),\r\n  (26, 'cog-cli-026',  'Beatriz',   'Cliente',         'beatriz@customers.cdl.test',             '+59820000026', TRUE),\r\n  (27, 'cog-cli-027',  'Mariana',   'Inm Julieta',     'mariana.julieta@customers.cdl.test',     '+59820000027', TRUE),\r\n  (28, 'cog-cli-028',  'Graciela',  'Cliente',         'graciela@customers.cdl.test',            '+59820000028', TRUE),\r\n  (29, 'cog-cli-029',  'Fernanda',  'Cliente',         'fernanda@customers.cdl.test',            '+59820000029', TRUE),\r\n  (30, 'cog-cli-030',  'Alicia',    'Alex',            'alicia.alex@customers.cdl.test',         '+59820000030', TRUE),\r\n  (31, 'cog-cli-031',  'Margot',    'Cliente',         'margot@customers.cdl.test',              '+59820000031', TRUE),\r\n  (32, 'cog-cli-032',  'Estefani',  'Cliente',         'estefani@customers.cdl.test',            '+59820000032', TRUE),\r\n  (33, 'cog-cli-033',  'Cecilia',   'Dante',           'cecilia.dante@customers.cdl.test',       '+59820000033', TRUE),\r\n  (34, 'cog-cli-034',  'Diego',     'Gimnasio',         'diego@customers.cdl.test',               '+59820000034', TRUE),\r\n  (35, 'cog-cli-035',  'Jaqueline', 'Steffano',         'jaqueline@customers.cdl.test',           '+59820000035', TRUE),\r\n  (36, 'cog-cli-036',  'Silka',     'Cliente',         'silka@customers.cdl.test',               '+59820000036', TRUE),\r\n  (37, 'cog-cli-037',  'Lilian',     'Freelook',        'lilia.freelook@customers.cdl.test',      '+59820000037', TRUE),\r\n  (38, 'cog-cli-039',  'Nacho',     'Gimnasio',        'nacho.gimnasio@customers.cdl.test',      '+59820000039', TRUE),\r\n  (39, 'cog-cli-040',  'Mariana',   'Inmobiliaria',    'mariana.inmobiliaria@customers.cdl.test','+59820000040', TRUE)\r\n;\r\n\r\n-- ===============================\r\n-- 2) Roles de cliente\r\n-- ===============================\r\nINSERT INTO user_role (user_id, role_id, assigned_at) VALUES\r\n  (7, 4, CURRENT_TIMESTAMP),\r\n  (8, 4, CURRENT_TIMESTAMP),\r\n  (9, 4, CURRENT_TIMESTAMP),\r\n  (10,4, CURRENT_TIMESTAMP),\r\n  (11,4, CURRENT_TIMESTAMP),\r\n  (12,4, CURRENT_TIMESTAMP),\r\n  (13,4, CURRENT_TIMESTAMP),\r\n  (14,4, CURRENT_TIMESTAMP),\r\n  (15,4, CURRENT_TIMESTAMP),\r\n  (16,4, CURRENT_TIMESTAMP),\r\n  (17,4, CURRENT_TIMESTAMP),\r\n  (18,4, CURRENT_TIMESTAMP),\r\n  (19,4, CURRENT_TIMESTAMP),\r\n  (20,4, CURRENT_TIMESTAMP),\r\n  (21,4, CURRENT_TIMESTAMP),\r\n  (22,4, CURRENT_TIMESTAMP),\r\n  (23,4, CURRENT_TIMESTAMP),\r\n  (24,4, CURRENT_TIMESTAMP),\r\n  (25,4, CURRENT_TIMESTAMP),\r\n  (26,4, CURRENT_TIMESTAMP),\r\n  (27,4, CURRENT_TIMESTAMP),\r\n  (28,4, CURRENT_TIMESTAMP),\r\n  (29,4, CURRENT_TIMESTAMP),\r\n  (30,4, CURRENT_TIMESTAMP),\r\n  (31,4, CURRENT_TIMESTAMP),\r\n  (32,4, CURRENT_TIMESTAMP),\r\n  (33,4, CURRENT_TIMESTAMP),\r\n  (34,4, CURRENT_TIMESTAMP),\r\n  (35,4, CURRENT_TIMESTAMP),\r\n  (36,4, CURRENT_TIMESTAMP),\r\n  (37,4, CURRENT_TIMESTAMP),\r\n  (38,4, CURRENT_TIMESTAMP),\r\n  (39,4, CURRENT_TIMESTAMP);\r\n\r\n-- ===============================\r\n-- 3) Direcciones\r\n-- ===============================\r\nINSERT INTO customer_address (id, user_id, label, line1, line2, city, region, postal_code, reference) VALUES\r\n  (6,  7,  'Casa',   'Calle Demo 7 123',    NULL, 'Montevideo', 'Montevideo', '11007', 'Referencia pendiente'),\r\n  (7,  8,  'Casa',   'Calle Demo 8 123',    NULL, 'Montevideo', 'Montevideo', '11008', 'Referencia pendiente'),\r\n  (8,  9,  'Casa',   'Calle Demo 9 123',    NULL, 'Montevideo', 'Montevideo', '11009', 'Referencia pendiente'),\r\n  (9,  10, 'Casa',   'Calle Demo 10 123',   NULL, 'Montevideo', 'Montevideo', '11010', 'Referencia pendiente'),\r\n  (10, 11, 'Local',  'Av Carniceria 11',    NULL, 'Montevideo', 'Montevideo', '11011', 'Actualizar referencia'),\r\n  (11, 12, 'Taller', 'Calle Mecanico 12',   NULL, 'Montevideo', 'Montevideo', '11012', 'Actualizar referencia'),\r\n  (12, 13, 'Casa',   'Calle Demo 13 123',   NULL, 'Montevideo', 'Montevideo', '11013', 'Referencia pendiente'),\r\n  (13, 14, 'Casa',   'Calle Demo 14 123',   NULL, 'Montevideo', 'Montevideo', '11014', 'Referencia pendiente'),\r\n  (14, 15, 'Casa',   'Calle Demo 15 123',   NULL, 'Montevideo', 'Montevideo', '11015', 'Referencia pendiente'),\r\n  (15, 16, 'Casa',   'Calle Demo 16 123',   NULL, 'Montevideo', 'Montevideo', '11016', 'Referencia pendiente'),\r\n  (16, 17, 'Local',  'Calle Peluqueria 17', NULL, 'Montevideo', 'Montevideo', '11017', 'Actualizar referencia'),\r\n  (17, 18, 'Local',  'Calle Peluqueria 18', NULL, 'Montevideo', 'Montevideo', '11018', 'Actualizar referencia'),\r\n  (18, 19, 'Casa',   'Calle Demo 19 123',   NULL, 'Montevideo', 'Montevideo', '11019', 'Referencia pendiente'),\r\n  (19, 20, 'Local',  'Calle Manicura 20',   NULL, 'Montevideo', 'Montevideo', '11020', 'Actualizar referencia'),\r\n  (20, 21, 'Casa',   'Calle Demo 21 123',   NULL, 'Montevideo', 'Montevideo', '11021', 'Referencia pendiente'),\r\n  (21, 22, 'Casa',   'Calle Demo 22 123',   NULL, 'Montevideo', 'Montevideo', '11022', 'Referencia pendiente'),\r\n  (22, 23, 'Casa',   'Calle Demo 23 123',   NULL, 'Montevideo', 'Montevideo', '11023', 'Referencia pendiente'),\r\n  (23, 24, 'Local',  'Calle Barberia 24',   NULL, 'Montevideo', 'Montevideo', '11024', 'Actualizar referencia'),\r\n  (24, 25, 'Casa',   'Calle Demo 25 123',   NULL, 'Montevideo', 'Montevideo', '11025', 'Referencia pendiente'),\r\n  (25, 26, 'Casa',   'Calle Demo 26 123',   NULL, 'Montevideo', 'Montevideo', '11026', 'Referencia pendiente'),\r\n  (26, 27, 'Local',  'Calle Inm Julieta 27',NULL, 'Montevideo', 'Montevideo', '11027', 'Actualizar referencia'),\r\n  (27, 28, 'Casa',   'Calle Demo 28 123',   NULL, 'Montevideo', 'Montevideo', '11028', 'Referencia pendiente'),\r\n  (28, 29, 'Casa',   'Calle Demo 29 123',   NULL, 'Montevideo', 'Montevideo', '11029', 'Referencia pendiente'),\r\n  (29, 30, 'Local',  'Calle Alex 30',       NULL, 'Montevideo', 'Montevideo', '11030', 'Actualizar referencia'),\r\n  (30, 31, 'Casa',   'Calle Demo 31 123',   NULL, 'Montevideo', 'Montevideo', '11031', 'Referencia pendiente'),\r\n  (31, 32, 'Casa',   'Calle Demo 32 123',   NULL, 'Montevideo', 'Montevideo', '11032', 'Referencia pendiente'),\r\n  (32, 33, 'Casa',   'Calle Demo 33 123',   NULL, 'Montevideo', 'Montevideo', '11033', 'Referencia pendiente'),\r\n  (33, 34, 'Casa',   'Calle Demo 34 123',   NULL, 'Montevideo', 'Montevideo', '11034', 'Referencia pendiente'),\r\n  (34, 35, 'Casa',   'Calle Demo 35 123',   NULL, 'Montevideo', 'Montevideo', '11035', 'Referencia pendiente'),\r\n  (35, 36, 'Casa',   'Calle Demo 36 123',   NULL, 'Montevideo', 'Montevideo', '11036', 'Referencia pendiente'),\r\n  (36, 37, 'Local',  'Calle Freelook 37',   NULL, 'Montevideo', 'Montevideo', '11037', 'Actualizar referencia'),\r\n  (37, 38, 'Casa',   'Calle Demo 38 123',   NULL, 'Montevideo', 'Montevideo', '11038', 'Referencia pendiente'),\r\n  (38, 39, 'Local',  'Calle Gimnasio 39',   NULL, 'Montevideo', 'Montevideo', '11039', 'Actualizar referencia');\r\n\r\n-- ===============================\r\n-- 4) Ajuste de identidades\r\n-- ===============================\r\nALTER TABLE app_user         ALTER COLUMN id RESTART WITH 41;\r\nALTER TABLE customer_address ALTER COLUMN id RESTART WITH 40;\r\n",
      "info": {
        "size": 9589,
        "last_modified": "2026-02-01T22:28:37.2939989",
        "mime_type": "text/x-sql",
        "extension": ".sql"
      }
    },
    {
      "path": "main\\resources\\log4j2-spring-prod.xml",
      "content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Configuration monitorInterval=\"60\" status=\"WARN\">\r\n    <Properties>\r\n        <Property name=\"LOG_PATTERN\">[%d{yyyy-MM-dd HH:mm:ss}] %-5p %c{1}:%L - %m%n</Property>\r\n        <!-- en EC2 pods poner /var/log/cocinadelicia -->\r\n        <Property name=\"LOG_DIR\">${sys:LOG_DIR:-/var/log/cocinadelicia}</Property>\r\n    </Properties>\r\n\r\n    <Appenders>\r\n        <!-- En prod tambin est bueno ver consola (journalctl, docker logs, cwagent) -->\r\n        <Console name=\"Console\" target=\"SYSTEM_OUT\">\r\n            <PatternLayout pattern=\"${LOG_PATTERN}\"/>\r\n        </Console>\r\n\r\n        <!-- Archivo rotativo -->\r\n        <RollingFile name=\"FileAppender\"\r\n                     fileName=\"${LOG_DIR}/cdd-app.log\"\r\n                     filePattern=\"${LOG_DIR}/cdd-app-%d{yyyy-MM-dd}-%i.log.gz\">\r\n            <PatternLayout pattern=\"${LOG_PATTERN}\"/>\r\n            <Policies>\r\n                <TimeBasedTriggeringPolicy interval=\"1\"/>\r\n                <SizeBasedTriggeringPolicy size=\"20 MB\"/>\r\n            </Policies>\r\n            <DefaultRolloverStrategy max=\"15\"/>\r\n        </RollingFile>\r\n    </Appenders>\r\n\r\n    <Loggers>\r\n        <!-- En prod bajamos el ruido -->\r\n        <Logger name=\"org.springframework\" level=\"INFO\"/>\r\n        <Logger name=\"org.hibernate\" level=\"WARN\"/>\r\n        <Logger name=\"org.flywaydb\" level=\"INFO\"/>\r\n\r\n        <!-- ROOT en prod: INFO -->\r\n        <Root level=\"INFO\">\r\n            <AppenderRef ref=\"Console\"/>\r\n            <AppenderRef ref=\"FileAppender\"/>\r\n        </Root>\r\n    </Loggers>\r\n</Configuration>\r\n",
      "info": {
        "size": 1573,
        "last_modified": "2026-02-01T22:28:37.3039994",
        "mime_type": "application/xml",
        "extension": ".xml"
      }
    },
    {
      "path": "main\\resources\\log4j2-spring.xml",
      "content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<Configuration monitorInterval=\"30\" status=\"WARN\">\r\n    <!-- Propiedades reutilizables -->\r\n    <Properties>\r\n        <!-- patrn pedido en la historia -->\r\n        <Property name=\"LOG_PATTERN\">[%d{yyyy-MM-dd HH:mm:ss}] %-5p %c{1}:%L - %m%n</Property>\r\n        <!-- carpeta por defecto (til si corrs local) -->\r\n        <Property name=\"LOG_DIR\">logs</Property>\r\n    </Properties>\r\n\r\n    <!-- ========== APPENDERS ========== -->\r\n    <!-- Consola: lo que vas a ver en IDEA / mvn spring-boot:run -->\r\n    <Appenders>\r\n        <Console name=\"Console\" target=\"SYSTEM_OUT\">\r\n            <PatternLayout pattern=\"${LOG_PATTERN}\"/>\r\n        </Console>\r\n\r\n        <!-- Este lo dejamos creado porque despus en prod lo vamos a usar -->\r\n        <RollingFile name=\"FileAppender\"\r\n                     fileName=\"${LOG_DIR}/cdd-app.log\"\r\n                     filePattern=\"${LOG_DIR}/cdd-app-%d{yyyy-MM-dd}-%i.log.gz\">\r\n            <PatternLayout pattern=\"${LOG_PATTERN}\"/>\r\n            <Policies>\r\n                <!-- rota cada da -->\r\n                <TimeBasedTriggeringPolicy interval=\"1\"/>\r\n                <!-- y tambin por tamao -->\r\n                <SizeBasedTriggeringPolicy size=\"10 MB\"/>\r\n            </Policies>\r\n            <DefaultRolloverStrategy max=\"30\"/>\r\n        </RollingFile>\r\n    </Appenders>\r\n\r\n    <!-- ========== LOGGERS ========== -->\r\n    <Loggers>\r\n        <!-- Bajar ruido de libreras -->\r\n        <Logger name=\"org.springframework\" level=\"INFO\"/>\r\n        <Logger name=\"org.hibernate\" level=\"INFO\"/>\r\n\r\n        <!-- Silenciar JSSESupport salvo errores serios -->\r\n        <Logger name=\"org.apache.tomcat.util.net.jsse.JSSESupport\" level=\"ERROR\" additivity=\"false\">\r\n            <AppenderRef ref=\"Console\"/>\r\n        </Logger>\r\n\r\n        <Logger name=\"org.apache.coyote.http11.Http11Processor\" level=\"ERROR\" additivity=\"false\">\r\n            <AppenderRef ref=\"Console\"/>\r\n        </Logger>\r\n\r\n        <!-- ROOT para DEV: DEBUG y a la consola -->\r\n        <Root level=\"DEBUG\">\r\n            <AppenderRef ref=\"Console\"/>\r\n            <!-- si quers ver archivo tambin en dev, descoment: -->\r\n            <!-- <AppenderRef ref=\"FileAppender\"/> -->\r\n        </Root>\r\n    </Loggers>\r\n</Configuration>\r\n",
      "info": {
        "size": 2270,
        "last_modified": "2026-02-01T22:28:37.3199994",
        "mime_type": "application/xml",
        "extension": ".xml"
      }
    },
    {
      "path": "main\\resources\\S3PresignerConfig.java",
      "content": "",
      "info": {
        "size": 0,
        "last_modified": "2026-02-01T22:28:37.3240024",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "main\\resources\\ssl\\cdd-local.p12",
      "content": "0\n\u0002\u0001\u00030\nt\u0006\t*H\r\u0001\u0007\u0001\ne\u0004\na0\n]0\u0005\u0006\t*H\r\u0001\u0007\u0001\u0005\u0004\u00050\u00050\u0005\u0006\u000b*H\r\u0001\f\n\u0001\u0002\u0005@0\u0005<0f\u0006\t*H\r\u0001\u0005\r0Y08\u0006\t*H\r\u0001\u0005\f0+\u0004\u0014>\u0017\u0016`w\f\u0002\u0002'\u0010\u0002\u0001 0\f\u0006\b*H\r\u0002\t\u0005\u00000\u001d\u0006\t`H\u0001e\u0003\u0004\u0001*\u0004\u0010Dt+{h f\u0004\u0004Q\u0007\tT[tV@X\u0005\u0006.M\u001f+m&LJ\u0002\u0019Z\u001d\u0012LZ\u0015\u001aI}AZ!Ng\u0019G5B^WXpQGK8\"E=a3\u0019U;Y\u0004-\u000fVzaz5X\u001a\u000f M\u0000Aq\u00157a355fS|FPF,\u000fSS*l0ACC/weB\u001d\u001atJ2\u0005(\u0007\u001b8Ixj[\u0013!\u0006\u0017&NcN^\t\u001b.0ju\u000b)H<u\u0012w\u000b\u0000{<\u0016\\\u0017=<(sxx\u0002&\u0012\u000b\u000fr?\u0005E|`\u0013\u001eRBCYG\u0002cH<lYB!r]f\u0015FjnHoKp\u0019[6|O\t\u001d:\tKc^G/|P4W\u0006O\">\u000e@p%a:zM\u0000I_Lj<[@\u001c\u0010@2;Vt~\u0007M.9kk\n\u0007'X\\\u001dA\u0016t,\bDh'~G\"\u0014\u001fy5\u001a2B 0\f\u0016\u0004\u0003q;zx\r2y\u0000kZyH\u00180O%\b\n\u0013)hB*`\rYgrMb%/\u0017.eio-<1[Zga?\u00144\u000b{C+\u0010\ry\u001dJ@?9A\u0018?|+(B\u0017\u00193>\u0000>1ud\u0013fl\u000f`\u0016~f#'Bw+\u0003QFcL\u0001*6w3\u001dU\u001b2:a\t3 ,%?\r\u00014z +91Y\u000e^<!i:.B\u000eg+nu?\u0006*E Y\rP_MD\u0017-$aRRC\u001eRU?H6l?\u0011Hc<K\u001e\f@\u0014Wf\u0004-\b\u0004\u0011'\u001dTl81\u0007(Vl*\u0003u?\u000fyZ\u000bW\u00073.A\u0003z)I'&^;\f@ZA.d\u0012H7\nZRsasTUn\u000ee7\u000e@\u001d\u0006B8\u00021I?&+Ln&3\u0004:Ix kG\u001a.znl\u0018mds\u001b^ B+'9pZ\u000edD~+(S+ev*yP%SdryS\u0015o~h\u001c[5Z\u0006aT\u0005M\"i\u001dn\u0016Q\u0015;\u00103u+5Mmu'>ztWmq?-;.e\u0014b}3<\u001eA~\u0006USy;\u000e\u0003+M1F0!\u0006\t*H\r\u0001\t\u00141\u0014\u001e\u0012\u0000c\u0000d\u0000d\u0000-\u0000l\u0000o\u0000c\u0000a\u0000l0!\u0006\t*H\r\u0001\t\u00151\u0014\u0004\u0012Time 17639295371210\u0004\u0006\t*H\r\u0001\u0007\u0006\u00040\u0004\u0002\u0001\u00000\u0004\u0006\t*H\r\u0001\u0007\u00010f\u0006\t*H\r\u0001\u0005\r0Y08\u0006\t*H\r\u0001\u0005\f0+\u0004\u0014lV\u0014m\u001c\u0012\u0010s\u0005]\u0002\u0002'\u0010\u0002\u0001 0\f\u0006\b*H\r\u0002\t\u0005\u00000\u001d\u0006\t`H\u0001e\u0003\u0004\u0001*\u0004\u0010\u001cgzg#ZQb\"A\u0004\u0010!\u001d5z\u0017#(\u000eN\u0002\u001bBG[m\nHjo#^,:)\b=\t\u00030,&ry\u001aUq9y\u001fR<\u0014C1{\u000b\\B\u001d.\u00159JJ_\f\u0007Ck).cA\u0017y:[Ac\u0002`$\u0006k%3\\1\r\u0000\rx\u0006\u001b'\u0012*\u0007y@ X\u0019[}`9; h\u0004QWX\"\u0014v\u0015\u00177\u0001\u000b!\u0004Yx74$\trDqcc'M\u000bq\u001b6A'\u0007/GR'~XCh-\u0010mPZK3XzZZJE:=x~0^\u000f]fb:u\u0011\u001fk\"`eT\u0011{\u001efHES\u00015s\u0019\u0005\u001csAy @\u0011*\u0005x\u0010qW9Bj+n\u001byX(K\u0017JFJA\u00036,\u0007\u001dqhzQ\u0012\u000eT\u001e-*_@T<cw\"$7i\u001dP.VpphIgA{T\u001d0E+\u001b03Q\u0018o\u001f\u001f]D9\u0006u\u0005\u001c}b\u0000V9U\u001bD%0z'!F`\u001c5E7\u0006\"g\u00039wRL\")vTxWe`<Ysb\rvOC<Kn\u0013FG#(\u001a\u000eaWH43\u00114\\HeyKC`zs\bv\";\u001c\u0010G|\u000b\u001d(LUD{{1zsy,'R\u001enk\u0004P]OC#\u00057G6?Lskp!\tcu:\u00034%J$j\u001e+Y\u0001TKC5g\fRn\f[\u001aJmO\u0005LxJJ\u001f$>e^AW5-\t\u001fn\u000e(\fY`x~]aV92R\r(u9)\u0001w)\u0005\u001b!\f\u0006<f)\u0015\u0016*d+pWr\\gV<&xtNufl\u0002KT+9\u0018\u001b:Wh\u0012\u0003X7_6d=e\rQPPU\u0015q}\u001b#?k0\u000e\u000e7\u0010[P`\u0018z0M010\r\u0006\t`H\u0001e\u0003\u0004\u0002\u0001\u0005\u0000\u0004 u8x|\u000bn%;7\u0012\u0015.}\u001dBP\u0004\u0014\u0010\f\u001a\u0014\u0015^p\u0010^%\u0002\u0002'\u0010",
      "info": {
        "size": 2766,
        "last_modified": "2026-02-01T22:28:37.3270479",
        "mime_type": "application/x-x509-key; format=der",
        "extension": ".p12"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\catalog\\CatalogControllerTest.java",
      "content": "\r\n",
      "info": {
        "size": 2,
        "last_modified": "2026-02-01T22:28:37.3545241",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\catalog\\controller\\CatalogControllerTest.java",
      "content": "\r\n",
      "info": {
        "size": 2,
        "last_modified": "2026-02-01T22:28:37.3585372",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\catalog\\controller\\CatalogDetailEndpointsTest.java",
      "content": "package com.cocinadelicia.backend.catalog.controller;\r\n\r\nimport static org.mockito.ArgumentMatchers.eq;\r\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\r\nimport static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;\r\n\r\nimport com.cocinadelicia.backend.catalog.dto.CatalogImageResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.CatalogVariantResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.MoneyResponse;\r\nimport com.cocinadelicia.backend.catalog.dto.ProductDetailResponse;\r\nimport com.cocinadelicia.backend.catalog.service.CatalogService;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport java.math.BigDecimal;\r\nimport java.util.List;\r\nimport org.junit.jupiter.api.BeforeEach;\r\nimport org.junit.jupiter.api.Test;\r\nimport org.mockito.Mockito;\r\nimport org.springdoc.core.configuration.SpringDocConfiguration;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\r\nimport org.springframework.boot.test.context.TestConfiguration;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Import;\r\nimport org.springframework.http.MediaType;\r\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\r\nimport org.springframework.test.context.TestPropertySource;\r\nimport org.springframework.test.web.servlet.MockMvc;\r\n\r\n@WebMvcTest(controllers = CatalogController.class)\r\n@Import({CatalogDetailEndpointsTest.MockConfig.class})\r\n@TestPropertySource(\r\n    properties = {\r\n      \"spring.security.oauth2.resourceserver.jwt.issuer-uri=disabled-for-tests\",\r\n      \"app.cdn.base-url=https://cdn.test/\"\r\n    })\r\nclass CatalogDetailEndpointsTest {\r\n\r\n  @Autowired MockMvc mvc;\r\n  @Autowired ObjectMapper om;\r\n\r\n  @Autowired CatalogService catalogService;\r\n\r\n  @TestConfiguration\r\n  static class MockConfig {\r\n    @Bean\r\n    CatalogService catalogService() {\r\n      return Mockito.mock(CatalogService.class);\r\n    }\r\n\r\n    @Bean\r\n    SpringDocConfiguration springDocConfiguration() {\r\n      return new SpringDocConfiguration();\r\n    }\r\n\r\n    @Bean\r\n    JwtDecoder jwtDecoder() {\r\n      return Mockito.mock(JwtDecoder.class);\r\n    }\r\n  }\r\n\r\n  @BeforeEach\r\n  void resetMocks() {\r\n    Mockito.reset(catalogService);\r\n  }\r\n\r\n  @Test\r\n  void getProductBySlug_ok_returns200() throws Exception {\r\n    var response = sampleDetail();\r\n    Mockito.when(catalogService.getProductBySlug(eq(\"milanesa-clasica\"))).thenReturn(response);\r\n\r\n    mvc.perform(get(\"/api/catalog/products/milanesa-clasica\").accept(MediaType.APPLICATION_JSON))\r\n        .andExpect(status().isOk())\r\n        .andExpect(jsonPath(\"$.slug\").value(\"milanesa-clasica\"))\r\n        .andExpect(jsonPath(\"$.name\").value(\"Milanesa clsica\"))\r\n        .andExpect(jsonPath(\"$.mainImageUrl\").value(\"https://cdn.test/products/main.jpg\"))\r\n        .andExpect(jsonPath(\"$.images[0].url\").value(\"https://cdn.test/products/main.jpg\"))\r\n        .andExpect(jsonPath(\"$.variants[0].price.amount\").value(590))\r\n        .andExpect(jsonPath(\"$.tags[0]\").value(\"casero\"));\r\n  }\r\n\r\n  @Test\r\n  void getProductBySlug_notFound_returns404() throws Exception {\r\n    Mockito.when(catalogService.getProductBySlug(eq(\"missing\")))\r\n        .thenThrow(new NotFoundException(\"PRODUCT_NOT_FOUND\", \"Producto no encontrado.\"));\r\n\r\n    mvc.perform(get(\"/api/catalog/products/missing\").accept(MediaType.APPLICATION_JSON))\r\n        .andExpect(status().isNotFound())\r\n        .andExpect(jsonPath(\"$.code\").value(\"PRODUCT_NOT_FOUND\"));\r\n  }\r\n\r\n  private ProductDetailResponse sampleDetail() {\r\n    var price = new MoneyResponse(new BigDecimal(\"590\"), \"UYU\");\r\n    var variant = new CatalogVariantResponse(100L, \"Grande\", price, true, 12, \"Disponible\");\r\n    var image =\r\n        new CatalogImageResponse(\r\n            1L, \"https://cdn.test/products/main.jpg\", true, 0, \"Milanesa clsica\");\r\n    return new ProductDetailResponse(\r\n        10L,\r\n        \"milanesa-clasica\",\r\n        \"Milanesa clsica\",\r\n        \"Descripcin larga del producto\",\r\n        \"Crujiente y deliciosa\",\r\n        1L,\r\n        \"Platos\",\r\n        \"platos\",\r\n        \"https://cdn.test/products/main.jpg\",\r\n        List.of(image),\r\n        price,\r\n        List.of(variant),\r\n        List.of(\"casero\", \"sin-tacc\"),\r\n        true,\r\n        false,\r\n        false,\r\n        true,\r\n        true,\r\n        false);\r\n  }\r\n}\r\n",
      "info": {
        "size": 4472,
        "last_modified": "2026-02-01T22:28:37.3626671",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\CocinaDeLiciaApplicationTests.java",
      "content": "package com.cocinadelicia.backend;\r\n\r\nimport org.junit.jupiter.api.Test;\r\nimport org.springframework.boot.test.context.SpringBootTest;\r\nimport org.springframework.test.context.ActiveProfiles;\r\n\r\n@SpringBootTest\r\n@ActiveProfiles(\"test\")\r\nclass CocinaDeLiciaApplicationTests {\r\n\r\n  @Test\r\n  void contextLoads() {}\r\n}\r\n",
      "info": {
        "size": 316,
        "last_modified": "2026-02-01T22:28:37.3726671",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\migration\\FlywayMigrationTest.java",
      "content": "\r\n",
      "info": {
        "size": 2,
        "last_modified": "2026-02-01T22:28:37.376667",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\OpenApiSmokeTest.java",
      "content": "// src/test/java/com/cocinadelicia/backend/OpenApiSmokeTest.java\r\npackage com.cocinadelicia.backend;\r\n\r\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\r\nimport static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;\r\n\r\nimport org.junit.jupiter.api.Test;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;\r\nimport org.springframework.boot.test.context.SpringBootTest;\r\nimport org.springframework.test.context.ActiveProfiles;\r\nimport org.springframework.test.web.servlet.MockMvc;\r\n\r\n@SpringBootTest\r\n@AutoConfigureMockMvc(addFilters = false) //  desactiva security filters para este test\r\n@ActiveProfiles(\"test\") //  levanta application-test.yml\r\nclass OpenApiSmokeTest {\r\n\r\n  @Autowired MockMvc mockMvc;\r\n\r\n  @Test\r\n  void swaggerUi_shouldRedirectToIndex() throws Exception {\r\n    mockMvc\r\n        .perform(get(\"/swagger-ui.html\"))\r\n        .andExpect(status().isFound()) // 302\r\n        .andExpect(redirectedUrl(\"/swagger-ui/index.html\"));\r\n  }\r\n\r\n  @Test\r\n  void apiDocs_shouldReturnJson() throws Exception {\r\n    mockMvc\r\n        .perform(get(\"/v3/api-docs\"))\r\n        .andExpect(status().isOk())\r\n        .andExpect(content().contentTypeCompatibleWith(\"application/json\"))\r\n        .andExpect(jsonPath(\"$.openapi\").exists());\r\n  }\r\n}\r\n",
      "info": {
        "size": 1404,
        "last_modified": "2026-02-01T22:28:37.3838031",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\order\\controller\\OrderControllerTest.java",
      "content": "// src/test/java/com/cocinadelicia/backend/order/controller/OrderControllerTest.java\r\npackage com.cocinadelicia.backend.order.controller;\r\n\r\nimport static org.mockito.ArgumentMatchers.*;\r\nimport static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;\r\nimport static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.jwt;\r\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.patch;\r\nimport static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.exception.NotFoundException;\r\nimport com.cocinadelicia.backend.common.model.enums.CurrencyCode;\r\nimport com.cocinadelicia.backend.common.model.enums.FulfillmentType;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport com.cocinadelicia.backend.order.dto.OrderItemResponse;\r\nimport com.cocinadelicia.backend.order.dto.OrderResponse;\r\nimport com.cocinadelicia.backend.order.dto.UpdateOrderStatusRequest;\r\nimport com.cocinadelicia.backend.order.service.OrderService;\r\nimport com.cocinadelicia.backend.user.service.CurrentUserService;\r\nimport com.cocinadelicia.backend.user.service.UserService;\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport java.math.BigDecimal;\r\nimport java.time.Instant;\r\nimport java.util.List;\r\nimport org.junit.jupiter.api.BeforeEach;\r\nimport org.junit.jupiter.api.Test;\r\nimport org.mockito.Mockito;\r\nimport org.springdoc.core.configuration.SpringDocConfiguration;\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\r\nimport org.springframework.boot.test.context.TestConfiguration;\r\nimport org.springframework.context.annotation.Bean;\r\nimport org.springframework.context.annotation.Import;\r\nimport org.springframework.http.MediaType;\r\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\r\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\r\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\r\nimport org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors;\r\nimport org.springframework.test.context.TestPropertySource;\r\nimport org.springframework.test.web.servlet.MockMvc;\r\n\r\n@WebMvcTest(controllers = OrderController.class)\r\n@Import({OrderControllerTest.MockConfig.class, OrderControllerTest.MethodSecurityConfig.class})\r\n@TestPropertySource(\r\n    properties = {\"spring.security.oauth2.resourceserver.jwt.issuer-uri=disabled-for-tests\"})\r\nclass OrderControllerTest {\r\n\r\n  @Autowired MockMvc mvc;\r\n  @Autowired ObjectMapper om;\r\n\r\n  @Autowired OrderService orderService;\r\n  @Autowired UserService userService;\r\n  @Autowired CurrentUserService currentUserService;\r\n\r\n  @TestConfiguration\r\n  static class MockConfig {\r\n    @Bean\r\n    OrderService orderService() {\r\n      return Mockito.mock(OrderService.class);\r\n    }\r\n\r\n    @Bean\r\n    UserService userService() {\r\n      return Mockito.mock(UserService.class);\r\n    }\r\n\r\n    @Bean\r\n    CurrentUserService currentUserService() {\r\n      return Mockito.mock(CurrentUserService.class);\r\n    }\r\n\r\n    // Evita problemas por SpringDoc en slice tests si lo ests usando en el proyecto\r\n    @Bean\r\n    SpringDocConfiguration springDocConfiguration() {\r\n      return new SpringDocConfiguration();\r\n    }\r\n\r\n    // Necesario para Resource Server en @WebMvcTest\r\n    @Bean\r\n    JwtDecoder jwtDecoder() {\r\n      return Mockito.mock(JwtDecoder.class);\r\n    }\r\n  }\r\n\r\n  // Habilita @PreAuthorize en este slice de prueba\r\n  @TestConfiguration\r\n  @EnableMethodSecurity\r\n  static class MethodSecurityConfig {}\r\n\r\n  // Admin con autoridad real\r\n  private SecurityMockMvcRequestPostProcessors.JwtRequestPostProcessor adminJwt() {\r\n    return jwt()\r\n        .jwt(\r\n            jwt -> {\r\n              jwt.subject(\"sub-123\");\r\n              jwt.claim(\"email\", \"admin@test.com\");\r\n            })\r\n        .authorities(new SimpleGrantedAuthority(\"ROLE_ADMIN\"));\r\n  }\r\n\r\n  // Sin roles/autorizaciones\r\n  private SecurityMockMvcRequestPostProcessors.JwtRequestPostProcessor noRoleJwt() {\r\n    return jwt()\r\n        .jwt(\r\n            jwt -> {\r\n              jwt.subject(\"sub-abc\");\r\n              jwt.claim(\"email\", \"user@test.com\");\r\n            })\r\n        .authorities(); // vaco\r\n  }\r\n\r\n  private OrderResponse sampleResponse(Long id, OrderStatus status) {\r\n    Instant now = Instant.now();\r\n\r\n    List<OrderItemResponse> items = List.of();\r\n    Instant requestedAt = now;\r\n    Instant deliveredAt = null;\r\n\r\n    return new OrderResponse(\r\n        id,\r\n        status,\r\n        FulfillmentType.PICKUP,\r\n        CurrencyCode.UYU,\r\n        new BigDecimal(\"100.00\"), // subtotal\r\n        BigDecimal.ZERO, // tax\r\n        BigDecimal.ZERO, // discount\r\n        new BigDecimal(\"100.00\"), // total\r\n        \"Eduardo\", // shipName\r\n        \"099\", // shipPhone\r\n        \"Calle 1\", // shipLine1\r\n        null, // shipLine2\r\n        \"MVD\", // shipCity\r\n        null, // shipRegion\r\n        null, // shipPostalCode\r\n        null, // shipReference\r\n        \"notes\", // notes\r\n        now, // createdAt\r\n        now, // updatedAt\r\n        items, // items\r\n        requestedAt, // requestedAt\r\n        deliveredAt // deliveredAt\r\n        );\r\n  }\r\n\r\n  @BeforeEach\r\n  void resetMocks() {\r\n    Mockito.reset(orderService, userService, currentUserService);\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_ok_returns200() throws Exception {\r\n    Mockito.when(orderService.updateStatus(eq(10L), anyString(), any()))\r\n        .thenReturn(sampleResponse(10L, OrderStatus.PREPARING));\r\n\r\n    var body = new UpdateOrderStatusRequest(OrderStatus.PREPARING, \"nota\");\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/10/status\")\r\n                .with(adminJwt())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isOk())\r\n        .andExpect(jsonPath(\"$.id\").value(10))\r\n        .andExpect(jsonPath(\"$.status\").value(\"PREPARING\"));\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_notFound_returns404() throws Exception {\r\n    Mockito.when(orderService.updateStatus(eq(999L), anyString(), any()))\r\n        .thenThrow(new NotFoundException(\"ORDER_NOT_FOUND\", \"Pedido no encontrado.\"));\r\n\r\n    var body = new UpdateOrderStatusRequest(OrderStatus.PREPARING, null);\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/999/status\")\r\n                .with(adminJwt())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isNotFound())\r\n        .andExpect(jsonPath(\"$.code\").value(\"ORDER_NOT_FOUND\"));\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_invalidTransition_returns400() throws Exception {\r\n    Mockito.when(orderService.updateStatus(eq(10L), anyString(), any()))\r\n        .thenThrow(\r\n            new BadRequestException(\r\n                \"INVALID_STATUS_TRANSITION\", \"No se puede pasar de CREATED a DELIVERED\"));\r\n\r\n    var body = new UpdateOrderStatusRequest(OrderStatus.DELIVERED, null);\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/10/status\")\r\n                .with(adminJwt())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isBadRequest())\r\n        .andExpect(jsonPath(\"$.code\").value(\"INVALID_STATUS_TRANSITION\"));\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_missingStatus_returns400() throws Exception {\r\n    Mockito.when(orderService.updateStatus(eq(10L), anyString(), any()))\r\n        .thenThrow(new BadRequestException(\"STATUS_REQUIRED\", \"El estado es obligatorio.\"));\r\n\r\n    var body = new UpdateOrderStatusRequest(null, \"nota\");\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/10/status\")\r\n                .with(adminJwt())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isBadRequest())\r\n        .andExpect(jsonPath(\"$.code\").value(\"STATUS_REQUIRED\"));\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_withoutToken_returns401() throws Exception {\r\n    var body = new UpdateOrderStatusRequest(OrderStatus.PREPARING, \"nota\");\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/10/status\")\r\n                .with(csrf())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isUnauthorized());\r\n  }\r\n\r\n  @Test\r\n  void patchStatus_withNoRequiredRole_returns403() throws Exception {\r\n    var body = new UpdateOrderStatusRequest(OrderStatus.PREPARING, \"nota\");\r\n\r\n    mvc.perform(\r\n            patch(\"/api/orders/10/status\")\r\n                .with(noRoleJwt())\r\n                .contentType(MediaType.APPLICATION_JSON)\r\n                .content(om.writeValueAsString(body)))\r\n        .andExpect(status().isForbidden());\r\n  }\r\n}\r\n",
      "info": {
        "size": 9015,
        "last_modified": "2026-02-01T22:28:37.387093",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\order\\domain\\OrderStatusTransitionValidatorTest.java",
      "content": "// src/test/java/com/cocinadelicia/backend/order/domain/OrderStatusTransitionValidatorTest.java\r\npackage com.cocinadelicia.backend.order.domain;\r\n\r\nimport static org.junit.jupiter.api.Assertions.*;\r\n\r\nimport com.cocinadelicia.backend.common.exception.BadRequestException;\r\nimport com.cocinadelicia.backend.common.model.enums.OrderStatus;\r\nimport org.junit.jupiter.params.ParameterizedTest;\r\nimport org.junit.jupiter.params.provider.CsvSource;\r\n\r\nclass OrderStatusTransitionValidatorTest {\r\n\r\n  @ParameterizedTest\r\n  @CsvSource({\r\n    \"CREATED,PREPARING\",\r\n    \"CREATED,CANCELLED\",\r\n    \"PREPARING,READY\",\r\n    \"PREPARING,CANCELLED\",\r\n    \"READY,DELIVERED\",\r\n    // Permitimos READY->OUT_FOR_DELIVERY aunque la UI del sprint no lo use\r\n    \"READY,OUT_FOR_DELIVERY\"\r\n  })\r\n  void validTransitions_doNotThrow(String current, String next) {\r\n    assertDoesNotThrow(\r\n        () ->\r\n            OrderStatusTransitionValidator.validateOrThrow(\r\n                OrderStatus.valueOf(current), OrderStatus.valueOf(next)));\r\n  }\r\n\r\n  @ParameterizedTest\r\n  @CsvSource({\"CREATED,DELIVERED\", \"READY,CREATED\", \"DELIVERED,READY\", \"CANCELLED,CREATED\"})\r\n  void invalidTransitions_throwBadRequest(String current, String next) {\r\n    var ex =\r\n        assertThrows(\r\n            BadRequestException.class,\r\n            () ->\r\n                OrderStatusTransitionValidator.validateOrThrow(\r\n                    OrderStatus.valueOf(current), OrderStatus.valueOf(next)));\r\n    assertEquals(\"INVALID_STATUS_TRANSITION\", ex.code());\r\n    assertTrue(ex.getMessage().contains(current));\r\n    assertTrue(ex.getMessage().contains(next));\r\n  }\r\n}\r\n",
      "info": {
        "size": 1621,
        "last_modified": "2026-02-01T22:28:37.394093",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    },
    {
      "path": "test\\java\\com\\cocinadelicia\\backend\\product\\repository\\spec\\ProductSpecificationsTest.java",
      "content": "\r\n",
      "info": {
        "size": 2,
        "last_modified": "2026-02-01T22:28:37.4050928",
        "mime_type": "text/x-java-source",
        "extension": ".java"
      }
    }
  ]
}